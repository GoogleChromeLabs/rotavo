!function(){"use strict";(function(){var t=new Set("annotation-xml color-profile font-face font-face-src font-face-uri font-face-format font-face-name missing-glyph".split(" "));function e(e){var n=t.has(e);return e=/^[a-z][.0-9_a-z]*-[\-.0-9_a-z]*$/.test(e),!n&&e}function n(t){var e=t.isConnected;if(void 0!==e)return e;for(;t&&!(t.__CE_isImportDocument||t instanceof Document);)t=t.parentNode||(window.ShadowRoot&&t instanceof ShadowRoot?t.host:void 0);return!(!t||!(t.__CE_isImportDocument||t instanceof Document))}function r(t,e){for(;e&&e!==t&&!e.nextSibling;)e=e.parentNode;return e&&e!==t?e.nextSibling:null}function i(t,e,n){n=void 0===n?new Set:n;for(var o=t;o;){if(o.nodeType===Node.ELEMENT_NODE){var a=o;e(a);var s=a.localName;if("link"===s&&"import"===a.getAttribute("rel")){if((o=a.import)instanceof Node&&!n.has(o))for(n.add(o),o=o.firstChild;o;o=o.nextSibling)i(o,e,n);o=r(t,a);continue}if("template"===s){o=r(t,a);continue}if(a=a.__CE_shadowRoot)for(a=a.firstChild;a;a=a.nextSibling)i(a,e,n)}o=o.firstChild?o.firstChild:r(t,o)}}function o(t,e,n){t[e]=n}function a(){this.a=new Map,this.g=new Map,this.c=[],this.f=[],this.b=!1}function s(t,e){t.b&&i(e,function(e){return u(t,e)})}function u(t,e){if(t.b&&!e.__CE_patched){e.__CE_patched=!0;for(var n=0;n<t.c.length;n++)t.c[n](e);for(n=0;n<t.f.length;n++)t.f[n](e)}}function c(t,e){var n=[];for(i(e,function(t){return n.push(t)}),e=0;e<n.length;e++){var r=n[e];1===r.__CE_state?t.connectedCallback(r):f(t,r)}}function h(t,e){var n=[];for(i(e,function(t){return n.push(t)}),e=0;e<n.length;e++){var r=n[e];1===r.__CE_state&&t.disconnectedCallback(r)}}function l(t,e,n){var r=(n=void 0===n?{}:n).u||new Set,o=n.i||function(e){return f(t,e)},a=[];if(i(e,function(e){if("link"===e.localName&&"import"===e.getAttribute("rel")){var n=e.import;n instanceof Node&&(n.__CE_isImportDocument=!0,n.__CE_hasRegistry=!0),n&&"complete"===n.readyState?n.__CE_documentLoadHandled=!0:e.addEventListener("load",function(){var n=e.import;if(!n.__CE_documentLoadHandled){n.__CE_documentLoadHandled=!0;var i=new Set(r);i.delete(n),l(t,n,{u:i,i:o})}})}else a.push(e)},r),t.b)for(e=0;e<a.length;e++)u(t,a[e]);for(e=0;e<a.length;e++)o(a[e])}function f(t,e){if(void 0===e.__CE_state){var r=e.ownerDocument;if((r.defaultView||r.__CE_isImportDocument&&r.__CE_hasRegistry)&&(r=t.a.get(e.localName))){r.constructionStack.push(e);var i=r.constructorFunction;try{try{if(new i!==e)throw Error("The custom element constructor did not produce the element being upgraded.")}finally{r.constructionStack.pop()}}catch(t){throw e.__CE_state=2,t}if(e.__CE_state=1,e.__CE_definition=r,r.attributeChangedCallback)for(r=r.observedAttributes,i=0;i<r.length;i++){var o=r[i],a=e.getAttribute(o);null!==a&&t.attributeChangedCallback(e,o,null,a,null)}n(e)&&t.connectedCallback(e)}}}function d(t){var e=document;this.c=t,this.a=e,this.b=void 0,l(this.c,this.a),"loading"===this.a.readyState&&(this.b=new MutationObserver(this.f.bind(this)),this.b.observe(this.a,{childList:!0,subtree:!0}))}function p(t){t.b&&t.b.disconnect()}function m(){var t=this;this.b=this.a=void 0,this.c=new Promise(function(e){t.b=e,t.a&&e(t.a)})}function y(t){if(t.a)throw Error("Already resolved.");t.a=void 0,t.b&&t.b(void 0)}function g(t){this.c=!1,this.a=t,this.j=new Map,this.f=function(t){return t()},this.b=!1,this.g=[],this.o=new d(t)}a.prototype.connectedCallback=function(t){var e=t.__CE_definition;e.connectedCallback&&e.connectedCallback.call(t)},a.prototype.disconnectedCallback=function(t){var e=t.__CE_definition;e.disconnectedCallback&&e.disconnectedCallback.call(t)},a.prototype.attributeChangedCallback=function(t,e,n,r,i){var o=t.__CE_definition;o.attributeChangedCallback&&-1<o.observedAttributes.indexOf(e)&&o.attributeChangedCallback.call(t,e,n,r,i)},d.prototype.f=function(t){var e=this.a.readyState;for("interactive"!==e&&"complete"!==e||p(this),e=0;e<t.length;e++)for(var n=t[e].addedNodes,r=0;r<n.length;r++)l(this.c,n[r])},g.prototype.l=function(t,n){var r=this;if(!(n instanceof Function))throw new TypeError("Custom element constructors must be functions.");if(!e(t))throw new SyntaxError("The element name '"+t+"' is not valid.");if(this.a.a.get(t))throw Error("A custom element with name '"+t+"' has already been defined.");if(this.c)throw Error("A custom element is already being defined.");this.c=!0;try{var i=function(t){var e=o[t];if(void 0!==e&&!(e instanceof Function))throw Error("The '"+t+"' callback must be a function.");return e},o=n.prototype;if(!(o instanceof Object))throw new TypeError("The custom element constructor's prototype is not an object.");var a=i("connectedCallback"),s=i("disconnectedCallback"),u=i("adoptedCallback"),c=i("attributeChangedCallback"),h=n.observedAttributes||[]}catch(t){return}finally{this.c=!1}n={localName:t,constructorFunction:n,connectedCallback:a,disconnectedCallback:s,adoptedCallback:u,attributeChangedCallback:c,observedAttributes:h,constructionStack:[]},function(t,e,n){t.a.set(e,n),t.g.set(n.constructorFunction,n)}(this.a,t,n),this.g.push(n),this.b||(this.b=!0,this.f(function(){return function(t){if(!1!==t.b){t.b=!1;for(var e=t.g,n=[],r=new Map,i=0;i<e.length;i++)r.set(e[i].localName,[]);for(l(t.a,document,{i:function(e){if(void 0===e.__CE_state){var i=e.localName,o=r.get(i);o?o.push(e):t.a.a.get(i)&&n.push(e)}}}),i=0;i<n.length;i++)f(t.a,n[i]);for(;0<e.length;){var o=e.shift();i=o.localName,o=r.get(o.localName);for(var a=0;a<o.length;a++)f(t.a,o[a]);(i=t.j.get(i))&&y(i)}}}(r)}))},g.prototype.i=function(t){l(this.a,t)},g.prototype.get=function(t){if(t=this.a.a.get(t))return t.constructorFunction},g.prototype.m=function(t){if(!e(t))return Promise.reject(new SyntaxError("'"+t+"' is not a valid custom element name."));var n=this.j.get(t);return n?n.c:(n=new m,this.j.set(t,n),this.a.a.get(t)&&!this.g.some(function(e){return e.localName===t})&&y(n),n.c)},g.prototype.s=function(t){p(this.o);var e=this.f;this.f=function(n){return t(function(){return e(n)})}},window.CustomElementRegistry=g,g.prototype.define=g.prototype.l,g.prototype.upgrade=g.prototype.i,g.prototype.get=g.prototype.get,g.prototype.whenDefined=g.prototype.m,g.prototype.polyfillWrapFlushCallback=g.prototype.s;var v=window.Document.prototype.createElement,b=window.Document.prototype.createElementNS,w=window.Document.prototype.importNode,E=window.Document.prototype.prepend,S=window.Document.prototype.append,T=window.DocumentFragment.prototype.prepend,_=window.DocumentFragment.prototype.append,I=window.Node.prototype.cloneNode,C=window.Node.prototype.appendChild,D=window.Node.prototype.insertBefore,A=window.Node.prototype.removeChild,k=window.Node.prototype.replaceChild,N=Object.getOwnPropertyDescriptor(window.Node.prototype,"textContent"),M=window.Element.prototype.attachShadow,O=Object.getOwnPropertyDescriptor(window.Element.prototype,"innerHTML"),R=window.Element.prototype.getAttribute,P=window.Element.prototype.setAttribute,L=window.Element.prototype.removeAttribute,x=window.Element.prototype.getAttributeNS,F=window.Element.prototype.setAttributeNS,q=window.Element.prototype.removeAttributeNS,B=window.Element.prototype.insertAdjacentElement,V=window.Element.prototype.insertAdjacentHTML,U=window.Element.prototype.prepend,j=window.Element.prototype.append,K=window.Element.prototype.before,Q=window.Element.prototype.after,z=window.Element.prototype.replaceWith,G=window.Element.prototype.remove,W=window.HTMLElement,H=Object.getOwnPropertyDescriptor(window.HTMLElement.prototype,"innerHTML"),Y=window.HTMLElement.prototype.insertAdjacentElement,X=window.HTMLElement.prototype.insertAdjacentHTML,J=new function(){};function $(t,e,r){function i(e){return function(r){for(var i=[],o=0;o<arguments.length;++o)i[o]=arguments[o];o=[];for(var a=[],s=0;s<i.length;s++){var u=i[s];if(u instanceof Element&&n(u)&&a.push(u),u instanceof DocumentFragment)for(u=u.firstChild;u;u=u.nextSibling)o.push(u);else o.push(u)}for(e.apply(this,i),i=0;i<a.length;i++)h(t,a[i]);if(n(this))for(i=0;i<o.length;i++)(a=o[i])instanceof Element&&c(t,a)}}void 0!==r.h&&(e.prepend=i(r.h)),void 0!==r.append&&(e.append=i(r.append))}var Z,tt=window.customElements;if(!tt||tt.forcePolyfill||"function"!=typeof tt.define||"function"!=typeof tt.get){var et=new a;Z=et,window.HTMLElement=function(){function t(){var t=this.constructor,e=Z.g.get(t);if(!e)throw Error("The custom element being constructed was not registered with `customElements`.");var n=e.constructionStack;if(0===n.length)return n=v.call(document,e.localName),Object.setPrototypeOf(n,t.prototype),n.__CE_state=1,n.__CE_definition=e,u(Z,n),n;var r=n[e=n.length-1];if(r===J)throw Error("The HTMLElement constructor was either called reentrantly for this constructor or called multiple times.");return n[e]=J,Object.setPrototypeOf(r,t.prototype),u(Z,r),r}return t.prototype=W.prototype,Object.defineProperty(t.prototype,"constructor",{writable:!0,configurable:!0,enumerable:!1,value:t}),t}(),function(){var t=et;o(Document.prototype,"createElement",function(e){if(this.__CE_hasRegistry){var n=t.a.get(e);if(n)return new n.constructorFunction}return e=v.call(this,e),u(t,e),e}),o(Document.prototype,"importNode",function(e,n){return e=w.call(this,e,!!n),this.__CE_hasRegistry?l(t,e):s(t,e),e}),o(Document.prototype,"createElementNS",function(e,n){if(this.__CE_hasRegistry&&(null===e||"http://www.w3.org/1999/xhtml"===e)){var r=t.a.get(n);if(r)return new r.constructorFunction}return e=b.call(this,e,n),u(t,e),e}),$(t,Document.prototype,{h:E,append:S})}(),$(et,DocumentFragment.prototype,{h:T,append:_}),function(){function t(t,r){Object.defineProperty(t,"textContent",{enumerable:r.enumerable,configurable:!0,get:r.get,set:function(t){if(this.nodeType===Node.TEXT_NODE)r.set.call(this,t);else{var i=void 0;if(this.firstChild){var o=this.childNodes,a=o.length;if(0<a&&n(this)){i=Array(a);for(var s=0;s<a;s++)i[s]=o[s]}}if(r.set.call(this,t),i)for(t=0;t<i.length;t++)h(e,i[t])}}})}var e=et;o(Node.prototype,"insertBefore",function(t,r){if(t instanceof DocumentFragment){var i=Array.prototype.slice.apply(t.childNodes);if(t=D.call(this,t,r),n(this))for(r=0;r<i.length;r++)c(e,i[r]);return t}return i=n(t),r=D.call(this,t,r),i&&h(e,t),n(this)&&c(e,t),r}),o(Node.prototype,"appendChild",function(t){if(t instanceof DocumentFragment){var r=Array.prototype.slice.apply(t.childNodes);if(t=C.call(this,t),n(this))for(var i=0;i<r.length;i++)c(e,r[i]);return t}return r=n(t),i=C.call(this,t),r&&h(e,t),n(this)&&c(e,t),i}),o(Node.prototype,"cloneNode",function(t){return t=I.call(this,!!t),this.ownerDocument.__CE_hasRegistry?l(e,t):s(e,t),t}),o(Node.prototype,"removeChild",function(t){var r=n(t),i=A.call(this,t);return r&&h(e,t),i}),o(Node.prototype,"replaceChild",function(t,r){if(t instanceof DocumentFragment){var i=Array.prototype.slice.apply(t.childNodes);if(t=k.call(this,t,r),n(this))for(h(e,r),r=0;r<i.length;r++)c(e,i[r]);return t}i=n(t);var o=k.call(this,t,r),a=n(this);return a&&h(e,r),i&&h(e,t),a&&c(e,t),o}),N&&N.get?t(Node.prototype,N):function(t,e){t.b=!0,t.c.push(e)}(e,function(e){t(e,{enumerable:!0,configurable:!0,get:function(){for(var t=[],e=0;e<this.childNodes.length;e++){var n=this.childNodes[e];n.nodeType!==Node.COMMENT_NODE&&t.push(n.textContent)}return t.join("")},set:function(t){for(;this.firstChild;)A.call(this,this.firstChild);null!=t&&""!==t&&C.call(this,document.createTextNode(t))}})})}(),function(){function t(t,e){Object.defineProperty(t,"innerHTML",{enumerable:e.enumerable,configurable:!0,get:e.get,set:function(t){var r=this,o=void 0;if(n(this)&&(o=[],i(this,function(t){t!==r&&o.push(t)})),e.set.call(this,t),o)for(var u=0;u<o.length;u++){var c=o[u];1===c.__CE_state&&a.disconnectedCallback(c)}return this.ownerDocument.__CE_hasRegistry?l(a,this):s(a,this),t}})}function e(t,e){o(t,"insertAdjacentElement",function(t,r){var i=n(r);return t=e.call(this,t,r),i&&h(a,r),n(t)&&c(a,r),t})}function r(t,e){function n(t,e){for(var n=[];t!==e;t=t.nextSibling)n.push(t);for(e=0;e<n.length;e++)l(a,n[e])}o(t,"insertAdjacentHTML",function(t,r){if("beforebegin"===(t=t.toLowerCase())){var i=this.previousSibling;e.call(this,t,r),n(i||this.parentNode.firstChild,this)}else if("afterbegin"===t)i=this.firstChild,e.call(this,t,r),n(this.firstChild,i);else if("beforeend"===t)i=this.lastChild,e.call(this,t,r),n(i||this.firstChild,null);else{if("afterend"!==t)throw new SyntaxError("The value provided ("+String(t)+") is not one of 'beforebegin', 'afterbegin', 'beforeend', or 'afterend'.");i=this.nextSibling,e.call(this,t,r),n(this.nextSibling,i)}})}var a=et;M&&o(Element.prototype,"attachShadow",function(t){t=M.call(this,t);var e=a;if(e.b&&!t.__CE_patched){t.__CE_patched=!0;for(var n=0;n<e.c.length;n++)e.c[n](t)}return this.__CE_shadowRoot=t}),O&&O.get?t(Element.prototype,O):H&&H.get?t(HTMLElement.prototype,H):function(t,e){t.b=!0,t.f.push(e)}(a,function(e){t(e,{enumerable:!0,configurable:!0,get:function(){return I.call(this,!0).innerHTML},set:function(t){var e="template"===this.localName,n=e?this.content:this,r=b.call(document,this.namespaceURI,this.localName);for(r.innerHTML=t;0<n.childNodes.length;)A.call(n,n.childNodes[0]);for(t=e?r.content:r;0<t.childNodes.length;)C.call(n,t.childNodes[0])}})}),o(Element.prototype,"setAttribute",function(t,e){if(1!==this.__CE_state)return P.call(this,t,e);var n=R.call(this,t);P.call(this,t,e),e=R.call(this,t),a.attributeChangedCallback(this,t,n,e,null)}),o(Element.prototype,"setAttributeNS",function(t,e,n){if(1!==this.__CE_state)return F.call(this,t,e,n);var r=x.call(this,t,e);F.call(this,t,e,n),n=x.call(this,t,e),a.attributeChangedCallback(this,e,r,n,t)}),o(Element.prototype,"removeAttribute",function(t){if(1!==this.__CE_state)return L.call(this,t);var e=R.call(this,t);L.call(this,t),null!==e&&a.attributeChangedCallback(this,t,e,null,null)}),o(Element.prototype,"removeAttributeNS",function(t,e){if(1!==this.__CE_state)return q.call(this,t,e);var n=x.call(this,t,e);q.call(this,t,e);var r=x.call(this,t,e);n!==r&&a.attributeChangedCallback(this,e,n,r,t)}),Y?e(HTMLElement.prototype,Y):B?e(Element.prototype,B):console.warn("Custom Elements: `Element#insertAdjacentElement` was not patched."),X?r(HTMLElement.prototype,X):V?r(Element.prototype,V):console.warn("Custom Elements: `Element#insertAdjacentHTML` was not patched."),$(a,Element.prototype,{h:U,append:j}),function(t){function e(e){return function(r){for(var i=[],o=0;o<arguments.length;++o)i[o]=arguments[o];o=[];for(var a=[],s=0;s<i.length;s++){var u=i[s];if(u instanceof Element&&n(u)&&a.push(u),u instanceof DocumentFragment)for(u=u.firstChild;u;u=u.nextSibling)o.push(u);else o.push(u)}for(e.apply(this,i),i=0;i<a.length;i++)h(t,a[i]);if(n(this))for(i=0;i<o.length;i++)(a=o[i])instanceof Element&&c(t,a)}}var r=Element.prototype;void 0!==K&&(r.before=e(K)),void 0!==K&&(r.after=e(Q)),void 0!==z&&o(r,"replaceWith",function(e){for(var r=[],i=0;i<arguments.length;++i)r[i]=arguments[i];i=[];for(var o=[],a=0;a<r.length;a++){var s=r[a];if(s instanceof Element&&n(s)&&o.push(s),s instanceof DocumentFragment)for(s=s.firstChild;s;s=s.nextSibling)i.push(s);else i.push(s)}for(a=n(this),z.apply(this,r),r=0;r<o.length;r++)h(t,o[r]);if(a)for(h(t,this),r=0;r<i.length;r++)(o=i[r])instanceof Element&&c(t,o)}),void 0!==G&&o(r,"remove",function(){var e=n(this);G.call(this),e&&h(t,this)})}(a)}(),document.__CE_hasRegistry=!0;var nt=new g(et);Object.defineProperty(window,"customElements",{configurable:!0,enumerable:!0,value:nt})}}).call(self);!function(t,e){"function"==typeof define&&define.amd?define(function(){return e(t,t.document)}):"undefined"!=typeof module&&module.exports?module.exports=e(t,t.document):t.Shake=e(t,t.document)}("undefined"!=typeof window?window:void 0,function(t,e){function n(n){if(this.hasDeviceMotion="ondevicemotion"in t,this.options={threshold:15,timeout:1e3},"object"==typeof n)for(var r in n)n.hasOwnProperty(r)&&(this.options[r]=n[r]);if(this.lastTime=new Date,this.lastX=null,this.lastY=null,this.lastZ=null,"function"==typeof e.CustomEvent)this.event=new e.CustomEvent("shake",{bubbles:!0,cancelable:!0});else{if("function"!=typeof e.createEvent)return!1;this.event=e.createEvent("Event"),this.event.initEvent("shake",!0,!0)}}return n.prototype.reset=function(){this.lastTime=new Date,this.lastX=null,this.lastY=null,this.lastZ=null},n.prototype.start=function(){this.reset(),this.hasDeviceMotion&&t.addEventListener("devicemotion",this,!1)},n.prototype.stop=function(){this.hasDeviceMotion&&t.removeEventListener("devicemotion",this,!1),this.reset()},n.prototype.devicemotion=function(e){var n,r,i,o=e.accelerationIncludingGravity;if(null===this.lastX&&null===this.lastY&&null===this.lastZ)return this.lastX=o.x,this.lastY=o.y,void(this.lastZ=o.z);n=Math.abs(this.lastX-o.x),r=Math.abs(this.lastY-o.y),i=Math.abs(this.lastZ-o.z),(n>this.options.threshold&&r>this.options.threshold||n>this.options.threshold&&i>this.options.threshold||r>this.options.threshold&&i>this.options.threshold)&&(new Date).getTime()-this.lastTime.getTime()>this.options.timeout&&(t.dispatchEvent(this.event),this.lastTime=new Date),this.lastX=o.x,this.lastY=o.y,this.lastZ=o.z},n.prototype.handleEvent=function(t){if("function"==typeof this[t.type])return this[t.type](t)},n});class t{constructor(t,e){this._rootElement=t,this._app=e,this._canDraw=!0,this._lastSketchAngle=null,this._lastDraw=0,this._drawInterval=0,this._keyInterval=200,this._horzKeys={w:{pressed:!1,timestamp:0,value:.01,prev:{key:"a",value:-.785},next:{key:"d",value:.785}},d:{pressed:!1,timestamp:0,value:1.57,prev:{key:"w",value:.785},next:{key:"s",value:2.355}},s:{pressed:!1,timestamp:0,value:3.14,prev:{key:"d",value:2.355},next:{key:"a",value:-2.355}},a:{pressed:!1,timestamp:0,value:-1.56,prev:{key:"s",value:-2.355},next:{key:"w",value:-.785}}},this._vertKeys={i:{pressed:!1,timestamp:0,value:.01,prev:{key:"j",value:-.785},next:{key:"l",value:.785}},l:{pressed:!1,timestamp:0,value:1.57,prev:{key:"i",value:.785},next:{key:"k",value:2.355}},k:{pressed:!1,timestamp:0,value:3.14,prev:{key:"l",value:2.355},next:{key:"j",value:-2.355}},j:{pressed:!1,timestamp:0,value:-1.56,prev:{key:"k",value:-2.355},next:{key:"i",value:-.785}}},this.activate=this.activate.bind(this),this.deactivate=this.deactivate.bind(this),this._handleKeydown=this._handleKeydown.bind(this),this._handleKeyup=this._handleKeyup.bind(this),this._onShake=this._onShake.bind(this),this._optimizeSketch=this._optimizeSketch.bind(this),this._requestOptimizeSketch=this._requestOptimizeSketch.bind(this),this._requestUpdateSketch=this._requestUpdateSketch.bind(this),this._toggleDetail=this._toggleDetail.bind(this),this._updateSketch=this._updateSketch.bind(this),this._screen=this._rootElement.querySelector(".screen"),this._activeSketch=this._rootElement.querySelector(".active-sketch"),this._path=this._rootElement.querySelector(".sketch-path"),this._stylus=this._rootElement.querySelector(".sketch-stylus"),this._horzKnob=this._rootElement.querySelector(".horz-knob"),this._vertKnob=this._rootElement.querySelector(".vert-knob")}activate(){this._rootElement.addEventListener("touch-knob-move",this._requestUpdateSketch,{capture:!1,passive:!0}),this._rootElement.addEventListener("touch-knob-end",this._requestOptimizeSketch,{capture:!1,passive:!0}),this._shakeDetector=new Shake({threshold:5,timeout:200}),this._shakeDetector.start(),window.addEventListener("shake",this._onShake,{capture:!1,passive:!0}),this._jiggleButton=this._rootElement.querySelector(".button-jiggle"),this._jiggleButton&&this._jiggleButton.addEventListener("click",this._onShake,{capture:!1,passive:!0}),this._detailButton=this._rootElement.querySelector(".button-detail"),this._detailButton&&this._detailButton.addEventListener("click",this._toggleDetail,{capture:!1,passive:!0}),this._rootElement.addEventListener("keydown",this._handleKeydown,{capture:!1,passive:!0}),this._rootElement.addEventListener("keyup",this._handleKeyup,{capture:!1,passive:!0})}deactivate(){this._rootElement.removeEventListener("touch-knob-move",this._requestUpdateSketch),this._rootElement.removeEventListener("touch-knob-end",this._requestOptimizeSketch),window.removeEventListener("shake",this._onShake,{capture:!1,passive:!0}),this._jiggleButton.removeEventListener("click",this._onShake,{capture:!1,passive:!0}),this._shakeDetector.stop(),this._detailButton.removeEventListener("click",this._toggleDetail,{capture:!1,passive:!0}),this._rootElement.removeEventListener("keydown",this._handleKeydown,{capture:!1,passive:!0}),this._rootElement.removeEventListener("keyup",this._handleKeyup,{capture:!1,passive:!0})}_isAnyKeyPressed(t){for(let e in t)if(t.hasOwnProperty(e)&&!0===t[e].pressed)return!0}_handleRotateKeydown(t,e,n){if(0!=e[t].pressed)return;const r=e[t],i=e[e[t].prev.key],o=e[e[t].next.key];!0===i.pressed||Date.now()-i.timestamp<this._keyInterval?n.rotateToContinue(r.prev.value):!0===o.pressed||Date.now()-o.timestamp<this._keyInterval?n.rotateToContinue(r.next.value):this._isAnyKeyPressed(e)?n.rotateToContinue(r.value):n.rotateToStart(r.value),r.pressed=!0,r.timestamp=Date.now()}_handleRotateKeyup(t,e,n){e[t].pressed=!1;const r=e[e[t].prev.key],i=e[e[t].next.key];!0===r.pressed?n.rotateToContinue(r.value):1==i.pressed?n.rotateToContinue(i.value):n.rotateToEnd()}_handleKeydown(t){["w","d","s","a"].includes(t.key)?this._handleRotateKeydown(t.key,this._horzKeys,this._horzKnob):["i","l","k","j"].includes(t.key)?this._handleRotateKeydown(t.key,this._vertKeys,this._vertKnob):"x"===t.key&&this._onShake()}_handleKeyup(t){["w","d","s","a"].includes(t.key)?this._handleRotateKeyup(t.key,this._horzKeys,this._horzKnob):["i","l","k","j"].includes(t.key)?this._handleRotateKeyup(t.key,this._vertKeys,this._vertKnob):"r"===t.key&&this._app.activateOptionsMode()}setDrawInterval(t){this._drawInterval=t}_requestUpdateSketch(){!0===this._canDraw&&Date.now()-this._lastDraw>this._drawInterval&&(this._canDraw=!1,this._lastDraw=Date.now(),window.requestAnimationFrame(this._updateSketch))}_requestOptimizeSketch(){!0===this._canDraw&&(this._canDraw=!1,window.requestAnimationFrame(this._optimizeSketch))}_updateSketch(){this._app.sketchModel.moveTo({x:this._horzKnob.value,y:this._vertKnob.value}),this._drawSketch(),this._canDraw=!0}_optimizeSketch(){this._app.sketchModel.simplifyPath(),this._drawSketch(),this._canDraw=!0}_drawSketch(){const t=this._app.sketchModel.path,e=t[0];let n=`M ${e.x-2} ${e.y-2} M ${e.x+2} ${e.y+2} M ${e.x} ${e.y}`;for(let e=1;e<t.length;e++){const r=t[e];n+=` L ${r.x} ${r.y}`}this._path.setAttribute("d",n);const r=this._app.sketchModel.lastPoint;this._stylus.setAttribute("x1",r.x),this._stylus.setAttribute("x2",r.x),this._stylus.setAttribute("y1",r.y),this._stylus.setAttribute("y2",r.y)}_onShake(){if(this._app.sketchModel.jiggle()){const t=document.createElementNS("http://www.w3.org/2000/svg","path"),e=this._app.sketchModel.path[0],n=`M ${e.x-2} ${e.y-2} M ${e.x+2} ${e.y+2} M ${e.x} ${e.y}`;t.setAttributeNS(null,"d",n),t.classList.add("sketch-path");const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.classList.add("erased-sketch"),r.setAttributeNS(null,"preserveAspectRatio","none"),r.setAttributeNS(null,"x","0"),r.setAttributeNS(null,"y","0"),r.setAttributeNS(null,"viewBox","-2 -2 302 302"),r.style.opacity="1",r.appendChild(this._path),this._path=t,this._activeSketch.insertBefore(this._path,this._stylus),this._screen.insertBefore(r,this._activeSketch)}this._screen.querySelectorAll(".erased-sketch").forEach(t=>{let e=Number.parseFloat(t.style.opacity);if(e<=0)this._screen.removeChild(t);else{const n=1-(e-=.21);t.style.opacity=e,t.style.filter="blur("+n+"vw)"}})}_toggleDetail(){switch(this._detailButton.value){case"fast":this._screen.classList.add("fast"),this._screen.classList.remove("fanciest","fancy"),this._detailButton.textContent="✨ Fancy",this._detailButton.value="fancy";break;case"fancy":this._screen.classList.add("fancy"),this._screen.classList.remove("fanciest","fast"),this._detailButton.textContent="🌈 Fanciest",this._detailButton.value="fanciest";break;case"fanciest":this._screen.classList.add("fanciest"),this._screen.classList.remove("fancy","fast"),this._detailButton.textContent="🚀 Fast",this._detailButton.value="fast"}}}!function(t){if(!t.fetch){var e={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};if(e.arrayBuffer)var n=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],r=function(t){return t&&DataView.prototype.isPrototypeOf(t)},i=ArrayBuffer.isView||function(t){return t&&n.indexOf(Object.prototype.toString.call(t))>-1};h.prototype.append=function(t,e){t=s(t),e=u(e);var n=this.map[t];this.map[t]=n?n+","+e:e},h.prototype.delete=function(t){delete this.map[s(t)]},h.prototype.get=function(t){return t=s(t),this.has(t)?this.map[t]:null},h.prototype.has=function(t){return this.map.hasOwnProperty(s(t))},h.prototype.set=function(t,e){this.map[s(t)]=u(e)},h.prototype.forEach=function(t,e){for(var n in this.map)this.map.hasOwnProperty(n)&&t.call(e,this.map[n],n,this)},h.prototype.keys=function(){var t=[];return this.forEach(function(e,n){t.push(n)}),c(t)},h.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),c(t)},h.prototype.entries=function(){var t=[];return this.forEach(function(e,n){t.push([n,e])}),c(t)},e.iterable&&(h.prototype[Symbol.iterator]=h.prototype.entries);var o=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];y.prototype.clone=function(){return new y(this,{body:this._bodyInit})},m.call(y.prototype),m.call(v.prototype),v.prototype.clone=function(){return new v(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new h(this.headers),url:this.url})},v.error=function(){var t=new v(null,{status:0,statusText:""});return t.type="error",t};var a=[301,302,303,307,308];v.redirect=function(t,e){if(-1===a.indexOf(e))throw new RangeError("Invalid status code");return new v(null,{status:e,headers:{location:t}})},t.Headers=h,t.Request=y,t.Response=v,t.fetch=function(t,n){return new Promise(function(r,i){var o=new y(t,n),a=new XMLHttpRequest;a.onload=function(){var t,e,n={status:a.status,statusText:a.statusText,headers:(t=a.getAllResponseHeaders()||"",e=new h,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var n=t.split(":"),r=n.shift().trim();if(r){var i=n.join(":").trim();e.append(r,i)}}),e)};n.url="responseURL"in a?a.responseURL:n.headers.get("X-Request-URL");var i="response"in a?a.response:a.responseText;r(new v(i,n))},a.onerror=function(){i(new TypeError("Network request failed"))},a.ontimeout=function(){i(new TypeError("Network request failed"))},a.open(o.method,o.url,!0),"include"===o.credentials?a.withCredentials=!0:"omit"===o.credentials&&(a.withCredentials=!1),"responseType"in a&&e.blob&&(a.responseType="blob"),o.headers.forEach(function(t,e){a.setRequestHeader(e,t)}),a.send(void 0===o._bodyInit?null:o._bodyInit)})},t.fetch.polyfill=!0}function s(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function u(t){return"string"!=typeof t&&(t=String(t)),t}function c(t){var n={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return e.iterable&&(n[Symbol.iterator]=function(){return n}),n}function h(t){this.map={},t instanceof h?t.forEach(function(t,e){this.append(e,t)},this):Array.isArray(t)?t.forEach(function(t){this.append(t[0],t[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function l(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function f(t){return new Promise(function(e,n){t.onload=function(){e(t.result)},t.onerror=function(){n(t.error)}})}function d(t){var e=new FileReader,n=f(e);return e.readAsArrayBuffer(t),n}function p(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function m(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t,t)if("string"==typeof t)this._bodyText=t;else if(e.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(e.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(e.arrayBuffer&&e.blob&&r(t))this._bodyArrayBuffer=p(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!e.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t)&&!i(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=p(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},e.blob&&(this.blob=function(){var t=l(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?l(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(d)}),this.text=function(){var t,e,n,r=l(this);if(r)return r;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,n=f(e),e.readAsText(t),n;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),n=new Array(e.length),r=0;r<e.length;r++)n[r]=String.fromCharCode(e[r]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},e.formData&&(this.formData=function(){return this.text().then(g)}),this.json=function(){return this.text().then(JSON.parse)},this}function y(t,e){var n,r,i=(e=e||{}).body;if(t instanceof y){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new h(t.headers)),this.method=t.method,this.mode=t.mode,i||null==t._bodyInit||(i=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new h(e.headers)),this.method=(n=e.method||this.method||"GET",r=n.toUpperCase(),o.indexOf(r)>-1?r:n),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function g(t){var e=new FormData;return t.trim().split("&").forEach(function(t){if(t){var n=t.split("="),r=n.shift().replace(/\+/g," "),i=n.join("=").replace(/\+/g," ");e.append(decodeURIComponent(r),decodeURIComponent(i))}}),e}function v(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new h(e.headers),this.url=e.url||"",this._initBody(t)}}("undefined"!=typeof self?self:void 0);var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(t,e){return t(e={exports:{}},e.exports),e.exports}function r(t){var e=this.constructor;return this.then(function(n){return e.resolve(t()).then(function(){return n})},function(n){return e.resolve(t()).then(function(){return e.reject(n)})})}var i=setTimeout;function o(){}function a(t){if(!(this instanceof a))throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],f(t,this)}function s(t,e){for(;3===t._state;)t=t._value;0!==t._state?(t._handled=!0,a._immediateFn(function(){var n=1===t._state?e.onFulfilled:e.onRejected;if(null!==n){var r;try{r=n(t._value)}catch(t){return void c(e.promise,t)}u(e.promise,r)}else(1===t._state?u:c)(e.promise,t._value)})):t._deferreds.push(e)}function u(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var n=e.then;if(e instanceof a)return t._state=3,t._value=e,void h(t);if("function"==typeof n)return void f((r=n,i=e,function(){r.apply(i,arguments)}),t)}t._state=1,t._value=e,h(t)}catch(e){c(t,e)}var r,i}function c(t,e){t._state=2,t._value=e,h(t)}function h(t){2===t._state&&0===t._deferreds.length&&a._immediateFn(function(){t._handled||a._unhandledRejectionFn(t._value)});for(var e=0,n=t._deferreds.length;e<n;e++)s(t,t._deferreds[e]);t._deferreds=null}function l(t,e,n){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=n}function f(t,e){var n=!1;try{t(function(t){n||(n=!0,u(e,t))},function(t){n||(n=!0,c(e,t))})}catch(t){if(n)return;n=!0,c(e,t)}}a.prototype.catch=function(t){return this.then(null,t)},a.prototype.then=function(t,e){var n=new this.constructor(o);return s(this,new l(t,e,n)),n},a.prototype.finally=r,a.all=function(t){return new a(function(e,n){if(!t||void 0===t.length)throw new TypeError("Promise.all accepts an array");var r=Array.prototype.slice.call(t);if(0===r.length)return e([]);var i=r.length;function o(t,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var s=a.then;if("function"==typeof s)return void s.call(a,function(e){o(t,e)},n)}r[t]=a,0==--i&&e(r)}catch(t){n(t)}}for(var a=0;a<r.length;a++)o(a,r[a])})},a.resolve=function(t){return t&&"object"==typeof t&&t.constructor===a?t:new a(function(e){e(t)})},a.reject=function(t){return new a(function(e,n){n(t)})},a.race=function(t){return new a(function(e,n){for(var r=0,i=t.length;r<i;r++)t[r].then(e,n)})},a._immediateFn="function"==typeof setImmediate&&function(t){setImmediate(t)}||function(t){i(t,0)},a._unhandledRejectionFn=function(t){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",t)};var d=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==e)return e;throw new Error("unable to locate global object")}();"Promise"in d?d.Promise.prototype.finally||(d.Promise.prototype.finally=r):d.Promise=a;var p,m,y,g=function(t,e,n){if(function(t){if("function"!=typeof t)throw TypeError(String(t)+" is not a function")}(t),void 0===e)return t;switch(n){case 0:return function(){return t.call(e)};case 1:return function(n){return t.call(e,n)};case 2:return function(n,r){return t.call(e,n,r)};case 3:return function(n,r,i){return t.call(e,n,r,i)}}return function(){return t.apply(e,arguments)}},v=function(t){try{return!!t()}catch(t){return!0}},b={}.toString,w=function(t){return b.call(t).slice(8,-1)},E="".split,S=v(function(){return!Object("z").propertyIsEnumerable(0)})?function(t){return"String"==w(t)?E.call(t,""):Object(t)}:Object,T=function(t){if(null==t)throw TypeError("Can't call method on "+t);return t},_=function(t){return Object(T(t))},I=Math.ceil,C=Math.floor,D=function(t){return isNaN(t=+t)?0:(t>0?C:I)(t)},A=Math.min,k=function(t){return t>0?A(D(t),9007199254740991):0},N=function(t){return"object"==typeof t?null!==t:"function"==typeof t},M=Array.isArray||function(t){return"Array"==w(t)},O="object"==typeof window&&window&&window.Math==Math?window:"object"==typeof self&&self&&self.Math==Math?self:Function("return this")(),R=!v(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),P=O.document,L=N(P)&&N(P.createElement),x=function(t){return L?P.createElement(t):{}},F=!R&&!v(function(){return 7!=Object.defineProperty(x("div"),"a",{get:function(){return 7}}).a}),q=function(t){if(!N(t))throw TypeError(String(t)+" is not an object");return t},B=function(t,e){if(!N(t))return t;var n,r;if(e&&"function"==typeof(n=t.toString)&&!N(r=n.call(t)))return r;if("function"==typeof(n=t.valueOf)&&!N(r=n.call(t)))return r;if(!e&&"function"==typeof(n=t.toString)&&!N(r=n.call(t)))return r;throw TypeError("Can't convert object to primitive value")},V=Object.defineProperty,U={f:R?V:function(t,e,n){if(q(t),e=B(e,!0),q(n),F)try{return V(t,e,n)}catch(t){}if("get"in n||"set"in n)throw TypeError("Accessors not supported");return"value"in n&&(t[e]=n.value),t}},j=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},K=R?function(t,e,n){return U.f(t,e,j(1,n))}:function(t,e,n){return t[e]=n,t},Q=function(t,e){try{K(O,t,e)}catch(n){O[t]=e}return e},z=n(function(t){var e=O["__core-js_shared__"]||Q("__core-js_shared__",{});(t.exports=function(t,n){return e[t]||(e[t]=void 0!==n?n:{})})("versions",[]).push({version:"3.0.1",mode:"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})}),G=0,W=Math.random(),H=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++G+W).toString(36))},Y=!v(function(){return!String(Symbol())}),X=z("wks"),J=O.Symbol,$=function(t){return X[t]||(X[t]=Y&&J[t]||(Y?J:H)("Symbol."+t))},Z=$("species"),tt=function(t,e){var n;return M(t)&&("function"!=typeof(n=t.constructor)||n!==Array&&!M(n.prototype)?N(n)&&null===(n=n[Z])&&(n=void 0):n=void 0),new(void 0===n?Array:n)(0===e?0:e)},et=function(t,e){var n=1==t,r=2==t,i=3==t,o=4==t,a=6==t,s=5==t||a,u=e||tt;return function(e,c,h){for(var l,f,d=_(e),p=S(d),m=g(c,h,3),y=k(p.length),v=0,b=n?u(e,y):r?u(e,0):void 0;y>v;v++)if((s||v in p)&&(f=m(l=p[v],v,d),t))if(n)b[v]=f;else if(f)switch(t){case 3:return!0;case 5:return l;case 6:return v;case 2:b.push(l)}else if(o)return!1;return a?-1:i||o?o:b}},nt={}.propertyIsEnumerable,rt=Object.getOwnPropertyDescriptor,it={f:rt&&!nt.call({1:2},1)?function(t){var e=rt(this,t);return!!e&&e.enumerable}:nt},ot=function(t){return S(T(t))},at={}.hasOwnProperty,st=function(t,e){return at.call(t,e)},ut=Object.getOwnPropertyDescriptor,ct={f:R?ut:function(t,e){if(t=ot(t),e=B(e,!0),F)try{return ut(t,e)}catch(t){}if(st(t,e))return j(!it.f.call(t,e),t[e])}},ht=z("native-function-to-string",Function.toString),lt=O.WeakMap,ft="function"==typeof lt&&/native code/.test(ht.call(lt)),dt=z("keys"),pt=function(t){return dt[t]||(dt[t]=H(t))},mt={},yt=O.WeakMap;if(ft){var gt=new yt,vt=gt.get,bt=gt.has,wt=gt.set;p=function(t,e){return wt.call(gt,t,e),e},m=function(t){return vt.call(gt,t)||{}},y=function(t){return bt.call(gt,t)}}else{var Et=pt("state");mt[Et]=!0,p=function(t,e){return K(t,Et,e),e},m=function(t){return st(t,Et)?t[Et]:{}},y=function(t){return st(t,Et)}}var St,Tt={set:p,get:m,has:y,enforce:function(t){return y(t)?m(t):p(t,{})},getterFor:function(t){return function(e){var n;if(!N(e)||(n=m(e)).type!==t)throw TypeError("Incompatible receiver, "+t+" required");return n}}},_t=n(function(t){var e=Tt.get,n=Tt.enforce,r=String(ht).split("toString");z("inspectSource",function(t){return ht.call(t)}),(t.exports=function(t,e,i,o){var a=!!o&&!!o.unsafe,s=!!o&&!!o.enumerable,u=!!o&&!!o.noTargetGet;"function"==typeof i&&("string"!=typeof e||st(i,"name")||K(i,"name",e),n(i).source=r.join("string"==typeof e?e:"")),t!==O?(a?!u&&t[e]&&(s=!0):delete t[e],s?t[e]=i:K(t,e,i)):s?t[e]=i:Q(e,i)})(Function.prototype,"toString",function(){return"function"==typeof this&&e(this).source||ht.call(this)})}),It=Math.max,Ct=Math.min,Dt=(St=!1,function(t,e,n){var r,i=ot(t),o=k(i.length),a=function(t,e){var n=D(t);return n<0?It(n+e,0):Ct(n,e)}(n,o);if(St&&e!=e){for(;o>a;)if((r=i[a++])!=r)return!0}else for(;o>a;a++)if((St||a in i)&&i[a]===e)return St||a||0;return!St&&-1}),At=function(t,e){var n,r=ot(t),i=0,o=[];for(n in r)!st(mt,n)&&st(r,n)&&o.push(n);for(;e.length>i;)st(r,n=e[i++])&&(~Dt(o,n)||o.push(n));return o},kt=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Nt=kt.concat("length","prototype"),Mt={f:Object.getOwnPropertyNames||function(t){return At(t,Nt)}},Ot={f:Object.getOwnPropertySymbols},Rt=O.Reflect,Pt=Rt&&Rt.ownKeys||function(t){var e=Mt.f(q(t)),n=Ot.f;return n?e.concat(n(t)):e},Lt=function(t,e){for(var n=Pt(e),r=U.f,i=ct.f,o=0;o<n.length;o++){var a=n[o];st(t,a)||r(t,a,i(e,a))}},xt=/#|\.prototype\./,Ft=function(t,e){var n=Bt[qt(t)];return n==Ut||n!=Vt&&("function"==typeof e?v(e):!!e)},qt=Ft.normalize=function(t){return String(t).replace(xt,".").toLowerCase()},Bt=Ft.data={},Vt=Ft.NATIVE="N",Ut=Ft.POLYFILL="P",jt=Ft,Kt=ct.f,Qt=function(t,e){var n,r,i,o,a,s=t.target,u=t.global,c=t.stat;if(n=u?O:c?O[s]||Q(s,{}):(O[s]||{}).prototype)for(r in e){if(o=e[r],i=t.noTargetGet?(a=Kt(n,r))&&a.value:n[r],!jt(u?r:s+(c?".":"#")+r,t.forced)&&void 0!==i){if(typeof o==typeof i)continue;Lt(o,i)}(t.sham||i&&i.sham)&&K(o,"sham",!0),_t(n,r,o,t)}},zt=Object.keys||function(t){return At(t,kt)},Gt=R?Object.defineProperties:function(t,e){q(t);for(var n,r=zt(e),i=r.length,o=0;i>o;)U.f(t,n=r[o++],e[n]);return t},Wt=O.document,Ht=Wt&&Wt.documentElement,Yt=pt("IE_PROTO"),Xt=function(){},Jt=function(){var t,e=x("iframe"),n=kt.length;for(e.style.display="none",Ht.appendChild(e),e.src=String("javascript:"),(t=e.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),Jt=t.F;n--;)delete Jt.prototype[kt[n]];return Jt()},$t=Object.create||function(t,e){var n;return null!==t?(Xt.prototype=q(t),n=new Xt,Xt.prototype=null,n[Yt]=t):n=Jt(),void 0===e?n:Gt(n,e)};mt[Yt]=!0;var Zt=$("unscopables"),te=Array.prototype;null==te[Zt]&&K(te,Zt,$t(null));var ee=function(t){te[Zt][t]=!0},ne=et(5),re=!0;"find"in[]&&Array(1).find(function(){re=!1}),Qt({target:"Array",proto:!0,forced:re},{find:function(t){return ne(this,t,arguments.length>1?arguments[1]:void 0)}}),ee("find");var ie=Function.call,oe=function(t,e,n){return g(ie,O[t].prototype[e],n)},ae=(oe("Array","find"),et(6)),se=!0;"findIndex"in[]&&Array(1).findIndex(function(){se=!1}),Qt({target:"Array",proto:!0,forced:se},{findIndex:function(t){return ae(this,t,arguments.length>1?arguments[1]:void 0)}}),ee("findIndex");oe("Array","findIndex");var ue=Object.assign,ce=!ue||v(function(){var t={},e={},n=Symbol();return t[n]=7,"abcdefghijklmnopqrst".split("").forEach(function(t){e[t]=t}),7!=ue({},t)[n]||"abcdefghijklmnopqrst"!=zt(ue({},e)).join("")})?function(t,e){for(var n=_(t),r=arguments.length,i=1,o=Ot.f,a=it.f;r>i;)for(var s,u=S(arguments[i++]),c=o?zt(u).concat(o(u)):zt(u),h=c.length,l=0;h>l;)a.call(u,s=c[l++])&&(n[s]=u[s]);return n}:ue;Qt({target:"Object",stat:!0,forced:Object.assign!==ce},{assign:ce});var he=O,le=(he.Object.assign,$("match")),fe=function(t,e,n){if(N(r=e)&&(void 0!==(i=r[le])?i:"RegExp"==w(r)))throw TypeError("String.prototype."+n+" doesn't accept regex");var r,i;return String(T(t))},de=$("match"),pe=function(t){var e=/./;try{"/./"[t](e)}catch(n){try{return e[de]=!1,"/./"[t](e)}catch(t){}}return!1}("startsWith"),me="".startsWith;Qt({target:"String",proto:!0,forced:!pe},{startsWith:function(t){var e=fe(this,t,"startsWith"),n=k(Math.min(arguments.length>1?arguments[1]:void 0,e.length)),r=String(t);return me?me.call(e,r,n):e.slice(n,n+r.length)===r}});oe("String","startsWith");Qt({target:"String",proto:!0},{repeat:"".repeat||function(t){var e=String(T(this)),n="",r=D(t);if(r<0||r==1/0)throw RangeError("Wrong number of repetitions");for(;r>0;(r>>>=1)&&(e+=e))1&r&&(n+=e);return n}});oe("String","repeat");var ye=function(t,e,n){var r=B(e);r in t?U.f(t,r,j(0,n)):t[r]=n},ge=$("species"),ve=$("isConcatSpreadable"),be=!v(function(){var t=[];return t[ve]=!1,t.concat()[0]!==t}),we=function(t){return!v(function(){var e=[];return(e.constructor={})[ge]=function(){return{foo:1}},1!==e[t](Boolean).foo})}("concat"),Ee=function(t){if(!N(t))return!1;var e=t[ve];return void 0!==e?!!e:M(t)};Qt({target:"Array",proto:!0,forced:!be||!we},{concat:function(t){var e,n,r,i,o,a=_(this),s=tt(a,0),u=0;for(e=-1,r=arguments.length;e<r;e++)if(o=-1===e?a:arguments[e],Ee(o)){if(u+(i=k(o.length))>9007199254740991)throw TypeError("Maximum allowed index exceeded");for(n=0;n<i;n++,u++)n in o&&ye(s,u,o[n])}else{if(u>=9007199254740991)throw TypeError("Maximum allowed index exceeded");ye(s,u++,o)}return s.length=u,s}});var Se=$("toStringTag"),Te="Arguments"==w(function(){return arguments}()),_e={};_e[$("toStringTag")]="z";var Ie="[object z]"!==String(_e)?function(){return"[object "+(void 0===(t=this)?"Undefined":null===t?"Null":"string"==typeof(n=function(t,e){try{return t[e]}catch(t){}}(e=Object(t),Se))?n:Te?w(e):"Object"==(r=w(e))&&"function"==typeof e.callee?"Arguments":r)+"]";var t,e,n,r}:_e.toString,Ce=Object.prototype;Ie!==Ce.toString&&_t(Ce,"toString",Ie,{unsafe:!0});var De=U.f,Ae=$("toStringTag"),ke=function(t,e,n){t&&!st(t=n?t:t.prototype,Ae)&&De(t,Ae,{configurable:!0,value:e})},Ne={f:$},Me=U.f,Oe=function(t){var e=he.Symbol||(he.Symbol={});st(e,t)||Me(e,t,{value:Ne.f(t)})},Re=Mt.f,Pe={}.toString,Le="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],xe={f:function(t){return Le&&"[object Window]"==Pe.call(t)?function(t){try{return Re(t)}catch(t){return Le.slice()}}(t):Re(ot(t))}},Fe=pt("hidden"),qe=Tt.set,Be=Tt.getterFor("Symbol"),Ve=ct.f,Ue=U.f,je=xe.f,Ke=O.Symbol,Qe=O.JSON,ze=Qe&&Qe.stringify,Ge=$("toPrimitive"),We=it.f,He=z("symbol-registry"),Ye=z("symbols"),Xe=z("op-symbols"),Je=z("wks"),$e=Object.prototype,Ze=O.QObject,tn=!Ze||!Ze.prototype||!Ze.prototype.findChild,en=R&&v(function(){return 7!=$t(Ue({},"a",{get:function(){return Ue(this,"a",{value:7}).a}})).a})?function(t,e,n){var r=Ve($e,e);r&&delete $e[e],Ue(t,e,n),r&&t!==$e&&Ue($e,e,r)}:Ue,nn=function(t,e){var n=Ye[t]=$t(Ke.prototype);return qe(n,{type:"Symbol",tag:t,description:e}),R||(n.description=e),n},rn=Y&&"symbol"==typeof Ke.iterator?function(t){return"symbol"==typeof t}:function(t){return Object(t)instanceof Ke},on=function(t,e,n){return t===$e&&on(Xe,e,n),q(t),e=B(e,!0),q(n),st(Ye,e)?(n.enumerable?(st(t,Fe)&&t[Fe][e]&&(t[Fe][e]=!1),n=$t(n,{enumerable:j(0,!1)})):(st(t,Fe)||Ue(t,Fe,j(1,{})),t[Fe][e]=!0),en(t,e,n)):Ue(t,e,n)},an=function(t,e){q(t);for(var n,r=function(t){var e=zt(t),n=Ot.f;if(n)for(var r,i=n(t),o=it.f,a=0;i.length>a;)o.call(t,r=i[a++])&&e.push(r);return e}(e=ot(e)),i=0,o=r.length;o>i;)on(t,n=r[i++],e[n]);return t},sn=function(t){var e=We.call(this,t=B(t,!0));return!(this===$e&&st(Ye,t)&&!st(Xe,t))&&(!(e||!st(this,t)||!st(Ye,t)||st(this,Fe)&&this[Fe][t])||e)},un=function(t,e){if(t=ot(t),e=B(e,!0),t!==$e||!st(Ye,e)||st(Xe,e)){var n=Ve(t,e);return!n||!st(Ye,e)||st(t,Fe)&&t[Fe][e]||(n.enumerable=!0),n}},cn=function(t){for(var e,n=je(ot(t)),r=[],i=0;n.length>i;)st(Ye,e=n[i++])||st(mt,e)||r.push(e);return r},hn=function(t){for(var e,n=t===$e,r=je(n?Xe:ot(t)),i=[],o=0;r.length>o;)!st(Ye,e=r[o++])||n&&!st($e,e)||i.push(Ye[e]);return i};Y||(_t((Ke=function(){if(this instanceof Ke)throw TypeError("Symbol is not a constructor");var t=void 0===arguments[0]?void 0:String(arguments[0]),e=H(t),n=function(t){this===$e&&n.call(Xe,t),st(this,Fe)&&st(this[Fe],e)&&(this[Fe][e]=!1),en(this,e,j(1,t))};return R&&tn&&en($e,e,{configurable:!0,set:n}),nn(e,t)}).prototype,"toString",function(){return Be(this).tag}),it.f=sn,U.f=on,ct.f=un,Mt.f=xe.f=cn,Ot.f=hn,R&&(Ue(Ke.prototype,"description",{configurable:!0,get:function(){return Be(this).description}}),_t($e,"propertyIsEnumerable",sn,{unsafe:!0})),Ne.f=function(t){return nn($(t),t)}),Qt({global:!0,wrap:!0,forced:!Y,sham:!Y},{Symbol:Ke});for(var ln=zt(Je),fn=0;ln.length>fn;)Oe(ln[fn++]);Qt({target:"Symbol",stat:!0,forced:!Y},{for:function(t){return st(He,t+="")?He[t]:He[t]=Ke(t)},keyFor:function(t){if(!rn(t))throw TypeError(t+" is not a symbol");for(var e in He)if(He[e]===t)return e},useSetter:function(){tn=!0},useSimple:function(){tn=!1}}),Qt({target:"Object",stat:!0,forced:!Y,sham:!R},{create:function(t,e){return void 0===e?$t(t):an($t(t),e)},defineProperty:on,defineProperties:an,getOwnPropertyDescriptor:un}),Qt({target:"Object",stat:!0,forced:!Y},{getOwnPropertyNames:cn,getOwnPropertySymbols:hn}),Qe&&Qt({target:"JSON",stat:!0,forced:!Y||v(function(){var t=Ke();return"[null]"!=ze([t])||"{}"!=ze({a:t})||"{}"!=ze(Object(t))})},{stringify:function(t){for(var e,n,r=[t],i=1;arguments.length>i;)r.push(arguments[i++]);if(n=e=r[1],(N(e)||void 0!==t)&&!rn(t))return M(e)||(e=function(t,e){if("function"==typeof n&&(e=n.call(this,t,e)),!rn(e))return e}),r[1]=e,ze.apply(Qe,r)}}),Ke.prototype[Ge]||K(Ke.prototype,Ge,Ke.prototype.valueOf),ke(Ke,"Symbol"),mt[Fe]=!0,Oe("asyncIterator");var dn=U.f,pn=O.Symbol;if(R&&"function"==typeof pn&&(!("description"in pn.prototype)||void 0!==pn().description)){var mn={},yn=function(){var t=arguments.length<1||void 0===arguments[0]?void 0:String(arguments[0]),e=this instanceof yn?new pn(t):void 0===t?pn():pn(t);return""===t&&(mn[e]=!0),e};Lt(yn,pn);var gn=yn.prototype=pn.prototype;gn.constructor=yn;var vn=gn.toString,bn="Symbol(test)"==String(pn("test")),wn=/^Symbol\((.*)\)[^)]+$/;dn(gn,"description",{configurable:!0,get:function(){var t=N(this)?this.valueOf():this,e=vn.call(t);if(st(mn,t))return"";var n=bn?e.slice(7,-1):e.replace(wn,"$1");return""===n?void 0:n}}),Qt({global:!0,forced:!0},{Symbol:yn})}Oe("hasInstance"),Oe("isConcatSpreadable"),Oe("iterator"),Oe("match"),Oe("replace"),Oe("search"),Oe("species"),Oe("split"),Oe("toPrimitive"),Oe("toStringTag"),Oe("unscopables"),ke(Math,"Math",!0),ke(O.JSON,"JSON",!0);he.Symbol;Oe("dispose"),Oe("observable"),Oe("patternMatch");var En,Sn,Tn,_n=!v(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),In=pt("IE_PROTO"),Cn=Object.prototype,Dn=_n?Object.getPrototypeOf:function(t){return t=_(t),st(t,In)?t[In]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?Cn:null},An=$("iterator"),kn=!1;[].keys&&("next"in(Tn=[].keys())?(Sn=Dn(Dn(Tn)))!==Object.prototype&&(En=Sn):kn=!0),null==En&&(En={}),st(En,An)||K(En,An,function(){return this});var Nn={IteratorPrototype:En,BUGGY_SAFARI_ITERATORS:kn},Mn=Nn.IteratorPrototype,On=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,n={};try{(t=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(n,[]),e=n instanceof Array}catch(t){}return function(n,r){return function(t,e){if(q(t),!N(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype")}(n,r),e?t.call(n,r):n.__proto__=r,n}}():void 0),Rn=$("iterator"),Pn=Nn.IteratorPrototype,Ln=Nn.BUGGY_SAFARI_ITERATORS,xn=function(){return this},Fn=function(t,e,n,r,i,o,a){!function(t,e,n){var r=e+" Iterator";t.prototype=$t(Mn,{next:j(1,n)}),ke(t,r,!1)}(n,e,r);var s,u,c,h=function(t){if(t===i&&m)return m;if(!Ln&&t in d)return d[t];switch(t){case"keys":case"values":case"entries":return function(){return new n(this,t)}}return function(){return new n(this)}},l=e+" Iterator",f=!1,d=t.prototype,p=d[Rn]||d["@@iterator"]||i&&d[i],m=!Ln&&p||h(i),y="Array"==e&&d.entries||p;if(y&&(s=Dn(y.call(new t)),Pn!==Object.prototype&&s.next&&(Dn(s)!==Pn&&(On?On(s,Pn):"function"!=typeof s[Rn]&&K(s,Rn,xn)),ke(s,l,!0))),"values"==i&&p&&"values"!==p.name&&(f=!0,m=function(){return p.call(this)}),d[Rn]!==m&&K(d,Rn,m),i)if(u={values:h("values"),keys:o?m:h("keys"),entries:h("entries")},a)for(c in u)!Ln&&!f&&c in d||_t(d,c,u[c]);else Qt({target:e,proto:!0,forced:Ln||f},u);return u},qn=Tt.set,Bn=Tt.getterFor("String Iterator");Fn(String,"String",function(t){qn(this,{type:"String Iterator",string:String(t),index:0})},function(){var t,e,n,r,i,o,a,s,u=Bn(this),c=u.string,h=u.index;return h>=c.length?{value:void 0,done:!0}:(e=h,n=!0,o=String(T(c)),a=D(e),s=o.length,t=a<0||a>=s?n?"":void 0:(r=o.charCodeAt(a))<55296||r>56319||a+1===s||(i=o.charCodeAt(a+1))<56320||i>57343?n?o.charAt(a):r:n?o.slice(a,a+2):i-56320+(r-55296<<10)+65536,u.index+=t.length,{value:t,done:!1})});var Vn={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Un=Tt.set,jn=Tt.getterFor("Array Iterator"),Kn=Fn(Array,"Array",function(t,e){Un(this,{type:"Array Iterator",target:ot(t),index:0,kind:e})},function(){var t=jn(this),e=t.target,n=t.kind,r=t.index++;return!e||r>=e.length?(t.target=void 0,{value:void 0,done:!0}):"keys"==n?{value:r,done:!1}:"values"==n?{value:e[r],done:!1}:{value:[r,e[r]],done:!1}},"values");ee("keys"),ee("values"),ee("entries");var Qn=$("iterator"),zn=$("toStringTag"),Gn=Kn.values;for(var Wn in Vn){var Hn=O[Wn],Yn=Hn&&Hn.prototype;if(Yn){if(Yn[Qn]!==Gn)try{K(Yn,Qn,Gn)}catch(pr){Yn[Qn]=Gn}if(Yn[zn]||K(Yn,zn,Wn),Vn[Wn])for(var Xn in Kn)if(Yn[Xn]!==Kn[Xn])try{K(Yn,Xn,Kn[Xn])}catch(pr){Yn[Xn]=Kn[Xn]}}}Ne.f("iterator");var Jn=function(t,e){return(Jn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function $n(t,e){function n(){this.constructor=t}Jn(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var Zn=function(){return(Zn=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function tr(t,e,n,r){return new(n||(n=Promise))(function(i,o){function a(t){try{u(r.next(t))}catch(t){o(t)}}function s(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(a,s)}u((r=r.apply(t,e||[])).next())})}function er(t,e){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function nr(t,e){if(!(e instanceof Object))return e;switch(e.constructor){case Date:return new Date(e.getTime());case Object:void 0===t&&(t={});break;case Array:t=[];break;default:return e}for(var n in e)e.hasOwnProperty(n)&&(t[n]=nr(t[n],e[n]));return t}function rr(t,e,n){t[e]=n}var ir="FirebaseError",or=function(t){function e(n,r){var i=t.call(this,r)||this;return i.code=n,i.name=ir,Object.setPrototypeOf(i,e.prototype),Error.captureStackTrace&&Error.captureStackTrace(i,ar.prototype.create),i}return $n(e,t),e}(Error),ar=function(){function t(t,e,n){this.service=t,this.serviceName=e,this.errors=n}return t.prototype.create=function(t,e){void 0===e&&(e={});for(var n=this.service+"/"+t,r=this.errors[t],i=r?function(t,e){return t.replace(sr,function(t,n){var r=e[n];return null!=r?r.toString():"<"+n+"?>"})}(r,e):"Error",o=this.serviceName+": "+i+" ("+n+").",a=new or(n,o),s=0,u=Object.keys(e);s<u.length;s++){var c=u[s];"_"!==c.slice(-1)&&(c in a&&console.warn('Overwriting FirebaseError base field "'+c+'" can cause unexpected behavior.'),a[c]=e[c])}return a},t}();var sr=/\{\$([^}]+)}/g;function ur(t,e){var n=new hr(t,e);return n.subscribe.bind(n)}var cr,hr=function(){function t(t,e){var n=this;this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=e,this.task.then(function(){t(n)}).catch(function(t){n.error(t)})}return t.prototype.next=function(t){this.forEachObserver(function(e){e.next(t)})},t.prototype.error=function(t){this.forEachObserver(function(e){e.error(t)}),this.close(t)},t.prototype.complete=function(){this.forEachObserver(function(t){t.complete()}),this.close()},t.prototype.subscribe=function(t,e,n){var r,i=this;if(void 0===t&&void 0===e&&void 0===n)throw new Error("Missing Observer.");void 0===(r=function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=0,r=e;n<r.length;n++){var i=r[n];if(i in t&&"function"==typeof t[i])return!0}return!1}(t,["next","error","complete"])?t:{next:t,error:e,complete:n}).next&&(r.next=lr),void 0===r.error&&(r.error=lr),void 0===r.complete&&(r.complete=lr);var o=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(function(){try{i.finalError?r.error(i.finalError):r.complete()}catch(t){}}),this.observers.push(r),o},t.prototype.unsubscribeOne=function(t){void 0!==this.observers&&void 0!==this.observers[t]&&(delete this.observers[t],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))},t.prototype.forEachObserver=function(t){if(!this.finalized)for(var e=0;e<this.observers.length;e++)this.sendOne(e,t)},t.prototype.sendOne=function(t,e){var n=this;this.task.then(function(){if(void 0!==n.observers&&void 0!==n.observers[t])try{e(n.observers[t])}catch(t){"undefined"!=typeof console&&console.error&&console.error(t)}})},t.prototype.close=function(t){var e=this;this.finalized||(this.finalized=!0,void 0!==t&&(this.finalError=t),this.task.then(function(){e.observers=void 0,e.onNoObservers=void 0}))},t}();function lr(){}var fr=((cr={})["no-app"]="No Firebase App '{$name}' has been created - call Firebase App.initializeApp()",cr["bad-app-name"]="Illegal App name: '{$name}",cr["duplicate-app"]="Firebase App named '{$name}' already exists",cr["app-deleted"]="Firebase App named '{$name}' already deleted",cr["duplicate-service"]="Firebase service named '{$name}' already registered",cr["invalid-app-argument"]="firebase.{$name}() takes either no argument or a Firebase App instance.",cr),dr=new ar("app","Firebase",fr);function pr(t,e){throw dr.create(t,e)}var mr="[DEFAULT]",yr=[],gr=function(){function t(t,e,n){this.firebase_=n,this.isDeleted_=!1,this.services_={},this.name_=e.name,this.automaticDataCollectionEnabled_=e.automaticDataCollectionEnabled||!1,this.options_=nr(void 0,t),this.INTERNAL={getUid:function(){return null},getToken:function(){return Promise.resolve(null)},addAuthTokenListener:function(t){yr.push(t),setTimeout(function(){return t(null)},0)},removeAuthTokenListener:function(t){yr=yr.filter(function(e){return e!==t})}}}return Object.defineProperty(t.prototype,"automaticDataCollectionEnabled",{get:function(){return this.checkDestroyed_(),this.automaticDataCollectionEnabled_},set:function(t){this.checkDestroyed_(),this.automaticDataCollectionEnabled_=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this.checkDestroyed_(),this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this.checkDestroyed_(),this.options_},enumerable:!0,configurable:!0}),t.prototype.delete=function(){var t=this;return new Promise(function(e){t.checkDestroyed_(),e()}).then(function(){t.firebase_.INTERNAL.removeApp(t.name_);for(var e=[],n=0,r=Object.keys(t.services_);n<r.length;n++)for(var i=r[n],o=0,a=Object.keys(t.services_[i]);o<a.length;o++){var s=a[o];e.push(t.services_[i][s])}return Promise.all(e.map(function(t){return t.INTERNAL.delete()}))}).then(function(){t.isDeleted_=!0,t.services_={}})},t.prototype._getService=function(t,e){if(void 0===e&&(e=mr),this.checkDestroyed_(),this.services_[t]||(this.services_[t]={}),!this.services_[t][e]){var n=e!==mr?e:void 0,r=this.firebase_.INTERNAL.factories[t](this,this.extendApp.bind(this),n);this.services_[t][e]=r}return this.services_[t][e]},t.prototype.extendApp=function(t){var e=this;nr(this,t),t.INTERNAL&&t.INTERNAL.addAuthTokenListener&&(yr.forEach(function(t){e.INTERNAL.addAuthTokenListener(t)}),yr=[])},t.prototype.checkDestroyed_=function(){this.isDeleted_&&pr("app-deleted",{name:this.name_})},t}();function vr(t,e){return Object.prototype.hasOwnProperty.call(t,e)}gr.prototype.name&&gr.prototype.options||gr.prototype.delete||console.log("dc");var br=!1;try{br="[object process]"===Object.prototype.toString.call(global.process)}catch(t){}if(br&&console.warn('\nWarning: This is a browser-targeted Firebase bundle but it appears it is being\nrun in a Node environment.  If running in a Node environment, make sure you\nare using the bundle specified by the "main" field in package.json.\n\nIf you are using Webpack, you can specify "main" as the first item in\n"resolve.mainFields":\nhttps://webpack.js.org/configuration/resolve/#resolvemainfields\n\nIf using Rollup, use the rollup-plugin-node-resolve plugin and set "module"\nto false and "main" to true:\nhttps://github.com/rollup/rollup-plugin-node-resolve\n'),self&&"firebase"in self){console.warn("\n    Warning: Firebase is already defined in the global scope. Please make sure\n    Firebase library is only loaded once.\n  ");var wr=self.firebase.SDK_VERSION;wr&&wr.indexOf("LITE")>=0&&console.warn("\n    Warning: You are trying to load Firebase while using Firebase Performance standalone script.\n    You should load Firebase Performance with this instance of Firebase to avoid loading duplicate code.\n    ")}var Er,Sr=function t(){var e=function(t){var e={},n={},r={},i={__esModule:!0,initializeApp:function(n,r){if(void 0===r&&(r={}),"object"!=typeof r||null===r){var o=r;r={name:o}}var a=r;void 0===a.name&&(a.name=mr);var u=a.name;"string"==typeof u&&u||pr("bad-app-name",{name:String(u)}),vr(e,u)&&pr("duplicate-app",{name:u});var c=new t(n,a,i);return e[u]=c,s(c,"create"),c},app:o,apps:null,Promise:Promise,SDK_VERSION:"5.11.0",INTERNAL:{registerService:function(e,s,u,c,h){function l(t){return void 0===t&&(t=o()),"function"!=typeof t[e]&&pr("invalid-app-argument",{name:e}),t[e]()}return void 0===h&&(h=!1),n[e]&&pr("duplicate-service",{name:e}),n[e]=s,c&&(r[e]=c,a().forEach(function(t){c("create",t)})),void 0!==u&&nr(l,u),i[e]=l,t.prototype[e]=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this._getService.bind(this,e).apply(this,h?t:[])},l},removeApp:function(t){s(e[t],"delete"),delete e[t]},factories:n,useAsService:u}};function o(t){return vr(e,t=t||mr)||pr("no-app",{name:t}),e[t]}function a(){return Object.keys(e).map(function(t){return e[t]})}function s(t,e){for(var i=0,o=Object.keys(n);i<o.length;i++){var a=u(t,o[i]);if(null===a)return;r[a]&&r[a](e,t)}}function u(t,e){if("serverAuth"===e)return null;var n=e;return t.options,n}return rr(i,"default",i),Object.defineProperty(i,"apps",{get:a}),rr(o,"App",t),i}(gr);return e.INTERNAL=Zn({},e.INTERNAL,{createFirebaseNamespace:t,extendNamespace:function(t){nr(e,t)},createSubscribe:ur,ErrorFactory:ar,deepExtend:nr}),e}();!function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"}(Er||(Er={}));var Tr,_r=Er.INFO,Ir=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(e<t.logLevel)){var i=(new Date).toISOString();switch(e){case Er.DEBUG:case Er.VERBOSE:console.log.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case Er.INFO:console.info.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case Er.WARN:console.warn.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case Er.ERROR:console.error.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+e+")")}}},Cr=function(){function t(t){this.name=t,this._logLevel=_r,this._logHandler=Ir}return Object.defineProperty(t.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in Er))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!0,configurable:!0}),t.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,Er.DEBUG].concat(t))},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,Er.VERBOSE].concat(t))},t.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,Er.INFO].concat(t))},t.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,Er.WARN].concat(t))},t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,Er.ERROR].concat(t))},t}(),Dr="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Ar=Ar||{},kr=Dr;function Nr(t){return"string"==typeof t}function Mr(t){return"number"==typeof t}function Or(t,e){t=t.split("."),e=e||kr;for(var n=0;n<t.length;n++)if(null==(e=e[t[n]]))return null;return e}function Rr(){}function Pr(t){var e=typeof t;if("object"==e){if(!t)return"null";if(t instanceof Array)return"array";if(t instanceof Object)return e;var n=Object.prototype.toString.call(t);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof t.length&&void 0!==t.splice&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==t.call&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("call"))return"function"}else if("function"==e&&void 0===t.call)return"object";return e}function Lr(t){return"array"==Pr(t)}function xr(t){var e=Pr(t);return"array"==e||"object"==e&&"number"==typeof t.length}function Fr(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var qr="closure_uid_"+(1e9*Math.random()>>>0),Br=0;function Vr(t,e,n){return t.call.apply(t.bind,arguments)}function Ur(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function jr(t,e,n){return(jr=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?Vr:Ur).apply(null,arguments)}function Kr(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}var Qr=Date.now||function(){return+new Date};function zr(t,e){function n(){}n.prototype=e.prototype,t.N=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.yb=function(t,n,r){for(var i=Array(arguments.length-2),o=2;o<arguments.length;o++)i[o-2]=arguments[o];return e.prototype[n].apply(t,i)}}function Gr(){this.j=this.j,this.i=this.i}Gr.prototype.j=!1,Gr.prototype.la=function(){if(!this.j&&(this.j=!0,this.G(),0))this[qr]||(this[qr]=++Br)},Gr.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var Wr=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if(Nr(t))return Nr(e)&&1==e.length?t.indexOf(e,0):-1;for(var n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},Hr=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){for(var r=t.length,i=Nr(t)?t.split(""):t,o=0;o<r;o++)o in i&&e.call(n,i[o],o,t)};function Yr(t){return Array.prototype.concat.apply([],arguments)}function Xr(t){var e=t.length;if(0<e){for(var n=Array(e),r=0;r<e;r++)n[r]=t[r];return n}return[]}function Jr(t){return/^[\s\xa0]*$/.test(t)}var $r,Zr=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function ti(t,e){return-1!=t.indexOf(e)}function ei(t,e){return t<e?-1:t>e?1:0}t:{var ni=kr.navigator;if(ni){var ri=ni.userAgent;if(ri){$r=ri;break t}}$r=""}function ii(t,e,n){for(var r in t)e.call(n,t[r],r,t)}function oi(t){var e,n={};for(e in t)n[e]=t[e];return n}var ai="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function si(t,e){for(var n,r,i=1;i<arguments.length;i++){for(n in r=arguments[i])t[n]=r[n];for(var o=0;o<ai.length;o++)n=ai[o],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function ui(t){return ui[" "](t),t}ui[" "]=Rr;var ci,hi,li=ti($r,"Opera"),fi=ti($r,"Trident")||ti($r,"MSIE"),di=ti($r,"Edge"),pi=di||fi,mi=ti($r,"Gecko")&&!(ti($r.toLowerCase(),"webkit")&&!ti($r,"Edge"))&&!(ti($r,"Trident")||ti($r,"MSIE"))&&!ti($r,"Edge"),yi=ti($r.toLowerCase(),"webkit")&&!ti($r,"Edge");function gi(){var t=kr.document;return t?t.documentMode:void 0}t:{var vi="",bi=(hi=$r,mi?/rv:([^\);]+)(\)|;)/.exec(hi):di?/Edge\/([\d\.]+)/.exec(hi):fi?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(hi):yi?/WebKit\/(\S+)/.exec(hi):li?/(?:Version)[ \/]?(\S+)/.exec(hi):void 0);if(bi&&(vi=bi?bi[1]:""),fi){var wi=gi();if(null!=wi&&wi>parseFloat(vi)){ci=String(wi);break t}}ci=vi}var Ei,Si={};function Ti(t){return function(t,e){var n=Si;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:n[t]=e(t)}(t,function(){for(var e=0,n=Zr(String(ci)).split("."),r=Zr(String(t)).split("."),i=Math.max(n.length,r.length),o=0;0==e&&o<i;o++){var a=n[o]||"",s=r[o]||"";do{if(a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==a[0].length&&0==s[0].length)break;e=ei(0==a[1].length?0:parseInt(a[1],10),0==s[1].length?0:parseInt(s[1],10))||ei(0==a[2].length,0==s[2].length)||ei(a[2],s[2]),a=a[3],s=s[3]}while(0==e)}return 0<=e})}var _i=kr.document;Ei=_i&&fi?gi()||("CSS1Compat"==_i.compatMode?parseInt(ci,10):5):void 0;var Ii=!fi||9<=Number(Ei),Ci=fi&&!Ti("9"),Di=function(){if(!kr.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{kr.addEventListener("test",Rr,e),kr.removeEventListener("test",Rr,e)}catch(t){}return t}();function Ai(t,e){this.type=t,this.a=this.target=e,this.Ja=!0}function ki(t,e){if(Ai.call(this,t?t.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.a=e,e=t.relatedTarget){if(mi){t:{try{ui(e.nodeName);var i=!0;break t}catch(t){}i=!1}i||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType=Nr(t.pointerType)?t.pointerType:Ni[t.pointerType]||"",this.c=t,t.defaultPrevented&&this.b()}}Ai.prototype.b=function(){this.Ja=!1},zr(ki,Ai);var Ni={2:"touch",3:"pen",4:"mouse"};ki.prototype.b=function(){ki.N.b.call(this);var t=this.c;if(t.preventDefault)t.preventDefault();else if(t.returnValue=!1,Ci)try{(t.ctrlKey||112<=t.keyCode&&123>=t.keyCode)&&(t.keyCode=-1)}catch(t){}};var Mi="closure_listenable_"+(1e6*Math.random()|0),Oi=0;function Ri(t,e,n,r,i){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.da=i,this.key=++Oi,this.X=this.Z=!1}function Pi(t){t.X=!0,t.listener=null,t.proxy=null,t.src=null,t.da=null}function Li(t){this.src=t,this.a={},this.b=0}function xi(t,e){var n=e.type;if(n in t.a){var r,i=t.a[n],o=Wr(i,e);(r=0<=o)&&Array.prototype.splice.call(i,o,1),r&&(Pi(e),0==t.a[n].length&&(delete t.a[n],t.b--))}}function Fi(t,e,n,r){for(var i=0;i<t.length;++i){var o=t[i];if(!o.X&&o.listener==e&&o.capture==!!n&&o.da==r)return i}return-1}Li.prototype.add=function(t,e,n,r,i){var o=t.toString();(t=this.a[o])||(t=this.a[o]=[],this.b++);var a=Fi(t,e,r,i);return-1<a?(e=t[a],n||(e.Z=!1)):((e=new Ri(e,this.src,o,!!r,i)).Z=n,t.push(e)),e};var qi="closure_lm_"+(1e6*Math.random()|0),Bi={};function Vi(t,e,n,r,i){if(r&&r.once)return function t(e,n,r,i,o){if(Lr(n)){for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);return null}r=Hi(r);return e&&e[Mi]?e.Ba(n,r,Fr(i)?!!i.capture:!!i,o):Ui(e,n,r,!0,i,o)}(t,e,n,r,i);if(Lr(e)){for(var o=0;o<e.length;o++)Vi(t,e[o],n,r,i);return null}return n=Hi(n),t&&t[Mi]?t.Aa(e,n,Fr(r)?!!r.capture:!!r,i):Ui(t,e,n,!1,r,i)}function Ui(t,e,n,r,i,o){if(!e)throw Error("Invalid event type");var a=Fr(i)?!!i.capture:!!i;if(a&&!Ii)return null;var s=Gi(t);if(s||(t[qi]=s=new Li(t)),(n=s.add(e,n,r,a,o)).proxy)return n;if(r=function(){var t=zi,e=Ii?function(n){return t.call(e.src,e.listener,n)}:function(n){if(!(n=t.call(e.src,e.listener,n)))return n};return e}(),n.proxy=r,r.src=t,r.listener=n,t.addEventListener)Di||(i=a),void 0===i&&(i=!1),t.addEventListener(e.toString(),r,i);else if(t.attachEvent)t.attachEvent(Ki(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function ji(t){if(!Mr(t)&&t&&!t.X){var e=t.src;if(e&&e[Mi])xi(e.c,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Ki(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=Gi(e))?(xi(n,t),0==n.b&&(n.src=null,e[qi]=null)):Pi(t)}}}function Ki(t){return t in Bi?Bi[t]:Bi[t]="on"+t}function Qi(t,e){var n=t.listener,r=t.da||t.src;return t.Z&&ji(t),n.call(r,e)}function zi(t,e){return!!t.X||(Ii?Qi(t,new ki(e,this)):Qi(t,e=new ki(e||Or("window.event"),this)))}function Gi(t){return(t=t[qi])instanceof Li?t:null}var Wi="__closure_events_fn_"+(1e9*Math.random()>>>0);function Hi(t){return"function"==Pr(t)?t:(t[Wi]||(t[Wi]=function(e){return t.handleEvent(e)}),t[Wi])}function Yi(){Gr.call(this),this.c=new Li(this),this.J=this,this.B=null}function Xi(t,e,n,r){if(!(e=t.c.a[String(e)]))return!0;e=e.concat();for(var i=!0,o=0;o<e.length;++o){var a=e[o];if(a&&!a.X&&a.capture==n){var s=a.listener,u=a.da||a.src;a.Z&&xi(t.c,a),i=!1!==s.call(u,r)&&i}}return i&&0!=r.Ja}zr(Yi,Gr),Yi.prototype[Mi]=!0,(Tr=Yi.prototype).addEventListener=function(t,e,n,r){Vi(this,t,e,n,r)},Tr.removeEventListener=function(t,e,n,r){!function t(e,n,r,i,o){if(Lr(n))for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);else i=Fr(i)?!!i.capture:!!i,r=Hi(r),e&&e[Mi]?(e=e.c,(n=String(n).toString())in e.a&&-1<(r=Fi(a=e.a[n],r,i,o))&&(Pi(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete e.a[n],e.b--))):e&&(e=Gi(e))&&(n=e.a[n.toString()],e=-1,n&&(e=Fi(n,r,i,o)),(r=-1<e?n[e]:null)&&ji(r))}(this,t,e,n,r)},Tr.dispatchEvent=function(t){var e,n=this.B;if(n)for(e=[];n;n=n.B)e.push(n);n=this.J;var r=t.type||t;if(Nr(t))t=new Ai(t,n);else if(t instanceof Ai)t.target=t.target||n;else{var i=t;si(t=new Ai(r,n),i)}if(i=!0,e)for(var o=e.length-1;0<=o;o--){var a=t.a=e[o];i=Xi(a,r,!0,t)&&i}if(i=Xi(a=t.a=n,r,!0,t)&&i,i=Xi(a,r,!1,t)&&i,e)for(o=0;o<e.length;o++)i=Xi(a=t.a=e[o],r,!1,t)&&i;return i},Tr.G=function(){if(Yi.N.G.call(this),this.c){var t,e=this.c;for(t in e.a){for(var n=e.a[t],r=0;r<n.length;r++)Pi(n[r]);delete e.a[t],e.b--}}this.B=null},Tr.Aa=function(t,e,n,r){return this.c.add(String(t),e,!1,n,r)},Tr.Ba=function(t,e,n,r){return this.c.add(String(t),e,!0,n,r)};var Ji=kr.JSON.stringify;function $i(t,e){this.c=t,this.f=e,this.b=0,this.a=null}function Zi(){this.b=this.a=null}$i.prototype.get=function(){if(0<this.b){this.b--;var t=this.a;this.a=t.next,t.next=null}else t=this.c();return t};var to,eo=new $i(function(){return new ro},function(t){t.reset()});function no(){var t=so,e=null;return t.a&&(e=t.a,t.a=t.a.next,t.a||(t.b=null),e.next=null),e}function ro(){this.next=this.b=this.a=null}function io(t){kr.setTimeout(function(){throw t},0)}function oo(t,e){to||function(){var t=kr.Promise.resolve(void 0);to=function(){t.then(uo)}}(),ao||(to(),ao=!0),so.add(t,e)}Zi.prototype.add=function(t,e){var n=eo.get();n.set(t,e),this.b?this.b.next=n:this.a=n,this.b=n},ro.prototype.set=function(t,e){this.a=t,this.b=e,this.next=null},ro.prototype.reset=function(){this.next=this.b=this.a=null};var ao=!1,so=new Zi;function uo(){for(var t;t=no();){try{t.a.call(t.b)}catch(t){io(t)}var e=eo;e.f(t),100>e.b&&(e.b++,t.next=e.a,e.a=t)}ao=!1}function co(t,e){Yi.call(this),this.b=t||1,this.a=e||kr,this.f=jr(this.gb,this),this.g=Qr()}function ho(t){t.ba=!1,t.L&&(t.a.clearTimeout(t.L),t.L=null)}function lo(t,e,n){if("function"==Pr(t))n&&(t=jr(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=jr(t.handleEvent,t)}return 2147483647<Number(e)?-1:kr.setTimeout(t,e||0)}function fo(t,e,n){Gr.call(this),this.f=null!=n?jr(t,n):t,this.c=e,this.b=jr(this.ab,this),this.a=[]}function po(t){t.U=lo(t.b,t.c),t.f.apply(null,t.a)}function mo(t){Gr.call(this),this.b=t,this.a={}}zr(co,Yi),(Tr=co.prototype).ba=!1,Tr.L=null,Tr.gb=function(){if(this.ba){var t=Qr()-this.g;0<t&&t<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-t):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(ho(this),this.start()))}},Tr.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=Qr())},Tr.G=function(){co.N.G.call(this),ho(this),delete this.a},zr(fo,Gr),(Tr=fo.prototype).ea=!1,Tr.U=null,Tr.Ua=function(t){this.a=arguments,this.U?this.ea=!0:po(this)},Tr.G=function(){fo.N.G.call(this),this.U&&(kr.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},Tr.ab=function(){this.U=null,this.ea&&(this.ea=!1,po(this))},zr(mo,Gr);var yo=[];function go(t,e,n,r){Lr(n)||(n&&(yo[0]=n.toString()),n=yo);for(var i=0;i<n.length;i++){var o=Vi(e,n[i],r||t.handleEvent,!1,t.b||t);if(!o)break;t.a[o.key]=o}}function vo(t){ii(t.a,function(t,e){this.a.hasOwnProperty(e)&&ji(t)},t),t.a={}}function bo(){}mo.prototype.G=function(){mo.N.G.call(this),vo(this)},mo.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var wo=new Yi;function Eo(t){Ai.call(this,"serverreachability",t)}function So(t){wo.dispatchEvent(new Eo(wo,t))}function To(t){Ai.call(this,"statevent",t)}function _o(t){wo.dispatchEvent(new To(wo,t))}function Io(t){Ai.call(this,"timingevent",t)}function Co(t,e){if("function"!=Pr(t))throw Error("Fn must not be null and must be a function");return kr.setTimeout(function(){t()},e)}zr(Eo,Ai),zr(To,Ai),zr(Io,Ai);var Do={NO_ERROR:0,hb:1,ob:2,nb:3,kb:4,mb:5,pb:6,Ma:7,TIMEOUT:8,sb:9},Ao={jb:"complete",wb:"success",Na:"error",Ma:"abort",ub:"ready",vb:"readystatechange",TIMEOUT:"timeout",qb:"incrementaldata",tb:"progress",lb:"downloadprogress",xb:"uploadprogress"};function ko(){}function No(t){var e;return(e=t.a)||(e=t.a={}),e}function Mo(){}ko.prototype.a=null;var Oo,Ro={OPEN:"a",ib:"b",Na:"c",rb:"d"};function Po(){Ai.call(this,"d")}function Lo(){Ai.call(this,"c")}function xo(){}function Fo(t,e,n){this.g=t,this.W=e,this.V=n||1,this.I=new mo(this),this.O=qo,t=pi?125:void 0,this.P=new co(t),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}zr(Po,Ai),zr(Lo,Ai),zr(xo,ko),Oo=new xo;var qo=45e3,Bo={},Vo={};function Uo(t,e,n){t.F=1,t.f=fa(oa(e)),t.l=n,t.H=!0,Ko(t,null)}function jo(t,e,n,r){t.F=1,t.f=fa(oa(e)),t.l=null,t.H=n,Ko(t,r)}function Ko(t,e){t.v=Qr(),Go(t),t.D=oa(t.f),la(t.D,"t",t.V),t.A=0,t.a=t.g.$(t.g.Y()?e:null),0<t.J&&(t.B=new fo(jr(t.Ka,t,t.a),t.J)),go(t.I,t.a,"readystatechange",t.eb),e=t.h?oi(t.h):{},t.l?(t.w||(t.w="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.a.ca(t.D,t.w,t.l,e)):(t.w="GET",t.a.ca(t.D,t.w,null,e)),So(1)}function Qo(t,e,n){for(var r=!0;!t.m&&t.A<n.length;){var i=zo(t,n);if(i==Vo){4==e&&(t.c=4,_o(14),r=!1);break}if(i==Bo){t.c=4,_o(15),r=!1;break}Jo(t,i)}4==e&&0==n.length&&(t.c=1,_o(16),r=!1),t.b=t.b&&r,r||(Xo(t),Yo(t))}function zo(t,e){var n=t.A,r=e.indexOf("\n",n);return-1==r?Vo:(n=Number(e.substring(n,r)),isNaN(n)?Bo:(r+=1)+n>e.length?Vo:(e=e.substr(r,n),t.A=r+n,e))}function Go(t){t.R=Qr()+t.O,Wo(t,t.O)}function Wo(t,e){if(null!=t.i)throw Error("WatchDog timer not null");t.i=Co(jr(t.bb,t),e)}function Ho(t){t.i&&(kr.clearTimeout(t.i),t.i=null)}function Yo(t){t.g.Da()||t.m||t.g.na(t)}function Xo(t){Ho(t);var e=t.B;e&&"function"==typeof e.la&&e.la(),t.B=null,ho(t.P),vo(t.I),t.a&&(e=t.a,t.a=null,e.abort(),e.la())}function Jo(t,e){try{t.g.Ga(t,e),So(4)}catch(t){}}function $o(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(xr(t)||Nr(t))Hr(t,e,void 0);else{if(t.K&&"function"==typeof t.K)var n=t.K();else if(t.C&&"function"==typeof t.C)n=void 0;else if(xr(t)||Nr(t)){n=[];for(var r=t.length,i=0;i<r;i++)n.push(i)}else for(i in n=[],r=0,t)n[r++]=i;i=(r=function(t){if(t.C&&"function"==typeof t.C)return t.C();if(Nr(t))return t.split("");if(xr(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length;for(var o=0;o<i;o++)e.call(void 0,r[o],n&&n[o],t)}}function Zo(t,e){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof Zo)for(n=t.K(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function ta(t,e){na(t.b,e)&&(delete t.b[e],t.c--,t.a.length>2*t.c&&ea(t))}function ea(t){if(t.c!=t.a.length){for(var e=0,n=0;e<t.a.length;){var r=t.a[e];na(t.b,r)&&(t.a[n++]=r),e++}t.a.length=n}if(t.c!=t.a.length){var i={};for(n=e=0;e<t.a.length;)na(i,r=t.a[e])||(t.a[n++]=r,i[r]=1),e++;t.a.length=n}}function na(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(Tr=Fo.prototype).setTimeout=function(t){this.O=t},Tr.eb=function(t){t=t.target;var e=this.B;e&&3==is(t)?e.Ua():this.Ka(t)},Tr.Ka=function(t){try{if(t==this.a)t:{var e=is(this.a),n=this.a.ya(),r=this.a.T();if(!(3>e||3==e&&!pi&&!this.a.aa())){this.m||4!=e||7==n||So(8==n||0>=r?3:2),Ho(this);var i=this.a.T();this.o=i;var o=this.a.aa();if(this.b=200==i){if(this.S&&!this.s){e:{if(this.a){var a=os(this.a,"X-HTTP-Initial-Response");if(a&&!Jr(a)){var s=a;break e}}s=null}if(!s){this.b=!1,this.c=3,_o(12),Xo(this),Yo(this);break t}this.s=!0,Jo(this,s)}this.H?(Qo(this,e,o),pi&&this.b&&3==e&&(go(this.I,this.P,"tick",this.cb),this.P.start())):Jo(this,o),4==e&&Xo(this),this.b&&!this.m&&(4==e?this.g.na(this):(this.b=!1,Go(this)))}else 400==i&&0<o.indexOf("Unknown SID")?(this.c=3,_o(12)):(this.c=0,_o(13)),Xo(this),Yo(this)}}}catch(t){}},Tr.cb=function(){if(this.a){var t=is(this.a),e=this.a.aa();this.A<e.length&&(Ho(this),Qo(this,t,e),this.b&&4!=t&&Go(this))}},Tr.cancel=function(){this.m=!0,Xo(this)},Tr.bb=function(){this.i=null;var t=Qr();0<=t-this.R?(2!=this.F&&(So(3),_o(17)),Xo(this),this.c=2,Yo(this)):Wo(this,this.R-t)},(Tr=Zo.prototype).C=function(){ea(this);for(var t=[],e=0;e<this.a.length;e++)t.push(this.b[this.a[e]]);return t},Tr.K=function(){return ea(this),this.a.concat()},Tr.get=function(t,e){return na(this.b,t)?this.b[t]:e},Tr.set=function(t,e){na(this.b,t)||(this.c++,this.a.push(t)),this.b[t]=e},Tr.forEach=function(t,e){for(var n=this.K(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);t.call(e,o,i,this)}};var ra=/^(?:([^:\/?#.]+):)?(?:\/\/(?:([^\/?#]*)@)?([^\/#?]*?)(?::([0-9]+))?(?=[\/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function ia(t,e){var n;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,t instanceof ia?(this.h=void 0!==e?e:t.h,aa(this,t.f),this.j=t.j,sa(this,t.b),ua(this,t.i),this.a=t.a,ca(this,Ca(t.c)),this.g=t.g):t&&(n=String(t).match(ra))?(this.h=!!e,aa(this,n[1]||"",!0),this.j=da(n[2]||""),sa(this,n[3]||"",!0),ua(this,n[4]),this.a=da(n[5]||"",!0),ca(this,n[6]||"",!0),this.g=da(n[7]||"")):(this.h=!!e,this.c=new Ea(null,this.h))}function oa(t){return new ia(t)}function aa(t,e,n){t.f=n?da(e,!0):e,t.f&&(t.f=t.f.replace(/:$/,""))}function sa(t,e,n){t.b=n?da(e,!0):e}function ua(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.i=e}else t.i=null}function ca(t,e,n){e instanceof Ea?(t.c=e,function(t,e){e&&!t.f&&(Sa(t),t.c=null,t.a.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(Ta(this,e),Ia(this,n,t))},t)),t.f=e}(t.c,t.h)):(n||(e=pa(e,ba)),t.c=new Ea(e,t.h))}function ha(t,e,n){t.c.set(e,n)}function la(t,e,n){Lr(n)||(n=[String(n)]),Ia(t.c,e,n)}function fa(t){return ha(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Qr()).toString(36)),t}function da(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function pa(t,e,n){return Nr(t)?(t=encodeURI(t).replace(e,ma),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function ma(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}ia.prototype.toString=function(){var t=[],e=this.f;e&&t.push(pa(e,ya,!0),":");var n=this.b;return(n||"file"==e)&&(t.push("//"),(e=this.j)&&t.push(pa(e,ya,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.i)&&t.push(":",String(n))),(n=this.a)&&(this.b&&"/"!=n.charAt(0)&&t.push("/"),t.push(pa(n,"/"==n.charAt(0)?va:ga,!0))),(n=this.c.toString())&&t.push("?",n),(n=this.g)&&t.push("#",pa(n,wa)),t.join("")},ia.prototype.resolve=function(t){var e=oa(this),n=!!t.f;n?aa(e,t.f):n=!!t.j,n?e.j=t.j:n=!!t.b,n?sa(e,t.b):n=null!=t.i;var r=t.a;if(n)ua(e,t.i);else if(n=!!t.a){if("/"!=r.charAt(0))if(this.b&&!this.a)r="/"+r;else{var i=e.a.lastIndexOf("/");-1!=i&&(r=e.a.substr(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(ti(i,"./")||ti(i,"/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");for(var o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i}return n?e.a=r:n=""!==t.c.toString(),n?ca(e,Ca(t.c)):n=!!t.g,n&&(e.g=t.g),e};var ya=/[#\/\?@]/g,ga=/[#\?:]/g,va=/[#\?]/g,ba=/[#\?@]/g,wa=/#/g;function Ea(t,e){this.b=this.a=null,this.c=t||null,this.f=!!e}function Sa(t){t.a||(t.a=new Zo,t.b=0,t.c&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),i=null;if(0<=r){var o=t[n].substring(0,r);i=t[n].substring(r+1)}else o=t[n];e(o,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(t.c,function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)}))}function Ta(t,e){Sa(t),e=Da(t,e),na(t.a.b,e)&&(t.c=null,t.b-=t.a.get(e).length,ta(t.a,e))}function _a(t,e){return Sa(t),e=Da(t,e),na(t.a.b,e)}function Ia(t,e,n){Ta(t,e),0<n.length&&(t.c=null,t.a.set(Da(t,e),Xr(n)),t.b+=n.length)}function Ca(t){var e=new Ea;return e.c=t.c,t.a&&(e.a=new Zo(t.a),e.b=t.b),e}function Da(t,e){return e=String(e),t.f&&(e=e.toLowerCase()),e}function Aa(t){this.a=t,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function ka(t){var e=t.a.F.a;if(null!=e)_o(4),e?(_o(10),gs(t.a,t,!1)):(_o(11),gs(t.a,t,!0));else{t.b=new Fo(t,void 0,void 0),t.b.h=t.h,e=Ss(e=t.a,e.Y()?t.f:null,t.i),_o(4),la(e,"TYPE","xmlhttp");var n=t.a.j,r=t.a.I;n&&r&&ha(e,n,r),jo(t.b,e,!1,t.f)}}function Na(){this.a=this.b=null}function Ma(){this.a=new Zo}function Oa(t){var e=typeof t;return"object"==e&&t||"function"==e?"o"+(t[qr]||(t[qr]=++Br)):e.charAt(0)+t}function Ra(t,e){this.b=t,this.a=e}function Pa(t){this.g=t||La,kr.PerformanceNavigationTiming?t=0<(t=kr.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):t=!!(kr.ka&&kr.ka.Ea&&kr.ka.Ea()&&kr.ka.Ea().zb),this.f=t?this.g:1,this.a=null,1<this.f&&(this.a=new Ma),this.b=null,this.c=[]}(Tr=Ea.prototype).add=function(t,e){Sa(this),this.c=null,t=Da(this,t);var n=this.a.get(t);return n||this.a.set(t,n=[]),n.push(e),this.b+=1,this},Tr.forEach=function(t,e){Sa(this),this.a.forEach(function(n,r){Hr(n,function(n){t.call(e,n,r,this)},this)},this)},Tr.K=function(){Sa(this);for(var t=this.a.C(),e=this.a.K(),n=[],r=0;r<e.length;r++)for(var i=t[r],o=0;o<i.length;o++)n.push(e[r]);return n},Tr.C=function(t){Sa(this);var e=[];if(Nr(t))_a(this,t)&&(e=Yr(e,this.a.get(Da(this,t))));else{t=this.a.C();for(var n=0;n<t.length;n++)e=Yr(e,t[n])}return e},Tr.set=function(t,e){return Sa(this),this.c=null,_a(this,t=Da(this,t))&&(this.b-=this.a.get(t).length),this.a.set(t,[e]),this.b+=1,this},Tr.get=function(t,e){return t&&0<(t=this.C(t)).length?String(t[0]):e},Tr.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var t=[],e=this.a.K(),n=0;n<e.length;n++){var r=e[n],i=encodeURIComponent(String(r));r=this.C(r);for(var o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),t.push(a)}}return this.c=t.join("&")},zr(function(){},function(){}),(Tr=Aa.prototype).M=null,Tr.$=function(t){return this.a.$(t)},Tr.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},Tr.Da=function(){return!1},Tr.Ga=function(t,e){if(this.c=t.o,0==this.M){if(!this.a.o&&(t=t.a)){var n=os(t,"X-Client-Wire-Protocol");this.l=n||null,this.a.j&&(t=os(t,"X-HTTP-Session-Id"))&&(this.a.I=t)}if(e){try{var r=this.a.ja.a.parse(e)}catch(t){return(e=this.a).m=this.c,void ws(e,2)}this.f=r[0]}else(e=this.a).m=this.c,ws(e,2)}else 1==this.M&&(this.g?_o(6):"11111"==e?(_o(5),this.g=!0,(!fi||10<=Number(Ei))&&(this.c=200,this.b.cancel(),_o(11),gs(this.a,this,!0))):(_o(7),this.g=!1))},Tr.na=function(){if(this.c=this.b.o,this.b.b)0==this.M?(this.M=1,ka(this)):1==this.M&&(this.g?(_o(11),gs(this.a,this,!0)):(_o(10),gs(this.a,this,!1)));else{0==this.M?_o(8):1==this.M&&_o(9);var t=this.a;t.m=this.c,ws(t,2)}},Tr.Y=function(){return this.a.Y()},Tr.ma=function(){return this.a.ma()},Ma.prototype.add=function(t){this.a.set(Oa(t),t)},Ma.prototype.C=function(){return this.a.C()};var La=10;function xa(t,e){!t.a&&(ti(e,"spdy")||ti(e,"quic")||ti(e,"h2"))&&(t.f=t.g,t.a=new Ma,t.b&&(Va(t,t.b),t.b=null))}function Fa(t){return!!t.b||!!t.a&&t.a.a.c>=t.f}function qa(t){return t.b?1:t.a?t.a.a.c:0}function Ba(t,e){return t.b?t=t.b==e:t.a?(e=Oa(e),t=na(t.a.a.b,e)):t=!1,t}function Va(t,e){t.a?t.a.add(e):t.b=e}function Ua(t,e){var n;t.b&&t.b==e?t.b=null:((n=t.a)&&(n=Oa(e),n=na(t.a.a.b,n)),n&&ta(t.a.a,Oa(e)))}function ja(t){if(null!=t.b)return t.c.concat(t.b.j);if(null!=t.a&&0!=t.a.a.c){var e=t.c;return Hr(t.a.C(),function(t){e=e.concat(t.j)}),e}return Xr(t.c)}function Ka(){}function Qa(){this.a=new Ka}function za(t,e,n){var r=n||"";try{$o(t,function(t,n){var i=t;Fr(t)&&(i=Ji(t)),e.push(r+n+"="+encodeURIComponent(i))})}catch(t){throw e.push(r+"type="+encodeURIComponent("_badmap")),t}}function Ga(t,e,n,r,i){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,i(r)}catch(t){}}Pa.prototype.cancel=function(){var t;this.c=ja(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(Hr(this.a.C(),function(t){t.cancel()}),(t=this.a.a).b={},t.a.length=0,t.c=0)},Ka.prototype.stringify=function(t){return kr.JSON.stringify(t,void 0)},Ka.prototype.parse=function(t){return kr.JSON.parse(t,void 0)};var Wa=kr.JSON.parse;function Ha(t){Yi.call(this),this.headers=new Zo,this.H=t||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=Ya,this.D=this.F=!1}zr(Ha,Yi);var Ya="",Xa=/^https?$/i,Ja=["POST","PUT"];function $a(t){return"content-type"==t.toLowerCase()}function Za(t,e){t.b=!1,t.a&&(t.g=!0,t.a.abort(),t.g=!1),t.f=e,t.h=5,ts(t),ns(t)}function ts(t){t.v||(t.v=!0,t.dispatchEvent("complete"),t.dispatchEvent("error"))}function es(t){if(t.b&&void 0!==Ar&&(!t.s[1]||4!=is(t)||2!=t.T()))if(t.l&&4==is(t))lo(t.Fa,0,t);else if(t.dispatchEvent("readystatechange"),4==is(t)){t.b=!1;try{var e,n=t.T();t:switch(n){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var r=!0;break t;default:r=!1}if(!(e=r)){var i;if(i=0===n){var o=String(t.A).match(ra)[1]||null;if(!o&&kr.self&&kr.self.location){var a=kr.self.location.protocol;o=a.substr(0,a.length-1)}i=!Xa.test(o?o.toLowerCase():"")}e=i}e?(t.dispatchEvent("complete"),t.dispatchEvent("success")):(t.h=6,t.f=t.za()+" ["+t.T()+"]",ts(t))}finally{ns(t)}}}function ns(t,e){if(t.a){rs(t);var n=t.a,r=t.s[0]?Rr:null;t.a=null,t.s=null,e||t.dispatchEvent("ready");try{n.onreadystatechange=r}catch(t){}}}function rs(t){t.a&&t.D&&(t.a.ontimeout=null),t.m&&(kr.clearTimeout(t.m),t.m=null)}function is(t){return t.a?t.a.readyState:0}function os(t,e){return t.a?t.a.getResponseHeader(e):null}function as(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}if(r)return t;if(n=function(t){var e="";return ii(t,function(t,n){e+=n,e+=":",e+=t,e+="\r\n"}),e}(n),Nr(t)){if(e=encodeURIComponent(String(e)),e+=n=null!=n?"="+encodeURIComponent(String(n)):""){if(0>(n=t.indexOf("#"))&&(n=t.length),0>(r=t.indexOf("?"))||r>n){r=n;var i=""}else i=t.substring(r+1,n);n=(t=[t.substr(0,r),i,t.substr(n)])[1],t[1]=e?n?n+"&"+e:e:n,t=t[0]+(t[1]?"?"+t[1]:"")+t[2]}return t}return ha(t,e,n),t}function ss(t){this.f=[],this.F=new Na,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Ra=this.P=0,this.Pa=!!Or("internalChannelParams.failFast",t),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Oa=Or("internalChannelParams.baseRetryDelayMs",t)||5e3,this.Sa=Or("internalChannelParams.retryDelaySeedMs",t)||1e4,this.Qa=Or("internalChannelParams.forwardChannelMaxRetries",t)||2,this.qa=Or("internalChannelParams.forwardChannelRequestTimeoutMs",t)||2e4,this.La=t&&t.Ab||void 0,this.D=void 0,this.R=t&&t.supportsCrossDomainXhr||!1,this.H="",this.b=new Pa(t&&t.concurrentRequestLimit),this.ja=new Qa,this.o=!t||void 0===t.backgroundChannelTest||t.backgroundChannelTest,(this.W=t&&t.fastHandshake||!1)&&!this.o&&(this.o=!0),t&&t.forceLongPolling&&(this.oa=!1),this.fa=void 0}function us(t){if(cs(t),3==t.u){var e=t.P++,n=oa(t.B);ha(n,"SID",t.H),ha(n,"RID",e),ha(n,"TYPE","terminate"),ds(t,n),(e=new Fo(t,e,void 0)).F=2,e.f=fa(oa(n)),n=!1,kr.navigator&&kr.navigator.sendBeacon&&(n=kr.navigator.sendBeacon(e.f.toString(),"")),!n&&kr.Image&&((new Image).src=e.f,n=!0),n||(e.a=e.g.$(null),e.a.ca(e.f)),e.v=Qr(),Go(e)}Es(t)}function cs(t){t.w&&(t.w.abort(),t.w=null),t.a&&(t.a.cancel(),t.a=null),t.l&&(kr.clearTimeout(t.l),t.l=null),vs(t),t.b.cancel(),t.h&&(Mr(t.h)&&kr.clearTimeout(t.h),t.h=null)}function hs(t,e){t.f.push(new Ra(t.Ra++,e)),3==t.u&&ls(t)}function ls(t){Fa(t.b)||t.h||(t.h=!0,oo(t.Ia,t),t.A=0)}function fs(t,e){var n;n=e?e.W:t.P++;var r=oa(t.B);ha(r,"SID",t.H),ha(r,"RID",n),ha(r,"AID",t.O),ds(t,r),t.g&&t.i&&as(r,t.g,t.i),n=new Fo(t,n,t.A+1),null===t.g&&(n.h=t.i),e&&(t.f=e.j.concat(t.f)),e=ps(t,n,1e3),n.setTimeout(Math.round(.5*t.qa)+Math.round(.5*t.qa*Math.random())),Va(t.b,n),Uo(n,r,e)}function ds(t,e){t.c&&$o({},function(t,n){ha(e,n,t)})}function ps(t,e,n){n=Math.min(t.f.length,n);var r=t.c?jr(t.c.Ta,t.c,t):null;t:for(var i=t.f,o=-1;;){var a=["count="+n];-1==o?0<n?(o=i[0].b,a.push("ofs="+o)):o=0:a.push("ofs="+o);for(var s=!0,u=0;u<n;u++){var c=i[u].b,h=i[u].a;if(0>(c-=o))o=Math.max(0,i[u].b-100),s=!1;else try{za(h,a,"req"+c+"_")}catch(t){r&&r(h)}}if(s){r=a.join("&");break t}}return t=t.f.splice(0,n),e.j=t,r}function ms(t){t.a||t.l||(t.S=1,oo(t.Ha,t),t.v=0)}function ys(t){return!(t.a||t.l||3<=t.v)&&(t.S++,t.l=Co(jr(t.Ha,t),bs(t,t.v)),t.v++,!0)}function gs(t,e,n){var r=e.l;r&&xa(t.b,r),t.ia=t.oa&&n,t.m=e.c,t.B=Ss(t,null,t.ha),ls(t)}function vs(t){null!=t.s&&(kr.clearTimeout(t.s),t.s=null)}function bs(t,e){var n=t.Oa+Math.floor(Math.random()*t.Sa);return t.ma()||(n*=2),n*e}function ws(t,e){if(2==e){var n=null;t.c&&(n=null);var r=jr(t.fb,t);n||(n=new ia("//www.google.com/images/cleardot.gif"),kr.location&&"http"==kr.location.protocol||aa(n,"https"),fa(n)),function(t,e){var n=new bo;if(kr.Image){var r=new Image;r.onload=Kr(Ga,n,r,"TestLoadImage: loaded",!0,e),r.onerror=Kr(Ga,n,r,"TestLoadImage: error",!1,e),r.onabort=Kr(Ga,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=Kr(Ga,n,r,"TestLoadImage: timeout",!1,e),kr.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}else e(!1)}(n.toString(),r)}else _o(2);t.u=0,t.c&&t.c.ta(e),Es(t),cs(t)}function Es(t){t.u=0,t.m=-1,t.c&&(0==ja(t.b).length&&0==t.f.length||(t.b.c.length=0,Xr(t.f),t.f.length=0),t.c.sa())}function Ss(t,e,n){var r=function(t){return t instanceof ia?oa(t):new ia(t,void 0)}(n);if(""!=r.b)e&&sa(r,e+"."+r.b),ua(r,r.i);else{var i,o=kr.location;i=e?e+"."+o.hostname:o.hostname,r=function(t,e,n,r){var i=new ia(null,void 0);return t&&aa(i,t),e&&sa(i,e),n&&ua(i,n),r&&(i.a=r),i}(o.protocol,i,+o.port,n)}return t.V&&ii(t.V,function(t,e){ha(r,e,t)}),e=t.j,n=t.I,e&&n&&ha(r,e,n),ha(r,"VER",t.wa),ds(t,r),r}function Ts(){}function _s(){if(fi&&!(10<=Number(Ei)))throw Error("Environmental error: no available transport.")}function Is(t,e){Yi.call(this),this.a=new ss(e),this.g=t,this.m=e&&e.testUrl?e.testUrl:function(t){for(var e=arguments[0],n=1;n<arguments.length;n++){var r,i=arguments[n];0==i.lastIndexOf("/",0)?e=i:((r=""==e)||(r=0<=(r=e.length-1)&&e.indexOf("/",r)==r),e+=r?i:"/"+i)}return e}(this.g,"test"),this.b=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.a.i=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.xa&&(t?t["X-WebChannel-Client-Profile"]=e.xa:t={"X-WebChannel-Client-Profile":e.xa}),this.a.J=t,(t=e&&e.httpHeadersOverwriteParam)&&!Jr(t)&&(this.a.g=t),this.l=e&&e.supportsCrossDomainXhr||!1,this.h=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!Jr(e)&&(this.a.j=e,null!==(t=this.b)&&e in t&&(e in(t=this.b)&&delete t[e])),this.f=new As(this)}function Cs(t){Po.call(this);var e=t.__sm__;if(e){t:{for(var n in e){t=n;break t}t=void 0}(this.c=t)?(t=this.c,this.data=null!==e&&t in e?e[t]:void 0):this.data=e}else this.data=t}function Ds(){Lo.call(this),this.status=1}function As(t){this.a=t}(Tr=Ha.prototype).ca=function(t,e,n,r){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+t);e=e?e.toUpperCase():"GET",this.A=t,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=this.H?No(this.H):No(Oo),this.a.onreadystatechange=jr(this.Fa,this);try{this.w=!0,this.a.open(e,String(t),!0),this.w=!1}catch(t){return void Za(this,t)}t=n||"";var i=new Zo(this.headers);r&&$o(r,function(t,e){i.set(e,t)}),r=function(t){t:{for(var e=$a,n=t.length,r=Nr(t)?t.split(""):t,i=0;i<n;i++)if(i in r&&e.call(void 0,r[i],i,t)){e=i;break t}e=-1}return 0>e?null:Nr(t)?t.charAt(e):t[e]}(i.K()),n=kr.FormData&&t instanceof kr.FormData,!(0<=Wr(Ja,e))||r||n||i.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),i.forEach(function(t,e){this.a.setRequestHeader(e,t)},this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{rs(this),0<this.o&&((this.D=function(t){return fi&&Ti(9)&&Mr(t.timeout)&&void 0!==t.ontimeout}(this.a))?(this.a.timeout=this.o,this.a.ontimeout=jr(this.Ca,this)):this.m=lo(this.Ca,this.o,this)),this.l=!0,this.a.send(t),this.l=!1}catch(t){Za(this,t)}},Tr.Ca=function(){void 0!==Ar&&this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},Tr.abort=function(t){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=t||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),ns(this))},Tr.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),ns(this,!0)),Ha.N.G.call(this)},Tr.Fa=function(){this.j||(this.w||this.l||this.g?es(this):this.$a())},Tr.$a=function(){es(this)},Tr.T=function(){try{return 2<is(this)?this.a.status:-1}catch(t){return-1}},Tr.za=function(){try{return 2<is(this)?this.a.statusText:""}catch(t){return""}},Tr.aa=function(){try{return this.a?this.a.responseText:""}catch(t){return""}},Tr.Va=function(t){if(this.a){var e=this.a.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),Wa(e)}},Tr.ya=function(){return this.h},Tr.Ya=function(){return Nr(this.f)?this.f:String(this.f)},(Tr=ss.prototype).wa=8,Tr.u=1,Tr.Da=function(){return 0==this.u},Tr.Ia=function(t){if(this.h)if(this.h=null,1==this.u){if(!t){this.P=Math.floor(1e5*Math.random());var e,n=new Fo(this,t=this.P++,void 0),r=this.i;if(this.J&&(r?si(r=oi(r),this.J):r=this.J),null===this.g&&(n.h=r),this.W)t:{for(var i=e=0;i<this.f.length;i++){var o=this.f[i];if(void 0===(o="__data__"in o.a&&Nr(o=o.a.__data__)?o.length:void 0))break;if(4096<(e+=o)){e=i;break t}if(4096===e||i===this.f.length-1){e=i+1;break t}}e=1e3}else e=1e3;e=ps(this,n,e),ha(i=oa(this.B),"RID",t),ha(i,"CVER",22),this.o&&this.j&&ha(i,"X-HTTP-Session-Id",this.j),ds(this,i),this.g&&r&&as(i,this.g,r),Va(this.b,n),this.W?(ha(i,"$req",e),ha(i,"SID","null"),n.S=!0,Uo(n,i,null)):Uo(n,i,e),this.u=2}}else 3==this.u&&(t?fs(this,t):0==this.f.length||Fa(this.b)||fs(this))},Tr.Ha=function(){this.l=null,this.a=new Fo(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var t=oa(this.pa);ha(t,"RID","rpc"),ha(t,"SID",this.H),ha(t,"CI",this.ia?"0":"1"),ha(t,"AID",this.O),ds(this,t),ha(t,"TYPE","xmlhttp"),this.g&&this.i&&as(t,this.g,this.i),this.D&&this.a.setTimeout(this.D),jo(this.a,t,!0,this.ga)},Tr.Ga=function(t,e){if(0!=this.u&&(this.a==t||Ba(this.b,t)))if(this.m=t.o,!t.s&&Ba(this.b,t)&&3==this.u){try{var n=this.ja.a.parse(e)}catch(t){n=null}if(Lr(n)&&3==n.length){if(0==(e=n)[0]){t:if(!this.l){if(this.a){if(!(this.a.v+3e3<t.v))break t;vs(this),this.a.cancel(),this.a=null}ys(this),_o(18)}}else this.ra=e[1],0<this.ra-this.O&&37500>e[2]&&this.ia&&0==this.v&&!this.s&&(this.s=Co(jr(this.Za,this),6e3));if(1>=qa(this.b)&&this.fa){try{this.fa()}catch(t){}this.fa=void 0}}else ws(this,11)}else if((t.s||this.a==t)&&vs(this),!Jr(e))for(e=n=this.ja.a.parse(e),n=0;n<e.length;n++){var r=e[n];if(this.O=r[0],r=r[1],2==this.u)if("c"==r[0]){this.H=r[1],this.ga=r[2];var i=r[3];null!=i&&(this.wa=i),null!=(r=r[5])&&Mr(r)&&0<r&&(this.D=1.5*r),this.o&&(r=t.a)&&((i=os(r,"X-Client-Wire-Protocol"))&&xa(this.b,i),this.j&&(r=os(r,"X-HTTP-Session-Id")))&&(this.I=r,ha(this.B,this.j,r)),this.u=3,this.c&&this.c.va(),r=t,this.pa=Ss(this,this.Y()?this.ga:null,this.ha),r.s?(Ua(this.b,r),(i=this.D)&&r.setTimeout(i),r.i&&(Ho(r),Go(r)),this.a=r):ms(this),0<this.f.length&&ls(this)}else"stop"!=r[0]&&"close"!=r[0]||ws(this,7);else 3==this.u&&("stop"==r[0]||"close"==r[0]?"stop"==r[0]?ws(this,7):us(this):"noop"!=r[0]&&this.c&&this.c.ua(r),this.v=0)}},Tr.Za=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,ys(this),_o(19))},Tr.na=function(t){var e=null;if(this.a==t){vs(this),this.a=null;var n=2}else{if(!Ba(this.b,t))return;e=t.j,Ua(this.b,t),n=1}if(this.m=t.o,0!=this.u)if(t.b)1==n?(e=Qr()-t.v,wo.dispatchEvent(new Io(wo,t.l?t.l.length:0,e,this.A)),ls(this)):ms(this);else{var r=t.c;if(3==r||0==r&&0<this.m||!(1==n&&function(t,e){return!(qa(t.b)>=t.b.f-(t.h?1:0)||(t.h?(t.f=e.j.concat(t.f),0):1==t.u||2==t.u||t.A>=(t.Pa?0:t.Qa)||(t.h=Co(jr(t.Ia,t,e),bs(t,t.A)),t.A++,0)))}(this,t)||2==n&&ys(this)))switch(e&&0<e.length&&(t=this.b,t.c=t.c.concat(e)),r){case 1:ws(this,5);break;case 4:ws(this,10);break;case 3:ws(this,6);break;default:ws(this,2)}}},Tr.fb=function(t){_o(t?2:1)},Tr.$=function(t){if(t&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new Ha(this.La)).F=this.R,t},Tr.ma=function(){return!!this.c&&!0},Tr.Y=function(){return this.R},(Tr=Ts.prototype).va=function(){},Tr.ua=function(){},Tr.ta=function(){},Tr.sa=function(){},Tr.Ta=function(){},_s.prototype.a=function(t,e){return new Is(t,e)},zr(Is,Yi),(Tr=Is.prototype).addEventListener=function(t,e,n,r){Is.N.addEventListener.call(this,t,e,n,r)},Tr.removeEventListener=function(t,e,n,r){Is.N.removeEventListener.call(this,t,e,n,r)},Tr.Wa=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var t=this.a,e=this.m,n=this.g,r=this.b||void 0;_o(0),t.ha=n,t.V=r||{},t.o&&(t.F.b=[],t.F.a=!1),t.w=new Aa(t),null===t.g&&(t.w.h=t.i),n=e,t.g&&t.i&&(n=as(e,t.g,t.i)),(t=t.w).i=n,e=Ss(t.a,null,t.i),_o(3),null!=(n=t.a.F.b)?(t.f=n[0],t.M=1,ka(t)):(la(e,"MODE","init"),!t.a.o&&t.a.j&&la(e,"X-HTTP-Session-Id",t.a.j),t.b=new Fo(t,void 0,void 0),t.b.h=t.h,jo(t.b,e,!1,null),t.M=0)},Tr.close=function(){us(this.a)},Tr.Xa=function(t){if(Nr(t)){var e={};e.__data__=t,hs(this.a,e)}else this.h?((e={}).__data__=Ji(t),hs(this.a,e)):hs(this.a,t)},Tr.G=function(){this.a.c=null,delete this.f,us(this.a),delete this.a,Is.N.G.call(this)},zr(Cs,Po),zr(Ds,Lo),zr(As,Ts),As.prototype.va=function(){this.a.dispatchEvent("a")},As.prototype.ua=function(t){this.a.dispatchEvent(new Cs(t))},As.prototype.ta=function(t){this.a.dispatchEvent(new Ds(t))},As.prototype.sa=function(){this.a.dispatchEvent("b")};var ks=Kr(function(t,e){function n(){}n.prototype=t.prototype;var r=new n;return t.apply(r,Array.prototype.slice.call(arguments,1)),r},_s);_s.prototype.createWebChannel=_s.prototype.a,Is.prototype.send=Is.prototype.Xa,Is.prototype.open=Is.prototype.Wa,Is.prototype.close=Is.prototype.close,Do.NO_ERROR=0,Do.TIMEOUT=8,Do.HTTP_ERROR=6,Ao.COMPLETE="complete",Mo.EventType=Ro,Ro.OPEN="a",Ro.CLOSE="b",Ro.ERROR="c",Ro.MESSAGE="d",Yi.prototype.listen=Yi.prototype.Aa,Ha.prototype.listenOnce=Ha.prototype.Ba,Ha.prototype.getLastError=Ha.prototype.Ya,Ha.prototype.getLastErrorCode=Ha.prototype.ya,Ha.prototype.getStatus=Ha.prototype.T,Ha.prototype.getStatusText=Ha.prototype.za,Ha.prototype.getResponseJson=Ha.prototype.Va,Ha.prototype.getResponseText=Ha.prototype.aa,Ha.prototype.send=Ha.prototype.ca;var Ns,Ms={createWebChannelTransport:ks,ErrorCode:Do,EventType:Ao,WebChannel:Mo,XhrIo:Ha},Os=Ms.createWebChannelTransport,Rs=Ms.ErrorCode,Ps=Ms.EventType,Ls=Ms.WebChannel,xs=Ms.XhrIo,Fs=Sr.SDK_VERSION,qs=new Cr("@firebase/firestore");function Bs(){return qs.logLevel===Er.DEBUG?Ns.DEBUG:qs.logLevel===Er.SILENT?Ns.SILENT:Ns.ERROR}function Vs(t){switch(t){case Ns.DEBUG:qs.logLevel=Er.DEBUG;break;case Ns.ERROR:qs.logLevel=Er.ERROR;break;case Ns.SILENT:qs.logLevel=Er.SILENT;break;default:qs.error("Firestore ("+Fs+"): Invalid value passed to `setLogLevel`")}}function Us(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(qs.logLevel<=Er.DEBUG){var i=n.map(Ks);qs.debug.apply(qs,["Firestore ("+Fs+") ["+t+"]: "+e].concat(i))}}function js(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(qs.logLevel<=Er.ERROR){var r=e.map(Ks);qs.error.apply(qs,["Firestore ("+Fs+"): "+t].concat(r))}}function Ks(t){if("string"==typeof t)return t;var e=Gs.getPlatform();try{return e.formatJSON(t)}catch(e){return t}}function Qs(t){var e="FIRESTORE ("+Fs+") INTERNAL ASSERTION FAILED: "+t;throw js(e),new Error(e)}function zs(t,e){t||Qs(e)}!function(t){t[t.DEBUG=0]="DEBUG",t[t.ERROR=1]="ERROR",t[t.SILENT=2]="SILENT"}(Ns||(Ns={}));var Gs=function(){function t(){}return t.setPlatform=function(e){t.platform&&Qs("Platform already defined"),t.platform=e},t.getPlatform=function(){return t.platform||Qs("Platform not set"),t.platform},t}();function Ws(){return Gs.getPlatform().emptyByteString}var Hs={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},Ys=function(t){function e(e,n){var r=t.call(this,n)||this;return r.code=e,r.message=n,r.name="FirebaseError",r.toString=function(){return r.name+": [code="+r.code+"]: "+r.message},r}return $n(e,t),e}(Error);function Xs(t,e){function n(){var t="This constructor is private.";throw e&&(t+=" ",t+=e),new Ys(Hs.INVALID_ARGUMENT,t)}for(var r in n.prototype=t.prototype,t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function Js(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function $s(t,e){return void 0!==t?t:e}function Zs(t,e){for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=Number(n);isNaN(r)||e(r,t[n])}}function tu(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function eu(t){for(var e in zs(null!=t&&"object"==typeof t,"isEmpty() expects object parameter."),t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function nu(t,e){if(0!==e.length)throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() does not support arguments, but was called with "+bu(e.length,"argument")+".")}function ru(t,e,n){if(e.length!==n)throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() requires "+bu(n,"argument")+", but was called with "+bu(e.length,"argument")+".")}function iu(t,e,n){if(e.length<n)throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() requires at least "+bu(n,"argument")+", but was called with "+bu(e.length,"argument")+".")}function ou(t,e,n,r){if(e.length<n||e.length>r)throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() requires between "+n+" and "+r+" arguments, but was called with "+bu(e.length,"argument")+".")}function au(t,e,n,r){fu(t,e,vu(n)+" argument",r)}function su(t,e,n,r){void 0!==r&&au(t,e,n,r)}function uu(t,e,n,r){fu(t,e,n+" option",r)}function cu(t,e,n,r){void 0!==r&&uu(t,e,n,r)}function hu(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){if(!(r instanceof Array))throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" option to be an array, but it was: "+pu(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() requires all "+e+" elements to be "+n+", but the value at index "+o+" was: "+pu(r[o]))}(t,e,n,r,i)}function lu(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){for(var o=[],a=0,s=i;a<s.length;a++){var u=s[a];if(u===r)return;o.push(pu(u))}var c=pu(r);throw new Ys(Hs.INVALID_ARGUMENT,"Invalid value "+c+" provided to function "+t+'() for option "'+n+'". Acceptable values: '+o.join(", "))}(t,0,n,r,i)}function fu(t,e,n,r){if(!("object"===e?du(r):"non-empty string"===e?"string"==typeof r&&""!==r:typeof r===e)){var i=pu(r);throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" to be of type "+e+", but it was: "+i)}}function du(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function pu(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";var e=function(t){if(t.constructor){var e=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(e&&e.length>1)return e[1]}return null}(t);return e?"a custom "+e+" object":"an object"}return"function"==typeof t?"a function":Qs("Unknown wrong type: "+typeof t)}function mu(t,e,n){if(void 0===n)throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+vu(e)+" argument, but it was undefined.")}function yu(t,e,n){tu(e,function(e,r){if(n.indexOf(e)<0)throw new Ys(Hs.INVALID_ARGUMENT,"Unknown option '"+e+"' passed to function "+t+"(). Available options: "+n.join(", "))})}function gu(t,e,n,r){var i=pu(r);return new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() requires its "+vu(n)+" argument to be a "+e+", but it was: "+i)}function vu(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function bu(t,e){return t+" "+e+(1===t?"":"s")}var wu=function(){function t(){}return t.newId=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",n=0;n<20;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return zs(20===e.length,"Invalid auto ID: "+e),e},t}();function Eu(t,e){return t<e?-1:t>e?1:0}function Su(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].isEqual(e[n]))return!1;return!0}function Tu(t){return t+"\0"}function _u(){if("undefined"==typeof Uint8Array)throw new Ys(Hs.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function Iu(){if(!Gs.getPlatform().base64Available)throw new Ys(Hs.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var Cu,Du,Au=function(){function t(t){Iu(),this._binaryString=t}return t.fromBase64String=function(e){ru("Blob.fromBase64String",arguments,1),au("Blob.fromBase64String","string",1,e),Iu();try{return new t(Gs.getPlatform().atob(e))}catch(t){throw new Ys(Hs.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},t.fromUint8Array=function(e){if(ru("Blob.fromUint8Array",arguments,1),_u(),!(e instanceof Uint8Array))throw gu("Blob.fromUint8Array","Uint8Array",1,e);return new t(Array.prototype.map.call(e,function(t){return String.fromCharCode(t)}).join(""))},t.prototype.toBase64=function(){return ru("Blob.toBase64",arguments,0),Iu(),Gs.getPlatform().btoa(this._binaryString)},t.prototype.toUint8Array=function(){ru("Blob.toUint8Array",arguments,0),_u();for(var t=new Uint8Array(this._binaryString.length),e=0;e<this._binaryString.length;e++)t[e]=this._binaryString.charCodeAt(e);return t},t.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},t.prototype.isEqual=function(t){return this._binaryString===t._binaryString},t.prototype._compareTo=function(t){return Eu(this._binaryString,t._binaryString)},t}(),ku=Xs(Au,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),Nu=function(){function t(t,e){if(ru("GeoPoint",arguments,2),au("GeoPoint","number",1,t),au("GeoPoint","number",2,e),!isFinite(t)||t<-90||t>90)throw new Ys(Hs.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Ys(Hs.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}return Object.defineProperty(t.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},t.prototype._compareTo=function(t){return Eu(this._lat,t._lat)||Eu(this._long,t._long)},t}(),Mu=function(){function t(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Ys(Hs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Ys(Hs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Ys(Hs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Ys(Hs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}return t.now=function(){return t.fromMillis(Date.now())},t.fromDate=function(e){return t.fromMillis(e.getTime())},t.fromMillis=function(e){var n=Math.floor(e/1e3);return new t(n,1e6*(e-1e3*n))},t.prototype.toDate=function(){return new Date(this.toMillis())},t.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},t.prototype._compareTo=function(t){return this.seconds===t.seconds?Eu(this.nanoseconds,t.nanoseconds):Eu(this.seconds,t.seconds)},t.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},t.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},t}(),Ou=function(){return function(t,e,n,r,i){this.databaseId=t,this.persistenceKey=e,this.host=n,this.ssl=r,this.forceLongPolling=i}}(),Ru="(default)",Pu=function(){function t(t,e){this.projectId=t,this.database=e||Ru}return Object.defineProperty(t.prototype,"isDefaultDatabase",{get:function(){return this.database===Ru},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return e instanceof t&&e.projectId===this.projectId&&e.database===this.database},t.prototype.compareTo=function(t){return Eu(this.projectId,t.projectId)||Eu(this.database,t.database)},t}(),Lu=function(){function t(t,e,n){this.init(t,e,n)}return t.prototype.init=function(t,e,n){void 0===e?e=0:e>t.length&&Qs("offset "+e+" out of range "+t.length),void 0===n?n=t.length-e:n>t.length-e&&Qs("length "+n+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.len=n},t.prototype.construct=function(t,e,n){var r=Object.create(Object.getPrototypeOf(this));return r.init(t,e,n),r},Object.defineProperty(t.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return 0===t.comparator(this,e)},t.prototype.child=function(e){var n=this.segments.slice(this.offset,this.limit());return e instanceof t?e.forEach(function(t){n.push(t)}):"string"==typeof e?n.push(e):Qs("Unknown parameter type for Path.child(): "+e),this.construct(n)},t.prototype.limit=function(){return this.offset+this.length},t.prototype.popFirst=function(t){return t=void 0===t?1:t,zs(this.length>=t,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+t,this.length-t)},t.prototype.popLast=function(){return zs(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},t.prototype.firstSegment=function(){return zs(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},t.prototype.lastSegment=function(){return this.get(this.length-1)},t.prototype.get=function(t){return zs(t<this.length,"Index out of range"),this.segments[this.offset+t]},t.prototype.isEmpty=function(){return 0===this.length},t.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},t.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},t.comparator=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),o=e.get(r);if(i<o)return-1;if(i>o)return 1}return t.length<e.length?-1:t.length>e.length?1:0},t}(),xu=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return $n(e,t),e.prototype.canonicalString=function(){return this.toArray().join("/")},e.prototype.toString=function(){return this.canonicalString()},e.fromString=function(t){if(t.indexOf("//")>=0)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new e(t.split("/").filter(function(t){return t.length>0}))},e.EMPTY_PATH=new e([]),e}(Lu),Fu=/^[_a-zA-Z][_a-zA-Z0-9]*$/,qu=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return $n(e,t),e.isValidIdentifier=function(t){return Fu.test(t)},e.prototype.canonicalString=function(){return this.toArray().map(function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),e.isValidIdentifier(t)||(t="`"+t+"`"),t}).join(".")},e.prototype.toString=function(){return this.canonicalString()},e.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)},e.keyField=function(){return new e(["__name__"])},e.fromServerFormat=function(t){for(var n=[],r="",i=0,o=function(){if(0===r.length)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");n.push(r),r=""},a=!1;i<t.length;){var s=t[i];if("\\"===s){if(i+1===t.length)throw new Ys(Hs.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var u=t[i+1];if("\\"!==u&&"."!==u&&"`"!==u)throw new Ys(Hs.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);r+=u,i+=2}else"`"===s?(a=!a,i++):"."!==s||a?(r+=s,i++):(o(),i++)}if(o(),a)throw new Ys(Hs.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new e(n)},e.EMPTY_PATH=new e([]),e}(Lu),Bu=function(){function t(e){this.path=e,zs(t.isDocumentKey(e),"Invalid DocumentKey with an odd number of segments: "+e.toArray().join("/"))}return t.prototype.hasCollectionId=function(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t},t.prototype.isEqual=function(t){return null!==t&&0===xu.comparator(this.path,t.path)},t.prototype.toString=function(){return this.path.toString()},t.comparator=function(t,e){return xu.comparator(t.path,e.path)},t.isDocumentKey=function(t){return t.length%2==0},t.fromSegments=function(e){return new t(new xu(e.slice()))},t.fromPathString=function(e){return new t(xu.fromString(e))},t.EMPTY=new t(new xu([])),t}(),Vu=function(){function t(t,e){this.key=t,this.version=e}return t.compareByKey=function(t,e){return Bu.comparator(t.key,e.key)},t}(),Uu=function(t){function e(e,n,r,i,o){var a=t.call(this,e,n)||this;return a.data=r,a.proto=o,a.hasLocalMutations=!!i.hasLocalMutations,a.hasCommittedMutations=!!i.hasCommittedMutations,a}return $n(e,t),e.prototype.field=function(t){return this.data.field(t)},e.prototype.fieldValue=function(t){var e=this.field(t);return e?e.value():void 0},e.prototype.value=function(){return this.data.value()},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.data.isEqual(t.data)&&this.hasLocalMutations===t.hasLocalMutations&&this.hasCommittedMutations===t.hasCommittedMutations},e.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),e.compareByField=function(t,e,n){var r=e.field(t),i=n.field(t);return void 0!==r&&void 0!==i?r.compareTo(i):Qs("Trying to compare documents on fields that don't exist")},e}(Vu),ju=function(t){function e(e,n,r){var i=t.call(this,e,n)||this;return i.hasCommittedMutations=!(!r||!r.hasCommittedMutations),i}return $n(e,t),e.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},e}(Vu),Ku=function(t){function e(e,n){return t.call(this,e,n)||this}return $n(e,t),e.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},e}(Vu),Qu=function(){function t(t,e){this.comparator=t,this.root=e||Gu.EMPTY}return t.prototype.insert=function(e,n){return new t(this.comparator,this.root.insert(e,n,this.comparator).copy(null,null,Gu.BLACK,null,null))},t.prototype.remove=function(e){return new t(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Gu.BLACK,null,null))},t.prototype.get=function(t){for(var e=this.root;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null},t.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1},t.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(t.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),t.prototype.minKey=function(){return this.root.minKey()},t.prototype.maxKey=function(){return this.root.maxKey()},t.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},t.prototype.forEach=function(t){this.inorderTraversal(function(e,n){return t(e,n),!1})},t.prototype.toString=function(){var t=[];return this.inorderTraversal(function(e,n){return t.push(e+":"+n),!1}),"{"+t.join(", ")+"}"},t.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},t.prototype.getIterator=function(){return new zu(this.root,null,this.comparator,!1)},t.prototype.getIteratorFrom=function(t){return new zu(this.root,t,this.comparator,!1)},t.prototype.getReverseIterator=function(){return new zu(this.root,null,this.comparator,!0)},t.prototype.getReverseIteratorFrom=function(t){return new zu(this.root,t,this.comparator,!0)},t}(),zu=function(){function t(t,e,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!t.isEmpty();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}return t.prototype.getNext=function(){zs(this.nodeStack.length>0,"getNext() called on iterator when hasNext() is false.");var t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},t.prototype.hasNext=function(){return this.nodeStack.length>0},t.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},t}(),Gu=function(){function t(e,n,r,i,o){this.key=e,this.value=n,this.color=null!=r?r:t.RED,this.left=null!=i?i:t.EMPTY,this.right=null!=o?o:t.EMPTY,this.size=this.left.size+1+this.right.size}return t.prototype.copy=function(e,n,r,i,o){return new t(null!=e?e:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=o?o:this.right)},t.prototype.isEmpty=function(){return!1},t.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},t.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},t.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},t.prototype.minKey=function(){return this.min().key},t.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},t.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()},t.prototype.removeMin=function(){if(this.left.isEmpty())return t.EMPTY;var e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()},t.prototype.remove=function(e,n){var r,i=this;if(n(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,n),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===n(e,i.key)){if(i.right.isEmpty())return t.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,n))}return i.fixUp()},t.prototype.isRed=function(){return this.color},t.prototype.fixUp=function(){var t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t},t.prototype.moveRedLeft=function(){var t=this.colorFlip();return t.right.left.isRed()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip()),t},t.prototype.moveRedRight=function(){var t=this.colorFlip();return t.left.left.isRed()&&(t=(t=t.rotateRight()).colorFlip()),t},t.prototype.rotateLeft=function(){var e=this.copy(null,null,t.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)},t.prototype.rotateRight=function(){var e=this.copy(null,null,t.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)},t.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},t.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},t.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw Qs("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw Qs("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check();if(t!==this.right.check())throw Qs("Black depths differ");return t+(this.isRed()?0:1)},t.EMPTY=null,t.RED=!0,t.BLACK=!1,t}(),Wu=function(){function t(){this.size=0}return t.prototype.copy=function(t,e,n,r,i){return this},t.prototype.insert=function(t,e,n){return new Gu(t,e)},t.prototype.remove=function(t,e){return this},t.prototype.isEmpty=function(){return!0},t.prototype.inorderTraversal=function(t){return!1},t.prototype.reverseTraversal=function(t){return!1},t.prototype.minKey=function(){return null},t.prototype.maxKey=function(){return null},t.prototype.isRed=function(){return!1},t.prototype.checkMaxDepth=function(){return!0},t.prototype.check=function(){return 0},t}();Gu.EMPTY=new Wu,function(t){t[t.NullValue=0]="NullValue",t[t.BooleanValue=1]="BooleanValue",t[t.NumberValue=2]="NumberValue",t[t.TimestampValue=3]="TimestampValue",t[t.StringValue=4]="StringValue",t[t.BlobValue=5]="BlobValue",t[t.RefValue=6]="RefValue",t[t.GeoPointValue=7]="GeoPointValue",t[t.ArrayValue=8]="ArrayValue",t[t.ObjectValue=9]="ObjectValue"}(Cu||(Cu={})),function(t){t[t.Default=0]="Default",t[t.Estimate=1]="Estimate",t[t.Previous=2]="Previous"}(Du||(Du={}));var Hu=function(){function t(t,e){this.serverTimestampBehavior=t,this.timestampsInSnapshots=e}return t.fromSnapshotOptions=function(e,n){switch(e.serverTimestamps){case"estimate":return new t(Du.Estimate,n);case"previous":return new t(Du.Previous,n);case"none":case void 0:return new t(Du.Default,n);default:return Qs("fromSnapshotOptions() called with invalid options.")}},t}(),Yu=function(){function t(){}return t.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},t.prototype.defaultCompareTo=function(t){return zs(this.typeOrder!==t.typeOrder,"Default compareTo should not be used for values of same type."),Eu(this.typeOrder,t.typeOrder)},t}(),Xu=function(t){function e(){var e=t.call(this)||this;return e.typeOrder=Cu.NullValue,e.internalValue=null,e}return $n(e,t),e.prototype.value=function(t){return null},e.prototype.isEqual=function(t){return t instanceof e},e.prototype.compareTo=function(t){return t instanceof e?0:this.defaultCompareTo(t)},e.INSTANCE=new e,e}(Yu),Ju=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.BooleanValue,n}return $n(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue===t.internalValue},e.prototype.compareTo=function(t){return t instanceof e?Eu(this,t):this.defaultCompareTo(t)},e.of=function(t){return t?e.TRUE:e.FALSE},e.TRUE=new e(!0),e.FALSE=new e(!1),e}(Yu),$u=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.NumberValue,n}return $n(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.compareTo=function(t){return t instanceof e?(n=this.internalValue,r=t.internalValue,n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1):this.defaultCompareTo(t);var n,r},e}(Yu);function Zu(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}var tc=function(t){function e(e){return t.call(this,e)||this}return $n(e,t),e.prototype.isEqual=function(t){return t instanceof e&&Zu(this.internalValue,t.internalValue)},e}($u),ec=function(t){function e(e){var n=t.call(this,e)||this;return n.internalValue=e,n}return $n(e,t),e.prototype.isEqual=function(t){return t instanceof e&&Zu(this.internalValue,t.internalValue)},e.NAN=new e(NaN),e.POSITIVE_INFINITY=new e(1/0),e.NEGATIVE_INFINITY=new e(-1/0),e}($u),nc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.StringValue,n}return $n(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue===t.internalValue},e.prototype.compareTo=function(t){return t instanceof e?Eu(this.internalValue,t.internalValue):this.defaultCompareTo(t)},e}(Yu),rc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.TimestampValue,n}return $n(e,t),e.prototype.value=function(t){return!t||t.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):t instanceof ic?-1:this.defaultCompareTo(t)},e}(Yu),ic=function(t){function e(e,n){var r=t.call(this)||this;return r.localWriteTime=e,r.previousValue=n,r.typeOrder=Cu.TimestampValue,r}return $n(e,t),e.prototype.value=function(t){return t&&t.serverTimestampBehavior===Du.Estimate?new rc(this.localWriteTime).value(t):t&&t.serverTimestampBehavior===Du.Previous&&this.previousValue?this.previousValue.value(t):null},e.prototype.isEqual=function(t){return t instanceof e&&this.localWriteTime.isEqual(t.localWriteTime)},e.prototype.compareTo=function(t){return t instanceof e?this.localWriteTime._compareTo(t.localWriteTime):t instanceof rc?1:this.defaultCompareTo(t)},e.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},e}(Yu),oc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.BlobValue,n}return $n(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},e}(Yu),ac=function(t){function e(e,n){var r=t.call(this)||this;return r.databaseId=e,r.key=n,r.typeOrder=Cu.RefValue,r}return $n(e,t),e.prototype.value=function(t){return this.key},e.prototype.isEqual=function(t){return t instanceof e&&(this.key.isEqual(t.key)&&this.databaseId.isEqual(t.databaseId))},e.prototype.compareTo=function(t){if(t instanceof e){var n=this.databaseId.compareTo(t.databaseId);return 0!==n?n:Bu.comparator(this.key,t.key)}return this.defaultCompareTo(t)},e}(Yu),sc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.GeoPointValue,n}return $n(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},e}(Yu),uc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.ObjectValue,n}return $n(e,t),e.prototype.value=function(t){var e={};return this.internalValue.inorderTraversal(function(n,r){e[n]=r.value(t)}),e},e.prototype.forEach=function(t){this.internalValue.inorderTraversal(t)},e.prototype.isEqual=function(t){if(t instanceof e){for(var n=this.internalValue.getIterator(),r=t.internalValue.getIterator();n.hasNext()&&r.hasNext();){var i=n.getNext(),o=r.getNext();if(i.key!==o.key||!i.value.isEqual(o.value))return!1}return!n.hasNext()&&!r.hasNext()}return!1},e.prototype.compareTo=function(t){if(t instanceof e){for(var n=this.internalValue.getIterator(),r=t.internalValue.getIterator();n.hasNext()&&r.hasNext();){var i=n.getNext(),o=r.getNext(),a=Eu(i.key,o.key)||i.value.compareTo(o.value);if(a)return a}return Eu(n.hasNext(),r.hasNext())}return this.defaultCompareTo(t)},e.prototype.set=function(t,n){if(zs(!t.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.setChild(t.firstSegment(),n);var r=this.child(t.firstSegment());r instanceof e||(r=e.EMPTY);var i=r.set(t.popFirst(),n);return this.setChild(t.firstSegment(),i)},e.prototype.delete=function(t){if(zs(!t.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new e(this.internalValue.remove(t.firstSegment()));var n=this.child(t.firstSegment());if(n instanceof e){var r=n.delete(t.popFirst());return new e(this.internalValue.insert(t.firstSegment(),r))}return this},e.prototype.contains=function(t){return void 0!==this.field(t)},e.prototype.field=function(t){zs(!t.isEmpty(),"Can't get field of empty path");var n=this;return t.forEach(function(t){n=n instanceof e&&n.internalValue.get(t)||void 0}),n},e.prototype.toString=function(){return this.internalValue.toString()},e.prototype.child=function(t){return this.internalValue.get(t)||void 0},e.prototype.setChild=function(t,n){return new e(this.internalValue.insert(t,n))},e.EMPTY=new e(new Qu(Eu)),e}(Yu),cc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.ArrayValue,n}return $n(e,t),e.prototype.value=function(t){return this.internalValue.map(function(e){return e.value(t)})},e.prototype.forEach=function(t){this.internalValue.forEach(t)},e.prototype.isEqual=function(t){if(t instanceof e){if(this.internalValue.length!==t.internalValue.length)return!1;for(var n=0;n<this.internalValue.length;n++)if(!this.internalValue[n].isEqual(t.internalValue[n]))return!1;return!0}return!1},e.prototype.compareTo=function(t){if(t instanceof e){for(var n=Math.min(this.internalValue.length,t.internalValue.length),r=0;r<n;r++){var i=this.internalValue[r].compareTo(t.internalValue[r]);if(i)return i}return Eu(this.internalValue.length,t.internalValue.length)}return this.defaultCompareTo(t)},e.prototype.toString=function(){return"["+this.internalValue.map(function(t){return t.toString()}).join(",")+"]"},e}(Yu),hc=Number,lc=hc.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),fc=hc.MAX_SAFE_INTEGER||Math.pow(2,53)-1,dc=hc.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t};function pc(t){return null==t}function mc(t){return dc(t)&&t<=fc&&t>=lc}var yc,gc=function(){function t(t,e,n,r,i,o,a){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=a,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}return t.atPath=function(e){return new t(e)},Object.defineProperty(t.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var t=this.getInequalityFilterField(),e=this.getFirstOrderByField();if(null!==t&&null===e)t.isKeyField()?this.memoizedOrderBy=[Cc]:this.memoizedOrderBy=[new Ic(t),Cc];else{zs(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field."),this.memoizedOrderBy=[];for(var n=!1,r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}if(!n){var a=this.explicitOrderBy.length>0?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Tc.ASCENDING;this.memoizedOrderBy.push(a===Tc.ASCENDING?Cc:Dc)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),t.prototype.addFilter=function(e){zs(null==this.getInequalityFilterField()||!(e instanceof wc)||!e.isInequality()||e.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),zs(!this.isDocumentQuery(),"No filtering allowed for document query");var n=this.filters.concat([e]);return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),n,this.limit,this.startAt,this.endAt)},t.prototype.addOrderBy=function(e){zs(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var n=this.explicitOrderBy.concat([e]);return new t(this.path,this.collectionGroup,n,this.filters.slice(),this.limit,this.startAt,this.endAt)},t.prototype.withLimit=function(e){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),e,this.startAt,this.endAt)},t.prototype.withStartAt=function(e){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,e,this.endAt)},t.prototype.withEndAt=function(e){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,e)},t.prototype.asCollectionQueryAtPath=function(e){return new t(e,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)},t.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var t=this.path.canonicalString();this.isCollectionGroupQuery()&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(var e=0,n=this.filters;e<n.length;e++){t+=n[e].canonicalId(),t+=","}t+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++){t+=i[r].canonicalId(),t+=","}pc(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.memoizedCanonicalId=t}return this.memoizedCanonicalId},t.prototype.toString=function(){var t="Query("+this.path.canonicalString();return this.isCollectionGroupQuery()&&(t+=" collectionGroup="+this.collectionGroup),this.filters.length>0&&(t+=", filters: ["+this.filters.join(", ")+"]"),pc(this.limit)||(t+=", limit: "+this.limit),this.explicitOrderBy.length>0&&(t+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),t+")"},t.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return this.collectionGroup===t.collectionGroup&&(!!this.path.isEqual(t.path)&&(!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)))},t.prototype.docComparator=function(t,e){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],a=o.compare(t,e);if(0!==a)return a;n=n||o.field.isKeyField()}return zs(n,"orderBy used that doesn't compare on key field"),0},t.prototype.matches=function(t){return this.matchesPathAndCollectionGroup(t)&&this.matchesOrderBy(t)&&this.matchesFilters(t)&&this.matchesBounds(t)},t.prototype.hasLimit=function(){return!pc(this.limit)},t.prototype.getFirstOrderByField=function(){return this.explicitOrderBy.length>0?this.explicitOrderBy[0].field:null},t.prototype.getInequalityFilterField=function(){for(var t=0,e=this.filters;t<e.length;t++){var n=e[t];if(n instanceof wc&&n.isInequality())return n.field}return null},t.prototype.hasArrayContainsFilter=function(){return void 0!==this.filters.find(function(t){return t instanceof wc&&t.op===bc.ARRAY_CONTAINS})},t.prototype.isDocumentQuery=function(){return Bu.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},t.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},t.prototype.matchesPathAndCollectionGroup=function(t){var e=t.key.path;return null!==this.collectionGroup?t.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(e):Bu.isDocumentKey(this.path)?this.path.isEqual(e):this.path.isImmediateParentOf(e)},t.prototype.matchesOrderBy=function(t){for(var e=0,n=this.explicitOrderBy;e<n.length;e++){var r=n[e];if(!r.field.isKeyField()&&void 0===t.field(r.field))return!1}return!0},t.prototype.matchesFilters=function(t){for(var e=0,n=this.filters;e<n.length;e++){if(!n[e].matches(t))return!1}return!0},t.prototype.matchesBounds=function(t){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,t))&&(!this.endAt||!this.endAt.sortsBeforeDocument(this.orderBy,t))},t.prototype.assertValidBound=function(t){zs(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},t}(),vc=function(){function t(){}return t.create=function(t,e,n){if(n.isEqual(Xu.INSTANCE)){if(e!==bc.EQUAL)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on null.");return new Ec(t)}if(n.isEqual(ec.NAN)){if(e!==bc.EQUAL)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on NaN.");return new Sc(t)}return new wc(t,e,n)},t}(),bc=function(){function t(t){this.name=t}return t.fromString=function(e){switch(e){case"<":return t.LESS_THAN;case"<=":return t.LESS_THAN_OR_EQUAL;case"==":return t.EQUAL;case">=":return t.GREATER_THAN_OR_EQUAL;case">":return t.GREATER_THAN;case"array-contains":return t.ARRAY_CONTAINS;default:return Qs("Unknown relation: "+e)}},t.prototype.toString=function(){return this.name},t.prototype.isEqual=function(t){return this.name===t.name},t.LESS_THAN=new t("<"),t.LESS_THAN_OR_EQUAL=new t("<="),t.EQUAL=new t("=="),t.GREATER_THAN=new t(">"),t.GREATER_THAN_OR_EQUAL=new t(">="),t.ARRAY_CONTAINS=new t("array-contains"),t}(),wc=function(t){function e(e,n,r){var i=t.call(this)||this;return i.field=e,i.op=n,i.value=r,i}return $n(e,t),e.prototype.matches=function(t){if(this.field.isKeyField()){zs(this.value instanceof ac,"Comparing on key, but filter value not a RefValue"),zs(this.op!==bc.ARRAY_CONTAINS,"array-contains queries don't make sense on document keys.");var e=this.value,n=Bu.comparator(t.key,e.key);return this.matchesComparison(n)}var r=t.field(this.field);return void 0!==r&&this.matchesValue(r)},e.prototype.matchesValue=function(t){var e=this;return this.op===bc.ARRAY_CONTAINS?t instanceof cc&&void 0!==t.internalValue.find(function(t){return t.isEqual(e.value)}):this.value.typeOrder===t.typeOrder&&this.matchesComparison(t.compareTo(this.value))},e.prototype.matchesComparison=function(t){switch(this.op){case bc.LESS_THAN:return t<0;case bc.LESS_THAN_OR_EQUAL:return t<=0;case bc.EQUAL:return 0===t;case bc.GREATER_THAN:return t>0;case bc.GREATER_THAN_OR_EQUAL:return t>=0;default:return Qs("Unknown relation op"+this.op)}},e.prototype.isInequality=function(){return this.op!==bc.EQUAL&&this.op!==bc.ARRAY_CONTAINS},e.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},e.prototype.isEqual=function(t){return t instanceof e&&(this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value))},e.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},e}(vc),Ec=function(t){function e(e){var n=t.call(this)||this;return n.field=e,n}return $n(e,t),e.prototype.matches=function(t){var e=t.field(this.field);return void 0!==e&&null===e.value()},e.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"},e.prototype.toString=function(){return this.field.canonicalString()+" IS null"},e.prototype.isEqual=function(t){return t instanceof e&&this.field.isEqual(t.field)},e}(vc),Sc=function(t){function e(e){var n=t.call(this)||this;return n.field=e,n}return $n(e,t),e.prototype.matches=function(t){var e=t.field(this.field),n=e&&e.value();return"number"==typeof n&&isNaN(n)},e.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"},e.prototype.toString=function(){return this.field.canonicalString()+" IS NaN"},e.prototype.isEqual=function(t){return t instanceof e&&this.field.isEqual(t.field)},e}(vc),Tc=function(){function t(t){this.name=t}return t.prototype.toString=function(){return this.name},t.ASCENDING=new t("asc"),t.DESCENDING=new t("desc"),t}(),_c=function(){function t(t,e){this.position=t,this.before=e}return t.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",e=0,n=this.position;e<n.length;e++){t+=n[e].toString()}return t},t.prototype.sortsBeforeDocument=function(t,e){zs(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i=t[r],o=this.position[r];if(i.field.isKeyField())zs(o instanceof ac,"Bound has a non-key value where the key path is being used."),n=Bu.comparator(o.key,e.key);else{var a=e.field(i.field);zs(void 0!==a,"Field should exist since document matched the orderBy already."),n=o.compareTo(a)}if(i.dir===Tc.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},t.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var e=0;e<this.position.length;e++){var n=this.position[e],r=t.position[e];return n.isEqual(r)}return!0},t}(),Ic=function(){function t(t,e){this.field=t,void 0===e&&(e=Tc.ASCENDING),this.dir=e,this.isKeyOrderBy=t.isKeyField()}return t.prototype.compare=function(t,e){var n=this.isKeyOrderBy?Uu.compareByKey(t,e):Uu.compareByField(this.field,t,e);switch(this.dir){case Tc.ASCENDING:return n;case Tc.DESCENDING:return-1*n;default:return Qs("Unknown direction: "+this.dir)}},t.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},t.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},t.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},t}(),Cc=new Ic(qu.keyField(),Tc.ASCENDING),Dc=new Ic(qu.keyField(),Tc.DESCENDING),Ac=function(){function t(t){this.timestamp=t}return t.fromMicroseconds=function(e){var n=Math.floor(e/1e6);return new t(new Mu(n,e%1e6*1e3))},t.fromTimestamp=function(e){return new t(e)},t.forDeletedDoc=function(){return t.MIN},t.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},t.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},t.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},t.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},t.prototype.toTimestamp=function(){return this.timestamp},t.MIN=new t(new Mu(0,0)),t}();!function(t){t[t.Listen=0]="Listen",t[t.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",t[t.LimboResolution=2]="LimboResolution"}(yc||(yc={}));var kc,Nc=function(){function t(t,e,n,r,i,o){void 0===i&&(i=Ac.MIN),void 0===o&&(o=Ws()),this.query=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.resumeToken=o}return t.prototype.copy=function(e){return new t(this.query,this.targetId,this.purpose,void 0===e.sequenceNumber?this.sequenceNumber:e.sequenceNumber,void 0===e.snapshotVersion?this.snapshotVersion:e.snapshotVersion,void 0===e.resumeToken?this.resumeToken:e.resumeToken)},t.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.purpose===t.purpose&&this.sequenceNumber===t.sequenceNumber&&this.snapshotVersion.isEqual(t.snapshotVersion)&&this.resumeToken===t.resumeToken&&this.query.isEqual(t.query)},t}(),Mc=function(){function t(t){this.comparator=t,this.data=new Qu(this.comparator)}return t.fromMapKeys=function(e){var n=new t(e.comparator);return e.forEach(function(t){n=n.add(t)}),n},t.prototype.has=function(t){return null!==this.data.get(t)},t.prototype.first=function(){return this.data.minKey()},t.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(t.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),t.prototype.indexOf=function(t){return this.data.indexOf(t)},t.prototype.forEach=function(t){this.data.inorderTraversal(function(e,n){return t(e),!1})},t.prototype.forEachInRange=function(t,e){for(var n=this.data.getIteratorFrom(t[0]);n.hasNext();){var r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}},t.prototype.forEachWhile=function(t,e){var n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();){if(!t(n.getNext().key))return}},t.prototype.firstAfterOrEqual=function(t){var e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null},t.prototype.getIterator=function(){return new Oc(this.data.getIterator())},t.prototype.getIteratorFrom=function(t){return new Oc(this.data.getIteratorFrom(t))},t.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},t.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},t.prototype.isEmpty=function(){return this.data.isEmpty()},t.prototype.unionWith=function(t){var e=this;return t.forEach(function(t){e=e.add(t)}),e},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.data.getIterator(),r=e.data.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(0!==this.comparator(i,o))return!1}return!0},t.prototype.toArray=function(){var t=[];return this.forEach(function(e){t.push(e)}),t},t.prototype.toString=function(){var t=[];return this.forEach(function(e){return t.push(e)}),"SortedSet("+t.toString()+")"},t.prototype.copy=function(e){var n=new t(this.comparator);return n.data=e,n},t}(),Oc=function(){function t(t){this.iter=t}return t.prototype.getNext=function(){return this.iter.getNext().key},t.prototype.hasNext=function(){return this.iter.hasNext()},t}(),Rc=function(){function t(t){this.fields=t}return t.fromSet=function(e){return new t(e)},t.fromArray=function(e){var n=new Mc(qu.comparator);return e.forEach(function(t){return n=n.add(t)}),new t(n)},t.prototype.covers=function(t){var e=!1;return this.fields.forEach(function(n){n.isPrefixOf(t)&&(e=!0)}),e},t.prototype.applyTo=function(t){var e=uc.EMPTY;return this.fields.forEach(function(n){if(n.isEmpty())return t;var r=t.field(n);void 0!==r&&(e=e.set(n,r))}),e},t.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},t}(),Pc=function(){function t(t,e){this.field=t,this.transform=e}return Object.defineProperty(t.prototype,"isIdempotent",{get:function(){return this.transform.isIdempotent},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},t}(),Lc=function(){return function(t,e){this.version=t,this.transformResults=e}}();!function(t){t[t.Set=0]="Set",t[t.Patch=1]="Patch",t[t.Transform=2]="Transform",t[t.Delete=3]="Delete"}(kc||(kc={}));var xc=function(){function t(t,e){this.updateTime=t,this.exists=e,zs(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}return t.exists=function(e){return new t(void 0,e)},t.updateTime=function(e){return new t(e)},Object.defineProperty(t.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),t.prototype.isValidFor=function(t){return void 0!==this.updateTime?t instanceof Uu&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof Uu:(zs(this.isNone,"Precondition should be empty"),!0)},t.prototype.isEqual=function(t){return e=this.updateTime,n=t.updateTime,(null!=e?!(!n||!e.isEqual(n)):e===n)&&this.exists===t.exists;var e,n},t.NONE=new t,t}(),Fc=function(){function t(){}return t.prototype.verifyKeyMatches=function(t){null!=t&&zs(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},t.getPostMutationVersion=function(t){return t instanceof Uu?t.version:Ac.MIN},t}(),qc=function(t){function e(e,n,r){var i=t.call(this)||this;return i.key=e,i.value=n,i.precondition=r,i.type=kc.Set,i}return $n(e,t),e.prototype.applyToRemoteDocument=function(t,e){this.verifyKeyMatches(t),zs(null==e.transformResults,"Transform results received by SetMutation.");var n=e.version;return new Uu(this.key,n,this.value,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Fc.getPostMutationVersion(t);return new Uu(this.key,r,this.value,{hasLocalMutations:!0})},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.precondition.isEqual(t.precondition)},e}(Fc),Bc=function(t){function e(e,n,r,i){var o=t.call(this)||this;return o.key=e,o.data=n,o.fieldMask=r,o.precondition=i,o.type=kc.Patch,o}return $n(e,t),e.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),zs(null==e.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(t))return new Ku(this.key,e.version);var n=this.patchDocument(t);return new Uu(this.key,e.version,n,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Fc.getPostMutationVersion(t),i=this.patchDocument(t);return new Uu(this.key,r,i,{hasLocalMutations:!0})},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.fieldMask.isEqual(t.fieldMask)&&this.precondition.isEqual(t.precondition)},e.prototype.patchDocument=function(t){var e;return e=t instanceof Uu?t.data:uc.EMPTY,this.patchObject(e)},e.prototype.patchObject=function(t){var e=this;return this.fieldMask.fields.forEach(function(n){if(!n.isEmpty()){var r=e.data.field(n);t=void 0!==r?t.set(n,r):t.delete(n)}}),t},e}(Fc),Vc=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r.fieldTransforms=n,r.type=kc.Transform,r.precondition=xc.exists(!0),r}return $n(e,t),e.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),zs(null!=e.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(t))return new Ku(this.key,e.version);var n=this.requireDocument(t),r=this.serverTransformResults(t,e.transformResults),i=e.version,o=this.transformObject(n.data,r);return new Uu(this.key,i,o,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=this.requireDocument(t),i=this.localTransformResults(n,e),o=this.transformObject(r.data,i);return new Uu(this.key,r.version,o,{hasLocalMutations:!0})},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){for(var t=0,e=this.fieldTransforms;t<e.length;t++){if(!e[t].isIdempotent)return!1}return!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldMask",{get:function(){var t=new Mc(qu.comparator);return this.fieldTransforms.forEach(function(e){return t=t.add(e.field)}),new Rc(t)},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&Su(this.fieldTransforms,t.fieldTransforms)&&this.precondition.isEqual(t.precondition)},e.prototype.requireDocument=function(t){zs(t instanceof Uu,"Unknown MaybeDocument type "+t);var e=t;return zs(e.key.isEqual(this.key),"Can only transform a document with the same key"),e},e.prototype.serverTransformResults=function(t,e){var n=[];zs(this.fieldTransforms.length===e.length,"server transform result count ("+e.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<e.length;r++){var i=this.fieldTransforms[r],o=i.transform,a=null;t instanceof Uu&&(a=t.field(i.field)||null),n.push(o.applyToRemoteDocument(a,e[r]))}return n},e.prototype.localTransformResults=function(t,e){for(var n=[],r=0,i=this.fieldTransforms;r<i.length;r++){var o=i[r],a=o.transform,s=null;e instanceof Uu&&(s=e.field(o.field)||null),n.push(a.applyToLocalView(s,t))}return n},e.prototype.transformObject=function(t,e){zs(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n].field;t=t.set(r,e[n])}return t},e}(Fc),Uc=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r.precondition=n,r.type=kc.Delete,r}return $n(e,t),e.prototype.applyToRemoteDocument=function(t,e){return this.verifyKeyMatches(t),zs(null==e.transformResults,"Transform results received by DeleteMutation."),new ju(this.key,e.version,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){return this.verifyKeyMatches(t),this.precondition.isValidFor(t)?(t&&zs(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new ju(this.key,Ac.forDeletedDoc())):t},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.precondition.isEqual(t.precondition)},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0}),e}(Fc),jc=function(){function t(){this.isIdempotent=!0}return t.prototype.applyToLocalView=function(t,e){return new ic(e,t)},t.prototype.applyToRemoteDocument=function(t,e){return e},t.prototype.isEqual=function(e){return e instanceof t},t.instance=new t,t}(),Kc=function(){function t(t){this.elements=t,this.isIdempotent=!0}return t.prototype.applyToLocalView=function(t,e){return this.apply(t)},t.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},t.prototype.apply=function(t){for(var e=Gc(t),n=function(t){e.find(function(e){return e.isEqual(t)})||e.push(t)},r=0,i=this.elements;r<i.length;r++){n(i[r])}return new cc(e)},t.prototype.isEqual=function(e){return e instanceof t&&Su(e.elements,this.elements)},t}(),Qc=function(){function t(t){this.elements=t,this.isIdempotent=!0}return t.prototype.applyToLocalView=function(t,e){return this.apply(t)},t.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},t.prototype.apply=function(t){for(var e=Gc(t),n=function(t){e=e.filter(function(e){return!e.isEqual(t)})},r=0,i=this.elements;r<i.length;r++){n(i[r])}return new cc(e)},t.prototype.isEqual=function(e){return e instanceof t&&Su(e.elements,this.elements)},t}(),zc=function(){function t(t){this.operand=t,this.isIdempotent=!1}return t.prototype.applyToLocalView=function(t,e){if(t instanceof tc&&this.operand instanceof tc){var n=t.internalValue+this.operand.internalValue;return new tc(n)}if(t instanceof $u){n=t.internalValue+this.operand.internalValue;return new ec(n)}return this.operand},t.prototype.applyToRemoteDocument=function(t,e){return zs(null!==e,"Didn't receive transformResult for NUMERIC_ADD transform"),e},t.prototype.isEqual=function(e){return e instanceof t&&this.operand.isEqual(e.operand)},t}();function Gc(t){return t instanceof cc?t.internalValue.slice():[]}var Wc,Hc=function(){function t(t){this.count=t}return t.prototype.isEqual=function(t){return t&&t.count===this.count},t}();function Yc(t){switch(t){case Hs.OK:return Qs("Treated status OK as error");case Hs.CANCELLED:case Hs.UNKNOWN:case Hs.DEADLINE_EXCEEDED:case Hs.RESOURCE_EXHAUSTED:case Hs.INTERNAL:case Hs.UNAVAILABLE:case Hs.UNAUTHENTICATED:return!1;case Hs.INVALID_ARGUMENT:case Hs.NOT_FOUND:case Hs.ALREADY_EXISTS:case Hs.PERMISSION_DENIED:case Hs.FAILED_PRECONDITION:case Hs.ABORTED:case Hs.OUT_OF_RANGE:case Hs.UNIMPLEMENTED:case Hs.DATA_LOSS:return!0;default:return Qs("Unknown status code: "+t)}}function Xc(t){if(void 0===t)return js("GRPC error has no .code"),Hs.UNKNOWN;switch(t){case Wc.OK:return Hs.OK;case Wc.CANCELLED:return Hs.CANCELLED;case Wc.UNKNOWN:return Hs.UNKNOWN;case Wc.DEADLINE_EXCEEDED:return Hs.DEADLINE_EXCEEDED;case Wc.RESOURCE_EXHAUSTED:return Hs.RESOURCE_EXHAUSTED;case Wc.INTERNAL:return Hs.INTERNAL;case Wc.UNAVAILABLE:return Hs.UNAVAILABLE;case Wc.UNAUTHENTICATED:return Hs.UNAUTHENTICATED;case Wc.INVALID_ARGUMENT:return Hs.INVALID_ARGUMENT;case Wc.NOT_FOUND:return Hs.NOT_FOUND;case Wc.ALREADY_EXISTS:return Hs.ALREADY_EXISTS;case Wc.PERMISSION_DENIED:return Hs.PERMISSION_DENIED;case Wc.FAILED_PRECONDITION:return Hs.FAILED_PRECONDITION;case Wc.ABORTED:return Hs.ABORTED;case Wc.OUT_OF_RANGE:return Hs.OUT_OF_RANGE;case Wc.UNIMPLEMENTED:return Hs.UNIMPLEMENTED;case Wc.DATA_LOSS:return Hs.DATA_LOSS;default:return Qs("Unknown status code: "+t)}}function Jc(t){if(void 0===t)return Wc.OK;switch(t){case Hs.OK:return Wc.OK;case Hs.CANCELLED:return Wc.CANCELLED;case Hs.UNKNOWN:return Wc.UNKNOWN;case Hs.DEADLINE_EXCEEDED:return Wc.DEADLINE_EXCEEDED;case Hs.RESOURCE_EXHAUSTED:return Wc.RESOURCE_EXHAUSTED;case Hs.INTERNAL:return Wc.INTERNAL;case Hs.UNAVAILABLE:return Wc.UNAVAILABLE;case Hs.UNAUTHENTICATED:return Wc.UNAUTHENTICATED;case Hs.INVALID_ARGUMENT:return Wc.INVALID_ARGUMENT;case Hs.NOT_FOUND:return Wc.NOT_FOUND;case Hs.ALREADY_EXISTS:return Wc.ALREADY_EXISTS;case Hs.PERMISSION_DENIED:return Wc.PERMISSION_DENIED;case Hs.FAILED_PRECONDITION:return Wc.FAILED_PRECONDITION;case Hs.ABORTED:return Wc.ABORTED;case Hs.OUT_OF_RANGE:return Wc.OUT_OF_RANGE;case Hs.UNIMPLEMENTED:return Wc.UNIMPLEMENTED;case Hs.DATA_LOSS:return Wc.DATA_LOSS;default:return Qs("Unknown status code: "+t)}}!function(t){t[t.OK=0]="OK",t[t.CANCELLED=1]="CANCELLED",t[t.UNKNOWN=2]="UNKNOWN",t[t.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",t[t.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",t[t.NOT_FOUND=5]="NOT_FOUND",t[t.ALREADY_EXISTS=6]="ALREADY_EXISTS",t[t.PERMISSION_DENIED=7]="PERMISSION_DENIED",t[t.UNAUTHENTICATED=16]="UNAUTHENTICATED",t[t.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",t[t.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",t[t.ABORTED=10]="ABORTED",t[t.OUT_OF_RANGE=11]="OUT_OF_RANGE",t[t.UNIMPLEMENTED=12]="UNIMPLEMENTED",t[t.INTERNAL=13]="INTERNAL",t[t.UNAVAILABLE=14]="UNAVAILABLE",t[t.DATA_LOSS=15]="DATA_LOSS"}(Wc||(Wc={}));var $c=new Qu(Bu.comparator);function Zc(){return $c}function th(){return Zc()}var eh=new Qu(Bu.comparator);function nh(){return eh}var rh=new Qu(Bu.comparator);function ih(){return rh}var oh=new Mc(Bu.comparator);function ah(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=oh,r=0,i=t;r<i.length;r++){var o=i[r];n=n.add(o)}return n}var sh=new Mc(Eu);function uh(){return sh}var ch,hh,lh=function(){function t(t){this.comparator=t?function(e,n){return t(e,n)||Bu.comparator(e.key,n.key)}:function(t,e){return Bu.comparator(t.key,e.key)},this.keyedMap=nh(),this.sortedSet=new Qu(this.comparator)}return t.emptySet=function(e){return new t(e.comparator)},t.prototype.has=function(t){return null!=this.keyedMap.get(t)},t.prototype.get=function(t){return this.keyedMap.get(t)},t.prototype.first=function(){return this.sortedSet.minKey()},t.prototype.last=function(){return this.sortedSet.maxKey()},t.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},t.prototype.indexOf=function(t){var e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1},Object.defineProperty(t.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t){this.sortedSet.inorderTraversal(function(e,n){return t(e),!1})},t.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))},t.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(!i.isEqual(o))return!1}return!0},t.prototype.toString=function(){var t=[];return this.forEach(function(e){t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"},t.prototype.copy=function(e,n){var r=new t;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=n,r},t}();!function(t){t[t.Added=0]="Added",t[t.Removed=1]="Removed",t[t.Modified=2]="Modified",t[t.Metadata=3]="Metadata"}(ch||(ch={})),function(t){t[t.Local=0]="Local",t[t.Synced=1]="Synced"}(hh||(hh={}));var fh,dh=function(){function t(){this.changeMap=new Qu(Bu.comparator)}return t.prototype.track=function(t){var e=t.doc.key,n=this.changeMap.get(e);n?t.type!==ch.Added&&n.type===ch.Metadata?this.changeMap=this.changeMap.insert(e,t):t.type===ch.Metadata&&n.type!==ch.Removed?this.changeMap=this.changeMap.insert(e,{type:n.type,doc:t.doc}):t.type===ch.Modified&&n.type===ch.Modified?this.changeMap=this.changeMap.insert(e,{type:ch.Modified,doc:t.doc}):t.type===ch.Modified&&n.type===ch.Added?this.changeMap=this.changeMap.insert(e,{type:ch.Added,doc:t.doc}):t.type===ch.Removed&&n.type===ch.Added?this.changeMap=this.changeMap.remove(e):t.type===ch.Removed&&n.type===ch.Modified?this.changeMap=this.changeMap.insert(e,{type:ch.Removed,doc:n.doc}):t.type===ch.Added&&n.type===ch.Removed?this.changeMap=this.changeMap.insert(e,{type:ch.Modified,doc:t.doc}):Qs("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(n)):this.changeMap=this.changeMap.insert(e,t)},t.prototype.getChanges=function(){var t=[];return this.changeMap.inorderTraversal(function(e,n){t.push(n)}),t},t}(),ph=function(){function t(t,e,n,r,i,o,a,s){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}return t.fromInitialDocuments=function(e,n,r,i){var o=[];return n.forEach(function(t){o.push({type:ch.Added,doc:t})}),new t(e,n,lh.emptySet(n),o,r,i,!0,!1)},Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},t}(),mh=function(){function t(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}return t.createSynthesizedRemoteEventForCurrentChange=function(e,n){var r,i=((r={})[e]=yh.createSynthesizedTargetChangeForCurrentChange(e,n),r);return new t(Ac.MIN,i,uh(),Zc(),ah())},t}(),yh=function(){function t(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}return t.createSynthesizedTargetChangeForCurrentChange=function(e,n){return new t(Ws(),n,ah(),ah(),ah())},t}(),gh=function(){return function(t,e,n,r){this.updatedTargetIds=t,this.removedTargetIds=e,this.key=n,this.newDoc=r}}(),vh=function(){return function(t,e){this.targetId=t,this.existenceFilter=e}}();!function(t){t[t.NoChange=0]="NoChange",t[t.Added=1]="Added",t[t.Removed=2]="Removed",t[t.Current=3]="Current",t[t.Reset=4]="Reset"}(fh||(fh={}));var bh=function(){return function(t,e,n,r){void 0===n&&(n=Ws()),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}(),wh=function(){function t(){this.pendingResponses=0,this.documentChanges=Th(),this._resumeToken=Ws(),this._current=!1,this._hasPendingChanges=!0}return Object.defineProperty(t.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),t.prototype.updateResumeToken=function(t){t.length>0&&(this._hasPendingChanges=!0,this._resumeToken=t)},t.prototype.toTargetChange=function(){var t=ah(),e=ah(),n=ah();return this.documentChanges.forEach(function(r,i){switch(i){case ch.Added:t=t.add(r);break;case ch.Modified:e=e.add(r);break;case ch.Removed:n=n.add(r);break;default:Qs("Encountered invalid change type: "+i)}}),new yh(this._resumeToken,this._current,t,e,n)},t.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=Th()},t.prototype.addDocumentChange=function(t,e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(t,e)},t.prototype.removeDocumentChange=function(t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(t)},t.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},t.prototype.recordTargetResponse=function(){this.pendingResponses-=1},t.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},t}(),Eh=function(){function t(t){this.metadataProvider=t,this.targetStates={},this.pendingDocumentUpdates=Zc(),this.pendingDocumentTargetMapping=Sh(),this.pendingTargetResets=new Mc(Eu)}return t.prototype.handleDocumentChange=function(t){for(var e=0,n=t.updatedTargetIds;e<n.length;e++){var r=n[e];t.newDoc instanceof Uu?this.addDocumentToTarget(r,t.newDoc):t.newDoc instanceof ju&&this.removeDocumentFromTarget(r,t.key,t.newDoc)}for(var i=0,o=t.removedTargetIds;i<o.length;i++){r=o[i];this.removeDocumentFromTarget(r,t.key,t.newDoc)}},t.prototype.handleTargetChange=function(t){var e=this;this.forEachTarget(t,function(n){var r=e.ensureTargetState(n);switch(t.state){case fh.NoChange:e.isActiveTarget(n)&&r.updateResumeToken(t.resumeToken);break;case fh.Added:r.recordTargetResponse(),r.isPending||r.clearPendingChanges(),r.updateResumeToken(t.resumeToken);break;case fh.Removed:r.recordTargetResponse(),r.isPending||e.removeTarget(n),zs(!t.cause,"WatchChangeAggregator does not handle errored targets");break;case fh.Current:e.isActiveTarget(n)&&(r.markCurrent(),r.updateResumeToken(t.resumeToken));break;case fh.Reset:e.isActiveTarget(n)&&(e.resetTarget(n),r.updateResumeToken(t.resumeToken));break;default:Qs("Unknown target watch change state: "+t.state)}})},t.prototype.forEachTarget=function(t,e){t.targetIds.length>0?t.targetIds.forEach(e):Zs(this.targetStates,e)},t.prototype.handleExistenceFilter=function(t){var e=t.targetId,n=t.existenceFilter.count,r=this.queryDataForActiveTarget(e);if(r){var i=r.query;if(i.isDocumentQuery())if(0===n){var o=new Bu(i.path);this.removeDocumentFromTarget(e,o,new ju(o,Ac.forDeletedDoc()))}else zs(1===n,"Single document existence filter with count: "+n);else this.getCurrentDocumentCountForTarget(e)!==n&&(this.resetTarget(e),this.pendingTargetResets=this.pendingTargetResets.add(e))}},t.prototype.createRemoteEvent=function(t){var e=this,n={};Zs(this.targetStates,function(r,i){var o=e.queryDataForActiveTarget(r);if(o){if(i.current&&o.query.isDocumentQuery()){var a=new Bu(o.query.path);null!==e.pendingDocumentUpdates.get(a)||e.targetContainsDocument(r,a)||e.removeDocumentFromTarget(r,a,new ju(a,t))}i.hasPendingChanges&&(n[r]=i.toTargetChange(),i.clearPendingChanges())}});var r=ah();this.pendingDocumentTargetMapping.forEach(function(t,n){var i=!0;n.forEachWhile(function(t){var n=e.queryDataForActiveTarget(t);return!n||n.purpose===yc.LimboResolution||(i=!1,!1)}),i&&(r=r.add(t))});var i=new mh(t,n,this.pendingTargetResets,this.pendingDocumentUpdates,r);return this.pendingDocumentUpdates=Zc(),this.pendingDocumentTargetMapping=Sh(),this.pendingTargetResets=new Mc(Eu),i},t.prototype.addDocumentToTarget=function(t,e){if(this.isActiveTarget(t)){var n=this.targetContainsDocument(t,e.key)?ch.Modified:ch.Added;this.ensureTargetState(t).addDocumentChange(e.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e.key,e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e.key,this.ensureDocumentTargetMapping(e.key).add(t))}},t.prototype.removeDocumentFromTarget=function(t,e,n){if(this.isActiveTarget(t)){var r=this.ensureTargetState(t);this.targetContainsDocument(t,e)?r.addDocumentChange(e,ch.Removed):r.removeDocumentChange(e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,this.ensureDocumentTargetMapping(e).delete(t)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e,n))}},t.prototype.removeTarget=function(t){delete this.targetStates[t]},t.prototype.getCurrentDocumentCountForTarget=function(t){var e=this.ensureTargetState(t).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size},t.prototype.recordPendingTargetRequest=function(t){this.ensureTargetState(t).recordPendingTargetRequest()},t.prototype.ensureTargetState=function(t){return this.targetStates[t]||(this.targetStates[t]=new wh),this.targetStates[t]},t.prototype.ensureDocumentTargetMapping=function(t){var e=this.pendingDocumentTargetMapping.get(t);return e||(e=new Mc(Eu),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,e)),e},t.prototype.isActiveTarget=function(t){return null!==this.queryDataForActiveTarget(t)},t.prototype.queryDataForActiveTarget=function(t){var e=this.targetStates[t];return e&&e.isPending?null:this.metadataProvider.getQueryDataForTarget(t)},t.prototype.resetTarget=function(t){var e=this;zs(!this.targetStates[t].isPending,"Should only reset active targets"),this.targetStates[t]=new wh,this.metadataProvider.getRemoteKeysForTarget(t).forEach(function(n){e.removeDocumentFromTarget(t,n,null)})},t.prototype.targetContainsDocument=function(t,e){return this.metadataProvider.getRemoteKeysForTarget(t).has(e)},t}();function Sh(){return new Qu(Bu.comparator)}function Th(){return new Qu(Bu.comparator)}var _h,Ih,Ch=((_h={})[Tc.ASCENDING.name]="ASCENDING",_h[Tc.DESCENDING.name]="DESCENDING",_h),Dh=((Ih={})[bc.LESS_THAN.name]="LESS_THAN",Ih[bc.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",Ih[bc.GREATER_THAN.name]="GREATER_THAN",Ih[bc.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",Ih[bc.EQUAL.name]="EQUAL",Ih[bc.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",Ih),Ah=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function kh(t,e){zs(!pc(t),e+" is missing")}function Nh(t){return"number"==typeof t?t:"string"==typeof t?Number(t):Qs("can't parse "+t)}var Mh=function(){function t(t,e){this.databaseId=t,this.options=e}return t.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},t.prototype.unsafeCastProtoByteString=function(t){return t},t.prototype.fromRpcStatus=function(t){var e=void 0===t.code?Hs.UNKNOWN:Xc(t.code);return new Ys(e,t.message||"")},t.prototype.toInt32Value=function(t){return pc(t)?void 0:{value:t}},t.prototype.fromInt32Value=function(t){var e;return pc(e="object"==typeof t?t.value:t)?null:e},t.prototype.toTimestamp=function(t){return{seconds:t.seconds,nanos:t.nanoseconds}},t.prototype.fromTimestamp=function(t){if("string"==typeof t)return this.fromIso8601String(t);zs(!!t,"Cannot deserialize null or undefined timestamp.");var e=Nh(t.seconds||"0"),n=t.nanos||0;return new Mu(e,n)},t.prototype.fromIso8601String=function(t){var e=0,n=Ah.exec(t);if(zs(!!n,"invalid timestamp: "+t),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),e=Number(r)}var i=new Date(t),o=Math.floor(i.getTime()/1e3);return new Mu(o,e)},t.prototype.toBytes=function(t){return this.options.useProto3Json?t.toBase64():this.unsafeCastProtoByteString(t.toUint8Array())},t.prototype.fromBlob=function(t){return"string"==typeof t?(zs(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Au.fromBase64String(t)):(zs(!this.options.useProto3Json,"Expected bytes to be passed in as string, but got something else instead."),Au.fromUint8Array(t))},t.prototype.toVersion=function(t){return this.toTimestamp(t.toTimestamp())},t.prototype.fromVersion=function(t){return zs(!!t,"Trying to deserialize version that isn't set"),Ac.fromTimestamp(this.fromTimestamp(t))},t.prototype.toResourceName=function(t,e){return this.fullyQualifiedPrefixPath(t).child("documents").child(e).canonicalString()},t.prototype.fromResourceName=function(t){var e=xu.fromString(t);return zs(this.isValidResourceName(e),"Tried to deserialize invalid key "+e.toString()),e},t.prototype.toName=function(t){return this.toResourceName(this.databaseId,t.path)},t.prototype.fromName=function(t){var e=this.fromResourceName(t);return zs(e.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+e.get(1)+" vs "+this.databaseId.projectId),zs(!e.get(3)&&!this.databaseId.database||e.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+e.get(3)+" vs "+this.databaseId.database),new Bu(this.extractLocalPathFromResourceName(e))},t.prototype.toQueryPath=function(t){return this.toResourceName(this.databaseId,t)},t.prototype.fromQueryPath=function(t){var e=this.fromResourceName(t);return 4===e.length?xu.EMPTY_PATH:this.extractLocalPathFromResourceName(e)},Object.defineProperty(t.prototype,"encodedDatabaseId",{get:function(){return new xu(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),t.prototype.fullyQualifiedPrefixPath=function(t){return new xu(["projects",t.projectId,"databases",t.database])},t.prototype.extractLocalPathFromResourceName=function(t){return zs(t.length>4&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.popFirst(5)},t.prototype.isValidResourceName=function(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)},t.prototype.toValue=function(t){if(t instanceof Xu)return{nullValue:"NULL_VALUE"};if(t instanceof Ju)return{booleanValue:t.value()};if(t instanceof tc)return{integerValue:""+t.value()};if(t instanceof ec){var e=t.value();if(this.options.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof nc?{stringValue:t.value()}:t instanceof uc?{mapValue:this.toMapValue(t)}:t instanceof cc?{arrayValue:this.toArrayValue(t)}:t instanceof rc?{timestampValue:this.toTimestamp(t.internalValue)}:t instanceof sc?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof oc?{bytesValue:this.toBytes(t.value())}:t instanceof ac?{referenceValue:this.toResourceName(t.databaseId,t.key.path)}:Qs("Unknown FieldValue "+JSON.stringify(t))},t.prototype.fromValue=function(t){var e=this,n=t.value_type;if(Oh(t,n,"nullValue"))return Xu.INSTANCE;if(Oh(t,n,"booleanValue"))return Ju.of(t.booleanValue);if(Oh(t,n,"integerValue"))return new tc(Nh(t.integerValue));if(Oh(t,n,"doubleValue")){if(this.options.useProto3Json){if("NaN"===t.doubleValue)return ec.NAN;if("Infinity"===t.doubleValue)return ec.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return ec.NEGATIVE_INFINITY}return new ec(t.doubleValue)}if(Oh(t,n,"stringValue"))return new nc(t.stringValue);if(Oh(t,n,"mapValue"))return this.fromFields(t.mapValue.fields||{});if(Oh(t,n,"arrayValue")){kh(t.arrayValue,"arrayValue");var r=t.arrayValue.values||[];return new cc(r.map(function(t){return e.fromValue(t)}))}if(Oh(t,n,"timestampValue"))return kh(t.timestampValue,"timestampValue"),new rc(this.fromTimestamp(t.timestampValue));if(Oh(t,n,"geoPointValue")){kh(t.geoPointValue,"geoPointValue");var i=t.geoPointValue.latitude||0,o=t.geoPointValue.longitude||0;return new sc(new Nu(i,o))}if(Oh(t,n,"bytesValue")){kh(t.bytesValue,"bytesValue");var a=this.fromBlob(t.bytesValue);return new oc(a)}if(Oh(t,n,"referenceValue")){kh(t.referenceValue,"referenceValue");var s=this.fromResourceName(t.referenceValue),u=new Pu(s.get(1),s.get(3)),c=new Bu(this.extractLocalPathFromResourceName(s));return new ac(u,c)}return Qs("Unknown Value proto "+JSON.stringify(t))},t.prototype.toMutationDocument=function(t,e){return{name:this.toName(t),fields:this.toFields(e)}},t.prototype.toDocument=function(t){return zs(!t.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(t.key),fields:this.toFields(t.data),updateTime:this.toTimestamp(t.version.toTimestamp())}},t.prototype.fromDocument=function(t,e){return new Uu(this.fromName(t.name),this.fromVersion(t.updateTime),this.fromFields(t.fields||{}),{hasCommittedMutations:!!e})},t.prototype.toFields=function(t){var e=this,n={};return t.forEach(function(t,r){n[t]=e.toValue(r)}),n},t.prototype.fromFields=function(t){var e=this,n=t,r=uc.EMPTY;return tu(n,function(t,n){r=r.set(new qu([t]),e.fromValue(n))}),r},t.prototype.toMapValue=function(t){return{fields:this.toFields(t)}},t.prototype.toArrayValue=function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.toValue(t))}),{values:n}},t.prototype.fromFound=function(t){zs(!!t.found,"Tried to deserialize a found document from a missing document."),kh(t.found.name,"doc.found.name"),kh(t.found.updateTime,"doc.found.updateTime");var e=this.fromName(t.found.name),n=this.fromVersion(t.found.updateTime),r=this.fromFields(t.found.fields||{});return new Uu(e,n,r,{},t.found)},t.prototype.fromMissing=function(t){zs(!!t.missing,"Tried to deserialize a missing document from a found document."),zs(!!t.readTime,"Tried to deserialize a missing document without a read time.");var e=this.fromName(t.missing),n=this.fromVersion(t.readTime);return new ju(e,n)},t.prototype.fromMaybeDocument=function(t){var e=t.result;return Oh(t,e,"found")?this.fromFound(t):Oh(t,e,"missing")?this.fromMissing(t):Qs("invalid batch get response: "+JSON.stringify(t))},t.prototype.toWatchTargetChangeState=function(t){switch(t){case fh.Added:return"ADD";case fh.Current:return"CURRENT";case fh.NoChange:return"NO_CHANGE";case fh.Removed:return"REMOVE";case fh.Reset:return"RESET";default:return Qs("Unknown WatchTargetChangeState: "+t)}},t.prototype.toTestWatchChange=function(t){if(t instanceof vh)return{filter:{count:t.existenceFilter.count,targetId:t.targetId}};if(t instanceof gh){if(t.newDoc instanceof Uu){var e=t.newDoc;return{documentChange:{document:{name:this.toName(e.key),fields:this.toFields(e.data),updateTime:this.toVersion(e.version)},targetIds:t.updatedTargetIds,removedTargetIds:t.removedTargetIds}}}if(t.newDoc instanceof ju){e=t.newDoc;return{documentDelete:{document:this.toName(e.key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}}}if(null===t.newDoc)return{documentRemove:{document:this.toName(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof bh){var n=void 0;return t.cause&&(n={code:Jc(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(t.state),targetIds:t.targetIds,resumeToken:this.unsafeCastProtoByteString(t.resumeToken),cause:n}}}return Qs("Unrecognized watch change: "+JSON.stringify(t))},t.prototype.fromWatchChange=function(t){var e,n=t.response_type;if(Oh(t,n,"targetChange")){kh(t.targetChange,"targetChange");var r=this.fromWatchTargetChangeState(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],o=t.targetChange.resumeToken||this.emptyByteString(),a=t.targetChange.cause,s=a&&this.fromRpcStatus(a);e=new bh(r,i,o,s||null)}else if(Oh(t,n,"documentChange")){kh(t.documentChange,"documentChange"),kh(t.documentChange.document,"documentChange.name"),kh(t.documentChange.document.name,"documentChange.document.name"),kh(t.documentChange.document.updateTime,"documentChange.document.updateTime");var u=t.documentChange,c=this.fromName(u.document.name),h=this.fromVersion(u.document.updateTime),l=this.fromFields(u.document.fields||{}),f=new Uu(c,h,l,{},u.document),d=u.targetIds||[],p=u.removedTargetIds||[];e=new gh(d,p,f.key,f)}else if(Oh(t,n,"documentDelete")){kh(t.documentDelete,"documentDelete"),kh(t.documentDelete.document,"documentDelete.document");var m=t.documentDelete;c=this.fromName(m.document),h=m.readTime?this.fromVersion(m.readTime):Ac.forDeletedDoc(),f=new ju(c,h),p=m.removedTargetIds||[];e=new gh([],p,f.key,f)}else if(Oh(t,n,"documentRemove")){kh(t.documentRemove,"documentRemove"),kh(t.documentRemove.document,"documentRemove");var y=t.documentRemove;c=this.fromName(y.document),p=y.removedTargetIds||[];e=new gh([],p,c,null)}else{if(!Oh(t,n,"filter"))return Qs("Unknown change type "+JSON.stringify(t));kh(t.filter,"filter"),kh(t.filter.targetId,"filter.targetId");var g=t.filter,v=g.count||0,b=new Hc(v),w=g.targetId;e=new vh(w,b)}return e},t.prototype.fromWatchTargetChangeState=function(t){return"NO_CHANGE"===t?fh.NoChange:"ADD"===t?fh.Added:"REMOVE"===t?fh.Removed:"CURRENT"===t?fh.Current:"RESET"===t?fh.Reset:Qs("Got unexpected TargetChange.state: "+t)},t.prototype.versionFromListenResponse=function(t){if(!Oh(t,t.response_type,"targetChange"))return Ac.MIN;var e=t.targetChange;return e.targetIds&&e.targetIds.length?Ac.MIN:e.readTime?this.fromVersion(e.readTime):Ac.MIN},t.prototype.toMutation=function(t){var e,n=this;if(t instanceof qc)e={update:this.toMutationDocument(t.key,t.value)};else if(t instanceof Uc)e={delete:this.toName(t.key)};else if(t instanceof Bc)e={update:this.toMutationDocument(t.key,t.data),updateMask:this.toDocumentMask(t.fieldMask)};else{if(!(t instanceof Vc))return Qs("Unknown mutation type "+t.type);e={transform:{document:this.toName(t.key),fieldTransforms:t.fieldTransforms.map(function(t){return n.toFieldTransform(t)})}}}return t.precondition.isNone||(e.currentDocument=this.toPrecondition(t.precondition)),e},t.prototype.fromMutation=function(t){var e=this,n=t.currentDocument?this.fromPrecondition(t.currentDocument):xc.NONE;if(t.update){kh(t.update.name,"name");var r=this.fromName(t.update.name),i=this.fromFields(t.update.fields||{});if(t.updateMask){var o=this.fromDocumentMask(t.updateMask);return new Bc(r,i,o,n)}return new qc(r,i,n)}if(t.delete){r=this.fromName(t.delete);return new Uc(r,n)}if(t.transform){r=this.fromName(t.transform.document);var a=t.transform.fieldTransforms.map(function(t){return e.fromFieldTransform(t)});return zs(!0===n.exists,'Transforms only support precondition "exists == true"'),new Vc(r,a)}return Qs("unknown mutation proto: "+JSON.stringify(t))},t.prototype.toPrecondition=function(t){return zs(!t.isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:Qs("Unknown precondition")},t.prototype.fromPrecondition=function(t){return void 0!==t.updateTime?xc.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?xc.exists(t.exists):xc.NONE},t.prototype.fromWriteResult=function(t,e){var n=this,r=t.updateTime?this.fromVersion(t.updateTime):this.fromVersion(e),i=null;return t.transformResults&&t.transformResults.length>0&&(i=t.transformResults.map(function(t){return n.fromValue(t)})),new Lc(r,i)},t.prototype.fromWriteResults=function(t,e){var n=this;return t&&t.length>0?(zs(void 0!==e,"Received a write result without a commit time"),t.map(function(t){return n.fromWriteResult(t,e)})):[]},t.prototype.toFieldTransform=function(t){var e=this,n=t.transform;if(n instanceof jc)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Kc)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Qc)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof zc)return{fieldPath:t.field.canonicalString(),increment:this.toValue(n.operand)};throw Qs("Unknown transform: "+t.transform)},t.prototype.fromFieldTransform=function(t){var e=this,n=t.transform_type,r=null;if(Oh(t,n,"setToServerValue"))zs("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),r=jc.instance;else if(Oh(t,n,"appendMissingElements")){var i=t.appendMissingElements.values||[];r=new Kc(i.map(function(t){return e.fromValue(t)}))}else if(Oh(t,n,"removeAllFromArray")){i=t.removeAllFromArray.values||[];r=new Qc(i.map(function(t){return e.fromValue(t)}))}else if(Oh(t,n,"increment")){var o=this.fromValue(t.increment);zs(o instanceof $u,"NUMERIC_ADD transform requires a NumberValue"),r=new zc(o)}else Qs("Unknown transform proto: "+JSON.stringify(t));var a=qu.fromServerFormat(t.fieldPath);return new Pc(a,r)},t.prototype.toDocumentsTarget=function(t){return{documents:[this.toQueryPath(t.path)]}},t.prototype.fromDocumentsTarget=function(t){var e=t.documents.length;zs(1===e,"DocumentsTarget contained other than 1 document: "+e);var n=t.documents[0];return gc.atPath(this.fromQueryPath(n))},t.prototype.toQueryTarget=function(t){var e={structuredQuery:{}},n=t.path;null!==t.collectionGroup?(zs(n.length%2==0,"Collection Group queries should be within a document path or root."),e.parent=this.toQueryPath(n),e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(zs(n.length%2!=0,"Document queries with filters are not supported."),e.parent=this.toQueryPath(n.popLast()),e.structuredQuery.from=[{collectionId:n.lastSegment()}]);var r=this.toFilter(t.filters);r&&(e.structuredQuery.where=r);var i=this.toOrder(t.orderBy);i&&(e.structuredQuery.orderBy=i);var o=this.toInt32Value(t.limit);return void 0!==o&&(e.structuredQuery.limit=o),t.startAt&&(e.structuredQuery.startAt=this.toCursor(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.toCursor(t.endAt)),e},t.prototype.fromQueryTarget=function(t){var e=this.fromQueryPath(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0,i=null;if(r>0){zs(1===r,"StructuredQuery.from with more than one collection is not supported.");var o=n.from[0];o.allDescendants?i=o.collectionId:e=e.child(o.collectionId)}var a=[];n.where&&(a=this.fromFilter(n.where));var s=[];n.orderBy&&(s=this.fromOrder(n.orderBy));var u=null;n.limit&&(u=this.fromInt32Value(n.limit));var c=null;n.startAt&&(c=this.fromCursor(n.startAt));var h=null;return n.endAt&&(h=this.fromCursor(n.endAt)),new gc(e,i,s,a,u,c,h)},t.prototype.toListenRequestLabels=function(t){var e=this.toLabel(t.purpose);return null==e?null:{"goog-listen-tags":e}},t.prototype.toLabel=function(t){switch(t){case yc.Listen:return null;case yc.ExistenceFilterMismatch:return"existence-filter-mismatch";case yc.LimboResolution:return"limbo-document";default:return Qs("Unrecognized query purpose: "+t)}},t.prototype.toTarget=function(t){var e,n=t.query;return(e=n.isDocumentQuery()?{documents:this.toDocumentsTarget(n)}:{query:this.toQueryTarget(n)}).targetId=t.targetId,t.resumeToken.length>0&&(e.resumeToken=this.unsafeCastProtoByteString(t.resumeToken)),e},t.prototype.toFilter=function(t){var e=this;if(0!==t.length){var n=t.map(function(t){return t instanceof wc?e.toRelationFilter(t):e.toUnaryFilter(t)});return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},t.prototype.fromFilter=function(t){var e=this;return t?void 0!==t.unaryFilter?[this.fromUnaryFilter(t)]:void 0!==t.fieldFilter?[this.fromRelationFilter(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(function(t){return e.fromFilter(t)}).reduce(function(t,e){return t.concat(e)}):Qs("Unknown filter: "+JSON.stringify(t)):[]},t.prototype.toOrder=function(t){var e=this;if(0!==t.length)return t.map(function(t){return e.toPropertyOrder(t)})},t.prototype.fromOrder=function(t){var e=this;return t.map(function(t){return e.fromPropertyOrder(t)})},t.prototype.toCursor=function(t){var e=this;return{before:t.before,values:t.position.map(function(t){return e.toValue(t)})}},t.prototype.fromCursor=function(t){var e=this,n=!!t.before,r=t.values.map(function(t){return e.fromValue(t)});return new _c(r,n)},t.prototype.toDirection=function(t){return Ch[t.name]},t.prototype.fromDirection=function(t){switch(t){case"ASCENDING":return Tc.ASCENDING;case"DESCENDING":return Tc.DESCENDING;default:return}},t.prototype.toOperatorName=function(t){return Dh[t.name]},t.prototype.fromOperatorName=function(t){switch(t){case"EQUAL":return bc.EQUAL;case"GREATER_THAN":return bc.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return bc.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return bc.LESS_THAN;case"LESS_THAN_OR_EQUAL":return bc.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return bc.ARRAY_CONTAINS;case"OPERATOR_UNSPECIFIED":return Qs("Unspecified relation");default:return Qs("Unknown relation")}},t.prototype.toFieldPathReference=function(t){return{fieldPath:t.canonicalString()}},t.prototype.fromFieldPathReference=function(t){return qu.fromServerFormat(t.fieldPath)},t.prototype.toPropertyOrder=function(t){return{field:this.toFieldPathReference(t.field),direction:this.toDirection(t.dir)}},t.prototype.fromPropertyOrder=function(t){return new Ic(this.fromFieldPathReference(t.field),this.fromDirection(t.direction))},t.prototype.toRelationFilter=function(t){return t instanceof wc?{fieldFilter:{field:this.toFieldPathReference(t.field),op:this.toOperatorName(t.op),value:this.toValue(t.value)}}:Qs("Unrecognized filter: "+JSON.stringify(t))},t.prototype.fromRelationFilter=function(t){return new wc(this.fromFieldPathReference(t.fieldFilter.field),this.fromOperatorName(t.fieldFilter.op),this.fromValue(t.fieldFilter.value))},t.prototype.toUnaryFilter=function(t){return t instanceof Sc?{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NAN"}}:t instanceof Ec?{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NULL"}}:Qs("Unrecognized filter: "+JSON.stringify(t))},t.prototype.fromUnaryFilter=function(t){switch(t.unaryFilter.op){case"IS_NAN":var e=this.fromFieldPathReference(t.unaryFilter.field);return new Sc(e);case"IS_NULL":var n=this.fromFieldPathReference(t.unaryFilter.field);return new Ec(n);case"OPERATOR_UNSPECIFIED":return Qs("Unspecified filter");default:return Qs("Unknown filter")}},t.prototype.toDocumentMask=function(t){var e=[];return t.fields.forEach(function(t){return e.push(t.canonicalString())}),{fieldPaths:e}},t.prototype.fromDocumentMask=function(t){var e=(t.fieldPaths||[]).map(function(t){return qu.fromServerFormat(t)});return Rc.fromArray(e)},t}();function Oh(t,e,n){return e===n||!e&&n in t}var Rh=function(){function t(t){this.sendFn=t.sendFn,this.closeFn=t.closeFn}return t.prototype.onOpen=function(t){zs(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=t},t.prototype.onClose=function(t){zs(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=t},t.prototype.onMessage=function(t){zs(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=t},t.prototype.close=function(){this.closeFn()},t.prototype.send=function(t){this.sendFn(t)},t.prototype.callOnOpen=function(){zs(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},t.prototype.callOnClose=function(t){zs(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(t)},t.prototype.callOnMessage=function(t){zs(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(t)},t}(),Ph="Connection",Lh={BatchGetDocuments:"batchGet",Commit:"commit"},xh="gl-js/ fire/"+Fs,Fh=function(){function t(t){this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.baseUrl=e+"://"+t.host,this.forceLongPolling=t.forceLongPolling}return t.prototype.modifyHeadersForRequest=function(t,e){if(e)for(var n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n]);t["X-Goog-Api-Client"]=xh},t.prototype.invokeRPC=function(t,e,n){var r=this,i=this.makeUrl(t);return new Promise(function(o,a){var s=new xs;s.listenOnce(Ps.COMPLETE,function(){try{switch(s.getLastErrorCode()){case Rs.NO_ERROR:var e=s.getResponseJson();Us(Ph,"XHR received:",JSON.stringify(e)),o(e);break;case Rs.TIMEOUT:Us(Ph,'RPC "'+t+'" timed out'),a(new Ys(Hs.DEADLINE_EXCEEDED,"Request time out"));break;case Rs.HTTP_ERROR:var n=s.getStatus();Us(Ph,'RPC "'+t+'" failed with status:',n,"response text:",s.getResponseText()),n>0?a(new Ys(function(t){switch(t){case 200:return Hs.OK;case 400:return Hs.INVALID_ARGUMENT;case 401:return Hs.UNAUTHENTICATED;case 403:return Hs.PERMISSION_DENIED;case 404:return Hs.NOT_FOUND;case 409:return Hs.ABORTED;case 416:return Hs.OUT_OF_RANGE;case 429:return Hs.RESOURCE_EXHAUSTED;case 499:return Hs.CANCELLED;case 500:return Hs.UNKNOWN;case 501:return Hs.UNIMPLEMENTED;case 503:return Hs.UNAVAILABLE;case 504:return Hs.DEADLINE_EXCEEDED;default:return t>=200&&t<300?Hs.OK:t>=400&&t<500?Hs.FAILED_PRECONDITION:t>=500&&t<600?Hs.INTERNAL:Hs.UNKNOWN}}(n),"Server responded with status "+s.getStatusText())):(Us(Ph,'RPC "'+t+'" failed'),a(new Ys(Hs.UNAVAILABLE,"Connection failed.")));break;default:Qs('RPC "'+t+'" failed with unanticipated webchannel error '+s.getLastErrorCode()+": "+s.getLastError()+", giving up.")}}finally{Us(Ph,'RPC "'+t+'" completed.')}});var u=JSON.stringify(e);Us(Ph,"XHR sending: ",i+" "+u);var c={"Content-Type":"text/plain"};r.modifyHeadersForRequest(c,n),s.send(i,"POST",u,c,15)})},t.prototype.invokeStreamingRPC=function(t,e,n){return this.invokeRPC(t,e,n)},t.prototype.openStream=function(t,e){var n=[this.baseUrl,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=Os(),i={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(i.initMessageHeaders,e),"object"==typeof navigator&&"ReactNative"===navigator.product||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");Us(Ph,"Creating WebChannel: "+o+" "+i);var a=r.createWebChannel(o,i),s=!1,u=!1,c=new Rh({sendFn:function(t){u?Us(Ph,"Not sending because WebChannel is closed:",t):(s||(Us(Ph,"Opening WebChannel transport."),a.open(),s=!0),Us(Ph,"WebChannel sending:",t),a.send(t))},closeFn:function(){return a.close()}}),h=function(t,e){a.listen(t,function(t){try{e(t)}catch(t){setTimeout(function(){throw t},0)}})};return h(Ls.EventType.OPEN,function(){u||Us(Ph,"WebChannel transport opened.")}),h(Ls.EventType.CLOSE,function(){u||(u=!0,Us(Ph,"WebChannel transport closed"),c.callOnClose())}),h(Ls.EventType.ERROR,function(t){u||(u=!0,Us(Ph,"WebChannel transport errored:",t),c.callOnClose(new Ys(Hs.UNAVAILABLE,"The operation could not be completed")))}),h(Ls.EventType.MESSAGE,function(t){if(!u){var e=t.data[0];zs(!!e,"Got a webchannel message without data.");var n=e.error||e[0]&&e[0].error;if(n){Us(Ph,"WebChannel received error:",n);var r=n.status,i=function(t){var e=Wc[t];if(void 0!==e)return Xc(e)}(r),o=n.message;void 0===i&&(i=Hs.INTERNAL,o="Unknown error status: "+r+" with message "+n.message),u=!0,c.callOnClose(new Ys(i,o)),a.close()}else Us(Ph,"WebChannel received:",e),c.callOnMessage(e)}}),setTimeout(function(){c.callOnOpen()},0),c},t.prototype.makeUrl=function(t){var e=Lh[t];zs(void 0!==e,"Unknown REST mapping for: "+t);var n=[this.baseUrl,"/","v1"];return n.push("/projects/"),n.push(this.databaseId.projectId),n.push("/databases/"),n.push(this.databaseId.database),n.push("/documents"),n.push(":"),n.push(e),n.join("")},t}(),qh=function(){function t(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}return Object.defineProperty(t.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),t.prototype.loadConnection=function(t){return Promise.resolve(new Fh(t))},t.prototype.newSerializer=function(t){return new Mh(t,{useProto3Json:!0})},t.prototype.formatJSON=function(t){return JSON.stringify(t)},t.prototype.atob=function(t){return atob(t)},t.prototype.btoa=function(t){return btoa(t)},t}();Gs.setPlatform(new qh);var Bh,Vh=function(){function t(t,e){var n=this;this.previousValue=t,e&&(e.sequenceNumberHandler=function(t){return n.setPreviousValue(t)},this.writeNewSequenceNumber=function(t){return e.writeSequenceNumber(t)})}return t.prototype.setPreviousValue=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},t.prototype.next=function(){var t=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(t),t},t.INVALID=-1,t}(),Uh=function(){return function(){var t=this;this.promise=new Promise(function(e,n){t.resolve=e,t.reject=n})}}();!function(t){t.All="all",t.ListenStreamIdle="listen_stream_idle",t.ListenStreamConnectionBackoff="listen_stream_connection_backoff",t.WriteStreamIdle="write_stream_idle",t.WriteStreamConnectionBackoff="write_stream_connection_backoff",t.OnlineStateTimeout="online_state_timeout",t.ClientMetadataRefresh="client_metadata_refresh",t.LruGarbageCollection="lru_garbage_collection"}(Bh||(Bh={}));var jh=function(){function t(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Uh,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(t){})}return t.createAndSchedule=function(e,n,r,i,o){var a=new t(e,n,Date.now()+r,i,o);return a.start(r),a},t.prototype.start=function(t){var e=this;this.timerHandle=setTimeout(function(){return e.handleDelayElapsed()},t)},t.prototype.skipDelay=function(){return this.handleDelayElapsed()},t.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Ys(Hs.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},t.prototype.handleDelayElapsed=function(){var t=this;this.asyncQueue.enqueueAndForget(function(){return null!==t.timerHandle?(t.clearTimeout(),t.op().then(function(e){return t.deferred.resolve(e)})):Promise.resolve()})},t.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},t}(),Kh=function(){function t(){this.tail=Promise.resolve(),this.delayedOperations=[],this.operationInProgress=!1}return t.prototype.enqueueAndForget=function(t){this.enqueue(t)},t.prototype.enqueue=function(t){var e=this;this.verifyNotFailed();var n=this.tail.then(function(){return e.operationInProgress=!0,t().catch(function(t){e.failure=t,e.operationInProgress=!1;var n=t.stack||t.message||"";throw js("INTERNAL UNHANDLED ERROR: ",n),n.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw t},0),t}).then(function(t){return e.operationInProgress=!1,t})});return this.tail=n,n},t.prototype.enqueueAfterDelay=function(t,e,n){var r=this;this.verifyNotFailed(),zs(e>=0,"Attempted to schedule an operation with a negative delay of "+e),zs(!this.containsDelayedOperation(t),"Attempted to schedule multiple operations with timer id "+t+".");var i=jh.createAndSchedule(this,t,e,n,function(t){return r.removeDelayedOperation(t)});return this.delayedOperations.push(i),i},t.prototype.verifyNotFailed=function(){this.failure&&Qs("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},t.prototype.verifyOperationInProgress=function(){zs(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},t.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})},t.prototype.containsDelayedOperation=function(t){for(var e=0,n=this.delayedOperations;e<n.length;e++){if(n[e].timerId===t)return!0}return!1},t.prototype.runDelayedOperationsEarly=function(t){var e=this;return this.drain().then(function(){zs(t===Bh.All||e.containsDelayedOperation(t),"Attempted to drain to missing operation "+t),e.delayedOperations.sort(function(t,e){return t.targetTimeMs-e.targetTimeMs});for(var n=0,r=e.delayedOperations;n<r.length;n++){var i=r[n];if(i.skipDelay(),t!==Bh.All&&i.timerId===t)break}return e.drain()})},t.prototype.removeDelayedOperation=function(t){var e=this.delayedOperations.indexOf(t);zs(e>=0,"Delayed operation not found."),this.delayedOperations.splice(e,1)},t}(),Qh="",zh="",Gh="",Wh="";function Hh(t){for(var e="",n=0;n<t.length;n++)e.length>0&&(e=Xh(e)),e=Yh(t.get(n),e);return Xh(e)}function Yh(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var o=t.charAt(i);switch(o){case"\0":n+=Qh+Gh;break;case Qh:n+=Qh+Wh;break;default:n+=o}}return n}function Xh(t){return t+Qh+zh}function Jh(t){var e=t.length;if(zs(e>=2,"Invalid path "+t),2===e)return zs(t.charAt(0)===Qh&&t.charAt(1)===zh,"Non-empty path "+t+" had length 2"),xu.EMPTY_PATH;for(var n=e-2,r=[],i="",o=0;o<e;){var a=t.indexOf(Qh,o);switch((a<0||a>n)&&Qs('Invalid encoded resource path: "'+t+'"'),t.charAt(a+1)){case zh:var s=t.substring(o,a),u=void 0;0===i.length?u=s:(u=i+=s,i=""),r.push(u);break;case Gh:i+=t.substring(o,a),i+="\0";break;case Wh:i+=t.substring(o,a+1);break;default:Qs('Invalid encoded resource path: "'+t+'"')}o=a+2}return new xu(r)}var $h=function(){function t(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r,zs(r.length>0,"Cannot create an empty mutation batch")}return t.prototype.applyToRemoteDocument=function(t,e,n){e&&zs(e.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+e.key);var r=n.mutationResults;zs(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o=this.mutations[i];if(o.key.isEqual(t)){var a=r[i];e=o.applyToRemoteDocument(e,a)}}return e},t.prototype.applyToLocalView=function(t,e){e&&zs(e.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+e.key);for(var n=0,r=this.baseMutations;n<r.length;n++){(s=r[n]).key.isEqual(t)&&(e=s.applyToLocalView(e,e,this.localWriteTime))}for(var i=e,o=0,a=this.mutations;o<a.length;o++){var s;(s=a[o]).key.isEqual(t)&&(e=s.applyToLocalView(e,i,this.localWriteTime))}return e},t.prototype.applyToLocalDocumentSet=function(t){var e=this,n=t;return this.mutations.forEach(function(r){var i=e.applyToLocalView(r.key,t.get(r.key));i&&(n=n.insert(r.key,i))}),n},t.prototype.keys=function(){return this.mutations.reduce(function(t,e){return t.add(e.key)},ah())},t.prototype.isEqual=function(t){return this.batchId===t.batchId&&Su(this.mutations,t.mutations)&&Su(this.baseMutations,t.baseMutations)},t}(),Zh=function(){function t(t,e,n,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.streamToken=r,this.docVersions=i}return t.from=function(e,n,r,i){zs(e.mutations.length===r.length,"Mutations sent "+e.mutations.length+" must equal results received "+r.length);for(var o=ih(),a=e.mutations,s=0;s<a.length;s++)o=o.insert(a[s].key,r[s].version);return new t(e,n,r,i,o)},t}(),tl=function(){function t(t){var e=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(function(t){e.isDone=!0,e.result=t,e.nextCallback&&e.nextCallback(t)},function(t){e.isDone=!0,e.error=t,e.catchCallback&&e.catchCallback(t)})}return t.prototype.catch=function(t){return this.next(void 0,t)},t.prototype.next=function(e,n){var r=this;return this.callbackAttached&&Qs("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(n,this.error):this.wrapSuccess(e,this.result):new t(function(t,i){r.nextCallback=function(n){r.wrapSuccess(e,n).next(t,i)},r.catchCallback=function(e){r.wrapFailure(n,e).next(t,i)}})},t.prototype.toPromise=function(){var t=this;return new Promise(function(e,n){t.next(e,n)})},t.prototype.wrapUserFunction=function(e){try{var n=e();return n instanceof t?n:t.resolve(n)}catch(e){return t.reject(e)}},t.prototype.wrapSuccess=function(e,n){return e?this.wrapUserFunction(function(){return e(n)}):t.resolve(n)},t.prototype.wrapFailure=function(e,n){return e?this.wrapUserFunction(function(){return e(n)}):t.reject(n)},t.resolve=function(e){return new t(function(t,n){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},t.waitFor=function(e){return new t(function(t,n){var r=0,i=0,o=!1;e.forEach(function(e){++r,e.next(function(){++i,o&&i===r&&t()},function(t){return n(t)})}),o=!0,i===r&&t()})},t.or=function(e){for(var n=t.resolve(!1),r=function(e){n=n.next(function(n){return n?t.resolve(n):e()})},i=0,o=e;i<o.length;i++){r(o[i])}return n},t.forEach=function(t,e){var n=this,r=[];return t.forEach(function(t,i){r.push(e.call(n,t,i))}),this.waitFor(r)},t}(),el=function(){function t(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.documentKeysByBatchId={}}return t.forUser=function(e,n,r,i){return zs(""!==e.uid,"UserID must not be an empty string."),new t(e.isAuthenticated()?e.uid:"",n,r,i)},t.prototype.checkEmpty=function(t){var e=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ol(t).iterate({index:ql.userMutationsIndex,range:n},function(t,n,r){e=!1,r.done()}).next(function(){return e})},t.prototype.acknowledgeBatch=function(t,e,n){return this.getMutationQueueMetadata(t).next(function(e){return e.lastStreamToken=il(n),sl(t).put(e)})},t.prototype.getLastStreamToken=function(t){return this.getMutationQueueMetadata(t).next(function(t){return t.lastStreamToken})},t.prototype.setLastStreamToken=function(t,e){return this.getMutationQueueMetadata(t).next(function(n){return n.lastStreamToken=il(e),sl(t).put(n)})},t.prototype.addMutationBatch=function(t,e,n,r){var i=this,o=al(t),a=ol(t);return a.add({}).next(function(s){zs("number"==typeof s,"Auto-generated key is not a number");var u=new $h(s,e,n,r),c=i.serializer.toDbMutationBatch(i.userId,u);i.documentKeysByBatchId[s]=u.keys();for(var h=[],l=0,f=r;l<f.length;l++){var d=f[l],p=Bl.key(i.userId,d.key.path,s);h.push(a.put(c)),h.push(o.put(p,Bl.PLACEHOLDER)),h.push(i.indexManager.addToCollectionParentIndex(t,d.key.path.popLast()))}return tl.waitFor(h).next(function(){return u})})},t.prototype.lookupMutationBatch=function(t,e){var n=this;return ol(t).get(e).next(function(t){return t?(zs(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),n.serializer.fromDbMutationBatch(t)):null})},t.prototype.lookupMutationKeys=function(t,e){var n=this;return this.documentKeysByBatchId[e]?tl.resolve(this.documentKeysByBatchId[e]):this.lookupMutationBatch(t,e).next(function(t){if(t){var r=t.keys();return n.documentKeysByBatchId[e]=r,r}return null})},t.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=this;return this.getMutationQueueMetadata(t).next(function(r){var i=e+1,o=IDBKeyRange.lowerBound([n.userId,i]),a=null;return ol(t).iterate({index:ql.userMutationsIndex,range:o},function(t,e,r){e.userId===n.userId&&(zs(e.batchId>=i,"Should have found mutation after "+i),a=n.serializer.fromDbMutationBatch(e)),r.done()}).next(function(){return a})})},t.prototype.getAllMutationBatches=function(t){var e=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ol(t).loadAll(ql.userMutationsIndex,n).next(function(t){return t.map(function(t){return e.serializer.fromDbMutationBatch(t)})})},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=Bl.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=[];return al(t).iterate({range:i},function(r,i,a){var s=r[0],u=r[1],c=r[2],h=Jh(u);if(s===n.userId&&e.path.isEqual(h))return ol(t).get(c).next(function(t){if(!t)throw Qs("Dangling document-mutation reference found: "+r+" which points to "+c);zs(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+c),o.push(n.serializer.fromDbMutationBatch(t))});a.done()}).next(function(){return o})},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new Mc(Eu),i=[];return e.forEach(function(e){var o=Bl.prefixForPath(n.userId,e.path),a=IDBKeyRange.lowerBound(o),s=al(t).iterate({range:a},function(t,i,o){var a=t[0],s=t[1],u=t[2],c=Jh(s);a===n.userId&&e.path.isEqual(c)?r=r.add(u):o.done()});i.push(s)}),tl.waitFor(i).next(function(){return n.lookupMutationBatches(t,r)})},t.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var n=this;zs(!e.isDocumentQuery(),"Document queries shouldn't go down this path"),zs(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var r=e.path,i=r.length+1,o=Bl.prefixForPath(this.userId,r),a=IDBKeyRange.lowerBound(o),s=new Mc(Eu);return al(t).iterate({range:a},function(t,e,o){var a=t[0],u=t[1],c=t[2],h=Jh(u);a===n.userId&&r.isPrefixOf(h)?h.length===i&&(s=s.add(c)):o.done()}).next(function(){return n.lookupMutationBatches(t,s)})},t.prototype.lookupMutationBatches=function(t,e){var n=this,r=[],i=[];return e.forEach(function(e){i.push(ol(t).get(e).next(function(t){if(null===t)throw Qs("Dangling document-mutation reference found, which points to "+e);zs(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),r.push(n.serializer.fromDbMutationBatch(t))}))}),tl.waitFor(i).next(function(){return r})},t.prototype.removeMutationBatch=function(t,e){var n=this;return rl(t.simpleDbTransaction,this.userId,e).next(function(r){return n.removeCachedMutationKeys(e.batchId),tl.forEach(r,function(e){return n.referenceDelegate.removeMutationReference(t,e)})})},t.prototype.removeCachedMutationKeys=function(t){delete this.documentKeysByBatchId[t]},t.prototype.performConsistencyCheck=function(t){var e=this;return this.checkEmpty(t).next(function(n){if(!n)return tl.resolve();var r=IDBKeyRange.lowerBound(Bl.prefixForUser(e.userId)),i=[];return al(t).iterate({range:r},function(t,n,r){if(t[0]===e.userId){var o=Jh(t[1]);i.push(o)}else r.done()}).next(function(){zs(0===i.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+i.map(function(t){return t.canonicalString()}))})})},t.prototype.containsKey=function(t,e){return nl(t,this.userId,e)},t.prototype.getMutationQueueMetadata=function(t){var e=this;return sl(t).get(this.userId).next(function(t){return t||new Fl(e.userId,-1,"")})},t}();function nl(t,e,n){var r=Bl.prefixForPath(e,n.path),i=r[1],o=IDBKeyRange.lowerBound(r),a=!1;return al(t).iterate({range:o,keysOnly:!0},function(t,n,r){var o=t[0],s=t[1];t[2];o===e&&s===i&&(a=!0),r.done()}).next(function(){return a})}function rl(t,e,n){var r=t.store(ql.store),i=t.store(Bl.store),o=[],a=IDBKeyRange.only(n.batchId),s=0,u=r.iterate({range:a},function(t,e,n){return s++,n.delete()});o.push(u.next(function(){zs(1===s,"Dangling document-mutation reference found: Missing batch "+n.batchId)}));for(var c=[],h=0,l=n.mutations;h<l.length;h++){var f=l[h],d=Bl.key(e,f.key.path,n.batchId);o.push(i.delete(d)),c.push(f.key)}return tl.waitFor(o).next(function(){return c})}function il(t){return t instanceof Uint8Array?(zs("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function ol(t){return pf.getStore(t,ql.store)}function al(t){return pf.getStore(t,Bl.store)}function sl(t){return pf.getStore(t,Fl.store)}var ul,cl=1;!function(t){t[t.QueryCache=0]="QueryCache",t[t.SyncEngine=1]="SyncEngine"}(ul||(ul={}));var hl=function(){function t(t,e){this.generatorId=t,zs((t&cl)===t,"Generator ID "+t+" contains more than "+cl+" reserved bits"),this.seek(void 0!==e?e:this.generatorId)}return t.prototype.next=function(){var t=this.nextId;return this.nextId+=1<<cl,t},t.prototype.after=function(t){return this.seek(t+(1<<cl)),this.next()},t.prototype.seek=function(t){zs((t&cl)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=t},t.forQueryCache=function(){return new t(ul.QueryCache,2)},t.forSyncEngine=function(){return new t(ul.SyncEngine)},t}(),ll=function(){function t(t){this.db=t}return t.openOrCreate=function(e,n,r){return zs(t.isAvailable(),"IndexedDB not supported in current environment."),Us("SimpleDb","Opening database:",e),new tl(function(i,o){var a=window.indexedDB.open(e,n);a.onsuccess=function(e){var n=e.target.result;i(new t(n))},a.onblocked=function(){o(new Ys(Hs.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},a.onerror=function(t){var e=t.target.error;"VersionError"===e.name?o(new Ys(Hs.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o(e)},a.onupgradeneeded=function(t){Us("SimpleDb",'Database "'+e+'" requires upgrade from version:',t.oldVersion);var n=t.target.result,i=new dl(a.transaction);r.createOrUpgrade(n,i,t.oldVersion,Rl).next(function(){Us("SimpleDb","Database upgrade to version "+Rl+" complete")})}}).toPromise()},t.delete=function(t){return Us("SimpleDb","Removing database:",t),ml(window.indexedDB.deleteDatabase(t)).toPromise()},t.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var e=window.navigator.userAgent,n=t.getIOSVersion(e),r=0<n&&n<10,i=t.getAndroidVersion(e),o=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||o)},t.getStore=function(t,e){return t.store(e)},t.getIOSVersion=function(t){var e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_")[0]:"-1";return Number(n)},t.getAndroidVersion=function(t){var e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)},t.prototype.runTransaction=function(t,e,n){var r=dl.open(this.db,t,e),i=n(r).catch(function(t){return r.abort(t),tl.reject(t)}).toPromise();return i.catch(function(){}),r.completionPromise.then(function(){return i})},t.prototype.close=function(){this.db.close()},t}(),fl=function(){function t(t){this.dbCursor=t,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(t.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cursor",{set:function(t){this.dbCursor=t},enumerable:!0,configurable:!0}),t.prototype.done=function(){this.shouldStop=!0},t.prototype.skip=function(t){this.nextKey=t},t.prototype.delete=function(){return ml(this.dbCursor.delete())},t}(),dl=function(){function t(t){var e=this;this.transaction=t,this.aborted=!1,this.completionDeferred=new Uh,this.transaction.oncomplete=function(){e.completionDeferred.resolve()},this.transaction.onabort=function(){t.error?e.completionDeferred.reject(t.error):e.completionDeferred.resolve()},this.transaction.onerror=function(t){e.completionDeferred.reject(t.target.error)}}return t.open=function(e,n,r){return new t(e.transaction(r,n))},Object.defineProperty(t.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),t.prototype.abort=function(t){t&&this.completionDeferred.reject(t),this.aborted||(Us("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},t.prototype.store=function(t){var e=this.transaction.objectStore(t);return zs(!!e,"Object store not part of transaction: "+t),new pl(e)},t}(),pl=function(){function t(t){this.store=t}return t.prototype.put=function(t,e){var n;return void 0!==e?(Us("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(Us("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),ml(n)},t.prototype.add=function(t){return Us("SimpleDb","ADD",this.store.name,t,t),ml(this.store.add(t))},t.prototype.get=function(t){var e=this;return ml(this.store.get(t)).next(function(n){return void 0===n&&(n=null),Us("SimpleDb","GET",e.store.name,t,n),n})},t.prototype.delete=function(t){return Us("SimpleDb","DELETE",this.store.name,t),ml(this.store.delete(t))},t.prototype.count=function(){return Us("SimpleDb","COUNT",this.store.name),ml(this.store.count())},t.prototype.loadAll=function(t,e){var n=this.cursor(this.options(t,e)),r=[];return this.iterateCursor(n,function(t,e){r.push(e)}).next(function(){return r})},t.prototype.deleteAll=function(t,e){Us("SimpleDb","DELETE ALL",this.store.name);var n=this.options(t,e);n.keysOnly=!1;var r=this.cursor(n);return this.iterateCursor(r,function(t,e,n){return n.delete()})},t.prototype.iterate=function(t,e){var n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.iterateCursor(r,e)},t.prototype.iterateSerial=function(t){var e=this.cursor({});return new tl(function(n,r){e.onerror=function(t){r(t.target.error)},e.onsuccess=function(e){var r=e.target.result;r?t(r.primaryKey,r.value).next(function(t){t?r.continue():n()}):n()}})},t.prototype.iterateCursor=function(t,e){var n=[];return new tl(function(r,i){t.onerror=function(t){i(t.target.error)},t.onsuccess=function(t){var i=t.target.result;if(i){var o=new fl(i),a=e(i.primaryKey,i.value,o);if(a instanceof tl){var s=a.catch(function(t){return o.done(),tl.reject(t)});n.push(s)}o.isDone?r():null===o.skipToKey?i.continue():i.continue(o.skipToKey)}else r()}}).next(function(){return tl.waitFor(n)})},t.prototype.options=function(t,e){var n=void 0;return void 0!==t&&("string"==typeof t?n=t:(zs(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:n,range:e}},t.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.keysOnly?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},t}();function ml(t){return new tl(function(e,n){t.onsuccess=function(t){var n=t.target.result;e(n)},t.onerror=function(t){n(t.target.error)}})}var yl=function(){function t(t,e){this.referenceDelegate=t,this.serializer=e,this.targetIdGenerator=hl.forQueryCache()}return t.prototype.allocateTargetId=function(t){var e=this;return this.retrieveMetadata(t).next(function(n){return n.highestTargetId=e.targetIdGenerator.after(n.highestTargetId),e.saveMetadata(t,n).next(function(){return n.highestTargetId})})},t.prototype.getLastRemoteSnapshotVersion=function(t){return this.retrieveMetadata(t).next(function(t){return Ac.fromTimestamp(new Mu(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))})},t.prototype.getHighestSequenceNumber=function(t){return bl(t.simpleDbTransaction)},t.prototype.setTargetsMetadata=function(t,e,n){var r=this;return this.retrieveMetadata(t).next(function(i){return i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),r.saveMetadata(t,i)})},t.prototype.addQueryData=function(t,e){var n=this;return this.saveQueryData(t,e).next(function(){return n.retrieveMetadata(t).next(function(r){return r.targetCount+=1,n.updateMetadataFromQueryData(e,r),n.saveMetadata(t,r)})})},t.prototype.updateQueryData=function(t,e){return this.saveQueryData(t,e)},t.prototype.removeQueryData=function(t,e){var n=this;return this.removeMatchingKeysForTargetId(t,e.targetId).next(function(){return gl(t).delete(e.targetId)}).next(function(){return n.retrieveMetadata(t)}).next(function(e){return zs(e.targetCount>0,"Removing from an empty query cache"),e.targetCount-=1,n.saveMetadata(t,e)})},t.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return gl(t).iterate(function(a,s){var u=r.serializer.fromDbTarget(s);u.sequenceNumber<=e&&void 0===n[u.targetId]&&(i++,o.push(r.removeQueryData(t,u)))}).next(function(){return tl.waitFor(o)}).next(function(){return i})},t.prototype.forEachTarget=function(t,e){var n=this;return gl(t).iterate(function(t,r){var i=n.serializer.fromDbTarget(r);e(i)})},t.prototype.retrieveMetadata=function(t){return vl(t.simpleDbTransaction)},t.prototype.saveMetadata=function(t,e){return(n=t,pf.getStore(n,Gl.store)).put(Gl.key,e);var n},t.prototype.saveQueryData=function(t,e){return gl(t).put(this.serializer.toDbTarget(e))},t.prototype.updateMetadataFromQueryData=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},t.prototype.getQueryCount=function(t){return this.retrieveMetadata(t).next(function(t){return t.targetCount})},t.prototype.getQueryData=function(t,e){var n=this,r=e.canonicalId(),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),o=null;return gl(t).iterate({range:i,index:Ql.queryTargetsIndexName},function(t,r,i){var a=n.serializer.fromDbTarget(r);e.isEqual(a.query)&&(o=a,i.done())}).next(function(){return o})},t.prototype.addMatchingKeys=function(t,e,n){var r=this,i=[],o=wl(t);return e.forEach(function(e){var a=Hh(e.path);i.push(o.put(new zl(n,a))),i.push(r.referenceDelegate.addReference(t,e))}),tl.waitFor(i)},t.prototype.removeMatchingKeys=function(t,e,n){var r=this,i=wl(t);return tl.forEach(e,function(e){var o=Hh(e.path);return tl.waitFor([i.delete([n,o]),r.referenceDelegate.removeReference(t,e)])})},t.prototype.removeMatchingKeysForTargetId=function(t,e){var n=wl(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)},t.prototype.getMatchingKeysForTargetId=function(t,e){var n=IDBKeyRange.bound([e],[e+1],!1,!0),r=wl(t),i=ah();return r.iterate({range:n,keysOnly:!0},function(t,e,n){var r=Jh(t[1]),o=new Bu(r);i=i.add(o)}).next(function(){return i})},t.prototype.containsKey=function(t,e){var n=Hh(e.path),r=IDBKeyRange.bound([n],[Tu(n)],!1,!0),i=0;return wl(t).iterate({index:zl.documentTargetsIndex,keysOnly:!0,range:r},function(t,e,n){var r=t[0];t[1];0!==r&&(i++,n.done())}).next(function(){return i>0})},t.prototype.getQueryDataForTarget=function(t,e){var n=this;return gl(t).get(e).next(function(t){return t?n.serializer.fromDbTarget(t):null})},t}();function gl(t){return pf.getStore(t,Ql.store)}function vl(t){return ll.getStore(t,Gl.store).get(Gl.key).next(function(t){return zs(null!==t,"Missing metadata row."),t})}function bl(t){return vl(t).next(function(t){return t.highestListenSequenceNumber})}function wl(t){return pf.getStore(t,zl.store)}var El=function(){function t(t){this.mapKeyFn=t,this.inner={}}return t.prototype.get=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];if(a.isEqual(t))return s}},t.prototype.has=function(t){return void 0!==this.get(t)},t.prototype.set=function(t,e){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(t))return void(r[i]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]},t.prototype.delete=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1},t.prototype.forEach=function(t){tu(this.inner,function(e,n){for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];t(a,s)}})},t.prototype.isEmpty=function(){return eu(this.inner)},t}(),Sl=function(){function t(){this.changes=Zc(),this.documentSizes=new El(function(t){return t.toString()})}return t.prototype.addEntry=function(t){var e=this.assertChanges();this.changes=e.insert(t.key,t)},t.prototype.getEntry=function(t,e){var n=this,r=this.assertChanges().get(e);return r?tl.resolve(r):this.getFromCache(t,e).next(function(t){return null===t?(n.documentSizes.set(e,0),null):(n.documentSizes.set(e,t.size),t.maybeDocument)})},t.prototype.getEntries=function(t,e){var n=this;return this.getAllFromCache(t,e).next(function(t){var e=t.maybeDocuments;return t.sizeMap.forEach(function(t,e){n.documentSizes.set(t,e)}),e})},t.prototype.apply=function(t){var e=this.applyChanges(t);return this.changes=null,e},t.prototype.assertChanges=function(){return zs(null!==this.changes,"Changes have already been applied."),this.changes},t}(),Tl="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",_l=function(){function t(t,e,n){this.serializer=t,this.indexManager=e,this.keepDocumentChangeLog=n,this._lastProcessedDocumentChangeId=0}return Object.defineProperty(t.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),t.prototype.start=function(t){var e=ll.getStore(t,Yl.store);return this.synchronizeLastDocumentChangeId(e)},t.prototype.addEntries=function(t,e,n){var r=[];if(e.length>0){for(var i=Dl(t),o=ah(),a=0,s=e;a<s.length;a++){var u=s[a],c=u.key,h=u.doc;r.push(i.put(kl(c),h)),o=o.add(c),r.push(this.indexManager.addToCollectionParentIndex(t,c.path.popLast()))}this.keepDocumentChangeLog&&r.push(Al(t).put({changes:this.serializer.toDbResourcePaths(o)})),r.push(this.updateSize(t,n))}return tl.waitFor(r)},t.prototype.removeEntry=function(t,e){var n=Dl(t),r=kl(e);return n.get(r).next(function(t){return t?n.delete(r).next(function(){return Nl(t)}):tl.resolve(0)})},t.prototype.getEntry=function(t,e){var n=this;return Dl(t).get(kl(e)).next(function(t){return t?n.serializer.fromDbRemoteDocument(t):null})},t.prototype.getSizedEntry=function(t,e){var n=this;return Dl(t).get(kl(e)).next(function(t){return t?{maybeDocument:n.serializer.fromDbRemoteDocument(t),size:Nl(t)}:null})},t.prototype.getEntries=function(t,e){var n=this,r=th();return this.forEachDbEntry(t,e,function(t,e){r=e?r.insert(t,n.serializer.fromDbRemoteDocument(e)):r.insert(t,null)}).next(function(){return r})},t.prototype.getSizedEntries=function(t,e){var n=this,r=th(),i=new Qu(Bu.comparator);return this.forEachDbEntry(t,e,function(t,e){e?(r=r.insert(t,n.serializer.fromDbRemoteDocument(e)),i=i.insert(t,Nl(e))):(r=r.insert(t,null),i=i.insert(t,0))}).next(function(){return{maybeDocuments:r,sizeMap:i}})},t.prototype.forEachDbEntry=function(t,e,n){if(e.isEmpty())return tl.resolve();var r=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),i=e.getIterator(),o=i.getNext();return Dl(t).iterate({range:r},function(t,e,r){for(var a=Bu.fromSegments(t);o&&Bu.comparator(o,a)<0;)n(o,null),o=i.getNext();o&&o.isEqual(a)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.skip(o.path.toArray()):r.done()}).next(function(){for(;o;)n(o,null),o=i.hasNext()?i.getNext():null})},t.prototype.getDocumentsMatchingQuery=function(t,e){var n=this;zs(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var r=nh(),i=e.path.length+1,o=e.path.toArray(),a=IDBKeyRange.lowerBound(o);return Dl(t).iterate({range:a},function(t,o,a){if(t.length===i){var s=n.serializer.fromDbRemoteDocument(o);e.path.isPrefixOf(s.key.path)?s instanceof Uu&&e.matches(s)&&(r=r.insert(s.key,s)):a.done()}}).next(function(){return r})},t.prototype.getNewDocumentChanges=function(t){var e=this;zs(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var n=ah(),r=Zc(),i=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),o=!0,a=Al(t);return a.iterate({range:i},function(t,r){if(o&&(o=!1,e._lastProcessedDocumentChangeId+1!==r.id))return e.synchronizeLastDocumentChangeId(a).next(function(){return tl.reject(new Ys(Hs.DATA_LOSS,Tl))});n=n.unionWith(e.serializer.fromDbResourcePaths(r.changes)),e._lastProcessedDocumentChangeId=r.id}).next(function(){var i=[];return n.forEach(function(n){i.push(e.getEntry(t,n).next(function(t){var e=t||new ju(n,Ac.forDeletedDoc());r=r.insert(n,e)}))}),tl.waitFor(i)}).next(function(){return r})},t.prototype.removeDocumentChangesThroughChangeId=function(t,e){var n=IDBKeyRange.upperBound(e);return Al(t).delete(n)},t.prototype.synchronizeLastDocumentChangeId=function(t){var e=this;return this._lastProcessedDocumentChangeId=0,t.iterate({keysOnly:!0,reverse:!0},function(t,n,r){e._lastProcessedDocumentChangeId=t,r.done()})},t.prototype.newChangeBuffer=function(){return new Cl(this)},t.prototype.getSize=function(t){return this.getMetadata(t).next(function(t){return t.byteSize})},t.prototype.getMetadata=function(t){return Il(t).get(Kl.key).next(function(t){return zs(!!t,"Missing document cache metadata"),t})},t.prototype.setMetadata=function(t,e){return Il(t).put(Kl.key,e)},t.prototype.updateSize=function(t,e){var n=this;return this.getMetadata(t).next(function(r){return r.byteSize+=e,n.setMetadata(t,r)})},t}();function Il(t){return pf.getStore(t,Kl.store)}var Cl=function(t){function e(e){var n=t.call(this)||this;return n.documentCache=e,n}return $n(e,t),e.prototype.applyChanges=function(t){var e=this,n=this.assertChanges(),r=0,i=[];return n.forEach(function(t,n){var o=e.documentCache.serializer.toDbRemoteDocument(n),a=e.documentSizes.get(t);zs(void 0!==a,"Attempting to change document "+t.toString()+" without having read it first");var s=Nl(o);r+=s-a,i.push({key:t,doc:o})}),this.documentCache.addEntries(t,i,r)},e.prototype.getFromCache=function(t,e){return this.documentCache.getSizedEntry(t,e)},e.prototype.getAllFromCache=function(t,e){return this.documentCache.getSizedEntries(t,e)},e}(Sl);function Dl(t){return pf.getStore(t,jl.store)}function Al(t){return pf.getStore(t,Yl.store)}function kl(t){return t.path.toArray()}function Nl(t){var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Qs("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}var Ml=function(){function t(){this.collectionParentIndex=new Ol}return t.prototype.addToCollectionParentIndex=function(t,e){return this.collectionParentIndex.add(e),tl.resolve()},t.prototype.getCollectionParents=function(t,e){return tl.resolve(this.collectionParentIndex.getEntries(e))},t}(),Ol=function(){function t(){this.index={}}return t.prototype.add=function(t){zs(t.length%2==1,"Expected a collection path.");var e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Mc(xu.comparator),i=!r.has(n);return this.index[e]=r.add(n),i},t.prototype.getEntries=function(t){return(this.index[t]||new Mc(xu.comparator)).toArray()},t}(),Rl=8,Pl=function(){function t(t){this.serializer=t}return t.prototype.createOrUpgrade=function(t,e,n,r){var i=this;zs(n<r&&n>=0&&r<=Rl,"Unexpected schema upgrade from v"+n+" to v{toVersion}."),n<1&&r>=1&&(function(t){t.createObjectStore(xl.store)}(t),function(t){t.createObjectStore(Fl.store,{keyPath:Fl.keyPath}),t.createObjectStore(ql.store,{keyPath:ql.keyPath,autoIncrement:!0}).createIndex(ql.userMutationsIndex,ql.userMutationsKeyPath,{unique:!0}),t.createObjectStore(Bl.store)}(t),Hl(t),function(t){t.createObjectStore(jl.store)}(t));var o=tl.resolve();return n<3&&r>=3&&(0!==n&&(!function(t){t.deleteObjectStore(zl.store),t.deleteObjectStore(Ql.store),t.deleteObjectStore(Gl.store)}(t),Hl(t)),o=o.next(function(){return function(t){var e=t.store(Gl.store),n=new Gl(0,0,Ac.MIN.toTimestamp(),0);return e.put(Gl.key,n)}(e)})),n<4&&r>=4&&(0!==n&&(o=o.next(function(){return function(t,e){return e.store(ql.store).loadAll().next(function(n){t.deleteObjectStore(ql.store);var r=t.createObjectStore(ql.store,{keyPath:ql.keyPath,autoIncrement:!0});r.createIndex(ql.userMutationsIndex,ql.userMutationsKeyPath,{unique:!0});var i=e.store(ql.store),o=n.map(function(t){return i.put(t)});return tl.waitFor(o)})}(t,e)})),o=o.next(function(){!function(t){t.createObjectStore(Xl.store,{keyPath:Xl.keyPath})}(t),function(t){t.createObjectStore(Yl.store,{keyPath:"id",autoIncrement:!0})}(t)})),n<5&&r>=5&&(o=o.next(function(){return i.removeAcknowledgedMutations(e)})),n<6&&r>=6&&(o=o.next(function(){return function(t){t.createObjectStore(Kl.store)}(t),i.addDocumentGlobal(e)})),n<7&&r>=7&&(o=o.next(function(){return i.ensureSequenceNumbers(e)})),n<8&&r>=8&&(o=o.next(function(){return i.createCollectionParentIndex(t,e)})),o},t.prototype.addDocumentGlobal=function(t){var e=0;return t.store(jl.store).iterate(function(t,n){e+=Nl(n)}).next(function(){var n=new Kl(e);return t.store(Kl.store).put(Kl.key,n)})},t.prototype.removeAcknowledgedMutations=function(t){var e=this,n=t.store(Fl.store),r=t.store(ql.store);return n.loadAll().next(function(n){return tl.forEach(n,function(n){var i=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return r.loadAll(ql.userMutationsIndex,i).next(function(r){return tl.forEach(r,function(r){zs(r.userId===n.userId,"Cannot process batch "+r.batchId+" from unexpected user");var i=e.serializer.fromDbMutationBatch(r);return rl(t,n.userId,i).next(function(){})})})})})},t.prototype.ensureSequenceNumbers=function(t){var e=t.store(zl.store),n=t.store(jl.store);return bl(t).next(function(t){var r=[];return n.iterate(function(n,i){var o=new xu(n),a=function(t){return[0,Hh(t)]}(o);r.push(e.get(a).next(function(n){return n?tl.resolve():function(n){return e.put(new zl(0,Hh(n),t))}(o)}))}).next(function(){return tl.waitFor(r)})})},t.prototype.createCollectionParentIndex=function(t,e){t.createObjectStore(Wl.store,{keyPath:Wl.keyPath});var n=e.store(Wl.store),r=new Ol,i=function(t){if(r.add(t)){var e=t.lastSegment(),i=t.popLast();return n.put({collectionId:e,parent:Hh(i)})}};return e.store(jl.store).iterate({keysOnly:!0},function(t,e){var n=new xu(t);return i(n.popLast())}).next(function(){return e.store(Bl.store).iterate({keysOnly:!0},function(t,e){t[0];var n=t[1],r=(t[2],Jh(n));return i(r.popLast())})})},t}();var Ll=function(){return function(t,e){this.seconds=t,this.nanoseconds=e}}(),xl=function(){function t(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}return t.store="owner",t.key="owner",t}();var Fl=function(){function t(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}return t.store="mutationQueues",t.keyPath="userId",t}(),ql=function(){function t(t,e,n,r,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i}return t.store="mutations",t.keyPath="batchId",t.userMutationsIndex="userMutationsIndex",t.userMutationsKeyPath=["userId","batchId"],t}();var Bl=function(){function t(){}return t.prefixForUser=function(t){return[t]},t.prefixForPath=function(t,e){return[t,Hh(e)]},t.key=function(t,e,n){return[t,Hh(e),n]},t.store="documentMutations",t.PLACEHOLDER=new t,t}();var Vl=function(){return function(t,e){this.path=t,this.readTime=e}}(),Ul=function(){return function(t,e){this.path=t,this.version=e}}(),jl=function(){function t(t,e,n,r){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r}return t.store="remoteDocuments",t}(),Kl=function(){function t(t){this.byteSize=t}return t.store="remoteDocumentGlobal",t.key="remoteDocumentGlobalKey",t}();var Ql=function(){function t(t,e,n,r,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.query=o}return t.store="targets",t.keyPath="targetId",t.queryTargetsIndexName="queryTargetsIndex",t.queryTargetsKeyPath=["canonicalId","targetId"],t}(),zl=function(){function t(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n,zs(0===t==(void 0!==n),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}return t.store="targetDocuments",t.keyPath=["targetId","path"],t.documentTargetsIndex="documentTargetsIndex",t.documentTargetsKeyPath=["path","targetId"],t}(),Gl=function(){function t(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}return t.key="targetGlobalKey",t.store="targetGlobal",t}(),Wl=function(){function t(t,e){this.collectionId=t,this.parent=e}return t.store="collectionParents",t.keyPath=["collectionId","parent"],t}();function Hl(t){t.createObjectStore(zl.store,{keyPath:zl.keyPath}).createIndex(zl.documentTargetsIndex,zl.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Ql.store,{keyPath:Ql.keyPath}).createIndex(Ql.queryTargetsIndexName,Ql.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Gl.store)}var Yl=function(){function t(t){this.changes=t}return t.store="remoteDocumentChanges",t.keyPath="id",t}();var Xl=function(){function t(t,e,n,r,i){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r,this.lastProcessedDocumentChangeId=i}return t.store="clientMetadata",t.keyPath="clientId",t}();var Jl=[Fl.store,ql.store,Bl.store,jl.store,Ql.store,xl.store,Gl.store,zl.store].concat([Xl.store,Yl.store]).concat([Kl.store]).concat([Wl.store]),$l=function(){function t(){this.collectionParentsCache=new Ol}return t.prototype.addToCollectionParentIndex=function(t,e){if(zs(e.length%2==1,"Expected a collection path."),this.collectionParentsCache.add(e)){zs(e.length>=1,"Invalid collection path.");var n=e.lastSegment(),r=e.popLast();return Zl(t).put({collectionId:n,parent:Hh(r)})}return tl.resolve()},t.prototype.getCollectionParents=function(t,e){var n=[],r=IDBKeyRange.bound([e,""],[Tu(e),""],!1,!0);return Zl(t).loadAll(r).next(function(t){for(var r=0,i=t;r<i.length;r++){var o=i[r];if(o.collectionId!==e)break;n.push(Jh(o.parent))}return n})},t}();function Zl(t){return pf.getStore(t,Wl.store)}var tf=function(){function t(t){this.remoteSerializer=t}return t.prototype.fromDbRemoteDocument=function(t){if(t.document)return this.remoteSerializer.fromDocument(t.document,!!t.hasCommittedMutations);if(t.noDocument){var e=Bu.fromSegments(t.noDocument.path),n=this.fromDbTimestamp(t.noDocument.readTime);return new ju(e,n,{hasCommittedMutations:!!t.hasCommittedMutations})}if(t.unknownDocument){e=Bu.fromSegments(t.unknownDocument.path),n=this.fromDbTimestamp(t.unknownDocument.version);return new Ku(e,n)}return Qs("Unexpected DbRemoteDocument")},t.prototype.toDbRemoteDocument=function(t){if(t instanceof Uu){var e=t.proto?t.proto:this.remoteSerializer.toDocument(t),n=t.hasCommittedMutations;return new jl(null,null,e,n)}if(t instanceof ju){var r=t.key.path.toArray(),i=this.toDbTimestamp(t.version);n=t.hasCommittedMutations;return new jl(null,new Vl(r,i),null,n)}if(t instanceof Ku){r=t.key.path.toArray(),i=this.toDbTimestamp(t.version);return new jl(new Ul(r,i),null,null,!0)}return Qs("Unexpected MaybeDocumment")},t.prototype.toDbTimestamp=function(t){var e=t.toTimestamp();return new Ll(e.seconds,e.nanoseconds)},t.prototype.fromDbTimestamp=function(t){var e=new Mu(t.seconds,t.nanoseconds);return Ac.fromTimestamp(e)},t.prototype.toDbMutationBatch=function(t,e){var n=this,r=e.baseMutations.map(function(t){return n.remoteSerializer.toMutation(t)}),i=e.mutations.map(function(t){return n.remoteSerializer.toMutation(t)});return new ql(t,e.batchId,e.localWriteTime.toMillis(),r,i)},t.prototype.fromDbMutationBatch=function(t){var e=this,n=(t.baseMutations||[]).map(function(t){return e.remoteSerializer.fromMutation(t)}),r=t.mutations.map(function(t){return e.remoteSerializer.fromMutation(t)}),i=Mu.fromMillis(t.localWriteTimeMs);return new $h(t.batchId,i,n,r)},t.prototype.toDbResourcePaths=function(t){var e=[];return t.forEach(function(t){e.push(Hh(t.path))}),e},t.prototype.fromDbResourcePaths=function(t){for(var e=ah(),n=0,r=t;n<r.length;n++){var i=r[n];e=e.add(new Bu(Jh(i)))}return e},t.prototype.fromDbTarget=function(t){var e,n=this.fromDbTimestamp(t.readTime);return e=void 0!==t.query.documents?this.remoteSerializer.fromDocumentsTarget(t.query):this.remoteSerializer.fromQueryTarget(t.query),new Nc(e,t.targetId,yc.Listen,t.lastListenSequenceNumber,n,t.resumeToken)},t.prototype.toDbTarget=function(t){zs(yc.Listen===t.purpose,"Only queries with purpose "+yc.Listen+" may be stored, got "+t.purpose);var e,n,r=this.toDbTimestamp(t.snapshotVersion);return e=t.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(t.query):this.remoteSerializer.toQueryTarget(t.query),t.resumeToken instanceof Uint8Array?(zs("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),n=t.resumeToken.toString()):n=t.resumeToken,new Ql(t.targetId,t.query.canonicalId(),r,n,t.sequenceNumber,e)},t}();function ef(t,e){var n=t[0],r=t[1],i=e[0],o=e[1],a=Eu(n,i);return 0===a?Eu(r,o):a}var nf=function(){function t(t){this.maxElements=t,this.buffer=new Mc(ef),this.previousIndex=0}return t.prototype.nextIndex=function(){return++this.previousIndex},t.prototype.addElement=function(t){var e=[t,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(e);else{var n=this.buffer.last();ef(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}},Object.defineProperty(t.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),t}(),rf={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},of=function(){function t(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}return t.withCacheSize=function(e){return new t(e,t.DEFAULT_COLLECTION_PERCENTILE,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},t.COLLECTION_DISABLED=-1,t.MINIMUM_CACHE_SIZE_BYTES=1048576,t.DEFAULT_CACHE_SIZE_BYTES=41943040,t.DEFAULT_COLLECTION_PERCENTILE=10,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,t.DEFAULT=new t(t.DEFAULT_CACHE_SIZE_BYTES,t.DEFAULT_COLLECTION_PERCENTILE,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),t.DISABLED=new t(t.COLLECTION_DISABLED,0,0),t}(),af=function(){function t(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.gcTask=null}return t.prototype.start=function(){zs(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==of.COLLECTION_DISABLED&&this.scheduleGC()},t.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(t.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),t.prototype.scheduleGC=function(){var t=this;zs(null===this.gcTask,"Cannot schedule GC while a task is pending");var e=this.hasRun?3e5:6e4;Us("LruGarbageCollector","Garbage collection scheduled in "+e+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(Bh.LruGarbageCollection,e,function(){return t.gcTask=null,t.hasRun=!0,t.localStore.collectGarbage(t.garbageCollector).then(function(){return t.scheduleGC()}).catch(mf)})},t}(),sf=function(){function t(t,e){this.delegate=t,this.params=e}return t.prototype.calculateTargetCount=function(t,e){return this.delegate.getSequenceNumberCount(t).next(function(t){return Math.floor(e/100*t)})},t.prototype.nthSequenceNumber=function(t,e){var n=this;if(0===e)return tl.resolve(Vh.INVALID);var r=new nf(e);return this.delegate.forEachTarget(t,function(t){return r.addElement(t.sequenceNumber)}).next(function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(t,function(t){return r.addElement(t)})}).next(function(){return r.maxValue})},t.prototype.removeTargets=function(t,e,n){return this.delegate.removeTargets(t,e,n)},t.prototype.removeOrphanedDocuments=function(t,e){return this.delegate.removeOrphanedDocuments(t,e)},t.prototype.collect=function(t,e){var n=this;return this.params.cacheSizeCollectionThreshold===of.COLLECTION_DISABLED?(Us("LruGarbageCollector","Garbage collection skipped; disabled"),tl.resolve(rf)):this.getCacheSize(t).next(function(r){return r<n.params.cacheSizeCollectionThreshold?(Us("LruGarbageCollector","Garbage collection skipped; Cache size "+r+" is lower than threshold "+n.params.cacheSizeCollectionThreshold),rf):n.runGarbageCollection(t,e)})},t.prototype.getCacheSize=function(t){return this.delegate.getCacheSize(t)},t.prototype.runGarbageCollection=function(t,e){var n,r,i,o,a,s,u,c,h=this;return o=Date.now(),this.calculateTargetCount(t,this.params.percentileToCollect).next(function(e){return e>h.params.maximumSequenceNumbersToCollect?(Us("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+h.params.maximumSequenceNumbersToCollect+" from "+e),r=h.params.maximumSequenceNumbersToCollect):r=e,a=Date.now(),h.nthSequenceNumber(t,r)}).next(function(r){return n=r,s=Date.now(),h.removeTargets(t,n,e)}).next(function(e){return i=e,u=Date.now(),h.removeOrphanedDocuments(t,n)}).next(function(t){(c=Date.now(),Bs()<=Ns.DEBUG)&&Us("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(a-o)+"ms\n\tDetermined least recently used "+r+" in "+(s-a)+"ms\n\tRemoved "+i+" targets in "+(u-s)+"ms\n\tRemoved "+t+" documents in "+(c-u)+"ms\nTotal Duration: "+(c-o)+"ms");return tl.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:t})})},t}(),uf=function(){return function(){}}(),cf="IndexedDbPersistence",hf="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",lf="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `experimentalTabSynchronization:true` in all tabs.",ff="This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.",df=function(t){function e(e,n){var r=t.call(this)||this;return r.simpleDbTransaction=e,r.currentSequenceNumber=n,r}return $n(e,t),e}(uf),pf=function(){function t(e,n,r,i,o,a,s){if(this.persistenceKey=e,this.clientId=n,this.queue=i,this.multiClientParams=s,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.inForeground=!1,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(t){return Promise.resolve()},!t.isAvailable())throw new Ys(Hs.UNIMPLEMENTED,ff);if(this.referenceDelegate=new vf(this,a),this.dbName=e+t.MAIN_DATABASE,this.serializer=new tf(o),this.document=r.document,this.allowTabSynchronization=void 0!==s,this.queryCache=new yl(this.referenceDelegate,this.serializer),this.indexManager=new $l,this.remoteDocumentCache=new _l(this.serializer,this.indexManager,this.allowTabSynchronization),!r.window||!r.window.localStorage)throw new Ys(Hs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=r.window,this.webStorage=this.window.localStorage}return t.getStore=function(t,e){if(t instanceof df)return ll.getStore(t.simpleDbTransaction,e);throw Qs("IndexedDbPersistence must use instances of IndexedDbTransaction")},t.createIndexedDbPersistence=function(e,n,r,i,o,a){return tr(this,void 0,void 0,function(){var s;return er(this,function(u){switch(u.label){case 0:return[4,(s=new t(e,n,r,i,o,a)).start()];case 1:return u.sent(),[2,s]}})})},t.createMultiClientIndexedDbPersistence=function(e,n,r,i,o,a,s){return tr(this,void 0,void 0,function(){var u;return er(this,function(c){switch(c.label){case 0:return[4,(u=new t(e,n,r,i,o,a,s)).start()];case 1:return c.sent(),[2,u]}})})},t.prototype.start=function(){var t=this;return zs(!this.started,"IndexedDbPersistence double-started!"),zs(null!==this.window,"Expected 'window' to be defined"),ll.openOrCreate(this.dbName,Rl,new Pl(this.serializer)).then(function(e){return t.simpleDb=e,t.updateClientMetadataAndTryBecomePrimary()}).then(function(){return t.attachVisibilityHandler(),t.attachWindowUnloadHook(),t.scheduleClientMetadataAndPrimaryLeaseRefreshes(),t.startRemoteDocumentCache()}).then(function(){return t.simpleDb.runTransaction("readonly",[Gl.store],function(e){return bl(e).next(function(e){var n=t.multiClientParams?t.multiClientParams.sequenceNumberSyncer:void 0;t.listenSequence=new Vh(e,n)})})}).then(function(){t._started=!0}).catch(function(e){return t.simpleDb&&t.simpleDb.close(),Promise.reject(e)})},t.prototype.startRemoteDocumentCache=function(){var t=this;return this.simpleDb.runTransaction("readonly",Jl,function(e){return t.remoteDocumentCache.start(e)})},t.prototype.setPrimaryStateListener=function(t){var e=this;return this.primaryStateListener=function(n){return tr(e,void 0,void 0,function(){return er(this,function(e){return this.started?[2,t(n)]:[2]})})},t(this.isPrimary)},t.prototype.setNetworkEnabled=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.queue.enqueueAndForget(function(){return tr(e,void 0,void 0,function(){return er(this,function(t){switch(t.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})}))},t.prototype.updateClientMetadataAndTryBecomePrimary=function(){var t=this;return this.simpleDb.runTransaction("readwrite",Jl,function(e){return gf(e).put(new Xl(t.clientId,Date.now(),t.networkEnabled,t.inForeground,t.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(t.isPrimary)return t.verifyPrimaryLease(e).next(function(e){e||(t.isPrimary=!1,t.queue.enqueueAndForget(function(){return t.primaryStateListener(!1)}))})}).next(function(){return t.canActAsPrimary(e)}).next(function(n){var r=t.isPrimary;return t.isPrimary=n,r!==t.isPrimary&&t.queue.enqueueAndForget(function(){return t.primaryStateListener(t.isPrimary)}),r&&!t.isPrimary?t.releasePrimaryLeaseIfHeld(e):t.isPrimary?t.acquireOrExtendPrimaryLease(e):void 0})})},t.prototype.verifyPrimaryLease=function(t){var e=this;return yf(t).get(xl.key).next(function(t){return tl.resolve(e.isLocalClient(t))})},t.prototype.removeClientMetadata=function(t){return gf(t).delete(this.clientId)},t.prototype.maybeGarbageCollectMultiClientState=function(){return tr(this,void 0,void 0,function(){var e,n,r=this;return er(this,function(i){switch(i.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),n=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(i){var o=t.getStore(i,Xl.store);return o.loadAll().next(function(t){e=r.filterActiveClients(t,18e5),n=t.filter(function(t){return-1===e.indexOf(t)})}).next(function(){return tl.forEach(n,function(t){return o.delete(t.clientId)})}).next(function(){if((e=e.filter(function(t){return t.clientId!==r.clientId})).length>0){var t=e.map(function(t){return t.lastProcessedDocumentChangeId||0}),n=Math.min.apply(Math,t);return r.remoteDocumentCache.removeDocumentChangesThroughChangeId(i,n)}})})]);case 1:i.sent(),n.forEach(function(t){r.window.localStorage.removeItem(r.zombiedClientLocalStorageKey(t.clientId))}),i.label=2;case 2:return[2]}})})},t.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var t=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(Bh.ClientMetadataRefresh,4e3,function(){return t.updateClientMetadataAndTryBecomePrimary().then(function(){return t.maybeGarbageCollectMultiClientState()}).then(function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},t.prototype.isLocalClient=function(t){return!!t&&t.ownerId===this.clientId},t.prototype.canActAsPrimary=function(t){var e=this;return yf(t).get(xl.key).next(function(n){if(null!==n&&e.isWithinAge(n.leaseTimestampMs,5e3)&&!e.isClientZombied(n.ownerId)){if(e.isLocalClient(n)&&e.networkEnabled)return!0;if(!e.isLocalClient(n)){if(!n.allowTabSynchronization)throw new Ys(Hs.FAILED_PRECONDITION,lf);return!1}}return!(!e.networkEnabled||!e.inForeground)||gf(t).loadAll().next(function(t){return void 0===e.filterActiveClients(t,5e3).find(function(t){if(e.clientId!==t.clientId){var n=!e.networkEnabled&&t.networkEnabled,r=!e.inForeground&&t.inForeground,i=e.networkEnabled===t.networkEnabled;if(n||r&&i)return!0}return!1})})}).next(function(t){return e.isPrimary!==t&&Us(cf,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t})},t.prototype.shutdown=function(){return tr(this,void 0,void 0,function(){var t=this;return er(this,function(e){switch(e.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&this.clientMetadataRefresher.cancel(),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[xl.store,Xl.store],function(e){return t.releasePrimaryLeaseIfHeld(e).next(function(){return t.removeClientMetadata(e)})})];case 1:return e.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}})})},t.prototype.filterActiveClients=function(t,e){var n=this;return t.filter(function(t){return n.isWithinAge(t.updateTimeMs,e)&&!n.isClientZombied(t.clientId)})},t.prototype.getActiveClients=function(){var t=this;return this.simpleDb.runTransaction("readonly",[Xl.store],function(e){return gf(e).loadAll().next(function(e){return t.filterActiveClients(e,18e5).map(function(t){return t.clientId})})})},t.clearPersistence=function(e){return tr(this,void 0,void 0,function(){var n;return er(this,function(r){switch(r.label){case 0:return t.isAvailable()?(n=e+t.MAIN_DATABASE,[4,ll.delete(n)]):[2,Promise.resolve()];case 1:return r.sent(),[2]}})})},Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.getMutationQueue=function(t){return zs(this.started,"Cannot initialize MutationQueue before persistence is started."),el.forUser(t,this.serializer,this.indexManager,this.referenceDelegate)},t.prototype.getQueryCache=function(){return zs(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},t.prototype.getRemoteDocumentCache=function(){return zs(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},t.prototype.getIndexManager=function(){return zs(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},t.prototype.runTransaction=function(t,e,n){var r=this;return Us(cf,"Starting transaction:",t),this.simpleDb.runTransaction("readonly"===e?"readonly":"readwrite",Jl,function(i){return"readwrite-primary"===e?r.verifyPrimaryLease(i).next(function(e){if(!e)throw js("Failed to obtain primary lease for action '"+t+"'."),r.isPrimary=!1,r.queue.enqueueAndForget(function(){return r.primaryStateListener(!1)}),new Ys(Hs.FAILED_PRECONDITION,hf);return n(new df(i,r.listenSequence.next()))}).next(function(t){return r.acquireOrExtendPrimaryLease(i).next(function(){return t})}):r.verifyAllowTabSynchronization(i).next(function(){return n(new df(i,r.listenSequence.next()))})})},t.prototype.verifyAllowTabSynchronization=function(t){var e=this;return yf(t).get(xl.key).next(function(t){if(null!==t&&e.isWithinAge(t.leaseTimestampMs,5e3)&&!e.isClientZombied(t.ownerId)&&!e.isLocalClient(t)&&!t.allowTabSynchronization)throw new Ys(Hs.FAILED_PRECONDITION,lf)})},t.prototype.acquireOrExtendPrimaryLease=function(t){var e=new xl(this.clientId,this.allowTabSynchronization,Date.now());return yf(t).put(xl.key,e)},t.isAvailable=function(){return ll.isAvailable()},t.buildStoragePrefix=function(t){var e=t.databaseId.projectId;return t.databaseId.isDefaultDatabase||(e+="."+t.databaseId.database),"firestore/"+t.persistenceKey+"/"+e+"/"},t.prototype.releasePrimaryLeaseIfHeld=function(t){var e=this,n=yf(t);return n.get(xl.key).next(function(t){return e.isLocalClient(t)?(Us(cf,"Releasing primary lease."),n.delete(xl.key)):tl.resolve()})},t.prototype.isWithinAge=function(t,e){var n=Date.now();return!(t<n-e)&&(!(t>n)||(js("Detected an update time that is in the future: "+t+" > "+n),!1))},t.prototype.attachVisibilityHandler=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){t.queue.enqueueAndForget(function(){return t.inForeground="visible"===t.document.visibilityState,t.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},t.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(zs(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},t.prototype.attachWindowUnloadHook=function(){var t=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget(function(){return t.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},t.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(zs("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},t.prototype.isClientZombied=function(t){try{var e=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(t));return Us(cf,"Client '"+t+"' "+(e?"is":"is not")+" zombied in LocalStorage"),e}catch(t){return js(cf,"Failed to get zombied client id.",t),!1}},t.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(t){js("Failed to set zombie client id.",t)}},t.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(t){}},t.prototype.zombiedClientLocalStorageKey=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},t.MAIN_DATABASE="main",t}();function mf(t){return tr(this,void 0,void 0,function(){return er(this,function(e){if(!function(t){return t.code===Hs.FAILED_PRECONDITION&&t.message===hf}(t))throw t;return Us(cf,"Unexpectedly lost primary lease"),[2]})})}function yf(t){return t.store(xl.store)}function gf(t){return t.store(Xl.store)}var vf=function(){function t(t,e){this.db=t,this.garbageCollector=new sf(this,e)}return t.prototype.getSequenceNumberCount=function(t){var e=this.orphanedDocmentCount(t);return this.db.getQueryCache().getQueryCount(t).next(function(t){return e.next(function(e){return t+e})})},t.prototype.orphanedDocmentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},t.prototype.forEachTarget=function(t,e){return this.db.getQueryCache().forEachTarget(t,e)},t.prototype.forEachOrphanedDocumentSequenceNumber=function(t,e){return this.forEachOrphanedDocument(t,function(t,n){return e(n)})},t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.addReference=function(t,e){return bf(t,e)},t.prototype.removeReference=function(t,e){return bf(t,e)},t.prototype.removeTargets=function(t,e,n){return this.db.getQueryCache().removeTargets(t,e,n)},t.prototype.removeMutationReference=function(t,e){return bf(t,e)},t.prototype.isPinned=function(t,e){return this.inMemoryPins.containsKey(e)?tl.resolve(!0):function(t,e){var n=!1;return sl(t).iterateSerial(function(r){return nl(t,r,e).next(function(t){return t&&(n=!0),tl.resolve(!t)})}).next(function(){return n})}(t,e)},t.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=0,i=0,o=[];return this.forEachOrphanedDocument(t,function(a,s){if(s<=e){var u=n.isPinned(t,a).next(function(e){if(!e)return r++,n.removeOrphanedDocument(t,a).next(function(t){i+=t})});o.push(u)}}).next(function(){return tl.waitFor(o)}).next(function(){return n.db.getRemoteDocumentCache().updateSize(t,-i)}).next(function(){return r})},t.prototype.removeOrphanedDocument=function(t,e){var n,r=0,i=this.db.getRemoteDocumentCache();return tl.waitFor([wl(t).delete((n=e,[0,Hh(n.path)])),i.removeEntry(t,e).next(function(t){r+=t})]).next(function(){return r})},t.prototype.removeTarget=function(t,e){var n=e.copy({sequenceNumber:t.currentSequenceNumber});return this.db.getQueryCache().updateQueryData(t,n)},t.prototype.updateLimboDocument=function(t,e){return bf(t,e)},t.prototype.forEachOrphanedDocument=function(t,e){var n,r=wl(t),i=Vh.INVALID;return r.iterate({index:zl.documentTargetsIndex},function(t,r){var o=t[0],a=(t[1],r.path),s=r.sequenceNumber;0===o?(i!==Vh.INVALID&&e(new Bu(Jh(n)),i),i=s,n=a):i=Vh.INVALID}).next(function(){i!==Vh.INVALID&&e(new Bu(Jh(n)),i)})},t.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},t}();function bf(t,e){return wl(t).put(function(t,e){return new zl(0,Hh(t.path),e)}(e,t.currentSequenceNumber))}var wf=function(){function t(t,e,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.indexManager=n}return t.prototype.getDocument=function(t,e){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(t,e).next(function(r){return n.getDocumentInternal(t,e,r)})},t.prototype.getDocumentInternal=function(t,e,n){return this.remoteDocumentCache.getEntry(t,e).next(function(t){for(var r=0,i=n;r<i.length;r++){t=i[r].applyToLocalView(e,t)}return t})},t.prototype.applyLocalMutationsToDocuments=function(t,e,n){var r=th();return e.forEach(function(t,e){for(var i=0,o=n;i<o.length;i++){e=o[i].applyToLocalView(t,e)}r=r.insert(t,e)}),r},t.prototype.getDocuments=function(t,e){var n=this;return this.remoteDocumentCache.getEntries(t,e).next(function(e){return n.getLocalViewOfDocuments(t,e)})},t.prototype.getLocalViewOfDocuments=function(t,e){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(function(r){var i=n.applyLocalMutationsToDocuments(t,e,r),o=Zc();return i.forEach(function(t,e){e||(e=new ju(t,Ac.forDeletedDoc())),o=o.insert(t,e)}),o})},t.prototype.getDocumentsMatchingQuery=function(t,e){return e.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(t,e.path):e.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(t,e):this.getDocumentsMatchingCollectionQuery(t,e)},t.prototype.getDocumentsMatchingDocumentQuery=function(t,e){return this.getDocument(t,new Bu(e)).next(function(t){var e=nh();return t instanceof Uu&&(e=e.insert(t.key,t)),e})},t.prototype.getDocumentsMatchingCollectionGroupQuery=function(t,e){var n=this;zs(e.path.isEmpty(),"Currently we only support collection group queries at the root.");var r=e.collectionGroup,i=nh();return this.indexManager.getCollectionParents(t,r).next(function(o){return tl.forEach(o,function(o){var a=e.asCollectionQueryAtPath(o.child(r));return n.getDocumentsMatchingCollectionQuery(t,a).next(function(t){t.forEach(function(t,e){i=i.insert(t,e)})})}).next(function(){return i})})},t.prototype.getDocumentsMatchingCollectionQuery=function(t,e){var n,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(t,e).next(function(i){return n=i,r.mutationQueue.getAllMutationBatchesAffectingQuery(t,e)}).next(function(t){for(var r=0,i=t;r<i.length;r++)for(var o=i[r],a=0,s=o.mutations;a<s.length;a++){var u=s[a],c=u.key;if(e.path.isImmediateParentOf(c.path)){var h=n.get(c),l=u.applyToLocalView(h,h,o.localWriteTime);n=l instanceof Uu?n.insert(c,l):n.remove(c)}}}).next(function(){return n.forEach(function(t,r){e.matches(r)||(n=n.remove(t))}),n})},t}(),Ef=function(){function t(){this.refsByKey=new Mc(Sf.compareByKey),this.refsByTarget=new Mc(Sf.compareByTargetId)}return t.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},t.prototype.addReference=function(t,e){var n=new Sf(t,e);this.refsByKey=this.refsByKey.add(n),this.refsByTarget=this.refsByTarget.add(n)},t.prototype.addReferences=function(t,e){var n=this;t.forEach(function(t){return n.addReference(t,e)})},t.prototype.removeReference=function(t,e){this.removeRef(new Sf(t,e))},t.prototype.removeReferences=function(t,e){var n=this;t.forEach(function(t){return n.removeReference(t,e)})},t.prototype.removeReferencesForId=function(t){var e=this,n=Bu.EMPTY,r=new Sf(n,t),i=new Sf(n,t+1),o=[];return this.refsByTarget.forEachInRange([r,i],function(t){e.removeRef(t),o.push(t.key)}),o},t.prototype.removeAllReferences=function(){var t=this;this.refsByKey.forEach(function(e){return t.removeRef(e)})},t.prototype.removeRef=function(t){this.refsByKey=this.refsByKey.delete(t),this.refsByTarget=this.refsByTarget.delete(t)},t.prototype.referencesForId=function(t){var e=Bu.EMPTY,n=new Sf(e,t),r=new Sf(e,t+1),i=ah();return this.refsByTarget.forEachInRange([n,r],function(t){i=i.add(t.key)}),i},t.prototype.containsKey=function(t){var e=new Sf(t,0),n=this.refsByKey.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)},t}(),Sf=function(){function t(t,e){this.key=t,this.targetOrBatchId=e}return t.compareByKey=function(t,e){return Bu.comparator(t.key,e.key)||Eu(t.targetOrBatchId,e.targetOrBatchId)},t.compareByTargetId=function(t,e){return Eu(t.targetOrBatchId,e.targetOrBatchId)||Bu.comparator(t.key,e.key)},t}(),Tf=function(){function t(t,e){this.persistence=t,this.localViewReferences=new Ef,this.queryDataByTarget={},zs(t.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=t.getMutationQueue(e),this.remoteDocuments=t.getRemoteDocumentCache(),this.queryCache=t.getQueryCache(),this.localDocuments=new wf(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}return t.prototype.handleUserChange=function(t){var e=this;return this.persistence.runTransaction("Handle user change","readonly",function(n){var r;return e.mutationQueue.getAllMutationBatches(n).next(function(i){return r=i,e.mutationQueue=e.persistence.getMutationQueue(t),e.localDocuments=new wf(e.remoteDocuments,e.mutationQueue,e.persistence.getIndexManager()),e.mutationQueue.getAllMutationBatches(n)}).next(function(t){for(var i=[],o=[],a=ah(),s=0,u=r;s<u.length;s++){var c=u[s];i.push(c.batchId);for(var h=0,l=c.mutations;h<l.length;h++){var f=l[h];a=a.add(f.key)}}for(var d=0,p=t;d<p.length;d++){c=p[d];o.push(c.batchId);for(var m=0,y=c.mutations;m<y.length;m++){f=y[m];a=a.add(f.key)}}return e.localDocuments.getDocuments(n,a).next(function(t){return{affectedDocuments:t,removedBatchIds:i,addedBatchIds:o}})})})},t.prototype.localWrite=function(t){var e=this,n=Mu.now(),r=t.reduce(function(t,e){return t.add(e.key)},ah());return this.persistence.runTransaction("Locally write mutations","readwrite",function(i){return e.localDocuments.getDocuments(i,r).next(function(r){for(var o=[],a=0,s=t;a<s.length;a++){var u=s[a],c=r.get(u.key);if(!u.isIdempotent){var h=u.fieldMask;if(h){var l=c instanceof Uu?h.applyTo(c.data):uc.EMPTY;o.push(new Bc(u.key,l,h,xc.exists(!0)))}}}return e.mutationQueue.addMutationBatch(i,n,o,t).next(function(t){var e=t.applyToLocalDocumentSet(r);return{batchId:t.batchId,changes:e}})})})},t.prototype.lookupMutationDocuments=function(t){var e=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(n){return e.mutationQueue.lookupMutationKeys(n,t).next(function(t){return t?e.localDocuments.getDocuments(n,t):tl.resolve(null)})})},t.prototype.acknowledgeBatch=function(t){var e=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(n){var r=t.batch.keys(),i=e.remoteDocuments.newChangeBuffer();return e.mutationQueue.acknowledgeBatch(n,t.batch,t.streamToken).next(function(){return e.applyWriteToRemoteDocuments(n,t,i)}).next(function(){return i.apply(n)}).next(function(){return e.mutationQueue.performConsistencyCheck(n)}).next(function(){return e.localDocuments.getDocuments(n,r)})})},t.prototype.rejectBatch=function(t){var e=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(n){var r;return e.mutationQueue.lookupMutationBatch(n,t).next(function(t){return zs(null!==t,"Attempt to reject nonexistent batch!"),r=t.keys(),e.mutationQueue.removeMutationBatch(n,t)}).next(function(){return e.mutationQueue.performConsistencyCheck(n)}).next(function(){return e.localDocuments.getDocuments(n,r)})})},t.prototype.getLastStreamToken=function(){var t=this;return this.persistence.runTransaction("Get last stream token","readonly",function(e){return t.mutationQueue.getLastStreamToken(e)})},t.prototype.setLastStreamToken=function(t){var e=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(n){return e.mutationQueue.setLastStreamToken(n,t)})},t.prototype.getLastRemoteSnapshotVersion=function(){var t=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(e){return t.queryCache.getLastRemoteSnapshotVersion(e)})},t.prototype.applyRemoteEvent=function(e){var n=this,r=this.remoteDocuments.newChangeBuffer();return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(i){var o=[],a=ah();Zs(e.targetChanges,function(r,s){var u=n.queryDataByTarget[r];if(u){s.addedDocuments.forEach(function(t){a=a.add(t)}),s.modifiedDocuments.forEach(function(t){a=a.add(t)}),o.push(n.queryCache.removeMatchingKeys(i,s.removedDocuments,r).next(function(){return n.queryCache.addMatchingKeys(i,s.addedDocuments,r)}));var c=s.resumeToken;if(c.length>0){var h=u;u=u.copy({resumeToken:c,snapshotVersion:e.snapshotVersion}),n.queryDataByTarget[r]=u,t.shouldPersistQueryData(h,u,s)&&o.push(n.queryCache.updateQueryData(i,u))}}});var s=Zc(),u=ah();e.documentUpdates.forEach(function(t,e){u=u.add(t)}),o.push(r.getEntries(i,u).next(function(t){e.documentUpdates.forEach(function(u,c){var h=t.get(u);null==h||c.version.isEqual(Ac.MIN)||a.has(c.key)&&!h.hasPendingWrites||c.version.compareTo(h.version)>=0?(r.addEntry(c),s=s.insert(u,c)):Us("LocalStore","Ignoring outdated watch update for ",u,". Current version:",h.version," Watch version:",c.version),e.resolvedLimboDocuments.has(u)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(i,u))})}));var c=e.snapshotVersion;if(!c.isEqual(Ac.MIN)){var h=n.queryCache.getLastRemoteSnapshotVersion(i).next(function(t){return zs(c.compareTo(t)>=0,"Watch stream reverted to previous snapshot?? "+c+" < "+t),n.queryCache.setTargetsMetadata(i,i.currentSequenceNumber,c)});o.push(h)}return tl.waitFor(o).next(function(){return r.apply(i)}).next(function(){return n.localDocuments.getLocalViewOfDocuments(i,s)})})},t.shouldPersistQueryData=function(t,e,n){return 0!==e.resumeToken.length&&(0===t.resumeToken.length||(e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0))},t.prototype.notifyLocalViewChanges=function(t){var e=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(n){return tl.forEach(t,function(t){return e.localViewReferences.addReferences(t.addedKeys,t.targetId),e.localViewReferences.removeReferences(t.removedKeys,t.targetId),tl.forEach(t.removedKeys,function(t){return e.persistence.referenceDelegate.removeReference(n,t)})})})},t.prototype.nextMutationBatch=function(t){var e=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(n){return void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)})},t.prototype.readDocument=function(t){var e=this;return this.persistence.runTransaction("read document","readonly",function(n){return e.localDocuments.getDocument(n,t)})},t.prototype.allocateQuery=function(t){var e=this;return this.persistence.runTransaction("Allocate query","readwrite",function(n){var r;return e.queryCache.getQueryData(n,t).next(function(i){return i?(r=i,tl.resolve()):e.queryCache.allocateTargetId(n).next(function(i){return r=new Nc(t,i,yc.Listen,n.currentSequenceNumber),e.queryCache.addQueryData(n,r)})}).next(function(){return zs(!e.queryDataByTarget[r.targetId],"Tried to allocate an already allocated query: "+t),e.queryDataByTarget[r.targetId]=r,r})})},t.prototype.releaseQuery=function(t,e){var n=this,r=e?"readwrite":"readwrite-primary";return this.persistence.runTransaction("Release query",r,function(r){return n.queryCache.getQueryData(r,t).next(function(i){zs(null!=i,"Tried to release nonexistent query: "+t);var o=i.targetId,a=n.queryDataByTarget[o],s=n.localViewReferences.removeReferencesForId(o);return delete n.queryDataByTarget[o],e?tl.resolve():tl.forEach(s,function(t){return n.persistence.referenceDelegate.removeReference(r,t)}).next(function(){return n.persistence.referenceDelegate.removeTarget(r,a)})})})},t.prototype.executeQuery=function(t){var e=this;return this.persistence.runTransaction("Execute query","readonly",function(n){return e.localDocuments.getDocumentsMatchingQuery(n,t)})},t.prototype.remoteDocumentKeys=function(t){var e=this;return this.persistence.runTransaction("Remote document keys","readonly",function(n){return e.queryCache.getMatchingKeysForTargetId(n,t)})},t.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},t.prototype.removeCachedMutationBatchMetadata=function(t){this.mutationQueue.removeCachedMutationKeys(t)},t.prototype.setNetworkEnabled=function(t){this.persistence.setNetworkEnabled(t)},t.prototype.applyWriteToRemoteDocuments=function(t,e,n){var r=this,i=e.batch,o=i.keys(),a=tl.resolve();return o.forEach(function(r){a=a.next(function(){return n.getEntry(t,r)}).next(function(t){var o=t,a=e.docVersions.get(r);zs(null!==a,"ackVersions should contain every doc in the write."),(!o||o.version.compareTo(a)<0)&&((o=i.applyToRemoteDocument(r,o,e))?n.addEntry(o):zs(!t,"Mutation batch "+i+" applied to document "+t+" resulted in null"))})}),a.next(function(){return r.mutationQueue.removeMutationBatch(t,i)})},t.prototype.collectGarbage=function(t){var e=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(n){return t.collect(n,e.queryDataByTarget)})},t.prototype.getQueryForTarget=function(t){var e=this;return this.queryDataByTarget[t]?Promise.resolve(this.queryDataByTarget[t].query):this.persistence.runTransaction("Get query data","readonly",function(n){return e.queryCache.getQueryDataForTarget(n,t).next(function(t){return t?t.query:null})})},t.prototype.getNewDocumentChanges=function(){var t=this;return this.persistence.runTransaction("Get new document changes","readonly",function(e){return t.remoteDocuments.getNewDocumentChanges(e)})},t.RESUME_TOKEN_MAX_AGE_MICROS=3e8,t}(),_f=function(){function t(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=Ws(),this.batchesByDocumentKey=new Mc(Sf.compareByKey)}return t.prototype.checkEmpty=function(t){return tl.resolve(0===this.mutationQueue.length)},t.prototype.acknowledgeBatch=function(t,e,n){var r=e.batchId,i=this.indexOfExistingBatchId(r,"acknowledged");zs(0===i,"Can only acknowledge the first batch in the mutation queue");var o=this.mutationQueue[i];return zs(r===o.batchId,"Queue ordering failure: expected batch "+r+", got batch "+o.batchId),this.lastStreamToken=n,tl.resolve()},t.prototype.getLastStreamToken=function(t){return tl.resolve(this.lastStreamToken)},t.prototype.setLastStreamToken=function(t,e){return this.lastStreamToken=e,tl.resolve()},t.prototype.addMutationBatch=function(t,e,n,r){zs(0!==r.length,"Mutation batches should not be empty");var i=this.nextBatchId;(this.nextBatchId++,this.mutationQueue.length>0)&&zs(this.mutationQueue[this.mutationQueue.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");var o=new $h(i,e,n,r);this.mutationQueue.push(o);for(var a=0,s=r;a<s.length;a++){var u=s[a];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new Sf(u.key,i)),this.indexManager.addToCollectionParentIndex(t,u.key.path.popLast())}return tl.resolve(o)},t.prototype.lookupMutationBatch=function(t,e){return tl.resolve(this.findMutationBatch(e))},t.prototype.lookupMutationKeys=function(t,e){var n=this.findMutationBatch(e);return zs(null!=n,"Failed to find local mutation batch."),tl.resolve(n.keys())},t.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=e+1,r=this.indexOfBatchId(n),i=r<0?0:r;return tl.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)},t.prototype.getAllMutationBatches=function(t){return tl.resolve(this.mutationQueue.slice())},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=new Sf(e,0),i=new Sf(e,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([r,i],function(t){zs(e.isEqual(t.key),"Should only iterate over a single key's batches");var r=n.findMutationBatch(t.targetOrBatchId);zs(null!==r,"Batches in the index must exist in the main table"),o.push(r)}),tl.resolve(o)},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new Mc(Eu);return e.forEach(function(t){var e=new Sf(t,0),i=new Sf(t,Number.POSITIVE_INFINITY);n.batchesByDocumentKey.forEachInRange([e,i],function(e){zs(t.isEqual(e.key),"For each key, should only iterate over a single key's batches"),r=r.add(e.targetOrBatchId)})}),tl.resolve(this.findMutationBatches(r))},t.prototype.getAllMutationBatchesAffectingQuery=function(t,e){zs(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var n=e.path,r=n.length+1,i=n;Bu.isDocumentKey(i)||(i=i.child(""));var o=new Sf(new Bu(i),0),a=new Mc(Eu);return this.batchesByDocumentKey.forEachWhile(function(t){var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(a=a.add(t.targetOrBatchId)),!0)},o),tl.resolve(this.findMutationBatches(a))},t.prototype.findMutationBatches=function(t){var e=this,n=[];return t.forEach(function(t){var r=e.findMutationBatch(t);null!==r&&n.push(r)}),n},t.prototype.removeMutationBatch=function(t,e){var n=this;zs(0===this.indexOfExistingBatchId(e.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var r=this.batchesByDocumentKey;return tl.forEach(e.mutations,function(i){var o=new Sf(i.key,e.batchId);return r=r.delete(o),n.referenceDelegate.removeMutationReference(t,i.key)}).next(function(){n.batchesByDocumentKey=r})},t.prototype.removeCachedMutationKeys=function(t){},t.prototype.containsKey=function(t,e){var n=new Sf(e,0),r=this.batchesByDocumentKey.firstAfterOrEqual(n);return tl.resolve(e.isEqual(r&&r.key))},t.prototype.performConsistencyCheck=function(t){return 0===this.mutationQueue.length&&zs(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),tl.resolve()},t.prototype.indexOfExistingBatchId=function(t,e){var n=this.indexOfBatchId(t);return zs(n>=0&&n<this.mutationQueue.length,"Batches must exist to be "+e),n},t.prototype.indexOfBatchId=function(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId},t.prototype.findMutationBatch=function(t){var e=this.indexOfBatchId(t);if(e<0||e>=this.mutationQueue.length)return null;var n=this.mutationQueue[e];return zs(n.batchId===t,"If found batch must match"),n},t}(),If=function(){function t(t){this.persistence=t,this.queries=new El(function(t){return t.canonicalId()}),this.lastRemoteSnapshotVersion=Ac.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new Ef,this.targetCount=0,this.targetIdGenerator=hl.forQueryCache()}return t.prototype.getTargetCount=function(t){return tl.resolve(this.targetCount)},t.prototype.forEachTarget=function(t,e){return this.queries.forEach(function(t,n){return e(n)}),tl.resolve()},t.prototype.getLastRemoteSnapshotVersion=function(t){return tl.resolve(this.lastRemoteSnapshotVersion)},t.prototype.getHighestSequenceNumber=function(t){return tl.resolve(this.highestSequenceNumber)},t.prototype.allocateTargetId=function(t){var e=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=e,tl.resolve(e)},t.prototype.setTargetsMetadata=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.highestSequenceNumber&&(this.highestSequenceNumber=e),tl.resolve()},t.prototype.saveQueryData=function(t){this.queries.set(t.query,t);var e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=t.sequenceNumber)},t.prototype.addQueryData=function(t,e){return zs(!this.queries.has(e.query),"Adding a query that already exists"),this.saveQueryData(e),this.targetCount+=1,tl.resolve()},t.prototype.updateQueryData=function(t,e){return zs(this.queries.has(e.query),"Updating a non-existent query"),this.saveQueryData(e),tl.resolve()},t.prototype.removeQueryData=function(t,e){return zs(this.targetCount>0,"Removing a target from an empty cache"),zs(this.queries.has(e.query),"Removing a non-existent target from the cache"),this.queries.delete(e.query),this.references.removeReferencesForId(e.targetId),this.targetCount-=1,tl.resolve()},t.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return this.queries.forEach(function(a,s){s.sequenceNumber<=e&&!n[s.targetId]&&(r.queries.delete(a),o.push(r.removeMatchingKeysForTargetId(t,s.targetId)),i++)}),tl.waitFor(o).next(function(){return i})},t.prototype.getQueryCount=function(t){return tl.resolve(this.targetCount)},t.prototype.getQueryData=function(t,e){var n=this.queries.get(e)||null;return tl.resolve(n)},t.prototype.getQueryDataForTarget=function(t,e){return Qs("Not yet implemented.")},t.prototype.addMatchingKeys=function(t,e,n){this.references.addReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(function(e){i.push(r.addReference(t,e))}),tl.waitFor(i)},t.prototype.removeMatchingKeys=function(t,e,n){this.references.removeReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(function(e){i.push(r.removeReference(t,e))}),tl.waitFor(i)},t.prototype.removeMatchingKeysForTargetId=function(t,e){return this.references.removeReferencesForId(e),tl.resolve()},t.prototype.getMatchingKeysForTargetId=function(t,e){var n=this.references.referencesForId(e);return tl.resolve(n)},t.prototype.containsKey=function(t,e){return tl.resolve(this.references.containsKey(e))},t}();var Cf,Df=function(){function t(t,e){this.indexManager=t,this.sizer=e,this.docs=new Qu(Bu.comparator),this.newDocumentChanges=ah(),this.size=0}return t.prototype.addEntries=function(t,e,n){for(var r=[],i=0,o=e;i<o.length;i++){var a=o[i],s=a.maybeDocument.key;this.docs=this.docs.insert(s,a),this.newDocumentChanges=this.newDocumentChanges.add(s),r.push(this.indexManager.addToCollectionParentIndex(t,s.path.popLast()))}return this.size+=n,tl.waitFor(r)},t.prototype.removeEntry=function(t,e){var n=this.docs.get(e);return n?(this.docs=this.docs.remove(e),this.size-=n.size,tl.resolve(n.size)):tl.resolve(0)},t.prototype.getEntry=function(t,e){var n=this.docs.get(e);return tl.resolve(n?n.maybeDocument:null)},t.prototype.getSizedEntry=function(t,e){return tl.resolve(this.docs.get(e))},t.prototype.getEntries=function(t,e){var n=this,r=th();return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null)}),tl.resolve(r)},t.prototype.getSizedEntries=function(t,e){var n=this,r=th(),i=new Qu(Bu.comparator);return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null),i=i.insert(t,e?e.size:0)}),tl.resolve({maybeDocuments:r,sizeMap:i})},t.prototype.getDocumentsMatchingQuery=function(t,e){zs(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var n=nh(),r=new Bu(e.path.child("")),i=this.docs.getIteratorFrom(r);i.hasNext();){var o=i.getNext(),a=o.key,s=o.value.maybeDocument;if(!e.path.isPrefixOf(a.path))break;s instanceof Uu&&e.matches(s)&&(n=n.insert(s.key,s))}return tl.resolve(n)},t.prototype.forEachDocumentKey=function(t,e){return tl.forEach(this.docs,function(t){return e(t)})},t.prototype.getNewDocumentChanges=function(t){var e=this,n=Zc();return this.newDocumentChanges.forEach(function(t){var r=e.docs.get(t),i=r?r.maybeDocument:new ju(t,Ac.forDeletedDoc());n=n.insert(t,i)}),this.newDocumentChanges=ah(),tl.resolve(n)},t.prototype.newChangeBuffer=function(){return new Af(this.sizer,this)},t.prototype.getSize=function(t){return tl.resolve(this.size)},t}(),Af=function(t){function e(e,n){var r=t.call(this)||this;return r.sizer=e,r.documentCache=n,r}return $n(e,t),e.prototype.applyChanges=function(t){var e=this,n=this.assertChanges(),r=0,i=[];return n.forEach(function(t,n){var o=e.documentSizes.get(t);zs(void 0!==o,"Attempting to change document "+t.toString()+" without having read it first");var a=e.sizer(n);r+=a-o,i.push({maybeDocument:n,size:a})}),this.documentCache.addEntries(t,i,r)},e.prototype.getFromCache=function(t,e){return this.documentCache.getSizedEntry(t,e)},e.prototype.getAllFromCache=function(t,e){return this.documentCache.getSizedEntries(t,e)},e}(Sl),kf=function(){function t(t,e){var n=this;this.clientId=t,this.mutationQueues={},this.listenSequence=new Vh(0),this._started=!1,this._started=!0,this.referenceDelegate=e(this),this.queryCache=new If(this);this.indexManager=new Ml,this.remoteDocumentCache=new Df(this.indexManager,function(t){return n.referenceDelegate.documentSize(t)})}return t.createLruPersistence=function(e,n,r){return new t(e,function(t){return new Of(t,new tf(n),r)})},t.createEagerPersistence=function(e){return new t(e,function(t){return new Mf(t)})},t.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.getActiveClients=function(){return tr(this,void 0,void 0,function(){return er(this,function(t){return[2,[this.clientId]]})})},t.prototype.setPrimaryStateListener=function(t){return t(!0)},t.prototype.setNetworkEnabled=function(t){},t.prototype.getIndexManager=function(){return this.indexManager},t.prototype.getMutationQueue=function(t){var e=this.mutationQueues[t.toKey()];return e||(e=new _f(this.indexManager,this.referenceDelegate),this.mutationQueues[t.toKey()]=e),e},t.prototype.getQueryCache=function(){return this.queryCache},t.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},t.prototype.runTransaction=function(t,e,n){var r=this;Us("MemoryPersistence","Starting transaction:",t);var i=new Nf(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next(function(t){return r.referenceDelegate.onTransactionCommitted(i).next(function(){return t})}).toPromise()},t.prototype.mutationQueuesContainKey=function(t,e){return tl.or((n=this.mutationQueues,r=[],tu(n,function(t,e){return r.push(e)}),r).map(function(n){return function(){return n.containsKey(t,e)}}));var n,r},t}(),Nf=function(){return function(t){this.currentSequenceNumber=t}}(),Mf=function(){function t(t){this.persistence=t}return t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.addReference=function(t,e){return this.orphanedDocuments.delete(e),tl.resolve()},t.prototype.removeReference=function(t,e){return this.orphanedDocuments.add(e),tl.resolve()},t.prototype.removeMutationReference=function(t,e){return this.orphanedDocuments.add(e),tl.resolve()},t.prototype.removeTarget=function(t,e){var n=this,r=this.persistence.getQueryCache();return r.getMatchingKeysForTargetId(t,e.targetId).next(function(t){t.forEach(function(t){return n.orphanedDocuments.add(t)})}).next(function(){return r.removeQueryData(t,e)})},t.prototype.onTransactionStarted=function(){this.orphanedDocuments=new Set},t.prototype.onTransactionCommitted=function(t){var e=this,n=this.persistence.getRemoteDocumentCache();return tl.forEach(this.orphanedDocuments,function(r){return e.isReferenced(t,r).next(function(e){return e?tl.resolve():n.removeEntry(t,r).next(function(){})})})},t.prototype.updateLimboDocument=function(t,e){var n=this;return this.isReferenced(t,e).next(function(t){t?n.orphanedDocuments.delete(e):n.orphanedDocuments.add(e)})},t.prototype.documentSize=function(t){return 0},t.prototype.isReferenced=function(t,e){var n=this;return tl.or([function(){return n.persistence.getQueryCache().containsKey(t,e)},function(){return n.persistence.mutationQueuesContainKey(t,e)},function(){return tl.resolve(n.inMemoryPins.containsKey(e))}])},t}(),Of=function(){function t(t,e,n){this.persistence=t,this.serializer=e,this.orphanedSequenceNumbers=new El(function(t){return Hh(t.path)}),this.garbageCollector=new sf(this,n)}return t.prototype.onTransactionStarted=function(){},t.prototype.onTransactionCommitted=function(t){return tl.resolve()},t.prototype.forEachTarget=function(t,e){return this.persistence.getQueryCache().forEachTarget(t,e)},t.prototype.getSequenceNumberCount=function(t){var e=this.orphanedDocumentCount(t);return this.persistence.getQueryCache().getTargetCount(t).next(function(t){return e.next(function(e){return t+e})})},t.prototype.orphanedDocumentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},t.prototype.forEachOrphanedDocumentSequenceNumber=function(t,e){var n=this;return tl.forEach(this.orphanedSequenceNumbers,function(r,i){return n.isPinned(t,r,i).next(function(t){return t?tl.resolve():e(i)})})},t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.removeTargets=function(t,e,n){return this.persistence.getQueryCache().removeTargets(t,e,n)},t.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=0,i=this.persistence.getRemoteDocumentCache();return i.forEachDocumentKey(t,function(o){return n.isPinned(t,o,e).next(function(e){return e?tl.resolve():(r++,i.removeEntry(t,o).next())})}).next(function(){return r})},t.prototype.removeMutationReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),tl.resolve()},t.prototype.removeTarget=function(t,e){var n=e.copy({sequenceNumber:t.currentSequenceNumber});return this.persistence.getQueryCache().updateQueryData(t,n)},t.prototype.addReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),tl.resolve()},t.prototype.removeReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),tl.resolve()},t.prototype.updateLimboDocument=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),tl.resolve()},t.prototype.documentSize=function(t){var e,n=this.serializer.toDbRemoteDocument(t);if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw Qs("Unknown remote document type");e=n.noDocument}return JSON.stringify(e).length},t.prototype.isPinned=function(t,e,n){var r=this;return tl.or([function(){return r.persistence.mutationQueuesContainKey(t,e)},function(){return tl.resolve(r.inMemoryPins.containsKey(e))},function(){return r.persistence.getQueryCache().containsKey(t,e)},function(){var t=r.orphanedSequenceNumbers.get(e);return tl.resolve(void 0!==t&&t>n)}])},t.prototype.getCacheSize=function(t){return this.persistence.getRemoteDocumentCache().getSize(t)},t}(),Rf=function(){function t(t,e,n,r,i){this.queue=t,this.timerId=e,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}return t.prototype.reset=function(){this.currentBaseMs=0},t.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},t.prototype.backoffAndRun=function(t){var e=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);this.currentBaseMs>0&&Us("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,function(){return e.lastAttemptTime=Date.now(),t()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},t.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},t.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},t}();!function(t){t[t.Initial=0]="Initial",t[t.Starting=1]="Starting",t[t.Open=2]="Open",t[t.Error=3]="Error",t[t.Backoff=4]="Backoff"}(Cf||(Cf={}));var Pf,Lf,xf=1e3,Ff=6e4,qf=1.5,Bf=function(){function t(t,e,n,r,i,o){this.queue=t,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=Cf.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new Rf(t,e,xf,qf,Ff)}return t.prototype.isStarted=function(){return this.state===Cf.Starting||this.state===Cf.Open||this.state===Cf.Backoff},t.prototype.isOpen=function(){return this.state===Cf.Open},t.prototype.start=function(){this.state!==Cf.Error?(zs(this.state===Cf.Initial,"Already started"),this.auth()):this.performBackoff()},t.prototype.stop=function(){return tr(this,void 0,void 0,function(){return er(this,function(t){switch(t.label){case 0:return this.isStarted()?[4,this.close(Cf.Initial)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t.prototype.inhibitBackoff=function(){zs(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=Cf.Initial,this.backoff.reset()},t.prototype.markIdle=function(){var t=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return t.handleIdleCloseTimer()}))},t.prototype.sendRequest=function(t){this.cancelIdleCheck(),this.stream.send(t)},t.prototype.handleIdleCloseTimer=function(){return tr(this,void 0,void 0,function(){return er(this,function(t){return this.isOpen()?[2,this.close(Cf.Initial)]:[2]})})},t.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},t.prototype.close=function(t,e){return tr(this,void 0,void 0,function(){return er(this,function(n){switch(n.label){case 0:return zs(this.isStarted(),"Only started streams should be closed."),zs(t===Cf.Error||pc(e),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,t!==Cf.Error?this.backoff.reset():e&&e.code===Hs.RESOURCE_EXHAUSTED?(js(e.toString()),js("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):e&&e.code===Hs.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=t,[4,this.listener.onClose(e)];case 1:return n.sent(),[2]}})})},t.prototype.tearDown=function(){},t.prototype.auth=function(){var t=this;zs(this.state===Cf.Initial,"Must be in initial state to auth"),this.state=Cf.Starting;var e=this.getCloseGuardedDispatcher(this.closeCount),n=this.closeCount;this.credentialsProvider.getToken().then(function(e){t.closeCount===n&&t.startStream(e)},function(n){e(function(){var e=new Ys(Hs.UNKNOWN,"Fetching auth token failed: "+n.message);return t.handleStreamClose(e)})})},t.prototype.startStream=function(t){var e=this;zs(this.state===Cf.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(t),this.stream.onOpen(function(){n(function(){return zs(e.state===Cf.Starting,"Expected stream to be in state Starting, but was "+e.state),e.state=Cf.Open,e.listener.onOpen()})}),this.stream.onClose(function(t){n(function(){return e.handleStreamClose(t)})}),this.stream.onMessage(function(t){n(function(){return e.onMessage(t)})})},t.prototype.performBackoff=function(){var t=this;zs(this.state===Cf.Error,"Should only perform backoff when in Error state"),this.state=Cf.Backoff,this.backoff.backoffAndRun(function(){return tr(t,void 0,void 0,function(){return er(this,function(t){return zs(this.state===Cf.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=Cf.Initial,this.start(),zs(this.isStarted(),"PersistentStream should have started"),[2]})})})},t.prototype.handleStreamClose=function(t){return zs(this.isStarted(),"Can't handle server close on non-started stream"),Us("PersistentStream","close with error: "+t),this.stream=null,this.close(Cf.Error,t)},t.prototype.getCloseGuardedDispatcher=function(t){var e=this;return function(n){e.queue.enqueueAndForget(function(){return e.closeCount===t?n():(Us("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},t}(),Vf=function(t){function e(e,n,r,i,o){var a=t.call(this,e,Bh.ListenStreamConnectionBackoff,Bh.ListenStreamIdle,n,r,o)||this;return a.serializer=i,a}return $n(e,t),e.prototype.startRpc=function(t){return this.connection.openStream("Listen",t)},e.prototype.onMessage=function(t){this.backoff.reset();var e=this.serializer.fromWatchChange(t),n=this.serializer.versionFromListenResponse(t);return this.listener.onWatchChange(e,n)},e.prototype.watch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.addTarget=this.serializer.toTarget(t);var n=this.serializer.toListenRequestLabels(t);n&&(e.labels=n),this.sendRequest(e)},e.prototype.unwatch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.removeTarget=t,this.sendRequest(e)},e}(Bf),Uf=function(t){function e(e,n,r,i,o){var a=t.call(this,e,Bh.WriteStreamConnectionBackoff,Bh.WriteStreamIdle,n,r,o)||this;return a.serializer=i,a.handshakeComplete_=!1,a}return $n(e,t),Object.defineProperty(e.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),e.prototype.start=function(){this.handshakeComplete_=!1,t.prototype.start.call(this)},e.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},e.prototype.startRpc=function(t){return this.connection.openStream("Write",t)},e.prototype.onMessage=function(t){if(zs(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.handshakeComplete_){this.backoff.reset();var e=this.serializer.fromWriteResults(t.writeResults,t.commitTime),n=this.serializer.fromVersion(t.commitTime);return this.listener.onMutationResult(n,e)}return zs(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},e.prototype.writeHandshake=function(){zs(this.isOpen(),"Writing handshake requires an opened stream"),zs(!this.handshakeComplete_,"Handshake already completed");var t={};t.database=this.serializer.encodedDatabaseId,this.sendRequest(t)},e.prototype.writeMutations=function(t){var e=this;zs(this.isOpen(),"Writing mutations requires an opened stream"),zs(this.handshakeComplete_,"Handshake must be complete before writing mutations"),zs(this.lastStreamToken.length>0,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:t.map(function(t){return e.serializer.toMutation(t)})};this.sendRequest(n)},e}(Bf),jf=function(){function t(t,e,n,r){this.queue=t,this.connection=e,this.credentials=n,this.serializer=r}return t.prototype.newPersistentWriteStream=function(t){return new Uf(this.queue,this.connection,this.credentials,this.serializer,t)},t.prototype.newPersistentWatchStream=function(t){return new Vf(this.queue,this.connection,this.credentials,this.serializer,t)},t.prototype.commit=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,writes:t.map(function(t){return e.serializer.toMutation(t)})};return this.invokeRPC("Commit",n).then(function(t){return e.serializer.fromWriteResults(t.writeResults,t.commitTime)})},t.prototype.lookup=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,documents:t.map(function(t){return e.serializer.toName(t)})};return this.invokeStreamingRPC("BatchGetDocuments",n).then(function(n){var r=Zc();n.forEach(function(t){var n=e.serializer.fromMaybeDocument(t);r=r.insert(n.key,n)});var i=[];return t.forEach(function(t){var e=r.get(t);zs(!!e,"Missing entity in write response for "+t),i.push(e)}),i})},t.prototype.invokeRPC=function(t,e){var n=this;return this.credentials.getToken().then(function(r){return n.connection.invokeRPC(t,e,r)}).catch(function(t){throw t.code===Hs.UNAUTHENTICATED&&n.credentials.invalidateToken(),t})},t.prototype.invokeStreamingRPC=function(t,e){var n=this;return this.credentials.getToken().then(function(r){return n.connection.invokeStreamingRPC(t,e,r)}).catch(function(t){throw t.code===Hs.UNAUTHENTICATED&&n.credentials.invalidateToken(),t})},t}(),Kf=function(){function t(t){this.datastore=t,this.readVersions=ih(),this.mutations=[],this.committed=!1}return t.prototype.recordVersion=function(t){var e;if(t instanceof Uu)e=t.version;else{if(!(t instanceof ju))throw Qs("Document in a transaction was a "+t.constructor.name);e=Ac.forDeletedDoc()}var n=this.readVersions.get(t.key);if(null!==n){if(!e.isEqual(n))throw new Ys(Hs.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(t.key,e)},t.prototype.lookup=function(t){var e=this;return this.committed?Promise.reject("Transaction has already completed."):this.mutations.length>0?Promise.reject("Transactions lookups are invalid after writes."):this.datastore.lookup(t).then(function(t){return t.forEach(function(t){t instanceof ju||t instanceof Uu?e.recordVersion(t):Qs("Document in a transaction was a "+t.constructor.name)}),t})},t.prototype.write=function(t){if(this.committed)throw new Ys(Hs.FAILED_PRECONDITION,"Transaction has already completed.");this.mutations=this.mutations.concat(t)},t.prototype.precondition=function(t){var e=this.readVersions.get(t);return e?xc.updateTime(e):xc.NONE},t.prototype.preconditionForUpdate=function(t){var e=this.readVersions.get(t);if(e&&e.isEqual(Ac.forDeletedDoc()))throw new Ys(Hs.FAILED_PRECONDITION,"Can't update a document that doesn't exist.");return e?xc.updateTime(e):xc.exists(!0)},t.prototype.set=function(t,e){this.write(e.toMutations(t,this.precondition(t)))},t.prototype.update=function(t,e){this.write(e.toMutations(t,this.preconditionForUpdate(t)))},t.prototype.delete=function(t){this.write([new Uc(t,this.precondition(t))]),this.readVersions=this.readVersions.insert(t,Ac.forDeletedDoc())},t.prototype.commit=function(){var t=this,e=this.readVersions;return this.mutations.forEach(function(t){e=e.remove(t.key)}),e.isEmpty()?this.datastore.commit(this.mutations).then(function(){t.committed=!0}):Promise.reject(Error("Every document read in a transaction must also be written."))},t}();!function(t){t[t.Unknown=0]="Unknown",t[t.Online=1]="Online",t[t.Offline=2]="Offline"}(Pf||(Pf={})),function(t){t[t.RemoteStore=0]="RemoteStore",t[t.SharedClientState=1]="SharedClientState"}(Lf||(Lf={}));var Qf=function(){function t(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state=Pf.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}return t.prototype.handleWatchStreamStart=function(){var t=this;0===this.watchStreamFailures&&(this.setAndBroadcast(Pf.Unknown),zs(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(Bh.OnlineStateTimeout,1e4,function(){return t.onlineStateTimer=null,zs(t.state===Pf.Unknown,"Timer should be canceled if we transitioned to a different state."),t.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),t.setAndBroadcast(Pf.Offline),Promise.resolve()}))},t.prototype.handleWatchStreamFailure=function(t){this.state===Pf.Online?(this.setAndBroadcast(Pf.Unknown),zs(0===this.watchStreamFailures,"watchStreamFailures must be 0"),zs(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,this.watchStreamFailures>=1&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+t.toString()),this.setAndBroadcast(Pf.Offline)))},t.prototype.set=function(t){this.clearOnlineStateTimer(),this.watchStreamFailures=0,t===Pf.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(t)},t.prototype.setAndBroadcast=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},t.prototype.logClientOfflineWarningIfNecessary=function(t){var e="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(js(e),this.shouldWarnClientIsOffline=!1):Us("OnlineStateTracker",e)},t.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},t}(),zf=function(){function t(t,e,n,r){this.localStore=t,this.datastore=e,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.onlineStateTracker=new Qf(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}return t.prototype.start=function(){return this.enableNetwork()},t.prototype.enableNetwork=function(){return tr(this,void 0,void 0,function(){var t;return er(this,function(e){switch(e.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(t=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return t.lastStreamToken=e.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(Pf.Unknown),[4,this.fillWritePipeline()];case 2:e.sent(),e.label=3;case 3:return[2]}})})},t.prototype.disableNetwork=function(){return tr(this,void 0,void 0,function(){return er(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(Pf.Offline),[2]}})})},t.prototype.disableNetworkInternal=function(){return tr(this,void 0,void 0,function(){return er(this,function(t){switch(t.label){case 0:return[4,this.writeStream.stop()];case 1:return t.sent(),[4,this.watchStream.stop()];case 2:return t.sent(),this.writePipeline.length>0&&(Us("RemoteStore","Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})},t.prototype.shutdown=function(){return tr(this,void 0,void 0,function(){return er(this,function(t){switch(t.label){case 0:return Us("RemoteStore","RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(Pf.Unknown),[2]}})})},t.prototype.listen=function(t){zs(!Js(this.listenTargets,t.targetId),"listen called with duplicate targetId!"),this.listenTargets[t.targetId]=t,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(t)},t.prototype.unlisten=function(t){zs(Js(this.listenTargets,t),"unlisten called without assigned target ID!"),delete this.listenTargets[t],this.watchStream.isOpen()&&this.sendUnwatchRequest(t),eu(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(Pf.Unknown))},t.prototype.getQueryDataForTarget=function(t){return this.listenTargets[t]||null},t.prototype.getRemoteKeysForTarget=function(t){return this.syncEngine.getRemoteKeysForTarget(t)},t.prototype.sendWatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t.targetId),this.watchStream.watch(t)},t.prototype.sendUnwatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t),this.watchStream.unwatch(t)},t.prototype.startWatchStream=function(){zs(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new Eh(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},t.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!eu(this.listenTargets)},t.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},t.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},t.prototype.onWatchStreamOpen=function(){return tr(this,void 0,void 0,function(){var t=this;return er(this,function(e){return Zs(this.listenTargets,function(e,n){t.sendWatchRequest(n)}),[2]})})},t.prototype.onWatchStreamClose=function(t){return tr(this,void 0,void 0,function(){return er(this,function(e){return void 0===t&&zs(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(t),this.startWatchStream()):this.onlineStateTracker.set(Pf.Unknown),[2]})})},t.prototype.onWatchStreamChange=function(t,e){return tr(this,void 0,void 0,function(){var n;return er(this,function(r){switch(r.label){case 0:return this.onlineStateTracker.set(Pf.Online),t instanceof bh&&t.state===fh.Removed&&t.cause?[2,this.handleTargetError(t)]:(t instanceof gh?this.watchChangeAggregator.handleDocumentChange(t):t instanceof vh?this.watchChangeAggregator.handleExistenceFilter(t):(zs(t instanceof bh,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(t)),e.isEqual(Ac.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return n=r.sent(),e.compareTo(n)>=0?[4,this.raiseWatchSnapshot(e)]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}})})},t.prototype.raiseWatchSnapshot=function(t){var e=this;zs(!t.isEqual(Ac.MIN),"Can't raise event for unknown SnapshotVersion");var n=this.watchChangeAggregator.createRemoteEvent(t);return Zs(n.targetChanges,function(n,r){if(r.resumeToken.length>0){var i=e.listenTargets[n];i&&(e.listenTargets[n]=i.copy({resumeToken:r.resumeToken,snapshotVersion:t}))}}),n.targetMismatches.forEach(function(t){var n=e.listenTargets[t];if(n){e.listenTargets[t]=n.copy({resumeToken:Ws()}),e.sendUnwatchRequest(t);var r=new Nc(n.query,t,yc.ExistenceFilterMismatch,n.sequenceNumber);e.sendWatchRequest(r)}}),this.syncEngine.applyRemoteEvent(n)},t.prototype.handleTargetError=function(t){var e=this;zs(!!t.cause,"Handling target error without a cause");var n=t.cause,r=Promise.resolve();return t.targetIds.forEach(function(t){r=r.then(function(){return tr(e,void 0,void 0,function(){return er(this,function(e){return Js(this.listenTargets,t)?(delete this.listenTargets[t],this.watchChangeAggregator.removeTarget(t),[2,this.syncEngine.rejectListen(t,n)]):[2]})})})}),r},t.prototype.fillWritePipeline=function(){return tr(this,void 0,void 0,function(){var t,e;return er(this,function(n){switch(n.label){case 0:return this.canAddToWritePipeline()?(t=this.writePipeline.length>0?this.writePipeline[this.writePipeline.length-1].batchId:-1,[4,this.localStore.nextMutationBatch(t)]):[3,4];case 1:return null!==(e=n.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(e),[4,this.fillWritePipeline()];case 3:n.sent(),n.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})},t.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},t.prototype.outstandingWrites=function(){return this.writePipeline.length},t.prototype.addToWritePipeline=function(t){zs(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(t),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(t.mutations)},t.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&this.writePipeline.length>0},t.prototype.startWriteStream=function(){zs(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},t.prototype.onWriteStreamOpen=function(){return tr(this,void 0,void 0,function(){return er(this,function(t){return this.writeStream.writeHandshake(),[2]})})},t.prototype.onWriteHandshakeComplete=function(){var t=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var e=0,n=t.writePipeline;e<n.length;e++){var r=n[e];t.writeStream.writeMutations(r.mutations)}}).catch(mf)},t.prototype.onMutationResult=function(t,e){var n=this;zs(this.writePipeline.length>0,"Got result for empty write pipeline");var r=this.writePipeline.shift(),i=Zh.from(r,t,e,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(i).then(function(){return n.fillWritePipeline()})},t.prototype.onWriteStreamClose=function(t){return tr(this,void 0,void 0,function(){var e=this;return er(this,function(n){return void 0===t&&zs(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),t&&this.writePipeline.length>0?(void 0,[2,(this.writeStream.handshakeComplete?this.handleWriteError(t):this.handleHandshakeError(t)).then(function(){e.shouldStartWriteStream()&&e.startWriteStream()})]):[2]})})},t.prototype.handleHandshakeError=function(t){return tr(this,void 0,void 0,function(){return er(this,function(e){return Yc(t.code)?(Us("RemoteStore","RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=Ws(),[2,this.localStore.setLastStreamToken(Ws()).catch(mf)]):[2]})})},t.prototype.handleWriteError=function(t){return tr(this,void 0,void 0,function(){var e,n=this;return er(this,function(r){return Yc(i=t.code)&&i!==Hs.ABORTED?(e=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(e.batchId,t).then(function(){return n.fillWritePipeline()})]):[2];var i})})},t.prototype.createTransaction=function(){return new Kf(this.datastore)},t.prototype.handleCredentialChange=function(){return tr(this,void 0,void 0,function(){return er(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(Us("RemoteStore","RemoteStore restarting streams for new credential"),this.networkEnabled=!1,[4,this.disableNetworkInternal()]):[3,3];case 1:return t.sent(),this.onlineStateTracker.set(Pf.Unknown),[4,this.enableNetwork()];case 2:t.sent(),t.label=3;case 3:return[2]}})})},t.prototype.applyPrimaryState=function(t){return tr(this,void 0,void 0,function(){return er(this,function(e){switch(e.label){case 0:return this.isPrimary=t,t&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return e.sent(),[3,4];case 2:return t?[3,4]:[4,this.disableNetworkInternal()];case 3:e.sent(),this.onlineStateTracker.set(Pf.Unknown),e.label=4;case 4:return[2]}})})},t}(),Gf=function(){return function(){this.listeners=[]}}(),Wf=function(){function t(t){this.syncEngine=t,this.queries=new El(function(t){return t.canonicalId()}),this.onlineState=Pf.Unknown,this.syncEngine.subscribe(this)}return t.prototype.listen=function(t){var e=t.query,n=!1,r=this.queries.get(e);return r||(n=!0,r=new Gf,this.queries.set(e,r)),r.listeners.push(t),t.applyOnlineStateChange(this.onlineState),r.viewSnap&&t.onViewSnapshot(r.viewSnap),n?this.syncEngine.listen(e).then(function(t){return r.targetId=t,t}):Promise.resolve(r.targetId)},t.prototype.unlisten=function(t){return tr(this,void 0,void 0,function(){var e,n,r,i;return er(this,function(o){return e=t.query,n=!1,(r=this.queries.get(e))&&(i=r.listeners.indexOf(t))>=0&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(e),[2,this.syncEngine.unlisten(e)]):[2]})})},t.prototype.onWatchChange=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e],i=r.query,o=this.queries.get(i);if(o){for(var a=0,s=o.listeners;a<s.length;a++){s[a].onViewSnapshot(r)}o.viewSnap=r}}},t.prototype.onWatchError=function(t,e){var n=this.queries.get(t);if(n)for(var r=0,i=n.listeners;r<i.length;r++){i[r].onError(e)}this.queries.delete(t)},t.prototype.onOnlineStateChange=function(t){this.onlineState=t,this.queries.forEach(function(e,n){for(var r=0,i=n.listeners;r<i.length;r++){i[r].applyOnlineStateChange(t)}})},t}(),Hf=function(){function t(t,e,n){this.query=t,this.queryObserver=e,this.raisedInitialEvent=!1,this.onlineState=Pf.Unknown,this.options=n||{}}return t.prototype.onViewSnapshot=function(t){if(zs(t.docChanges.length>0||t.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];i.type!==ch.Metadata&&e.push(i)}t=new ph(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}this.raisedInitialEvent?this.shouldRaiseEvent(t)&&this.queryObserver.next(t):this.shouldRaiseInitialEvent(t,this.onlineState)&&this.raiseInitialEvent(t),this.snap=t},t.prototype.onError=function(t){this.queryObserver.error(t)},t.prototype.applyOnlineStateChange=function(t){this.onlineState=t,this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,t)&&this.raiseInitialEvent(this.snap)},t.prototype.shouldRaiseInitialEvent=function(t,e){if(zs(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!t.fromCache)return!0;var n=e!==Pf.Offline;return this.options.waitForSyncWhenOnline&&n?(zs(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.isEmpty()||e===Pf.Offline},t.prototype.shouldRaiseEvent=function(t){if(t.docChanges.length>0)return!0;var e=this.snap&&this.snap.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges},t.prototype.raiseInitialEvent=function(t){zs(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t=ph.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(t)},t}(),Yf=function(){function t(t,e,n){this.targetId=t,this.addedKeys=e,this.removedKeys=n}return t.fromSnapshot=function(e,n){for(var r=ah(),i=ah(),o=0,a=n.docChanges;o<a.length;o++){var s=a[o];switch(s.type){case ch.Added:r=r.add(s.doc.key);break;case ch.Removed:i=i.add(s.doc.key)}}return new t(e,r,i)},t}(),Xf=function(){return function(t){this.key=t}}(),Jf=function(){return function(t){this.key=t}}(),$f=function(){function t(t,e){this.query=t,this._syncedDocuments=e,this.syncState=null,this.current=!1,this.limboDocuments=ah(),this.mutatedKeys=ah(),this.documentSet=new lh(t.docComparator.bind(t))}return Object.defineProperty(t.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),t.prototype.computeDocChanges=function(t,e){var n=this,r=e?e.changeSet:new dh,i=e?e.documentSet:this.documentSet,o=e?e.mutatedKeys:this.mutatedKeys,a=i,s=!1,u=this.query.hasLimit()&&i.size===this.query.limit?i.last():null;if(t.inorderTraversal(function(t,e){var c=i.get(t),h=e instanceof Uu?e:null;h&&(zs(t.isEqual(h.key),"Mismatching keys found in document changes: "+t+" != "+h.key),h=n.query.matches(h)?h:null);var l=!!c&&n.mutatedKeys.has(c.key),f=!!h&&(h.hasLocalMutations||n.mutatedKeys.has(h.key)&&h.hasCommittedMutations),d=!1;c&&h?c.data.isEqual(h.data)?l!==f&&(r.track({type:ch.Metadata,doc:h}),d=!0):n.shouldWaitForSyncedDocument(c,h)||(r.track({type:ch.Modified,doc:h}),d=!0,u&&n.query.docComparator(h,u)>0&&(s=!0)):!c&&h?(r.track({type:ch.Added,doc:h}),d=!0):c&&!h&&(r.track({type:ch.Removed,doc:c}),d=!0,u&&(s=!0));d&&(h?(a=a.add(h),o=f?o.add(t):o.delete(t)):(a=a.delete(t),o=o.delete(t)))}),this.query.hasLimit())for(;a.size>this.query.limit;){var c=a.last();a=a.delete(c.key),o=o.delete(c.key),r.track({type:ch.Removed,doc:c})}return zs(!s||!e,"View was refilled using docs that themselves needed refilling."),{documentSet:a,changeSet:r,needsRefill:s,mutatedKeys:o}},t.prototype.shouldWaitForSyncedDocument=function(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations},t.prototype.applyChanges=function(t,e,n){var r=this;zs(!t.needsRefill,"Cannot apply changes that need a refill");var i=this.documentSet;this.documentSet=t.documentSet,this.mutatedKeys=t.mutatedKeys;var o=t.changeSet.getChanges();o.sort(function(t,e){return function(t,e){var n=function(t){switch(t){case ch.Added:return 1;case ch.Modified:case ch.Metadata:return 2;case ch.Removed:return 0;default:return Qs("Unknown ChangeType: "+t)}};return n(t)-n(e)}(t.type,e.type)||r.query.docComparator(t.doc,e.doc)}),this.applyTargetChange(n);var a=e?this.updateLimboDocuments():[],s=0===this.limboDocuments.size&&this.current?hh.Synced:hh.Local,u=s!==this.syncState;return this.syncState=s,0!==o.length||u?{snapshot:new ph(this.query,t.documentSet,i,o,t.mutatedKeys,s===hh.Local,u,!1),limboChanges:a}:{limboChanges:a}},t.prototype.applyOnlineStateChange=function(t){return this.current&&t===Pf.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new dh,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},t.prototype.shouldBeInLimbo=function(t){return!this._syncedDocuments.has(t)&&(!!this.documentSet.has(t)&&!this.documentSet.get(t).hasLocalMutations)},t.prototype.applyTargetChange=function(t){var e=this;t&&(t.addedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.add(t)}),t.modifiedDocuments.forEach(function(t){return zs(e._syncedDocuments.has(t),"Modified document "+t+" not found in view.")}),t.removedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.delete(t)}),this.current=t.current)},t.prototype.updateLimboDocuments=function(){var t=this;if(!this.current)return[];var e=this.limboDocuments;this.limboDocuments=ah(),this.documentSet.forEach(function(e){t.shouldBeInLimbo(e.key)&&(t.limboDocuments=t.limboDocuments.add(e.key))});var n=[];return e.forEach(function(e){t.limboDocuments.has(e)||n.push(new Jf(e))}),this.limboDocuments.forEach(function(t){e.has(t)||n.push(new Xf(t))}),n},t.prototype.synchronizeWithPersistedState=function(t,e){this._syncedDocuments=e,this.limboDocuments=ah();var n=this.computeDocChanges(t);return this.applyChanges(n,!0)},t.prototype.computeInitialSnapshot=function(){return ph.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===hh.Local)},t}();var Zf=function(){return function(t,e,n){this.query=t,this.targetId=e,this.view=n}}(),td=function(){return function(t){this.key=t}}(),ed=function(){function t(t,e,n,r){this.localStore=t,this.remoteStore=e,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new El(function(t){return t.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new Qu(Bu.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new Ef,this.mutationUserCallbacks={},this.limboTargetIdGenerator=hl.forSyncEngine(),this.isPrimary=void 0,this.onlineState=Pf.Unknown}return Object.defineProperty(t.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),t.prototype.subscribe=function(t){zs(null!==t,"SyncEngine listener cannot be null"),zs(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=t},t.prototype.listen=function(t){return tr(this,void 0,void 0,function(){var e,n,r,i,o;return er(this,function(a){switch(a.label){case 0:return this.assertSubscribed("listen()"),(r=this.queryViewsByQuery.get(t))?(e=r.targetId,this.sharedClientState.addLocalQueryTarget(e),n=r.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(t)];case 2:return i=a.sent(),o=this.sharedClientState.addLocalQueryTarget(i.targetId),e=i.targetId,[4,this.initializeViewAndComputeSnapshot(i,"current"===o)];case 3:n=a.sent(),this.isPrimary&&this.remoteStore.listen(i),a.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,e]}})})},t.prototype.initializeViewAndComputeSnapshot=function(t,e){var n=this,r=t.query;return this.localStore.executeQuery(r).then(function(i){return n.localStore.remoteDocumentKeys(t.targetId).then(function(o){var a=new $f(r,o),s=a.computeDocChanges(i),u=yh.createSynthesizedTargetChangeForCurrentChange(t.targetId,e&&n.onlineState!==Pf.Offline),c=a.applyChanges(s,!0===n.isPrimary,u);zs(0===c.limboChanges.length,"View returned limbo docs before target ack from the server."),zs(!!c.snapshot,"applyChanges for new view should always return a snapshot");var h=new Zf(r,t.targetId,a);return n.queryViewsByQuery.set(r,h),n.queryViewsByTarget[t.targetId]=h,c.snapshot})})},t.prototype.synchronizeViewAndComputeSnapshot=function(t){var e=this;return this.localStore.executeQuery(t.query).then(function(n){return e.localStore.remoteDocumentKeys(t.targetId).then(function(r){return tr(e,void 0,void 0,function(){var e;return er(this,function(i){return e=t.view.synchronizeWithPersistedState(n,r),this.isPrimary&&this.updateTrackedLimbos(t.targetId,e.limboChanges),[2,e]})})})})},t.prototype.unlisten=function(t){return tr(this,void 0,void 0,function(){var e,n=this;return er(this,function(r){switch(r.label){case 0:return this.assertSubscribed("unlisten()"),zs(!!(e=this.queryViewsByQuery.get(t)),"Trying to unlisten on query not found:"+t),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(e.targetId),this.sharedClientState.isActiveQueryTarget(e.targetId)?[3,2]:[4,this.localStore.releaseQuery(t,!1).then(function(){n.sharedClientState.clearQueryState(e.targetId),n.remoteStore.unlisten(e.targetId),n.removeAndCleanupQuery(e)}).catch(mf)]):[3,3];case 1:r.sent(),r.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(e),[4,this.localStore.releaseQuery(t,!0)];case 4:r.sent(),r.label=5;case 5:return[2]}})})},t.prototype.write=function(t,e){var n=this;return this.assertSubscribed("write()"),this.localStore.localWrite(t).then(function(t){return n.sharedClientState.addPendingMutation(t.batchId),n.addMutationCallback(t.batchId,e),n.emitNewSnapsAndNotifyLocalStore(t.changes)}).then(function(){return n.remoteStore.fillWritePipeline()})},t.prototype.wrapUpdateFunctionError=function(t){return t},t.prototype.runTransaction=function(t,e){var n=this;void 0===e&&(e=5),zs(e>=0,"Got negative number of retries for transaction.");var r=this.remoteStore.createTransaction();return function(){try{var e=t(r);return!pc(e)&&e.catch&&e.then?e.catch(function(t){return Promise.reject(n.wrapUpdateFunctionError(t))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(t){return Promise.reject(n.wrapUpdateFunctionError(t))}}().then(function(i){return r.commit().then(function(){return i}).catch(function(r){return 0===e?Promise.reject(r):n.runTransaction(t,e-1)})})},t.prototype.applyRemoteEvent=function(t){var e=this;return this.assertSubscribed("applyRemoteEvent()"),this.localStore.applyRemoteEvent(t).then(function(n){return tu(t.targetChanges,function(t,n){var r=e.limboResolutionsByTarget[t];r&&(zs(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),n.addedDocuments.size>0?r.receivedDocument=!0:n.modifiedDocuments.size>0?zs(r.receivedDocument,"Received change for limbo target document without add."):n.removedDocuments.size>0&&(zs(r.receivedDocument,"Received remove for limbo target document without add."),r.receivedDocument=!1))}),e.emitNewSnapsAndNotifyLocalStore(n,t)}).catch(mf)},t.prototype.applyOnlineStateChange=function(t,e){if(this.isPrimary&&e===Lf.RemoteStore||!this.isPrimary&&e===Lf.SharedClientState){var n=[];this.queryViewsByQuery.forEach(function(e,r){var i=r.view.applyOnlineStateChange(t);zs(0===i.limboChanges.length,"OnlineState should not affect limbo documents."),i.snapshot&&n.push(i.snapshot)}),this.syncEngineListener.onOnlineStateChange(t),this.syncEngineListener.onWatchChange(n),this.onlineState=t,this.isPrimary&&this.sharedClientState.setOnlineState(t)}},t.prototype.rejectListen=function(t,e){return tr(this,void 0,void 0,function(){var n,r,i,o,a,s,u=this;return er(this,function(c){switch(c.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(t,"rejected",e),n=this.limboResolutionsByTarget[t],(r=n&&n.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(r),delete this.limboResolutionsByTarget[t],i=(i=new Qu(Bu.comparator)).insert(r,new ju(r,Ac.forDeletedDoc())),o=ah().add(r),a=new mh(Ac.MIN,{},new Mc(Eu),i,o),[2,this.applyRemoteEvent(a)]):[3,1];case 1:return zs(!!(s=this.queryViewsByTarget[t]),"Unknown targetId: "+t),[4,this.localStore.releaseQuery(s.query,!1).then(function(){return u.removeAndCleanupQuery(s)}).catch(mf)];case 2:c.sent(),this.syncEngineListener.onWatchError(s.query,e),c.label=3;case 3:return[2]}})})},t.prototype.applyBatchState=function(t,e,n){return tr(this,void 0,void 0,function(){var r;return er(this,function(i){switch(i.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(t)];case 1:return null===(r=i.sent())?(Us("SyncEngine","Cannot apply mutation batch with id: "+t),[2]):"pending"!==e?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return i.sent(),[3,4];case 3:"acknowledged"===e||"rejected"===e?(this.processUserCallback(t,n||null),this.localStore.removeCachedMutationBatchMetadata(t)):Qs("Unknown batchState: "+e),i.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(r)];case 5:return i.sent(),[2]}})})},t.prototype.applySuccessfulWrite=function(t){var e=this;this.assertSubscribed("applySuccessfulWrite()");var n=t.batch.batchId;return this.processUserCallback(n,null),this.localStore.acknowledgeBatch(t).then(function(t){return e.sharedClientState.updateMutationState(n,"acknowledged"),e.emitNewSnapsAndNotifyLocalStore(t)}).catch(mf)},t.prototype.rejectFailedWrite=function(t,e){var n=this;return this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(t,e),this.localStore.rejectBatch(t).then(function(r){return n.sharedClientState.updateMutationState(t,"rejected",e),n.emitNewSnapsAndNotifyLocalStore(r)}).catch(mf)},t.prototype.addMutationCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n||(n=new Qu(Eu)),n=n.insert(t,e),this.mutationUserCallbacks[this.currentUser.toKey()]=n},t.prototype.processUserCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];if(n){var r=n.get(t);r&&(zs(t===n.minKey(),"Mutation callbacks processed out-of-order?"),e?r.reject(e):r.resolve(),n=n.remove(t)),this.mutationUserCallbacks[this.currentUser.toKey()]=n}},t.prototype.removeAndCleanupQuery=function(t){var e=this;if(this.sharedClientState.removeLocalQueryTarget(t.targetId),this.queryViewsByQuery.delete(t.query),delete this.queryViewsByTarget[t.targetId],this.isPrimary){var n=this.limboDocumentRefs.referencesForId(t.targetId);this.limboDocumentRefs.removeReferencesForId(t.targetId),n.forEach(function(t){e.limboDocumentRefs.containsKey(t)||e.removeLimboTarget(t)})}},t.prototype.removeLimboTarget=function(t){var e=this.limboTargetsByKey.get(t);null!==e&&(this.remoteStore.unlisten(e),this.limboTargetsByKey=this.limboTargetsByKey.remove(t),delete this.limboResolutionsByTarget[e])},t.prototype.updateTrackedLimbos=function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n];if(i instanceof Xf)this.limboDocumentRefs.addReference(i.key,t),this.trackLimboChange(i);else if(i instanceof Jf){Us("SyncEngine","Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,t),this.limboDocumentRefs.containsKey(i.key)||this.removeLimboTarget(i.key)}else Qs("Unknown limbo change: "+JSON.stringify(i))}},t.prototype.trackLimboChange=function(t){var e=t.key;if(!this.limboTargetsByKey.get(e)){Us("SyncEngine","New document in limbo: "+e);var n=this.limboTargetIdGenerator.next(),r=gc.atPath(e.path);this.limboResolutionsByTarget[n]=new td(e),this.remoteStore.listen(new Nc(r,n,yc.LimboResolution,Vh.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(e,n)}},t.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},t.prototype.emitNewSnapsAndNotifyLocalStore=function(t,e){return tr(this,void 0,void 0,function(){var n,r,i,o=this;return er(this,function(a){switch(a.label){case 0:return n=[],r=[],i=[],this.queryViewsByQuery.forEach(function(a,s){i.push(Promise.resolve().then(function(){var e=s.view.computeDocChanges(t);return e.needsRefill?o.localStore.executeQuery(s.query).then(function(t){return s.view.computeDocChanges(t,e)}):e}).then(function(t){var i=e&&e.targetChanges[s.targetId],a=s.view.applyChanges(t,!0===o.isPrimary,i);if(o.updateTrackedLimbos(s.targetId,a.limboChanges),a.snapshot){o.isPrimary&&o.sharedClientState.updateQueryState(s.targetId,a.snapshot.fromCache?"not-current":"current"),n.push(a.snapshot);var u=Yf.fromSnapshot(s.targetId,a.snapshot);r.push(u)}}))}),[4,Promise.all(i)];case 1:return a.sent(),this.syncEngineListener.onWatchChange(n),[4,this.localStore.notifyLocalViewChanges(r)];case 2:return a.sent(),[2]}})})},t.prototype.assertSubscribed=function(t){zs(null!==this.syncEngineListener,"Trying to call "+t+" before calling subscribe().")},t.prototype.handleCredentialChange=function(t){return tr(this,void 0,void 0,function(){var e,n;return er(this,function(r){switch(r.label){case 0:return e=!this.currentUser.isEqual(t),this.currentUser=t,e?[4,this.localStore.handleUserChange(t)]:[3,3];case 1:return n=r.sent(),this.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(n.affectedDocuments)];case 2:r.sent(),r.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return r.sent(),[2]}})})},t.prototype.applyPrimaryState=function(t){return tr(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u=this;return er(this,function(c){switch(c.label){case 0:return!0!==t||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return c.sent(),e=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e.toArray())];case 2:for(n=c.sent(),r=0,i=n;r<i.length;r++)o=i[r],this.remoteStore.listen(o);return[3,7];case 3:return!1!==t||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,a=[],s=Promise.resolve(),Zs(this.queryViewsByTarget,function(t,e){u.sharedClientState.isLocalQueryTarget(t)?a.push(t):s=s.then(function(){return u.unlisten(e.query)}),u.remoteStore.unlisten(e.targetId)}),[4,s]);case 4:return c.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(a)];case 5:return c.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:c.sent(),c.label=7;case 7:return[2]}})})},t.prototype.resetLimboDocuments=function(){var t=this;Zs(this.limboResolutionsByTarget,function(e){t.remoteStore.unlisten(e)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new Qu(Bu.comparator)},t.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(t){for(var e=this,n=Promise.resolve(),r=[],i=[],o=function(t){n=n.then(function(){return tr(e,void 0,void 0,function(){var e,n,o,a;return er(this,function(s){switch(s.label){case 0:return(n=this.queryViewsByTarget[t])?[4,this.localStore.releaseQuery(n.query,!0)]:[3,4];case 1:return s.sent(),[4,this.localStore.allocateQuery(n.query)];case 2:return e=s.sent(),[4,this.synchronizeViewAndComputeSnapshot(n)];case 3:return(o=s.sent()).snapshot&&i.push(o.snapshot),[3,8];case 4:return zs(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(t)];case 5:return zs(!!(a=s.sent()),"Query data for target "+t+" not found"),[4,this.localStore.allocateQuery(a)];case 6:return e=s.sent(),[4,this.initializeViewAndComputeSnapshot(e,!1)];case 7:s.sent(),s.label=8;case 8:return r.push(e),[2]}})})})},a=0,s=t;a<s.length;a++){o(s[a])}return n.then(function(){return e.syncEngineListener.onWatchChange(i),r})},t.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},t.prototype.applyTargetState=function(t,e,n){return tr(this,void 0,void 0,function(){var r,i=this;return er(this,function(o){switch(o.label){case 0:if(this.isPrimary)return Us("SyncEngine","Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[t])return[3,5];switch(e){case"current":case"not-current":return[3,1];case"rejected":return[3,2]}return[3,4];case 1:return[2,this.localStore.getNewDocumentChanges().then(function(n){return tr(i,void 0,void 0,function(){var r;return er(this,function(i){switch(i.label){case 0:return r=mh.createSynthesizedRemoteEventForCurrentChange(t,"current"===e),[4,this.emitNewSnapsAndNotifyLocalStore(n,r)];case 1:return i.sent(),[2]}})})},function(t){return tr(i,void 0,void 0,function(){var e;return er(this,function(n){switch(n.label){case 0:return function(t){return t.code===Hs.DATA_LOSS&&t.message===Tl}(t)?(e=[],Zs(this.queryViewsByTarget,function(t){return e.push(t)}),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e)]):[3,2];case 1:return n.sent(),[3,3];case 2:throw t;case 3:return[2]}})})})];case 2:return r=this.queryViewsByTarget[t],this.removeAndCleanupQuery(r),[4,this.localStore.releaseQuery(r.query,!0)];case 3:return o.sent(),this.syncEngineListener.onWatchError(r.query,n),[3,5];case 4:Qs("Unexpected target state: "+e),o.label=5;case 5:return[2]}})})},t.prototype.applyActiveTargetsChange=function(t,e){return tr(this,void 0,void 0,function(){var n,r,i,o,a,s,u,c,h,l=this;return er(this,function(f){switch(f.label){case 0:if(!this.isPrimary)return[2];n=0,r=t,f.label=1;case 1:return n<r.length?(h=r[n],zs(!this.queryViewsByTarget[h],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(h)]):[3,6];case 2:return zs(!!(i=f.sent()),"Query data for active target "+h+" not found"),[4,this.localStore.allocateQuery(i)];case 3:return o=f.sent(),[4,this.initializeViewAndComputeSnapshot(o,!1)];case 4:f.sent(),this.remoteStore.listen(o),f.label=5;case 5:return n++,[3,1];case 6:a=function(t){var e;return er(this,function(n){switch(n.label){case 0:return(e=s.queryViewsByTarget[t])?[4,s.localStore.releaseQuery(e.query,!1).then(function(){l.remoteStore.unlisten(t),l.removeAndCleanupQuery(e)}).catch(mf)]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}})},s=this,u=0,c=e,f.label=7;case 7:return u<c.length?(h=c[u],[5,a(h)]):[3,10];case 8:f.sent(),f.label=9;case 9:return u++,[3,7];case 10:return[2]}})})},t.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},t.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},t.prototype.getRemoteKeysForTarget=function(t){var e=this.limboResolutionsByTarget[t];return e&&e.receivedDocument?ah().add(e.key):this.queryViewsByTarget[t]?this.queryViewsByTarget[t].view.syncedDocuments:ah()},t}(),nd=function(){function t(t){this.uid=t}return t.prototype.isAuthenticated=function(){return null!=this.uid},t.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},t.prototype.isEqual=function(t){return t.uid===this.uid},t.UNAUTHENTICATED=new t(null),t.GOOGLE_CREDENTIALS=new t("google-credentials-uid"),t.FIRST_PARTY=new t("first-party-uid"),t}(),rd="SharedClientState",id="firestore_clients",od="firestore_mutations",ad="firestore_targets",sd="firestore_online_state",ud="firestore_sequence_number",cd=function(){function t(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r,zs(void 0!==r==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}return t.fromWebStorageEntry=function(e,n,r){var i=JSON.parse(r),o="object"==typeof i&&-1!==["pending","acknowledged","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error),a=void 0;return o&&i.error&&(o="string"==typeof i.error.message&&"string"==typeof i.error.code)&&(a=new Ys(i.error.code,i.error.message)),o?new t(e,n,i.state,a):(js(rd,"Failed to parse mutation state for ID '"+n+"': "+r),null)},t.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),hd=function(){function t(t,e,n){this.targetId=t,this.state=e,this.error=n,zs(void 0!==n==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}return t.fromWebStorageEntry=function(e,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["not-current","current","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new Ys(r.error.code,r.error.message)),i?new t(e,r.state,o):(js(rd,"Failed to parse target state for ID '"+e+"': "+n),null)},t.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),ld=function(){function t(t,e){this.clientId=t,this.activeTargetIds=e}return t.fromWebStorageEntry=function(e,n){for(var r=JSON.parse(n),i="object"==typeof r&&r.activeTargetIds instanceof Array,o=uh(),a=0;i&&a<r.activeTargetIds.length;++a)i=mc(r.activeTargetIds[a]),o=o.add(r.activeTargetIds[a]);return i?new t(e,o):(js(rd,"Failed to parse client data for instance '"+e+"': "+n),null)},t}(),fd=function(){function t(t,e){this.clientId=t,this.onlineState=e}return t.fromWebStorageEntry=function(e){var n=JSON.parse(e);return"object"==typeof n&&void 0!==Pf[n.onlineState]&&"string"==typeof n.clientId?new t(n.clientId,Pf[n.onlineState]):(js(rd,"Failed to parse online state: "+e),null)},t}(),dd=function(){function t(){this.activeTargetIds=uh()}return t.prototype.addQueryTarget=function(t){zs(!this.activeTargetIds.has(t),"Target with ID '"+t+"' already active."),this.activeTargetIds=this.activeTargetIds.add(t)},t.prototype.removeQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},t.prototype.toWebStorageJSON=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},t}(),pd=function(){function t(e,n,r,i,o){if(this.queue=e,this.platform=n,this.persistenceKey=r,this.localClientId=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!t.isAvailable(this.platform))throw new Ys(Hs.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var a=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=o,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey=ud+"_"+r,this.activeClients[this.localClientId]=new dd,this.clientStateKeyRe=new RegExp("^"+id+"_"+a+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+od+"_"+a+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+ad+"_"+a+"_(\\d+)$"),this.onlineStateKey=sd+"_"+r,this.platform.window.addEventListener("storage",this.storageListener)}return t.isAvailable=function(t){return!(!t.window||null==t.window.localStorage)},t.prototype.start=function(){return tr(this,void 0,void 0,function(){var t,e,n,r,i,o,a,s,u,c,h,l=this;return er(this,function(f){switch(f.label){case 0:return zs(!this.started,"WebStorageSharedClientState already started"),zs(null!==this.syncEngine,"syncEngine property must be set before calling start()"),zs(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(t=f.sent(),e=0,n=t;e<n.length;e++)(r=n[e])!==this.localClientId&&(i=this.getItem(this.toWebStorageClientStateKey(r)))&&(o=ld.fromWebStorageEntry(r,i))&&(this.activeClients[o.clientId]=o);for(this.persistClientState(),(a=this.storage.getItem(this.onlineStateKey))&&(s=this.fromWebStorageOnlineState(a))&&this.handleOnlineStateEvent(s),u=0,c=this.earlyEvents;u<c.length;u++)h=c[u],this.handleWebStorageEvent(h);return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return l.shutdown()}),this.started=!0,[2]}})})},t.prototype.writeSequenceNumber=function(t){this.setItem(this.sequenceNumberKey,JSON.stringify(t))},t.prototype.getAllActiveQueryTargets=function(){var t=uh();return tu(this.activeClients,function(e,n){t=t.unionWith(n.activeTargetIds)}),t},t.prototype.isActiveQueryTarget=function(t){for(var e in this.activeClients)if(this.activeClients.hasOwnProperty(e)&&this.activeClients[e].activeTargetIds.has(t))return!0;return!1},t.prototype.addPendingMutation=function(t){this.persistMutationState(t,"pending")},t.prototype.updateMutationState=function(t,e,n){this.persistMutationState(t,e,n),this.removeMutationState(t)},t.prototype.addLocalQueryTarget=function(t){var e="not-current";if(this.isActiveQueryTarget(t)){var n=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(t));if(n){var r=hd.fromWebStorageEntry(t,n);r&&(e=r.state)}}return this.localClientState.addQueryTarget(t),this.persistClientState(),e},t.prototype.removeLocalQueryTarget=function(t){this.localClientState.removeQueryTarget(t),this.persistClientState()},t.prototype.isLocalQueryTarget=function(t){return this.localClientState.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){this.removeItem(this.toWebStorageQueryTargetMetadataKey(t))},t.prototype.updateQueryState=function(t,e,n){this.persistQueryTargetState(t,e,n)},t.prototype.handleUserChange=function(t,e,n){var r=this;e.forEach(function(t){r.removeMutationState(t)}),this.currentUser=t,n.forEach(function(t){r.addPendingMutation(t)})},t.prototype.setOnlineState=function(t){this.persistOnlineState(t)},t.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},t.prototype.getItem=function(t){var e=this.storage.getItem(t);return Us(rd,"READ",t,e),e},t.prototype.setItem=function(t,e){Us(rd,"SET",t,e),this.storage.setItem(t,e)},t.prototype.removeItem=function(t){Us(rd,"REMOVE",t),this.storage.removeItem(t)},t.prototype.handleWebStorageEvent=function(t){var e=this;if(t.storageArea===this.storage){if(Us(rd,"EVENT",t.key,t.newValue),t.key===this.localClientStorageKey)return void js("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget(function(){return tr(e,void 0,void 0,function(){var e,n,r,i,o,a;return er(this,function(s){if(!this.started)return this.earlyEvents.push(t),[2];if(null===t.key)return[2];if(this.clientStateKeyRe.test(t.key)){if(null==t.newValue)return n=this.fromWebStorageClientStateKey(t.key),[2,this.handleClientStateEvent(n,null)];if(e=this.fromWebStorageClientState(t.key,t.newValue))return[2,this.handleClientStateEvent(e.clientId,e)]}else if(this.mutationBatchKeyRe.test(t.key)){if(null!==t.newValue&&(r=this.fromWebStorageMutationMetadata(t.key,t.newValue)))return[2,this.handleMutationBatchEvent(r)]}else if(this.queryTargetKeyRe.test(t.key)){if(null!==t.newValue&&(i=this.fromWebStorageQueryTargetMetadata(t.key,t.newValue)))return[2,this.handleQueryTargetEvent(i)]}else if(t.key===this.onlineStateKey){if(null!==t.newValue&&(o=this.fromWebStorageOnlineState(t.newValue)))return[2,this.handleOnlineStateEvent(o)]}else t.key===this.sequenceNumberKey&&(zs(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(a=function(t){var e=Vh.INVALID;if(null!=t)try{var n=JSON.parse(t);zs("number"==typeof n,"Found non-numeric sequence number"),e=n}catch(t){js(rd,"Failed to read sequence number from WebStorage",t)}return e}(t.newValue))!==Vh.INVALID&&this.sequenceNumberHandler(a));return[2]})})})}},Object.defineProperty(t.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),t.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},t.prototype.persistMutationState=function(t,e,n){var r=new cd(this.currentUser,t,e,n),i=this.toWebStorageMutationBatchKey(t);this.setItem(i,r.toWebStorageJSON())},t.prototype.removeMutationState=function(t){var e=this.toWebStorageMutationBatchKey(t);this.removeItem(e)},t.prototype.persistOnlineState=function(t){var e={clientId:this.localClientId,onlineState:Pf[t]};this.storage.setItem(this.onlineStateKey,JSON.stringify(e))},t.prototype.persistQueryTargetState=function(t,e,n){var r=this.toWebStorageQueryTargetMetadataKey(t),i=new hd(t,e,n);this.setItem(r,i.toWebStorageJSON())},t.prototype.toWebStorageClientStateKey=function(t){return zs(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),id+"_"+this.persistenceKey+"_"+t},t.prototype.toWebStorageQueryTargetMetadataKey=function(t){return ad+"_"+this.persistenceKey+"_"+t},t.prototype.toWebStorageMutationBatchKey=function(t){var e=od+"_"+this.persistenceKey+"_"+t;return this.currentUser.isAuthenticated()&&(e+="_"+this.currentUser.uid),e},t.prototype.fromWebStorageClientStateKey=function(t){var e=this.clientStateKeyRe.exec(t);return e?e[1]:null},t.prototype.fromWebStorageClientState=function(t,e){var n=this.fromWebStorageClientStateKey(t);return zs(null!==n,"Cannot parse client state key '"+t+"'"),ld.fromWebStorageEntry(n,e)},t.prototype.fromWebStorageMutationMetadata=function(t,e){var n=this.mutationBatchKeyRe.exec(t);zs(null!==n,"Cannot parse mutation batch key '"+t+"'");var r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return cd.fromWebStorageEntry(new nd(i),r,e)},t.prototype.fromWebStorageQueryTargetMetadata=function(t,e){var n=this.queryTargetKeyRe.exec(t);zs(null!==n,"Cannot parse query target key '"+t+"'");var r=Number(n[1]);return hd.fromWebStorageEntry(r,e)},t.prototype.fromWebStorageOnlineState=function(t){return fd.fromWebStorageEntry(t)},t.prototype.handleMutationBatchEvent=function(t){return tr(this,void 0,void 0,function(){return er(this,function(e){return t.user.uid!==this.currentUser.uid?(Us(rd,"Ignoring mutation for non-active user "+t.user.uid),[2]):[2,this.syncEngine.applyBatchState(t.batchId,t.state,t.error)]})})},t.prototype.handleQueryTargetEvent=function(t){return this.syncEngine.applyTargetState(t.targetId,t.state,t.error)},t.prototype.handleClientStateEvent=function(t,e){var n=this,r=this.getAllActiveQueryTargets();e?this.activeClients[t]=e:delete this.activeClients[t];var i=this.getAllActiveQueryTargets(),o=[],a=[];return i.forEach(function(t){return tr(n,void 0,void 0,function(){return er(this,function(e){return r.has(t)||o.push(t),[2]})})}),r.forEach(function(t){return tr(n,void 0,void 0,function(){return er(this,function(e){return i.has(t)||a.push(t),[2]})})}),this.syncEngine.applyActiveTargetsChange(o,a)},t.prototype.handleOnlineStateEvent=function(t){this.activeClients[t.clientId]&&this.onlineStateHandler(t.onlineState)},t}();var md=function(){function t(){this.localState=new dd,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}return t.prototype.addPendingMutation=function(t){},t.prototype.updateMutationState=function(t,e,n){},t.prototype.addLocalQueryTarget=function(t){return this.localState.addQueryTarget(t),this.queryState[t]||"not-current"},t.prototype.updateQueryState=function(t,e,n){this.queryState[t]=e},t.prototype.removeLocalQueryTarget=function(t){this.localState.removeQueryTarget(t)},t.prototype.isLocalQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){delete this.queryState[t]},t.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},t.prototype.isActiveQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},t.prototype.start=function(){return this.localState=new dd,Promise.resolve()},t.prototype.handleUserChange=function(t,e,n){},t.prototype.setOnlineState=function(t){},t.prototype.shutdown=function(){},t.prototype.writeSequenceNumber=function(t){},t}(),yd=function(){function t(t,e){this.cacheSizeBytes=t,this.experimentalTabSynchronization=e}return t.prototype.lruParams=function(){return of.withCacheSize(this.cacheSizeBytes)},t}(),gd=function(){return function(){}}(),vd=function(){function t(t,e,n,r){this.platform=t,this.databaseInfo=e,this.credentials=n,this.asyncQueue=r,this.clientId=wu.newId(),this.isShutdown=!1}return t.prototype.start=function(t){var e=this;this.verifyNotShutdown();var n=new Uh,r=new Uh,i=!1;return this.credentials.setChangeListener(function(o){i?e.asyncQueue.enqueueAndForget(function(){return e.handleCredentialChange(o)}):(i=!0,e.initializePersistence(t,r,o).then(function(t){return e.initializeRest(o,t)}).then(n.resolve,n.reject))}),this.asyncQueue.enqueueAndForget(function(){return n.promise}),r.promise},t.prototype.enableNetwork=function(){var t=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return t.syncEngine.enableNetwork()})},t.prototype.initializePersistence=function(t,e,n){var r=this;return t instanceof yd?this.startIndexedDbPersistence(n,t).then(function(t){return e.resolve(),t}).catch(function(t){if(e.reject(t),!r.canFallback(t))throw t;return console.warn("Error enabling offline storage. Falling back to storage disabled: "+t),r.startMemoryPersistence()}):(e.resolve(),this.startMemoryPersistence())},t.prototype.canFallback=function(t){return t instanceof Ys?t.code===Hs.FAILED_PRECONDITION||t.code===Hs.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code)},t.prototype.verifyNotShutdown=function(){if(this.isShutdown)throw new Ys(Hs.FAILED_PRECONDITION,"The client has already been shutdown.")},t.prototype.startIndexedDbPersistence=function(t,e){var n=this,r=pf.buildStoragePrefix(this.databaseInfo),i=new Mh(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return tr(n,void 0,void 0,function(){var n,o;return er(this,function(a){switch(a.label){case 0:if(e.experimentalTabSynchronization&&!pd.isAvailable(this.platform))throw new Ys(Hs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return o=e.lruParams(),e.experimentalTabSynchronization?(this.sharedClientState=new pd(this.asyncQueue,this.platform,r,this.clientId,t),[4,pf.createMultiClientIndexedDbPersistence(r,this.clientId,this.platform,this.asyncQueue,i,o,{sequenceNumberSyncer:this.sharedClientState})]):[3,2];case 1:return n=a.sent(),[3,4];case 2:return this.sharedClientState=new md,[4,pf.createIndexedDbPersistence(r,this.clientId,this.platform,this.asyncQueue,i,o)];case 3:n=a.sent(),a.label=4;case 4:return this.persistence=n,[2,n.referenceDelegate.garbageCollector]}})})})},t.prototype.startMemoryPersistence=function(){return this.persistence=kf.createEagerPersistence(this.clientId),this.sharedClientState=new md,Promise.resolve(null)},t.prototype.initializeRest=function(t,e){var n=this;return Us("FirestoreClient","Initializing. user=",t.uid),this.platform.loadConnection(this.databaseInfo).then(function(r){return tr(n,void 0,void 0,function(){var n,i,o,a,s=this;return er(this,function(u){switch(u.label){case 0:return this.localStore=new Tf(this.persistence,t),e&&(this.lruScheduler=new af(e,this.asyncQueue,this.localStore)),n=this.platform.newSerializer(this.databaseInfo.databaseId),i=new jf(this.asyncQueue,r,this.credentials,n),o=function(t){return s.syncEngine.applyOnlineStateChange(t,Lf.RemoteStore)},a=function(t){return s.syncEngine.applyOnlineStateChange(t,Lf.SharedClientState)},this.remoteStore=new zf(this.localStore,i,this.asyncQueue,o),this.syncEngine=new ed(this.localStore,this.remoteStore,this.sharedClientState,t),this.sharedClientState.onlineStateHandler=a,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new Wf(this.syncEngine),[4,this.sharedClientState.start()];case 1:return u.sent(),[4,this.remoteStore.start()];case 2:return u.sent(),[4,this.persistence.setPrimaryStateListener(function(t){return tr(s,void 0,void 0,function(){return er(this,function(e){switch(e.label){case 0:return[4,this.syncEngine.applyPrimaryState(t)];case 1:return e.sent(),this.lruScheduler&&(t&&!this.lruScheduler.started?this.lruScheduler.start():t||this.lruScheduler.stop()),[2]}})})})];case 3:return u.sent(),[2]}})})})},t.prototype.handleCredentialChange=function(t){return this.asyncQueue.verifyOperationInProgress(),Us("FirestoreClient","Credential Changed. Current user: "+t.uid),this.syncEngine.handleCredentialChange(t)},t.prototype.disableNetwork=function(){var t=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return t.syncEngine.disableNetwork()})},t.prototype.shutdown=function(){var t=this;return!0===this.isShutdown?Promise.resolve():this.asyncQueue.enqueue(function(){return tr(t,void 0,void 0,function(){return er(this,function(t){switch(t.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return t.sent(),[4,this.sharedClientState.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown()];case 3:return t.sent(),this.credentials.removeChangeListener(),this.isShutdown=!0,[2]}})})})},t.prototype.listen=function(t,e,n){var r=this;this.verifyNotShutdown();var i=new Hf(t,e,n);return this.asyncQueue.enqueueAndForget(function(){return r.eventMgr.listen(i)}),i},t.prototype.unlisten=function(t){var e=this;this.verifyNotShutdown(),this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.unlisten(t)})},t.prototype.getDocumentFromLocalCache=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return e.localStore.readDocument(t)}).then(function(t){if(t instanceof Uu)return t;if(t instanceof ju)return null;throw new Ys(Hs.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},t.prototype.getDocumentsFromLocalCache=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return e.localStore.executeQuery(t)}).then(function(e){var n=ah(),r=new $f(t,n),i=r.computeDocChanges(e);return r.applyChanges(i,!1).snapshot})},t.prototype.write=function(t){var e=this;this.verifyNotShutdown();var n=new Uh;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.write(t,n)}),n.promise},t.prototype.databaseId=function(){return this.databaseInfo.databaseId},t.prototype.transaction=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return tr(e,void 0,void 0,function(){return er(this,function(t){return[2]})})}).then(function(){return e.syncEngine.runTransaction(t)})},t}(),bd=function(){function t(t){this.observer=t,this.muted=!1}return t.prototype.next=function(t){this.scheduleEvent(this.observer.next,t)},t.prototype.error=function(t){this.scheduleEvent(this.observer.error,t)},t.prototype.mute=function(){this.muted=!0},t.prototype.scheduleEvent=function(t,e){var n=this;this.muted||setTimeout(function(){n.muted||t(e)},0)},t}(),wd=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];!function(t,e,n,r){if(!(e instanceof Array)||e.length<r)throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" argument to be an array with at least "+bu(r,"element")+".")}("FieldPath",t,"fieldNames",1);for(var n=0;n<t.length;++n)if(au("FieldPath","string",n,t[n]),0===t[n].length)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new qu(t)}return t.documentId=function(){return t._DOCUMENT_ID},t.prototype.isEqual=function(e){if(!(e instanceof t))throw gu("isEqual","FieldPath",1,e);return this._internalPath.isEqual(e._internalPath)},t._DOCUMENT_ID=new t(qu.keyField().canonicalString()),t}(),Ed=new RegExp("[~\\*/\\[\\]]");var Sd=function(){return function(t,e){this.user=e,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+t}}}(),Td=function(){function t(){this.changeListener=null}return t.prototype.getToken=function(){return Promise.resolve(null)},t.prototype.invalidateToken=function(){},t.prototype.setChangeListener=function(t){zs(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,t(nd.UNAUTHENTICATED)},t.prototype.removeChangeListener=function(){zs(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},t}(),_d=function(){function t(t){var e=this;this.app=t,this.tokenListener=null,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){e.tokenCounter++,e.currentUser=e.getUser(),e.changeListener&&e.changeListener(e.currentUser)},this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}return t.prototype.getToken=function(){var t=this;zs(null!=this.tokenListener,"getToken cannot be called after listener removed.");var e=this.tokenCounter,n=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(n).then(function(n){if(t.tokenCounter!==e)throw new Ys(Hs.ABORTED,"getToken aborted due to token change.");return n?(zs("string"==typeof n.accessToken,"Invalid tokenData returned from getToken():"+n),new Sd(n.accessToken,t.currentUser)):null})},t.prototype.invalidateToken=function(){this.forceRefresh=!0},t.prototype.setChangeListener=function(t){zs(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,this.currentUser&&t(this.currentUser)},t.prototype.removeChangeListener=function(){zs(null!=this.tokenListener,"removeChangeListener() called twice"),zs(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},t.prototype.getUser=function(){var t=this.app.INTERNAL.getUid();return zs(null===t||"string"==typeof t,"Received invalid UID: "+t),new nd(t)},t}(),Id=function(){function t(t,e){this.gapi=t,this.sessionIndex=e,this.type="FirstParty",this.user=nd.FIRST_PARTY}return Object.defineProperty(t.prototype,"authHeaders",{get:function(){var t={"X-Goog-AuthUser":this.sessionIndex},e=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),t},enumerable:!0,configurable:!0}),t}(),Cd=function(){function t(t,e){this.gapi=t,this.sessionIndex=e}return t.prototype.getToken=function(){return Promise.resolve(new Id(this.gapi,this.sessionIndex))},t.prototype.setChangeListener=function(t){t(nd.FIRST_PARTY)},t.prototype.removeChangeListener=function(){},t.prototype.invalidateToken=function(){},t}();function Dd(t){return function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=t,r=0,i=e;r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return!0}return!1}(t,["next","error","complete"])}var Ad,kd=function(){function t(t){this._methodName=t}return t.delete=function(){return nu("FieldValue.delete",arguments),Nd.instance},t.serverTimestamp=function(){return nu("FieldValue.serverTimestamp",arguments),Md.instance},t.arrayUnion=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return iu("FieldValue.arrayUnion",arguments,1),new Od(t)},t.arrayRemove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return iu("FieldValue.arrayRemove",arguments,1),new Rd(t)},t.increment=function(t){return au("FieldValue.increment","number",1,t),ru("FieldValue.increment",arguments,1),new Pd(t)},t.prototype.isEqual=function(t){return this===t},t}(),Nd=function(t){function e(){return t.call(this,"FieldValue.delete")||this}return $n(e,t),e.instance=new e,e}(kd),Md=function(t){function e(){return t.call(this,"FieldValue.serverTimestamp")||this}return $n(e,t),e.instance=new e,e}(kd),Od=function(t){function e(e){var n=t.call(this,"FieldValue.arrayUnion")||this;return n._elements=e,n}return $n(e,t),e}(kd),Rd=function(t){function e(e){var n=t.call(this,"FieldValue.arrayRemove")||this;return n._elements=e,n}return $n(e,t),e}(kd),Pd=function(t){function e(e){var n=t.call(this,"FieldValue.increment")||this;return n._operand=e,n}return $n(e,t),e}(kd),Ld=Xs(kd,"Use FieldValue.<field>() instead."),xd=/^__.*__$/,Fd=function(){function t(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}return t.prototype.toMutations=function(t,e){var n=[];return null!==this.fieldMask?n.push(new Bc(t,this.data,this.fieldMask,e)):n.push(new qc(t,this.data,e)),this.fieldTransforms.length>0&&n.push(new Vc(t,this.fieldTransforms)),n},t}(),qd=function(){function t(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}return t.prototype.toMutations=function(t,e){var n=[new Bc(t,this.data,this.fieldMask,e)];return this.fieldTransforms.length>0&&n.push(new Vc(t,this.fieldTransforms)),n},t}();function Bd(t){switch(t){case Ad.Set:case Ad.MergeSet:case Ad.Update:return!0;case Ad.Argument:return!1;default:throw Qs("Unexpected case for UserDataSource: "+t)}}!function(t){t[t.Set=0]="Set",t[t.Update=1]="Update",t[t.MergeSet=2]="MergeSet",t[t.Argument=3]="Argument"}(Ad||(Ad={}));var Vd=function(){function t(t,e,n,r,i,o){this.dataSource=t,this.methodName=e,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}return t.prototype.childContextForField=function(e){var n=null==this.path?null:this.path.child(e),r=new t(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePathSegment(e),r},t.prototype.childContextForFieldPath=function(e){var n=null==this.path?null:this.path.child(e),r=new t(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePath(),r},t.prototype.childContextForArray=function(e){return new t(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},t.prototype.createError=function(t){var e=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new Ys(Hs.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+e)},t.prototype.contains=function(t){return void 0!==this.fieldMask.find(function(e){return t.isPrefixOf(e)})||void 0!==this.fieldTransforms.find(function(e){return t.isPrefixOf(e.field)})},t.prototype.validatePath=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.validatePathSegment(this.path.get(t))},t.prototype.validatePathSegment=function(t){if(Bd(this.dataSource)&&xd.test(t))throw this.createError("Document fields cannot begin and end with __")},t}(),Ud=function(){return function(t,e){this.databaseId=t,this.key=e}}(),jd=function(){function t(t){this.preConverter=t}return t.prototype.parseSetData=function(t,e){var n=new Vd(Ad.Set,t,qu.EMPTY_PATH);Qd("Data must be an object, but it was:",n,e);var r=this.parseData(e,n);return new Fd(r,null,n.fieldTransforms)},t.prototype.parseMergeData=function(t,e,n){var r=new Vd(Ad.MergeSet,t,qu.EMPTY_PATH);Qd("Data must be an object, but it was:",r,e);var i,o,a=this.parseData(e,r);if(n){for(var s=new Mc(qu.comparator),u=0,c=n;u<c.length;u++){var h=c[u],l=void 0;if(h instanceof wd)l=h._internalPath;else{if("string"!=typeof h)throw Qs("Expected stringOrFieldPath to be a string or a FieldPath");l=Gd(t,h)}if(!r.contains(l))throw new Ys(Hs.INVALID_ARGUMENT,"Field '"+l+"' is specified in your field mask but missing from your input data.");s=s.add(l)}i=Rc.fromSet(s),o=r.fieldTransforms.filter(function(t){return i.covers(t.field)})}else i=Rc.fromArray(r.fieldMask),o=r.fieldTransforms;return new Fd(a,i,o)},t.prototype.parseUpdateData=function(t,e){var n=this,r=new Vd(Ad.Update,t,qu.EMPTY_PATH);Qd("Data must be an object, but it was:",r,e);var i=new Mc(qu.comparator),o=uc.EMPTY;tu(e,function(e,a){var s=Gd(t,e),u=r.childContextForFieldPath(s);if((a=n.runPreConverter(a,u))instanceof Nd)i=i.add(s);else{var c=n.parseData(a,u);null!=c&&(i=i.add(s),o=o.set(s,c))}});var a=Rc.fromSet(i);return new qd(o,a,r.fieldTransforms)},t.prototype.parseUpdateVarargs=function(t,e,n,r){var i=new Vd(Ad.Update,t,qu.EMPTY_PATH),o=[zd(t,e)],a=[n];if(r.length%2!=0)throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var s=0;s<r.length;s+=2)o.push(zd(t,r[s])),a.push(r[s+1]);var u=new Mc(qu.comparator),c=uc.EMPTY;for(s=0;s<o.length;++s){var h=o[s],l=i.childContextForFieldPath(h),f=this.runPreConverter(a[s],l);if(f instanceof Nd)u=u.add(h);else{var d=this.parseData(f,l);null!=d&&(u=u.add(h),c=c.set(h,d))}}var p=Rc.fromSet(u);return new qd(c,p,i.fieldTransforms)},t.prototype.parseQueryValue=function(t,e){var n=new Vd(Ad.Argument,t,qu.EMPTY_PATH),r=this.parseData(e,n);return zs(null!=r,"Parsed data should not be null."),zs(0===n.fieldTransforms.length,"Field transforms should have been disallowed."),r},t.prototype.runPreConverter=function(t,e){try{return this.preConverter(t)}catch(t){var n=Wd(t);throw e.createError(n)}},t.prototype.parseData=function(t,e){if(Kd(t=this.runPreConverter(t,e)))return Qd("Unsupported field value:",e,t),this.parseObject(t,e);if(t instanceof kd)return this.parseSentinelFieldValue(t,e),null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.arrayElement)throw e.createError("Nested arrays are not supported");return this.parseArray(t,e)}return this.parseScalarValue(t,e)},t.prototype.parseObject=function(t,e){var n=this,r=new Qu(Eu);return eu(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):tu(t,function(t,i){var o=n.parseData(i,e.childContextForField(t));null!=o&&(r=r.insert(t,o))}),new uc(r)},t.prototype.parseArray=function(t,e){for(var n=[],r=0,i=0,o=t;i<o.length;i++){var a=o[i],s=this.parseData(a,e.childContextForArray(r));null==s&&(s=Xu.INSTANCE),n.push(s),r++}return new cc(n)},t.prototype.parseSentinelFieldValue=function(t,e){if(!Bd(e.dataSource))throw e.createError(t._methodName+"() can only be used with update() and set()");if(null===e.path)throw e.createError(t._methodName+"() is not currently supported inside arrays");if(t instanceof Nd){if(e.dataSource!==Ad.MergeSet)throw e.dataSource===Ad.Update?(zs(e.path.length>0,"FieldValue.delete() at the top level should have already been handled."),e.createError("FieldValue.delete() can only appear at the top level of your update data")):e.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.fieldMask.push(e.path)}else if(t instanceof Md)e.fieldTransforms.push(new Pc(e.path,jc.instance));else if(t instanceof Od){var n=this.parseArrayTransformElements(t._methodName,t._elements),r=new Kc(n);e.fieldTransforms.push(new Pc(e.path,r))}else if(t instanceof Rd){n=this.parseArrayTransformElements(t._methodName,t._elements);var i=new Qc(n);e.fieldTransforms.push(new Pc(e.path,i))}else if(t instanceof Pd){var o=this.parseQueryValue("FieldValue.increment",t._operand),a=new zc(o);e.fieldTransforms.push(new Pc(e.path,a))}else Qs("Unknown FieldValue type: "+t)},t.prototype.parseScalarValue=function(t,e){if(null===t)return Xu.INSTANCE;if("number"==typeof t)return mc(t)?new tc(t):new ec(t);if("boolean"==typeof t)return Ju.of(t);if("string"==typeof t)return new nc(t);if(t instanceof Date)return new rc(Mu.fromDate(t));if(t instanceof Mu)return new rc(new Mu(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof Nu)return new sc(t);if(t instanceof Au)return new oc(t);if(t instanceof Ud)return new ac(t.databaseId,t.key);throw e.createError("Unsupported field value: "+pu(t))},t.prototype.parseArrayTransformElements=function(t,e){var n=this;return e.map(function(e,r){var i=new Vd(Ad.Argument,t,qu.EMPTY_PATH);return n.parseData(e,i.childContextForArray(r))})},t}();function Kd(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Mu||t instanceof Nu||t instanceof Au||t instanceof Ud||t instanceof kd)}function Qd(t,e,n){if(!Kd(n)||!du(n)){var r=pu(n);throw"an object"===r?e.createError(t+" a custom object"):e.createError(t+" "+r)}}function zd(t,e){if(e instanceof wd)return e._internalPath;if("string"==typeof e)return Gd(t,e);throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function Gd(t,e){try{return function(t){if(t.search(Ed)>=0)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(wd.bind.apply(wd,[void 0].concat(t.split("."))))}catch(e){throw new Ys(Hs.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(e)._internalPath}catch(e){var n=Wd(e);throw new Ys(Hs.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. "+n)}}function Wd(t){return t instanceof Error?t.message:t.toString()}var Hd="firestore.googleapis.com",Yd=!0,Xd=!0,Jd=!1,$d=of.COLLECTION_DISABLED,Zd=function(){function t(t){if(void 0===t.host){if(void 0!==t.ssl)throw new Ys(Hs.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=Hd,this.ssl=Yd}else uu("settings","non-empty string","host",t.host),this.host=t.host,cu("settings","boolean","ssl",t.ssl),this.ssl=$s(t.ssl,Yd);if(yu("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),cu("settings","object","credentials",t.credentials),this.credentials=t.credentials,cu("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?js("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&js("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=$s(t.timestampsInSnapshots,Xd),cu("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=of.DEFAULT_CACHE_SIZE_BYTES;else{if(t.cacheSizeBytes!==$d&&t.cacheSizeBytes<of.MINIMUM_CACHE_SIZE_BYTES)throw new Ys(Hs.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+of.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=t.cacheSizeBytes}cu("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0===t.experimentalForceLongPolling?Jd:t.experimentalForceLongPolling}return t.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling},t}(),tp=function(){return function(){}}(),ep=function(){function t(e){var n=this;this._queue=new Kh,this.INTERNAL={delete:function(){return tr(n,void 0,void 0,function(){return er(this,function(t){switch(t.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.shutdown()];case 1:return t.sent(),this.clientRunning=!1,[2]}})})}},this.clientRunning=!1;var r=new tp;if("object"==typeof e.options){var i=e;r.firebaseApp=i,r.databaseId=t.databaseIdFromApp(i),r.persistenceKey=r.firebaseApp.name,r.credentials=new _d(i)}else{var o=e;if(!o.projectId)throw new Ys(Hs.INVALID_ARGUMENT,"Must provide projectId");r.databaseId=new Pu(o.projectId,o.database),r.persistenceKey="[DEFAULT]",r.credentials=new Td}r.settings=new Zd({}),this._config=r,this._databaseId=r.databaseId}return t.prototype.settings=function(t){if(ru("Firestore.settings",arguments,1),au("Firestore.settings","object",1,t),Js(t,"persistence"))throw new Ys(Hs.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var e=new Zd(t);if(this._firestoreClient&&!this._config.settings.isEqual(e))throw new Ys(Hs.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this._config.settings=e,void 0!==e.credentials&&(this._config.credentials=function(t){if(!t)return new Td;switch(t.type){case"gapi":var e=t.client;return zs(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new Cd(e,t.sessionIndex||"0");case"provider":return t.client;default:throw new Ys(Hs.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(e.credentials))},t.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},t.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},t.prototype.enablePersistence=function(t){if(this._firestoreClient)throw new Ys(Hs.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");return this.configureClient(new yd(this._config.settings.cacheSizeBytes,void 0!==t&&$s(t.experimentalTabSynchronization,!1)))},t.prototype._clearPersistence=function(){if(this.clientRunning)throw new Ys(Hs.FAILED_PRECONDITION,"Persistence cannot be cleared while the client is running");var t=pf.buildStoragePrefix(this.makeDatabaseInfo());return pf.clearPersistence(t)},t.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new gd),this._firestoreClient},t.prototype.makeDatabaseInfo=function(){return new Ou(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl,this._config.settings.forceLongPolling)},t.prototype.configureClient=function(t){var e=this;zs(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey"),zs(!this._firestoreClient,"configureClient() called multiple times"),this.clientRunning=!0;var n=this.makeDatabaseInfo();return this._dataConverter=new jd(function(t){if(t instanceof ip){var n=e._config.databaseId,r=t.firestore._config.databaseId;if(!r.isEqual(n))throw new Ys(Hs.INVALID_ARGUMENT,"Document reference is for database "+r.projectId+"/"+r.database+" but should be for database "+n.projectId+"/"+n.database);return new Ud(e._config.databaseId,t._key)}return t}),this._firestoreClient=new vd(Gs.getPlatform(),n,this._config.credentials,this._queue),this._firestoreClient.start(t)},t.databaseIdFromApp=function(t){var e=t.options;if(!Js(e,"projectId"))throw new Ys(Hs.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var n=e.projectId;if(!n||"string"!=typeof n)throw new Ys(Hs.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new Pu(n)},Object.defineProperty(t.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new Ys(Hs.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){return ru("Firestore.collection",arguments,1),au("Firestore.collection","non-empty string",1,t),this.ensureClientConfigured(),new hp(xu.fromString(t),this)},t.prototype.doc=function(t){return ru("Firestore.doc",arguments,1),au("Firestore.doc","non-empty string",1,t),this.ensureClientConfigured(),ip.forPath(xu.fromString(t),this)},t.prototype._collectionGroup=function(t){if(ru("Firestore.collectionGroup",arguments,1),au("Firestore.collectionGroup","non-empty string",1,t),t.indexOf("/")>=0)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new up(new gc(xu.EMPTY_PATH,t),this)},t.prototype.runTransaction=function(t){var e=this;return ru("Firestore.runTransaction",arguments,1),au("Firestore.runTransaction","function",1,t),this.ensureClientConfigured().transaction(function(n){return t(new np(e,n))})},t.prototype.batch=function(){return this.ensureClientConfigured(),new rp(this)},Object.defineProperty(t,"logLevel",{get:function(){switch(Bs()){case Ns.DEBUG:return"debug";case Ns.ERROR:return"error";case Ns.SILENT:return"silent";default:return Qs("Unknown log level: "+Bs())}},enumerable:!0,configurable:!0}),t.setLogLevel=function(t){switch(ru("Firestore.setLogLevel",arguments,1),au("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":Vs(Ns.DEBUG);break;case"error":Vs(Ns.ERROR);break;case"silent":Vs(Ns.SILENT);break;default:throw new Ys(Hs.INVALID_ARGUMENT,"Invalid log level: "+t)}},t.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots},t}(),np=function(){function t(t,e){this._firestore=t,this._transaction=e}return t.prototype.get=function(t){var e=this;ru("Transaction.get",arguments,1);var n=pp("Transaction.get",t,this._firestore);return this._transaction.lookup([n._key]).then(function(t){if(!t||1!==t.length)return Qs("Mismatch in docs returned from document lookup.");var r=t[0];if(r instanceof ju)return new ap(e._firestore,n._key,null,!1,!1);if(r instanceof Uu)return new ap(e._firestore,n._key,r,!1,!1);throw Qs("BatchGetDocumentsRequest returned unexpected document type: "+r.constructor.name)})},t.prototype.set=function(t,e,n){ou("Transaction.set",arguments,2,3);var r=pp("Transaction.set",t,this._firestore),i=(n=lp("Transaction.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",e);return this._transaction.set(r._key,i),this},t.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return"string"==typeof e||e instanceof wd?(iu("Transaction.update",arguments,3),r=pp("Transaction.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",e,n,o)):(ru("Transaction.update",arguments,2),r=pp("Transaction.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateData("Transaction.update",e)),this._transaction.update(r._key,i),this},t.prototype.delete=function(t){ru("Transaction.delete",arguments,1);var e=pp("Transaction.delete",t,this._firestore);return this._transaction.delete(e._key),this},t}(),rp=function(){function t(t){this._firestore=t,this._mutations=[],this._committed=!1}return t.prototype.set=function(t,e,n){ou("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var r=pp("WriteBatch.set",t,this._firestore),i=(n=lp("WriteBatch.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",e);return this._mutations=this._mutations.concat(i.toMutations(r._key,xc.NONE)),this},t.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return this.verifyNotCommitted(),"string"==typeof e||e instanceof wd?(iu("WriteBatch.update",arguments,3),r=pp("WriteBatch.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",e,n,o)):(ru("WriteBatch.update",arguments,2),r=pp("WriteBatch.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",e)),this._mutations=this._mutations.concat(i.toMutations(r._key,xc.exists(!0))),this},t.prototype.delete=function(t){ru("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var e=pp("WriteBatch.delete",t,this._firestore);return this._mutations=this._mutations.concat(new Uc(e._key,xc.NONE)),this},t.prototype.commit=function(){return tr(this,void 0,void 0,function(){return er(this,function(t){return this.verifyNotCommitted(),this._committed=!0,this._mutations.length>0?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},t.prototype.verifyNotCommitted=function(){if(this._committed)throw new Ys(Hs.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},t}(),ip=function(){function t(t,e){this._key=t,this.firestore=e,this._firestoreClient=this.firestore.ensureClientConfigured()}return t.forPath=function(e,n){if(e.length%2!=0)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new t(new Bu(e),n)},Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return new hp(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){if(ru("DocumentReference.collection",arguments,1),au("DocumentReference.collection","non-empty string",1,t),!t)throw new Ys(Hs.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var e=xu.fromString(t);return new hp(this._key.path.child(e),this.firestore)},t.prototype.isEqual=function(e){if(!(e instanceof t))throw gu("isEqual","DocumentReference",1,e);return this.firestore===e.firestore&&this._key.isEqual(e._key)},t.prototype.set=function(t,e){ou("DocumentReference.set",arguments,1,2);var n=(e=lp("DocumentReference.set",e)).merge||e.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",t,e.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",t);return this._firestoreClient.write(n.toMutations(this._key,xc.NONE))},t.prototype.update=function(t,e){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return"string"==typeof t||t instanceof wd?(iu("DocumentReference.update",arguments,2),n=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",t,e,r)):(ru("DocumentReference.update",arguments,1),n=this.firestore._dataConverter.parseUpdateData("DocumentReference.update",t)),this._firestoreClient.write(n.toMutations(this._key,xc.exists(!0)))},t.prototype.delete=function(){return ru("DocumentReference.delete",arguments,0),this._firestoreClient.write([new Uc(this._key,xc.NONE)])},t.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];ou("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},i=0;"object"!=typeof t[i]||Dd(t[i])||(yu("DocumentReference.onSnapshot",r=t[i],["includeMetadataChanges"]),cu("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++);var o={includeMetadataChanges:r.includeMetadataChanges};return Dd(t[i])?n=t[i]:(au("DocumentReference.onSnapshot","function",i,t[i]),su("DocumentReference.onSnapshot","function",i+1,t[i+1]),su("DocumentReference.onSnapshot","function",i+2,t[i+2]),n={next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(o,n)},t.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new bd({next:function(t){if(e.next){zs(t.docs.size<=1,"Too many documents returned on a document query");var r=t.docs.get(n._key);e.next(new ap(n.firestore,n._key,r,t.fromCache,t.hasPendingWrites))}},error:r}),o=this._firestoreClient.listen(gc.atPath(this._key.path),i,t);return function(){i.mute(),n._firestoreClient.unlisten(o)}},t.prototype.get=function(t){var e=this;return ou("DocumentReference.get",arguments,0,1),dp("DocumentReference.get",t),new Promise(function(n,r){t&&"cache"===t.source?e.firestore.ensureClientConfigured().getDocumentFromLocalCache(e._key).then(function(t){n(new ap(e.firestore,e._key,t,!0,t instanceof Uu&&t.hasLocalMutations))},r):e.getViaSnapshotListener(n,r,t)})},t.prototype.getViaSnapshotListener=function(t,e,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),!i.exists&&i.metadata.fromCache?e(new Ys(Hs.UNAVAILABLE,"Failed to get document because the client is offline.")):i.exists&&i.metadata.fromCache&&n&&"server"===n.source?e(new Ys(Hs.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):t(i)},error:e})},t}(),op=function(){function t(t,e){this.hasPendingWrites=t,this.fromCache=e}return t.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},t}(),ap=function(){function t(t,e,n,r,i){this._firestore=t,this._key=e,this._document=n,this._fromCache=r,this._hasPendingWrites=i}return t.prototype.data=function(t){return ou("DocumentSnapshot.data",arguments,0,1),t=fp("DocumentSnapshot.data",t),this._document?this.convertObject(this._document.data,Hu.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},t.prototype.get=function(t,e){if(ou("DocumentSnapshot.get",arguments,1,2),e=fp("DocumentSnapshot.get",e),this._document){var n=this._document.data.field(zd("DocumentSnapshot.get",t));if(void 0!==n)return this.convertValue(n,Hu.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ref",{get:function(){return new ip(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"metadata",{get:function(){return new op(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){if(!(e instanceof t))throw gu("isEqual","DocumentSnapshot",1,e);return this._firestore===e._firestore&&this._fromCache===e._fromCache&&this._key.isEqual(e._key)&&(null===this._document?null===e._document:this._document.isEqual(e._document))},t.prototype.convertObject=function(t,e){var n=this,r={};return t.forEach(function(t,i){r[t]=n.convertValue(i,e)}),r},t.prototype.convertValue=function(t,e){if(t instanceof uc)return this.convertObject(t,e);if(t instanceof cc)return this.convertArray(t,e);if(t instanceof ac){var n=t.value(e),r=this._firestore.ensureClientConfigured().databaseId();return t.databaseId.isEqual(r)||js("Document "+this._key.path+" contains a document reference within a different database ("+t.databaseId.projectId+"/"+t.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new ip(n,this._firestore)}return t.value(e)},t.prototype.convertArray=function(t,e){var n=this;return t.internalValue.map(function(t){return n.convertValue(t,e)})},t}(),sp=function(t){function e(e,n,r,i,o){return t.call(this,e,n,r,i,o)||this}return $n(e,t),e.prototype.data=function(e){var n=t.prototype.data.call(this,e);return zs("object"==typeof n,"Document in a QueryDocumentSnapshot should exist"),n},e}(ap),up=function(){function t(t,e){this._query=t,this.firestore=e}return t.prototype.where=function(e,n,r){ru("Query.where",arguments,3),mu("Query.where",3,r);var i;!function(t,e,n,r){if(!e.some(function(t){return t===r}))throw new Ys(Hs.INVALID_ARGUMENT,"Invalid value "+pu(r)+" provided to function "+t+"() for its "+vu(n)+" argument. Acceptable values: "+e.join(", "))}("Query.where",["<","<=","==",">=",">","array-contains"],2,n);var o=zd("Query.where",e),a=bc.fromString(n);if(o.isKeyField()){if(a===bc.ARRAY_CONTAINS)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid Query. You can't perform array-contains queries on FieldPath.documentId() since document IDs are not arrays.");if("string"==typeof r){if(""===r)throw new Ys(Hs.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==r.indexOf("/"))throw new Ys(Hs.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection by FieldPath.documentId(), the value provided must be a plain document ID, but '"+r+"' contains a slash.");var s=this._query.path.child(xu.fromString(r));if(!Bu.isDocumentKey(s))throw new Ys(Hs.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+s+"' is not because it has an odd number of segments ("+s.length+").");i=new ac(this.firestore._databaseId,new Bu(s))}else{if(!(r instanceof ip))throw new Ys(Hs.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a string or a DocumentReference if the first parameter is FieldPath.documentId(), but it was: "+pu(r)+".");var u=r;i=new ac(this.firestore._databaseId,u._key)}}else i=this.firestore._dataConverter.parseQueryValue("Query.where",r);var c=vc.create(o,a,i);return this.validateNewFilter(c),new t(this._query.addFilter(c),this.firestore)},t.prototype.orderBy=function(e,n){var r;if(ou("Query.orderBy",arguments,1,2),su("Query.orderBy","non-empty string",2,n),void 0===n||"asc"===n)r=Tc.ASCENDING;else{if("desc"!==n)throw new Ys(Hs.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+n+"', expected 'asc' or 'desc'.");r=Tc.DESCENDING}if(null!==this._query.startAt)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var i=zd("Query.orderBy",e),o=new Ic(i,r);return this.validateNewOrderBy(o),new t(this._query.addOrderBy(o),this.firestore)},t.prototype.limit=function(e){if(ru("Query.limit",arguments,1),au("Query.limit","number",1,e),e<=0)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid Query. Query limit ("+e+") is invalid. Limit must be positive.");return new t(this._query.withLimit(e),this.firestore)},t.prototype.startAt=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];iu("Query.startAt",arguments,1);var i=this.boundFromDocOrFields("Query.startAt",e,n,!0);return new t(this._query.withStartAt(i),this.firestore)},t.prototype.startAfter=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];iu("Query.startAfter",arguments,1);var i=this.boundFromDocOrFields("Query.startAfter",e,n,!1);return new t(this._query.withStartAt(i),this.firestore)},t.prototype.endBefore=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];iu("Query.endBefore",arguments,1);var i=this.boundFromDocOrFields("Query.endBefore",e,n,!0);return new t(this._query.withEndAt(i),this.firestore)},t.prototype.endAt=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];iu("Query.endAt",arguments,1);var i=this.boundFromDocOrFields("Query.endAt",e,n,!1);return new t(this._query.withEndAt(i),this.firestore)},t.prototype.isEqual=function(e){if(!(e instanceof t))throw gu("isEqual","Query",1,e);return this.firestore===e.firestore&&this._query.isEqual(e._query)},t.prototype.boundFromDocOrFields=function(t,e,n,r){if(mu(t,1,e),e instanceof ap){if(n.length>0)throw new Ys(Hs.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var i=e;if(!i.exists)throw new Ys(Hs.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.boundFromDocument(t,i._document,r)}var o=[e].concat(n);return this.boundFromFields(t,o,r)},t.prototype.boundFromDocument=function(t,e,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var a=o[i];if(a.field.isKeyField())r.push(new ac(this.firestore._databaseId,e.key));else{var s=e.field(a.field);if(s instanceof ic)throw new Ys(Hs.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(void 0===s){var u=a.field.canonicalString();throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}r.push(s)}}return new _c(r,n)},t.prototype.boundFromFields=function(t,e,n){var r=this._query.explicitOrderBy;if(e.length>r.length)throw new Ys(Hs.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<e.length;o++){var a=e[o];if(r[o].field.isKeyField()){if("string"!=typeof a)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof a);if(!this._query.isCollectionGroupQuery()&&-1!==a.indexOf("/"))throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+t+"() must be a plain document ID, but '"+a+"' contains a slash.");var s=this._query.path.child(xu.fromString(a));if(!Bu.isDocumentKey(s))throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+t+"() must result in a valid document path, but '"+s+"' is not because it contains an odd number of segments.");var u=new Bu(s);i.push(new ac(this.firestore._databaseId,u))}else{var c=this.firestore._dataConverter.parseQueryValue(t,a);i.push(c)}}return new _c(i,n)},t.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];ou("Query.onSnapshot",arguments,1,4);var n,r={},i=0;return"object"!=typeof t[i]||Dd(t[i])||(yu("Query.onSnapshot",r=t[i],["includeMetadataChanges"]),cu("Query.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++),Dd(t[i])?n=t[i]:(au("Query.onSnapshot","function",i,t[i]),su("Query.onSnapshot","function",i+1,t[i+1]),su("Query.onSnapshot","function",i+2,t[i+2]),n={next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(r,n)},t.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new bd({next:function(t){e.next&&e.next(new cp(n.firestore,n._query,t))},error:r}),o=this.firestore.ensureClientConfigured(),a=o.listen(this._query,i,t);return function(){i.mute(),o.unlisten(a)}},t.prototype.get=function(t){var e=this;return ou("Query.get",arguments,0,1),dp("Query.get",t),new Promise(function(n,r){t&&"cache"===t.source?e.firestore.ensureClientConfigured().getDocumentsFromLocalCache(e._query).then(function(t){n(new cp(e.firestore,e._query,t))},r):e.getViaSnapshotListener(n,r,t)})},t.prototype.getViaSnapshotListener=function(t,e,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),i.metadata.fromCache&&n&&"server"===n.source?e(new Ys(Hs.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):t(i)},error:e})},t.prototype.validateNewFilter=function(t){if(t instanceof wc)if(t.isInequality()){var e=this._query.getInequalityFilterField();if(null!==e&&!e.isEqual(t.field))throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+e.toString()+"' and '"+t.field.toString()+"'");var n=this._query.getFirstOrderByField();null!==n&&this.validateOrderByAndInequalityMatch(t.field,n)}else if(t.op===bc.ARRAY_CONTAINS&&this._query.hasArrayContainsFilter())throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. Queries only support a single array-contains filter.")},t.prototype.validateNewOrderBy=function(t){if(null===this._query.getFirstOrderByField()){var e=this._query.getInequalityFilterField();null!==e&&this.validateOrderByAndInequalityMatch(e,t.field)}},t.prototype.validateOrderByAndInequalityMatch=function(t,e){if(!e.isEqual(t))throw new Ys(Hs.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+e.toString()+"' instead.")},t}(),cp=function(){function t(t,e,n){this._firestore=t,this._originalQuery=e,this._snapshot=n,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new op(n.hasPendingWrites,n.fromCache)}return Object.defineProperty(t.prototype,"docs",{get:function(){var t=[];return this.forEach(function(e){return t.push(e)}),t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t,e){var n=this;ou("QuerySnapshot.forEach",arguments,1,2),au("QuerySnapshot.forEach","function",1,t),this._snapshot.docs.forEach(function(r){t.call(e,n.convertToDocumentImpl(r))})},Object.defineProperty(t.prototype,"query",{get:function(){return new up(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),t.prototype.docChanges=function(t){t&&(yu("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),cu("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));var e=!(!t||!t.includeMetadataChanges);if(e&&this._snapshot.excludesMetadataChanges)throw new Ys(Hs.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e,n){if(n.oldDocs.isEmpty()){var r,i=0;return n.docChanges.map(function(e){var o=new sp(t,e.doc.key,e.doc,n.fromCache,n.mutatedKeys.has(e.doc.key));return zs(e.type===ch.Added,"Invalid event type for first snapshot"),zs(!r||n.query.docComparator(r,e.doc)<0,"Got added events in wrong order"),r=e.doc,{type:"added",doc:o,oldIndex:-1,newIndex:i++}})}var o=n.oldDocs;return n.docChanges.filter(function(t){return e||t.type!==ch.Metadata}).map(function(e){var r=new sp(t,e.doc.key,e.doc,n.fromCache,n.mutatedKeys.has(e.doc.key)),i=-1,a=-1;return e.type!==ch.Added&&(zs((i=o.indexOf(e.doc.key))>=0,"Index for document not found"),o=o.delete(e.doc.key)),e.type!==ch.Removed&&(o=o.add(e.doc),a=o.indexOf(e.doc.key)),{type:mp(e.type),doc:r,oldIndex:i,newIndex:a}})}(this._firestore,e,this._snapshot),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges},t.prototype.isEqual=function(e){if(!(e instanceof t))throw gu("isEqual","QuerySnapshot",1,e);return this._firestore===e._firestore&&this._originalQuery.isEqual(e._originalQuery)&&this._snapshot.isEqual(e._snapshot)},t.prototype.convertToDocumentImpl=function(t){return new sp(this._firestore,t.key,t,this.metadata.fromCache,this._snapshot.mutatedKeys.has(t.key))},t}();["length","forEach","map"].concat("undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach(function(t){try{Object.defineProperty(cp.prototype.docChanges,t,{get:function(){return function(){throw new Ys(Hs.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}()}})}catch(t){}});var hp=function(t){function e(e,n){var r=t.call(this,gc.atPath(e),n)||this;if(e.length%2!=1)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+e.canonicalString()+" has "+e.length);return r}return $n(e,t),Object.defineProperty(e.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){var t=this._query.path.popLast();return t.isEmpty()?null:new ip(new Bu(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),e.prototype.doc=function(t){if(ou("CollectionReference.doc",arguments,0,1),0===arguments.length&&(t=wu.newId()),au("CollectionReference.doc","non-empty string",1,t),""===t)throw new Ys(Hs.INVALID_ARGUMENT,"Document path must be a non-empty string");var e=xu.fromString(t);return ip.forPath(this._query.path.child(e),this.firestore)},e.prototype.add=function(t){ru("CollectionReference.add",arguments,1),au("CollectionReference.add","object",1,t);var e=this.doc();return e.set(t).then(function(){return e})},e}(up);function lp(t,e){if(void 0===e)return{merge:!1};if(yu(t,e,["merge","mergeFields"]),cu(t,"boolean","merge",e.merge),hu(t,"mergeFields","a string or a FieldPath",e.mergeFields,function(t){return"string"==typeof t||t instanceof wd}),void 0!==e.mergeFields&&void 0!==e.merge)throw new Ys(Hs.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return e}function fp(t,e){return void 0===e?{}:(yu(t,e,["serverTimestamps"]),lu(t,0,"serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function dp(t,e){su(t,"object",1,e),e&&(yu(t,e,["source"]),lu(t,0,"source",e.source,["default","server","cache"]))}function pp(t,e,n){if(e instanceof ip){if(e.firestore!==n)throw new Ys(Hs.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}throw gu(t,"DocumentReference",1,e)}function mp(t){switch(t){case ch.Added:return"added";case ch.Modified:case ch.Metadata:return"modified";case ch.Removed:return"removed";default:return Qs("Unknown change type: "+t)}}var yp=Xs(ep,"Use firebase.firestore() instead."),gp=Xs(np,"Use firebase.firestore().runTransaction() instead."),vp=Xs(rp,"Use firebase.firestore().batch() instead."),bp=Xs(ip,"Use firebase.firestore().doc() instead."),wp=Xs(ap),Ep=Xs(sp),Sp=Xs(up),Tp=Xs(cp),_p=Xs(hp,"Use firebase.firestore().collection() instead."),Ip={Firestore:yp,GeoPoint:Nu,Timestamp:Mu,Blob:ku,Transaction:gp,WriteBatch:vp,DocumentReference:bp,DocumentSnapshot:wp,Query:Sp,QueryDocumentSnapshot:Ep,QuerySnapshot:Tp,CollectionReference:_p,FieldPath:wd,FieldValue:Ld,setLogLevel:ep.setLogLevel,CACHE_SIZE_UNLIMITED:$d};function Cp(t){t.INTERNAL.registerService("firestore",function(t){return new ep(t)},function(t){zs(t&&"object"==typeof t,"shallowCopy() expects object parameter.");var e={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}(Ip))}Cp(Sr);var Dp=n(function(t,e){t.exports=function(){var t=function(){},e=Object.prototype.hasOwnProperty,n=Array.prototype.slice;function r(t,r,i){var o,a;i=n.call(arguments,2);for(var s=0,u=i.length;s<u;s++)for(o in a=i[s])t&&!e.call(a,o)||(r[o]=a[o])}var i=function(e,n,i,o){var a=this;return"string"!=typeof e&&(o=i,i=n,n=e,e=null),"function"!=typeof n&&(o=i,i=n,n=function(){return a.apply(this,arguments)}),r(!1,n,a,o),n.prototype=function(e,n){var i;return"function"==typeof Object.create?i=Object.create(e):(t.prototype=e,i=new t,t.prototype=null),n&&r(!0,i,n),i}(a.prototype,i),n.prototype.constructor=n,n.class_=e||a.class_,n.super_=a,n};function o(){}o.class_="Nevis",o.super_=Object,o.extend=i;var a=o,s=a.extend(function(t,e,n){this.qrious=t,this.element=e,this.element.qrious=t,this.enabled=Boolean(n)},{draw:function(t){},getElement:function(){return this.enabled||(this.enabled=!0,this.render()),this.element},getModuleSize:function(t){var e=this.qrious,n=e.padding||0,r=Math.floor((e.size-2*n)/t.width);return Math.max(1,r)},getOffset:function(t){var e=this.qrious,n=e.padding;if(null!=n)return n;var r=this.getModuleSize(t),i=Math.floor((e.size-r*t.width)/2);return Math.max(0,i)},render:function(t){this.enabled&&(this.resize(),this.reset(),this.draw(t))},reset:function(){},resize:function(){}}),u=s.extend({draw:function(t){var e,n,r=this.qrious,i=this.getModuleSize(t),o=this.getOffset(t),a=this.element.getContext("2d");for(a.fillStyle=r.foreground,a.globalAlpha=r.foregroundAlpha,e=0;e<t.width;e++)for(n=0;n<t.width;n++)t.buffer[n*t.width+e]&&a.fillRect(i*e+o,i*n+o,i,i)},reset:function(){var t=this.qrious,e=this.element.getContext("2d"),n=t.size;e.lineWidth=1,e.clearRect(0,0,n,n),e.fillStyle=t.background,e.globalAlpha=t.backgroundAlpha,e.fillRect(0,0,n,n)},resize:function(){var t=this.element;t.width=t.height=this.qrious.size}}),c=a.extend(null,{BLOCK:[0,11,15,19,23,27,31,16,18,20,22,24,26,28,20,22,24,24,26,28,28,22,24,24,26,26,28,28,24,24,26,26,26,28,28,24,26,26,26,28,28]}),h=a.extend(null,{BLOCKS:[1,0,19,7,1,0,16,10,1,0,13,13,1,0,9,17,1,0,34,10,1,0,28,16,1,0,22,22,1,0,16,28,1,0,55,15,1,0,44,26,2,0,17,18,2,0,13,22,1,0,80,20,2,0,32,18,2,0,24,26,4,0,9,16,1,0,108,26,2,0,43,24,2,2,15,18,2,2,11,22,2,0,68,18,4,0,27,16,4,0,19,24,4,0,15,28,2,0,78,20,4,0,31,18,2,4,14,18,4,1,13,26,2,0,97,24,2,2,38,22,4,2,18,22,4,2,14,26,2,0,116,30,3,2,36,22,4,4,16,20,4,4,12,24,2,2,68,18,4,1,43,26,6,2,19,24,6,2,15,28,4,0,81,20,1,4,50,30,4,4,22,28,3,8,12,24,2,2,92,24,6,2,36,22,4,6,20,26,7,4,14,28,4,0,107,26,8,1,37,22,8,4,20,24,12,4,11,22,3,1,115,30,4,5,40,24,11,5,16,20,11,5,12,24,5,1,87,22,5,5,41,24,5,7,24,30,11,7,12,24,5,1,98,24,7,3,45,28,15,2,19,24,3,13,15,30,1,5,107,28,10,1,46,28,1,15,22,28,2,17,14,28,5,1,120,30,9,4,43,26,17,1,22,28,2,19,14,28,3,4,113,28,3,11,44,26,17,4,21,26,9,16,13,26,3,5,107,28,3,13,41,26,15,5,24,30,15,10,15,28,4,4,116,28,17,0,42,26,17,6,22,28,19,6,16,30,2,7,111,28,17,0,46,28,7,16,24,30,34,0,13,24,4,5,121,30,4,14,47,28,11,14,24,30,16,14,15,30,6,4,117,30,6,14,45,28,11,16,24,30,30,2,16,30,8,4,106,26,8,13,47,28,7,22,24,30,22,13,15,30,10,2,114,28,19,4,46,28,28,6,22,28,33,4,16,30,8,4,122,30,22,3,45,28,8,26,23,30,12,28,15,30,3,10,117,30,3,23,45,28,4,31,24,30,11,31,15,30,7,7,116,30,21,7,45,28,1,37,23,30,19,26,15,30,5,10,115,30,19,10,47,28,15,25,24,30,23,25,15,30,13,3,115,30,2,29,46,28,42,1,24,30,23,28,15,30,17,0,115,30,10,23,46,28,10,35,24,30,19,35,15,30,17,1,115,30,14,21,46,28,29,19,24,30,11,46,15,30,13,6,115,30,14,23,46,28,44,7,24,30,59,1,16,30,12,7,121,30,12,26,47,28,39,14,24,30,22,41,15,30,6,14,121,30,6,34,47,28,46,10,24,30,2,64,15,30,17,4,122,30,29,14,46,28,49,10,24,30,24,46,15,30,4,18,122,30,13,32,46,28,48,14,24,30,42,32,15,30,20,4,117,30,40,7,47,28,43,22,24,30,10,67,15,30,19,6,118,30,18,31,47,28,34,34,24,30,20,61,15,30],FINAL_FORMAT:[30660,29427,32170,30877,26159,25368,27713,26998,21522,20773,24188,23371,17913,16590,20375,19104,13663,12392,16177,14854,9396,8579,11994,11245,5769,5054,7399,6608,1890,597,3340,2107],LEVELS:{L:1,M:2,Q:3,H:4}}),l=a.extend(null,{EXPONENT:[1,2,4,8,16,32,64,128,29,58,116,232,205,135,19,38,76,152,45,90,180,117,234,201,143,3,6,12,24,48,96,192,157,39,78,156,37,74,148,53,106,212,181,119,238,193,159,35,70,140,5,10,20,40,80,160,93,186,105,210,185,111,222,161,95,190,97,194,153,47,94,188,101,202,137,15,30,60,120,240,253,231,211,187,107,214,177,127,254,225,223,163,91,182,113,226,217,175,67,134,17,34,68,136,13,26,52,104,208,189,103,206,129,31,62,124,248,237,199,147,59,118,236,197,151,51,102,204,133,23,46,92,184,109,218,169,79,158,33,66,132,21,42,84,168,77,154,41,82,164,85,170,73,146,57,114,228,213,183,115,230,209,191,99,198,145,63,126,252,229,215,179,123,246,241,255,227,219,171,75,150,49,98,196,149,55,110,220,165,87,174,65,130,25,50,100,200,141,7,14,28,56,112,224,221,167,83,166,81,162,89,178,121,242,249,239,195,155,43,86,172,69,138,9,18,36,72,144,61,122,244,245,247,243,251,235,203,139,11,22,44,88,176,125,250,233,207,131,27,54,108,216,173,71,142,0],LOG:[255,0,1,25,2,50,26,198,3,223,51,238,27,104,199,75,4,100,224,14,52,141,239,129,28,193,105,248,200,8,76,113,5,138,101,47,225,36,15,33,53,147,142,218,240,18,130,69,29,181,194,125,106,39,249,185,201,154,9,120,77,228,114,166,6,191,139,98,102,221,48,253,226,152,37,179,16,145,34,136,54,208,148,206,143,150,219,189,241,210,19,92,131,56,70,64,30,66,182,163,195,72,126,110,107,58,40,84,250,133,186,61,202,94,155,159,10,21,121,43,78,212,229,172,115,243,167,87,7,112,192,247,140,128,99,13,103,74,222,237,49,197,254,24,227,165,153,119,38,184,180,124,17,68,146,217,35,32,137,46,55,63,209,91,149,188,207,205,144,135,151,178,220,252,190,97,242,86,211,171,20,42,93,158,132,60,57,83,71,109,65,162,31,45,67,216,183,123,164,118,196,23,73,236,127,12,111,246,108,161,59,82,41,157,85,170,251,96,134,177,187,204,62,90,203,89,95,176,156,169,160,81,11,245,22,235,122,117,44,215,79,174,213,233,230,231,173,232,116,214,244,234,168,80,88,175]}),f=a.extend(null,{BLOCK:[3220,1468,2713,1235,3062,1890,2119,1549,2344,2936,1117,2583,1330,2470,1667,2249,2028,3780,481,4011,142,3098,831,3445,592,2517,1776,2234,1951,2827,1070,2660,1345,3177]}),d=a.extend(function(t){var e,n,r,i,o,a=t.value.length;for(this._badness=[],this._level=h.LEVELS[t.level],this._polynomial=[],this._value=t.value,this._version=0,this._stringBuffer=[];this._version<40&&(this._version++,r=4*(this._level-1)+16*(this._version-1),i=h.BLOCKS[r++],o=h.BLOCKS[r++],e=h.BLOCKS[r++],n=h.BLOCKS[r],r=e*(i+o)+o-3+(this._version<=9),!(a<=r)););this._dataBlock=e,this._eccBlock=n,this._neccBlock1=i,this._neccBlock2=o;var s=this.width=17+4*this._version;this.buffer=d._createArray(s*s),this._ecc=d._createArray(e+(e+n)*(i+o)+o),this._mask=d._createArray((s*(s+1)+1)/2),this._insertFinders(),this._insertAlignments(),this.buffer[8+s*(s-8)]=1,this._insertTimingGap(),this._reverseMask(),this._insertTimingRowAndColumn(),this._insertVersion(),this._syncMask(),this._convertBitStream(a),this._calculatePolynomial(),this._appendEccToData(),this._interleaveBlocks(),this._pack(),this._finish()},{_addAlignment:function(t,e){var n,r=this.buffer,i=this.width;for(r[t+i*e]=1,n=-2;n<2;n++)r[t+n+i*(e-2)]=1,r[t-2+i*(e+n+1)]=1,r[t+2+i*(e+n)]=1,r[t+n+1+i*(e+2)]=1;for(n=0;n<2;n++)this._setMask(t-1,e+n),this._setMask(t+1,e-n),this._setMask(t-n,e-1),this._setMask(t+n,e+1)},_appendData:function(t,e,n,r){var i,o,a,s=this._polynomial,u=this._stringBuffer;for(o=0;o<r;o++)u[n+o]=0;for(o=0;o<e;o++){if(255!==(i=l.LOG[u[t+o]^u[n]]))for(a=1;a<r;a++)u[n+a-1]=u[n+a]^l.EXPONENT[d._modN(i+s[r-a])];else for(a=n;a<n+r;a++)u[a]=u[a+1];u[n+r-1]=255===i?0:l.EXPONENT[d._modN(i+s[0])]}},_appendEccToData:function(){var t,e=0,n=this._dataBlock,r=this._calculateMaxLength(),i=this._eccBlock;for(t=0;t<this._neccBlock1;t++)this._appendData(e,n,r,i),e+=n,r+=i;for(t=0;t<this._neccBlock2;t++)this._appendData(e,n+1,r,i),e+=n+1,r+=i},_applyMask:function(t){var e,n,r,i,o=this.buffer,a=this.width;switch(t){case 0:for(i=0;i<a;i++)for(r=0;r<a;r++)r+i&1||this._isMasked(r,i)||(o[r+i*a]^=1);break;case 1:for(i=0;i<a;i++)for(r=0;r<a;r++)1&i||this._isMasked(r,i)||(o[r+i*a]^=1);break;case 2:for(i=0;i<a;i++)for(e=0,r=0;r<a;r++,e++)3===e&&(e=0),e||this._isMasked(r,i)||(o[r+i*a]^=1);break;case 3:for(n=0,i=0;i<a;i++,n++)for(3===n&&(n=0),e=n,r=0;r<a;r++,e++)3===e&&(e=0),e||this._isMasked(r,i)||(o[r+i*a]^=1);break;case 4:for(i=0;i<a;i++)for(e=0,n=i>>1&1,r=0;r<a;r++,e++)3===e&&(e=0,n=!n),n||this._isMasked(r,i)||(o[r+i*a]^=1);break;case 5:for(n=0,i=0;i<a;i++,n++)for(3===n&&(n=0),e=0,r=0;r<a;r++,e++)3===e&&(e=0),(r&i&1)+!(!e|!n)||this._isMasked(r,i)||(o[r+i*a]^=1);break;case 6:for(n=0,i=0;i<a;i++,n++)for(3===n&&(n=0),e=0,r=0;r<a;r++,e++)3===e&&(e=0),(r&i&1)+(e&&e===n)&1||this._isMasked(r,i)||(o[r+i*a]^=1);break;case 7:for(n=0,i=0;i<a;i++,n++)for(3===n&&(n=0),e=0,r=0;r<a;r++,e++)3===e&&(e=0),(e&&e===n)+(r+i&1)&1||this._isMasked(r,i)||(o[r+i*a]^=1)}},_calculateMaxLength:function(){return this._dataBlock*(this._neccBlock1+this._neccBlock2)+this._neccBlock2},_calculatePolynomial:function(){var t,e,n=this._eccBlock,r=this._polynomial;for(r[0]=1,t=0;t<n;t++){for(r[t+1]=1,e=t;e>0;e--)r[e]=r[e]?r[e-1]^l.EXPONENT[d._modN(l.LOG[r[e]]+t)]:r[e-1];r[0]=l.EXPONENT[d._modN(l.LOG[r[0]]+t)]}for(t=0;t<=n;t++)r[t]=l.LOG[r[t]]},_checkBadness:function(){var t,e,n,r,i,o=0,a=this._badness,s=this.buffer,u=this.width;for(i=0;i<u-1;i++)for(r=0;r<u-1;r++)(s[r+u*i]&&s[r+1+u*i]&&s[r+u*(i+1)]&&s[r+1+u*(i+1)]||!(s[r+u*i]||s[r+1+u*i]||s[r+u*(i+1)]||s[r+1+u*(i+1)]))&&(o+=d.N2);var c=0;for(i=0;i<u;i++){for(n=0,a[0]=0,t=0,r=0;r<u;r++)e=s[r+u*i],t===e?a[n]++:a[++n]=1,c+=(t=e)?1:-1;o+=this._getBadness(n)}c<0&&(c=-c);var h=0,l=c;for(l+=l<<2,l<<=1;l>u*u;)l-=u*u,h++;for(o+=h*d.N4,r=0;r<u;r++){for(n=0,a[0]=0,t=0,i=0;i<u;i++)e=s[r+u*i],t===e?a[n]++:a[++n]=1,t=e;o+=this._getBadness(n)}return o},_convertBitStream:function(t){var e,n,r=this._ecc,i=this._version;for(n=0;n<t;n++)r[n]=this._value.charCodeAt(n);var o=this._stringBuffer=r.slice(),a=this._calculateMaxLength();t>=a-2&&(t=a-2,i>9&&t--);var s=t;if(i>9){for(o[s+2]=0,o[s+3]=0;s--;)e=o[s],o[s+3]|=255&e<<4,o[s+2]=e>>4;o[2]|=255&t<<4,o[1]=t>>4,o[0]=64|t>>12}else{for(o[s+1]=0,o[s+2]=0;s--;)e=o[s],o[s+2]|=255&e<<4,o[s+1]=e>>4;o[1]|=255&t<<4,o[0]=64|t>>4}for(s=t+3-(i<10);s<a;)o[s++]=236,o[s++]=17},_getBadness:function(t){var e,n=0,r=this._badness;for(e=0;e<=t;e++)r[e]>=5&&(n+=d.N1+r[e]-5);for(e=3;e<t-1;e+=2)r[e-2]===r[e+2]&&r[e+2]===r[e-1]&&r[e-1]===r[e+1]&&3*r[e-1]===r[e]&&(0===r[e-3]||e+3>t||3*r[e-3]>=4*r[e]||3*r[e+3]>=4*r[e])&&(n+=d.N3);return n},_finish:function(){var t,e;this._stringBuffer=this.buffer.slice();var n=0,r=3e4;for(e=0;e<8&&(this._applyMask(e),(t=this._checkBadness())<r&&(r=t,n=e),7!==n);e++)this.buffer=this._stringBuffer.slice();n!==e&&this._applyMask(n),r=h.FINAL_FORMAT[n+(this._level-1<<3)];var i=this.buffer,o=this.width;for(e=0;e<8;e++,r>>=1)1&r&&(i[o-1-e+8*o]=1,e<6?i[8+o*e]=1:i[8+o*(e+1)]=1);for(e=0;e<7;e++,r>>=1)1&r&&(i[8+o*(o-7+e)]=1,e?i[6-e+8*o]=1:i[7+8*o]=1)},_interleaveBlocks:function(){var t,e,n=this._dataBlock,r=this._ecc,i=this._eccBlock,o=0,a=this._calculateMaxLength(),s=this._neccBlock1,u=this._neccBlock2,c=this._stringBuffer;for(t=0;t<n;t++){for(e=0;e<s;e++)r[o++]=c[t+e*n];for(e=0;e<u;e++)r[o++]=c[s*n+t+e*(n+1)]}for(e=0;e<u;e++)r[o++]=c[s*n+t+e*(n+1)];for(t=0;t<i;t++)for(e=0;e<s+u;e++)r[o++]=c[a+t+e*i];this._stringBuffer=r},_insertAlignments:function(){var t,e,n,r=this._version,i=this.width;if(r>1)for(t=c.BLOCK[r],n=i-7;;){for(e=i-7;e>t-3&&(this._addAlignment(e,n),!(e<t));)e-=t;if(n<=t+9)break;n-=t,this._addAlignment(6,n),this._addAlignment(n,6)}},_insertFinders:function(){var t,e,n,r,i=this.buffer,o=this.width;for(t=0;t<3;t++){for(e=0,r=0,1===t&&(e=o-7),2===t&&(r=o-7),i[r+3+o*(e+3)]=1,n=0;n<6;n++)i[r+n+o*e]=1,i[r+o*(e+n+1)]=1,i[r+6+o*(e+n)]=1,i[r+n+1+o*(e+6)]=1;for(n=1;n<5;n++)this._setMask(r+n,e+1),this._setMask(r+1,e+n+1),this._setMask(r+5,e+n),this._setMask(r+n+1,e+5);for(n=2;n<4;n++)i[r+n+o*(e+2)]=1,i[r+2+o*(e+n+1)]=1,i[r+4+o*(e+n)]=1,i[r+n+1+o*(e+4)]=1}},_insertTimingGap:function(){var t,e,n=this.width;for(e=0;e<7;e++)this._setMask(7,e),this._setMask(n-8,e),this._setMask(7,e+n-7);for(t=0;t<8;t++)this._setMask(t,7),this._setMask(t+n-8,7),this._setMask(t,n-8)},_insertTimingRowAndColumn:function(){var t,e=this.buffer,n=this.width;for(t=0;t<n-14;t++)1&t?(this._setMask(8+t,6),this._setMask(6,8+t)):(e[8+t+6*n]=1,e[6+n*(8+t)]=1)},_insertVersion:function(){var t,e,n,r,i=this.buffer,o=this._version,a=this.width;if(o>6)for(t=f.BLOCK[o-7],e=17,n=0;n<6;n++)for(r=0;r<3;r++,e--)1&(e>11?o>>e-12:t>>e)?(i[5-n+a*(2-r+a-11)]=1,i[2-r+a-11+a*(5-n)]=1):(this._setMask(5-n,2-r+a-11),this._setMask(2-r+a-11,5-n))},_isMasked:function(t,e){var n=d._getMaskBit(t,e);return 1===this._mask[n]},_pack:function(){var t,e,n,r=1,i=1,o=this.width,a=o-1,s=o-1,u=(this._dataBlock+this._eccBlock)*(this._neccBlock1+this._neccBlock2)+this._neccBlock2;for(e=0;e<u;e++)for(t=this._stringBuffer[e],n=0;n<8;n++,t<<=1){128&t&&(this.buffer[a+o*s]=1);do{i?a--:(a++,r?0!==s?s--:(r=!r,6==(a-=2)&&(a--,s=9)):s!==o-1?s++:(r=!r,6==(a-=2)&&(a--,s-=8))),i=!i}while(this._isMasked(a,s))}},_reverseMask:function(){var t,e,n=this.width;for(t=0;t<9;t++)this._setMask(t,8);for(t=0;t<8;t++)this._setMask(t+n-8,8),this._setMask(8,t);for(e=0;e<7;e++)this._setMask(8,e+n-7)},_setMask:function(t,e){var n=d._getMaskBit(t,e);this._mask[n]=1},_syncMask:function(){var t,e,n=this.width;for(e=0;e<n;e++)for(t=0;t<=e;t++)this.buffer[t+n*e]&&this._setMask(t,e)}},{_createArray:function(t){var e,n=[];for(e=0;e<t;e++)n[e]=0;return n},_getMaskBit:function(t,e){var n;return t>e&&(n=t,t=e,e=n),n=e,n+=e*e,n>>=1,n+=t},_modN:function(t){for(;t>=255;)t=((t-=255)>>8)+(255&t);return t},N1:3,N2:3,N3:40,N4:10}),p=d,m=s.extend({draw:function(){this.element.src=this.qrious.toDataURL()},reset:function(){this.element.src=""},resize:function(){var t=this.element;t.width=t.height=this.qrious.size}}),y=a.extend(function(t,e,n,r){this.name=t,this.modifiable=Boolean(e),this.defaultValue=n,this._valueTransformer=r},{transform:function(t){var e=this._valueTransformer;return"function"==typeof e?e(t,this):t}}),g=a.extend(null,{abs:function(t){return null!=t?Math.abs(t):null},hasOwn:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},noop:function(){},toUpperCase:function(t){return null!=t?t.toUpperCase():null}}),v=a.extend(function(t){this.options={},t.forEach(function(t){this.options[t.name]=t},this)},{exists:function(t){return null!=this.options[t]},get:function(t,e){return v._get(this.options[t],e)},getAll:function(t){var e,n=this.options,r={};for(e in n)g.hasOwn(n,e)&&(r[e]=v._get(n[e],t));return r},init:function(t,e,n){var r,i;for(r in"function"!=typeof n&&(n=g.noop),this.options)g.hasOwn(this.options,r)&&(i=this.options[r],v._set(i,i.defaultValue,e),v._createAccessor(i,e,n));this._setAll(t,e,!0)},set:function(t,e,n){return this._set(t,e,n)},setAll:function(t,e){return this._setAll(t,e)},_set:function(t,e,n,r){var i=this.options[t];if(!i)throw new Error("Invalid option: "+t);if(!i.modifiable&&!r)throw new Error("Option cannot be modified: "+t);return v._set(i,e,n)},_setAll:function(t,e,n){if(!t)return!1;var r,i=!1;for(r in t)g.hasOwn(t,r)&&this._set(r,t[r],e,n)&&(i=!0);return i}},{_createAccessor:function(t,e,n){var r={get:function(){return v._get(t,e)}};t.modifiable&&(r.set=function(r){v._set(t,r,e)&&n(r,t)}),Object.defineProperty(e,t.name,r)},_get:function(t,e){return e["_"+t.name]},_set:function(t,e,n){var r="_"+t.name,i=n[r],o=t.transform(null!=e?e:t.defaultValue);return n[r]=o,o!==i}}),b=v,w=a.extend(function(){this._services={}},{getService:function(t){var e=this._services[t];if(!e)throw new Error("Service is not being managed with name: "+t);return e},setService:function(t,e){if(this._services[t])throw new Error("Service is already managed with name: "+t);e&&(this._services[t]=e)}}),E=new b([new y("background",!0,"white"),new y("backgroundAlpha",!0,1,g.abs),new y("element"),new y("foreground",!0,"black"),new y("foregroundAlpha",!0,1,g.abs),new y("level",!0,"L",g.toUpperCase),new y("mime",!0,"image/png"),new y("padding",!0,null,g.abs),new y("size",!0,100,g.abs),new y("value",!0,"")]),S=new w,T=a.extend(function(t){E.init(t,this,this.update.bind(this));var e=E.get("element",this),n=S.getService("element"),r=e&&n.isCanvas(e)?e:n.createCanvas(),i=e&&n.isImage(e)?e:n.createImage();this._canvasRenderer=new u(this,r,!0),this._imageRenderer=new m(this,i,i===e),this.update()},{get:function(){return E.getAll(this)},set:function(t){E.setAll(t,this)&&this.update()},toDataURL:function(t){return this.canvas.toDataURL(t||this.mime)},update:function(){var t=new p({level:this.level,value:this.value});this._canvasRenderer.render(t),this._imageRenderer.render(t)}},{use:function(t){S.setService(t.getName(),t)}});Object.defineProperties(T.prototype,{canvas:{get:function(){return this._canvasRenderer.getElement()}},image:{get:function(){return this._imageRenderer.getElement()}}});var _=T,I=a.extend({getName:function(){}}).extend({createCanvas:function(){},createImage:function(){},getName:function(){return"element"},isCanvas:function(t){},isImage:function(t){}}).extend({createCanvas:function(){return document.createElement("canvas")},createImage:function(){return document.createElement("img")},isCanvas:function(t){return t instanceof HTMLCanvasElement},isImage:function(t){return t instanceof HTMLImageElement}});return _.use(new I),_}()});class Ap{constructor(t,e){this._rootElement=t,this._app=e,this._db=null,this._screen=this._rootElement.querySelector(".screen"),this._detailButton=this._rootElement.querySelector(".button-detail"),this._options=this._rootElement.querySelector(".options"),this._qrcode=this._rootElement.querySelector(".qrcode"),this._drawingLink=this._rootElement.querySelector(".drawing-link>a"),this.activate=this.activate.bind(this),this.deactivate=this.deactivate.bind(this),this._handleKeydown=this._handleKeydown.bind(this),this._handleKeyup=this._handleKeyup.bind(this),this._toggleDetail=this._toggleDetail.bind(this),this._initFirebase()}_initFirebase(){this._db||(Sr.initializeApp({apiKey:"AIzaSyCV444-QKFwglGHmhJbVgCN6Cj2GXf5KIM",authDomain:"rotavo-pwa.firebaseapp.com",databaseURL:"https://rotavo-pwa.firebaseio.com",projectId:"rotavo-pwa",storageBucket:"rotavo-pwa.appspot.com",messagingSenderId:"646348013955"}),this._db=Sr.firestore())}activate(){const t=this._qrcode,e=this._drawingLink;this._db.collection("drawings").add({path:this._app.sketchModel.path}).then(function(n){const r="https://rotavo-pwa.firebaseapp.com/sharing/"+n.id;e.href=r,e.textContent=r;new Dp({element:t,value:r,size:200,foreground:"black",background:"white"})}).catch(function(t){console.error("Error adding document: ",t)}),this._options.classList.add("options-active"),this._rootElement.addEventListener("keydown",this._handleKeydown,{capture:!1,passive:!0}),this._rootElement.addEventListener("keyup",this._handleKeyup,{capture:!1,passive:!0})}deactivate(){this._options.classList.remove("options-active"),this._rootElement.removeEventListener("keydown",this._handleKeydown,{capture:!1,passive:!0}),this._rootElement.removeEventListener("keyup",this._handleKeyup,{capture:!1,passive:!0})}_handleKeydown(t){switch(t.key){case"w":case"d":case"s":case"a":case"i":case"l":case"k":case"j":break;case"x":this._toggleDetail()}}_handleKeyup(t){switch(t.key){case"w":case"d":case"s":case"a":case"i":case"l":case"k":case"j":case"x":break;case"r":this._app.activateDrawingMode()}}_toggleDetail(){switch(console.log(this._detailButton.value),this._detailButton.value){case"fast":this._screen.classList.add("fast"),this._screen.classList.remove("fanciest","fancy"),this._detailButton.textContent="✨ Fancy",this._detailButton.value="fancy";break;case"fancy":this._screen.classList.add("fancy"),this._screen.classList.remove("fanciest","fast"),this._detailButton.textContent="🌈 Fanciest",this._detailButton.value="fanciest";break;case"fanciest":this._screen.classList.add("fanciest"),this._screen.classList.remove("fancy","fast"),this._detailButton.textContent="🚀 Fast",this._detailButton.value="fast"}}_toggleDetail(){switch(this._detailButton.value){case"fast":this._screen.classList.add("fast"),this._screen.classList.remove("fanciest","fancy"),this._detailButton.textContent="✨ Fancy",this._detailButton.value="fancy";break;case"fancy":this._screen.classList.add("fancy"),this._screen.classList.remove("fanciest","fast"),this._detailButton.textContent="🌈 Fanciest",this._detailButton.value="fanciest";break;case"fanciest":this._screen.classList.add("fanciest"),this._screen.classList.remove("fancy","fast"),this._detailButton.textContent="🚀 Fast",this._detailButton.value="fast"}}}!function(){function t(t,e,n){var r=e.x,i=e.y,o=n.x-r,a=n.y-i;if(0!==o||0!==a){var s=((t.x-r)*o+(t.y-i)*a)/(o*o+a*a);s>1?(r=n.x,i=n.y):s>0&&(r+=o*s,i+=a*s)}return(o=t.x-r)*o+(a=t.y-i)*a}function e(e,n){var r=e.length-1,i=[e[0]];return function e(n,r,i,o,a){for(var s,u=o,c=r+1;c<i;c++){var h=t(n[c],n[r],n[i]);h>u&&(s=c,u=h)}u>o&&(s-r>1&&e(n,r,s,o,a),a.push(n[s]),i-s>1&&e(n,s,i,o,a))}(e,0,r,n,i),i.push(e[r]),i}function n(t,n,r){if(t.length<=2)return t;var i=void 0!==n?n*n:1;return t=e(t=r?t:function(t,e){for(var n,r,i,o,a,s=t[0],u=[s],c=1,h=t.length;c<h;c++)n=t[c],i=s,o=void 0,a=void 0,o=(r=n).x-i.x,a=r.y-i.y,o*o+a*a>e&&(u.push(n),s=n);return s!==n&&u.push(n),u}(t,i),i)}"function"==typeof define&&define.amd?define(function(){return n}):"undefined"!=typeof module?(module.exports=n,module.exports.default=n):"undefined"!=typeof self?self.simplify=n:window.simplify=n}();class kp{constructor(t){this.path=[t],this.erasedPaths=[],this._lastAngle=null}get lastPoint(){return this.path[this.path.length-1]}get lastAngle(){if(this.path.length<2)return null;const t=this.path[this.path.length-2];return Math.atan2(this.lastPoint.x-t.x,this.lastPoint.y-t.y)}moveTo(t){t={x:parseFloat(t.x),y:parseFloat(t.y)},Math.atan2(t.x-this.lastPoint.x,t.y-this.lastPoint.y)!==this.lastAngle||this.lastPoint.x===t.x&&this.lastPoint.y===t.y||this.path.pop(),this.path.push(t)}simplifyPath(){this.path=simplify(this.path,.5)}jiggle(){return this.path.length>1&&(this.erasedPaths.push(this.path),this.path=[this.lastPoint],this._lastAngle=null,!0)}}class Np{constructor(e){this._drawingMode=new t(e,this),this._drawingMode.setDrawInterval(150),this._optionsMode=new Ap(e,this),this.sketchModel=new kp({x:2,y:2}),this._drawingMode.activate()}activateOptionsMode(){this._drawingMode.deactivate(),this._optionsMode.activate()}activateDrawingMode(){this._optionsMode.deactivate(),this._drawingMode.activate()}}window.customElements.define("touch-knob",class extends HTMLElement{constructor(){super(),this._angle=0,this._canDraw=!0,this._rotations=0,this._TWO_PI=2*Math.PI,this.min=0,this.max=298,this._drawState=this._drawState.bind(this),this._onMousedown=this._onMousedown.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseup=this._onMouseup.bind(this),this._onPointerdown=this._onPointerdown.bind(this),this._onPointermove=this._onPointermove.bind(this),this._onPointerup=this._onPointerup.bind(this),this._onTouchend=this._onTouchend.bind(this),this._onTouchmove=this._onTouchmove.bind(this),this._onTouchstart=this._onTouchstart.bind(this)}get value(){return this.hasAttribute("value")?this.getAttribute("value"):0}set value(t){this.setAttribute("value",t)}get scale(){return this.hasAttribute("scale")?this.getAttribute("scale"):1}set scale(t){this.setAttribute("scale",t)}connectedCallback(){this.style.setProperty("transform","rotate("+this._angle+"rad)"),"PointerEvent"in window?this.addEventListener("pointerdown",this._onPointerdown):(this.addEventListener("touchstart",this._onTouchstart),this.addEventListener("mousedown",this._onMousedown))}disconnectedCallback(){this.removeEventListener("pointerdown",this._onPointerdown),this.removeEventListener("touchstart",this._onTouchstart),this.removeEventListener("mousedown",this._onMousedown)}rotateTo(t){this._handleStart(),this._previousAttemptedAngle=this._attemptedAngle,this._attemptedAngle=t,this._handleMove(),this._handleEnd()}rotateToStart(t){this._initCenter(),this._touchX=this._centerX+30*Math.sin(t),this._touchY=this._centerY-30*Math.cos(t),this._handleStart()}rotateToContinue(t){this._touchX=this._centerX+30*Math.sin(t),this._touchY=this._centerY-30*Math.cos(t),this._calcTouchAngle(),this._handleMove()}rotateToEnd(){this._handleEnd()}_onMousedown(t){this._touchX=t.clientX,this._touchY=t.clientY,this._initCenter(),this._handleStart(),document.addEventListener("mousemove",this._onMousemove),document.addEventListener("mouseup",this._onMouseup)}_onMousemove(t){t.preventDefault(),this._touchX=t.clientX,this._touchY=t.clientY,this._calcTouchAngle(),this._handleMove()}_onMouseup(t){t.preventDefault(),document.removeEventListener("mousemove",this._onMousemove),document.removeEventListener("mouseup",this._onMouseup),this._handleEnd()}_onTouchstart(t){t.preventDefault(),window.oncontextmenu=(()=>!1),this._touchX=t.changedTouches[0].clientX,this._touchY=t.changedTouches[0].clientY,this._initCenter(),this._handleStart(),this.addEventListener("touchmove",this._onTouchmove),this.addEventListener("touchend",this._onTouchend),this.addEventListener("touchcancel",this._onTouchend)}_onTouchmove(t){t.preventDefault(),this._touchX=t.targetTouches[0].clientX,this._touchY=t.targetTouches[0].clientY,this._calcTouchAngle(),this._handleMove()}_onTouchend(t){t.preventDefault(),window.oncontextmenu=null,this.removeEventListener("touchmove",this._onTouchmove),this.removeEventListener("touchend",this._onTouchend),this.removeEventListener("touchcancel",this._onTouchend),this._handleEnd()}_onPointerdown(t){t.preventDefault(),window.oncontextmenu=(()=>!1),this._touchX=t.clientX,this._touchY=t.clientY,this.setPointerCapture(t.pointerId),this._initCenter(),this._handleStart(),this.addEventListener("pointermove",this._onPointermove),this.addEventListener("pointerup",this._onPointerup),this.addEventListener("pointercancel",this._onPointerup)}_onPointermove(t){t.preventDefault(),this._touchX=t.clientX,this._touchY=t.clientY,this._calcTouchAngle(),this._handleMove()}_onPointerup(t){t.preventDefault(),window.oncontextmenu=null,this.releasePointerCapture(t.pointerId),this.removeEventListener("pointermove",this._onPointermove),this.removeEventListener("pointerup",this._onPointerup),this.removeEventListener("pointercancel",this._onPointerup),this._handleEnd()}_handleStart(){this._initTouchAngle(),this._initialAngle=this._angle,this._initialValue=parseFloat(this.value),this._attemptedAngle=this._angle,this._attemptedRotations=this._rotations,this._attemptedValue=this.value;const t=new CustomEvent("touch-knob-start",{bubbles:!0});this.dispatchEvent(t)}_handleMove(){!0===this._canDraw&&(this._canDraw=!1,this._drawState());const t=new CustomEvent("touch-knob-move",{bubbles:!0});this.dispatchEvent(t)}_handleEnd(){const t=new CustomEvent("touch-knob-end",{bubbles:!0});this.dispatchEvent(t)}_initCenter(){this._centerX=this.offsetLeft-this.scrollLeft+this.clientLeft+this.offsetWidth/2,this._centerY=this.offsetTop-this.scrollTop+this.clientTop+this.offsetHeight/2}_initTouchAngle(){this._initialTouchAngle=Math.atan2(this._touchY-this._centerY,this._touchX-this._centerX)}_calcTouchAngle(){this._previousAttemptedAngle=this._attemptedAngle,this._attemptedAngle=this._initialAngle-this._initialTouchAngle+Math.atan2(this._touchY-this._centerY,this._touchX-this._centerX),this._attemptedAngle=this._attemptedAngle-this._TWO_PI*Math.floor((this._attemptedAngle+Math.PI)/this._TWO_PI)}_drawState(){this._previousAttemptedAngle>-1.57&&this._previousAttemptedAngle<0&&this._attemptedAngle>=0&&this._attemptedAngle<=1.57?this._attemptedRotations++:this._previousAttemptedAngle<1.57&&this._previousAttemptedAngle>0&&this._attemptedAngle<=0&&this._attemptedAngle>=-1.57&&this._attemptedRotations--,this._attemptedAngle>=0?this._attemptedValue=(this._attemptedAngle+this._TWO_PI*this._attemptedRotations)*this.scale:this._attemptedAngle<0&&(this._attemptedValue=(this._attemptedAngle+this._TWO_PI*(this._attemptedRotations+1))*this.scale),this._attemptedValue>=this.min&&this._attemptedValue<=this.max&&(this.value=this._attemptedValue,this._rotations=this._attemptedRotations,this._angle=this._attemptedAngle,this.style.setProperty("transform",`rotate(${this._angle}rad)`)),this._canDraw=!0}}),window.customElements.define("toggle-fullscreen",class extends HTMLElement{constructor(){super(),this._onFullscreenchange=this._onFullscreenchange.bind(this),this._toggleFullscreen=this._toggleFullscreen.bind(this)}connectedCallback(){document.addEventListener("fullscreenchange",this._onFullscreenchange,{capture:!1,passive:!0}),this._fullscreenButton=this.querySelector(".button-fullscreen"),this._fullscreenButton.addEventListener("click",this._toggleFullscreen,{capture:!1,passive:!0})}disconnectedCallback(){this._fullscreenButton.removeEventListener("click",this._toggleFullscreen)}_onFullscreenchange(){null!==document.fullscreenElement?this._fullscreenButton.textContent="⤵️ Return":this._fullscreenButton.textContent="⤴️ Full"}_toggleFullscreen(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}),window.customElements.whenDefined("touch-knob").then(void new Np(document)),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js").then(function(t){})})}();
//# sourceMappingURL=kiosk.js.map
