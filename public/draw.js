!function(){"use strict";!function(t){if(!t.fetch){var e={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};if(e.arrayBuffer)var n=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],r=function(t){return t&&DataView.prototype.isPrototypeOf(t)},i=ArrayBuffer.isView||function(t){return t&&n.indexOf(Object.prototype.toString.call(t))>-1};h.prototype.append=function(t,e){t=s(t),e=u(e);var n=this.map[t];this.map[t]=n?n+","+e:e},h.prototype.delete=function(t){delete this.map[s(t)]},h.prototype.get=function(t){return t=s(t),this.has(t)?this.map[t]:null},h.prototype.has=function(t){return this.map.hasOwnProperty(s(t))},h.prototype.set=function(t,e){this.map[s(t)]=u(e)},h.prototype.forEach=function(t,e){for(var n in this.map)this.map.hasOwnProperty(n)&&t.call(e,this.map[n],n,this)},h.prototype.keys=function(){var t=[];return this.forEach(function(e,n){t.push(n)}),c(t)},h.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),c(t)},h.prototype.entries=function(){var t=[];return this.forEach(function(e,n){t.push([n,e])}),c(t)},e.iterable&&(h.prototype[Symbol.iterator]=h.prototype.entries);var o=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];m.prototype.clone=function(){return new m(this,{body:this._bodyInit})},y.call(m.prototype),y.call(v.prototype),v.prototype.clone=function(){return new v(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new h(this.headers),url:this.url})},v.error=function(){var t=new v(null,{status:0,statusText:""});return t.type="error",t};var a=[301,302,303,307,308];v.redirect=function(t,e){if(-1===a.indexOf(e))throw new RangeError("Invalid status code");return new v(null,{status:e,headers:{location:t}})},t.Headers=h,t.Request=m,t.Response=v,t.fetch=function(t,n){return new Promise(function(r,i){var o=new m(t,n),a=new XMLHttpRequest;a.onload=function(){var t,e,n={status:a.status,statusText:a.statusText,headers:(t=a.getAllResponseHeaders()||"",e=new h,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var n=t.split(":"),r=n.shift().trim();if(r){var i=n.join(":").trim();e.append(r,i)}}),e)};n.url="responseURL"in a?a.responseURL:n.headers.get("X-Request-URL");var i="response"in a?a.response:a.responseText;r(new v(i,n))},a.onerror=function(){i(new TypeError("Network request failed"))},a.ontimeout=function(){i(new TypeError("Network request failed"))},a.open(o.method,o.url,!0),"include"===o.credentials?a.withCredentials=!0:"omit"===o.credentials&&(a.withCredentials=!1),"responseType"in a&&e.blob&&(a.responseType="blob"),o.headers.forEach(function(t,e){a.setRequestHeader(e,t)}),a.send(void 0===o._bodyInit?null:o._bodyInit)})},t.fetch.polyfill=!0}function s(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function u(t){return"string"!=typeof t&&(t=String(t)),t}function c(t){var n={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return e.iterable&&(n[Symbol.iterator]=function(){return n}),n}function h(t){this.map={},t instanceof h?t.forEach(function(t,e){this.append(e,t)},this):Array.isArray(t)?t.forEach(function(t){this.append(t[0],t[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function l(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function f(t){return new Promise(function(e,n){t.onload=function(){e(t.result)},t.onerror=function(){n(t.error)}})}function p(t){var e=new FileReader,n=f(e);return e.readAsArrayBuffer(t),n}function d(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function y(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t,t)if("string"==typeof t)this._bodyText=t;else if(e.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(e.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(e.arrayBuffer&&e.blob&&r(t))this._bodyArrayBuffer=d(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!e.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t)&&!i(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=d(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},e.blob&&(this.blob=function(){var t=l(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?l(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(p)}),this.text=function(){var t,e,n,r=l(this);if(r)return r;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,n=f(e),e.readAsText(t),n;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),n=new Array(e.length),r=0;r<e.length;r++)n[r]=String.fromCharCode(e[r]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},e.formData&&(this.formData=function(){return this.text().then(g)}),this.json=function(){return this.text().then(JSON.parse)},this}function m(t,e){var n,r,i=(e=e||{}).body;if(t instanceof m){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new h(t.headers)),this.method=t.method,this.mode=t.mode,i||null==t._bodyInit||(i=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new h(e.headers)),this.method=(n=e.method||this.method||"GET",r=n.toUpperCase(),o.indexOf(r)>-1?r:n),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function g(t){var e=new FormData;return t.trim().split("&").forEach(function(t){if(t){var n=t.split("="),r=n.shift().replace(/\+/g," "),i=n.join("=").replace(/\+/g," ");e.append(decodeURIComponent(r),decodeURIComponent(i))}}),e}function v(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new h(e.headers),this.url=e.url||"",this._initBody(t)}}("undefined"!=typeof self?self:void 0);var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(t,e){return t(e={exports:{}},e.exports),e.exports}function n(t){var e=this.constructor;return this.then(function(n){return e.resolve(t()).then(function(){return n})},function(n){return e.resolve(t()).then(function(){return e.reject(n)})})}var r=setTimeout;function i(){}function o(t){if(!(this instanceof o))throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],l(t,this)}function a(t,e){for(;3===t._state;)t=t._value;0!==t._state?(t._handled=!0,o._immediateFn(function(){var n=1===t._state?e.onFulfilled:e.onRejected;if(null!==n){var r;try{r=n(t._value)}catch(t){return void u(e.promise,t)}s(e.promise,r)}else(1===t._state?s:u)(e.promise,t._value)})):t._deferreds.push(e)}function s(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var n=e.then;if(e instanceof o)return t._state=3,t._value=e,void c(t);if("function"==typeof n)return void l((r=n,i=e,function(){r.apply(i,arguments)}),t)}t._state=1,t._value=e,c(t)}catch(e){u(t,e)}var r,i}function u(t,e){t._state=2,t._value=e,c(t)}function c(t){2===t._state&&0===t._deferreds.length&&o._immediateFn(function(){t._handled||o._unhandledRejectionFn(t._value)});for(var e=0,n=t._deferreds.length;e<n;e++)a(t,t._deferreds[e]);t._deferreds=null}function h(t,e,n){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=n}function l(t,e){var n=!1;try{t(function(t){n||(n=!0,s(e,t))},function(t){n||(n=!0,u(e,t))})}catch(t){if(n)return;n=!0,u(e,t)}}o.prototype.catch=function(t){return this.then(null,t)},o.prototype.then=function(t,e){var n=new this.constructor(i);return a(this,new h(t,e,n)),n},o.prototype.finally=n,o.all=function(t){return new o(function(e,n){if(!t||void 0===t.length)throw new TypeError("Promise.all accepts an array");var r=Array.prototype.slice.call(t);if(0===r.length)return e([]);var i=r.length;function o(t,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var s=a.then;if("function"==typeof s)return void s.call(a,function(e){o(t,e)},n)}r[t]=a,0==--i&&e(r)}catch(t){n(t)}}for(var a=0;a<r.length;a++)o(a,r[a])})},o.resolve=function(t){return t&&"object"==typeof t&&t.constructor===o?t:new o(function(e){e(t)})},o.reject=function(t){return new o(function(e,n){n(t)})},o.race=function(t){return new o(function(e,n){for(var r=0,i=t.length;r<i;r++)t[r].then(e,n)})},o._immediateFn="function"==typeof setImmediate&&function(t){setImmediate(t)}||function(t){r(t,0)},o._unhandledRejectionFn=function(t){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",t)};var f=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==t)return t;throw new Error("unable to locate global object")}();"Promise"in f?f.Promise.prototype.finally||(f.Promise.prototype.finally=n):f.Promise=o;var p,d,y,m=function(t,e,n){if(function(t){if("function"!=typeof t)throw TypeError(String(t)+" is not a function")}(t),void 0===e)return t;switch(n){case 0:return function(){return t.call(e)};case 1:return function(n){return t.call(e,n)};case 2:return function(n,r){return t.call(e,n,r)};case 3:return function(n,r,i){return t.call(e,n,r,i)}}return function(){return t.apply(e,arguments)}},g=function(t){try{return!!t()}catch(t){return!0}},v={}.toString,b=function(t){return v.call(t).slice(8,-1)},w="".split,S=g(function(){return!Object("z").propertyIsEnumerable(0)})?function(t){return"String"==b(t)?w.call(t,""):Object(t)}:Object,E=function(t){if(null==t)throw TypeError("Can't call method on "+t);return t},T=function(t){return Object(E(t))},I=Math.ceil,C=Math.floor,D=function(t){return isNaN(t=+t)?0:(t>0?C:I)(t)},A=Math.min,N=function(t){return t>0?A(D(t),9007199254740991):0},k=function(t){return"object"==typeof t?null!==t:"function"==typeof t},R=Array.isArray||function(t){return"Array"==b(t)},O="object"==typeof window&&window&&window.Math==Math?window:"object"==typeof self&&self&&self.Math==Math?self:Function("return this")(),_=!g(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),M=O.document,P=k(M)&&k(M.createElement),L=function(t){return P?M.createElement(t):{}},x=!_&&!g(function(){return 7!=Object.defineProperty(L("div"),"a",{get:function(){return 7}}).a}),q=function(t){if(!k(t))throw TypeError(String(t)+" is not an object");return t},F=function(t,e){if(!k(t))return t;var n,r;if(e&&"function"==typeof(n=t.toString)&&!k(r=n.call(t)))return r;if("function"==typeof(n=t.valueOf)&&!k(r=n.call(t)))return r;if(!e&&"function"==typeof(n=t.toString)&&!k(r=n.call(t)))return r;throw TypeError("Can't convert object to primitive value")},B=Object.defineProperty,V={f:_?B:function(t,e,n){if(q(t),e=F(e,!0),q(n),x)try{return B(t,e,n)}catch(t){}if("get"in n||"set"in n)throw TypeError("Accessors not supported");return"value"in n&&(t[e]=n.value),t}},U=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},j=_?function(t,e,n){return V.f(t,e,U(1,n))}:function(t,e,n){return t[e]=n,t},Q=function(t,e){try{j(O,t,e)}catch(n){O[t]=e}return e},K=e(function(t){var e=O["__core-js_shared__"]||Q("__core-js_shared__",{});(t.exports=function(t,n){return e[t]||(e[t]=void 0!==n?n:{})})("versions",[]).push({version:"3.0.1",mode:"global",copyright:"Â© 2019 Denis Pushkarev (zloirock.ru)"})}),G=0,W=Math.random(),z=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++G+W).toString(36))},H=!g(function(){return!String(Symbol())}),Y=K("wks"),X=O.Symbol,J=function(t){return Y[t]||(Y[t]=H&&X[t]||(H?X:z)("Symbol."+t))},$=J("species"),Z=function(t,e){var n;return R(t)&&("function"!=typeof(n=t.constructor)||n!==Array&&!R(n.prototype)?k(n)&&null===(n=n[$])&&(n=void 0):n=void 0),new(void 0===n?Array:n)(0===e?0:e)},tt=function(t,e){var n=1==t,r=2==t,i=3==t,o=4==t,a=6==t,s=5==t||a,u=e||Z;return function(e,c,h){for(var l,f,p=T(e),d=S(p),y=m(c,h,3),g=N(d.length),v=0,b=n?u(e,g):r?u(e,0):void 0;g>v;v++)if((s||v in d)&&(f=y(l=d[v],v,p),t))if(n)b[v]=f;else if(f)switch(t){case 3:return!0;case 5:return l;case 6:return v;case 2:b.push(l)}else if(o)return!1;return a?-1:i||o?o:b}},et={}.propertyIsEnumerable,nt=Object.getOwnPropertyDescriptor,rt={f:nt&&!et.call({1:2},1)?function(t){var e=nt(this,t);return!!e&&e.enumerable}:et},it=function(t){return S(E(t))},ot={}.hasOwnProperty,at=function(t,e){return ot.call(t,e)},st=Object.getOwnPropertyDescriptor,ut={f:_?st:function(t,e){if(t=it(t),e=F(e,!0),x)try{return st(t,e)}catch(t){}if(at(t,e))return U(!rt.f.call(t,e),t[e])}},ct=K("native-function-to-string",Function.toString),ht=O.WeakMap,lt="function"==typeof ht&&/native code/.test(ct.call(ht)),ft=K("keys"),pt=function(t){return ft[t]||(ft[t]=z(t))},dt={},yt=O.WeakMap;if(lt){var mt=new yt,gt=mt.get,vt=mt.has,bt=mt.set;p=function(t,e){return bt.call(mt,t,e),e},d=function(t){return gt.call(mt,t)||{}},y=function(t){return vt.call(mt,t)}}else{var wt=pt("state");dt[wt]=!0,p=function(t,e){return j(t,wt,e),e},d=function(t){return at(t,wt)?t[wt]:{}},y=function(t){return at(t,wt)}}var St,Et={set:p,get:d,has:y,enforce:function(t){return y(t)?d(t):p(t,{})},getterFor:function(t){return function(e){var n;if(!k(e)||(n=d(e)).type!==t)throw TypeError("Incompatible receiver, "+t+" required");return n}}},Tt=e(function(t){var e=Et.get,n=Et.enforce,r=String(ct).split("toString");K("inspectSource",function(t){return ct.call(t)}),(t.exports=function(t,e,i,o){var a=!!o&&!!o.unsafe,s=!!o&&!!o.enumerable,u=!!o&&!!o.noTargetGet;"function"==typeof i&&("string"!=typeof e||at(i,"name")||j(i,"name",e),n(i).source=r.join("string"==typeof e?e:"")),t!==O?(a?!u&&t[e]&&(s=!0):delete t[e],s?t[e]=i:j(t,e,i)):s?t[e]=i:Q(e,i)})(Function.prototype,"toString",function(){return"function"==typeof this&&e(this).source||ct.call(this)})}),It=Math.max,Ct=Math.min,Dt=(St=!1,function(t,e,n){var r,i=it(t),o=N(i.length),a=function(t,e){var n=D(t);return n<0?It(n+e,0):Ct(n,e)}(n,o);if(St&&e!=e){for(;o>a;)if((r=i[a++])!=r)return!0}else for(;o>a;a++)if((St||a in i)&&i[a]===e)return St||a||0;return!St&&-1}),At=function(t,e){var n,r=it(t),i=0,o=[];for(n in r)!at(dt,n)&&at(r,n)&&o.push(n);for(;e.length>i;)at(r,n=e[i++])&&(~Dt(o,n)||o.push(n));return o},Nt=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],kt=Nt.concat("length","prototype"),Rt={f:Object.getOwnPropertyNames||function(t){return At(t,kt)}},Ot={f:Object.getOwnPropertySymbols},_t=O.Reflect,Mt=_t&&_t.ownKeys||function(t){var e=Rt.f(q(t)),n=Ot.f;return n?e.concat(n(t)):e},Pt=function(t,e){for(var n=Mt(e),r=V.f,i=ut.f,o=0;o<n.length;o++){var a=n[o];at(t,a)||r(t,a,i(e,a))}},Lt=/#|\.prototype\./,xt=function(t,e){var n=Ft[qt(t)];return n==Vt||n!=Bt&&("function"==typeof e?g(e):!!e)},qt=xt.normalize=function(t){return String(t).replace(Lt,".").toLowerCase()},Ft=xt.data={},Bt=xt.NATIVE="N",Vt=xt.POLYFILL="P",Ut=xt,jt=ut.f,Qt=function(t,e){var n,r,i,o,a,s=t.target,u=t.global,c=t.stat;if(n=u?O:c?O[s]||Q(s,{}):(O[s]||{}).prototype)for(r in e){if(o=e[r],i=t.noTargetGet?(a=jt(n,r))&&a.value:n[r],!Ut(u?r:s+(c?".":"#")+r,t.forced)&&void 0!==i){if(typeof o==typeof i)continue;Pt(o,i)}(t.sham||i&&i.sham)&&j(o,"sham",!0),Tt(n,r,o,t)}},Kt=Object.keys||function(t){return At(t,Nt)},Gt=_?Object.defineProperties:function(t,e){q(t);for(var n,r=Kt(e),i=r.length,o=0;i>o;)V.f(t,n=r[o++],e[n]);return t},Wt=O.document,zt=Wt&&Wt.documentElement,Ht=pt("IE_PROTO"),Yt=function(){},Xt=function(){var t,e=L("iframe"),n=Nt.length;for(e.style.display="none",zt.appendChild(e),e.src=String("javascript:"),(t=e.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),Xt=t.F;n--;)delete Xt.prototype[Nt[n]];return Xt()},Jt=Object.create||function(t,e){var n;return null!==t?(Yt.prototype=q(t),n=new Yt,Yt.prototype=null,n[Ht]=t):n=Xt(),void 0===e?n:Gt(n,e)};dt[Ht]=!0;var $t=J("unscopables"),Zt=Array.prototype;null==Zt[$t]&&j(Zt,$t,Jt(null));var te=function(t){Zt[$t][t]=!0},ee=tt(5),ne=!0;"find"in[]&&Array(1).find(function(){ne=!1}),Qt({target:"Array",proto:!0,forced:ne},{find:function(t){return ee(this,t,arguments.length>1?arguments[1]:void 0)}}),te("find");var re=Function.call,ie=function(t,e,n){return m(re,O[t].prototype[e],n)},oe=(ie("Array","find"),tt(6)),ae=!0;"findIndex"in[]&&Array(1).findIndex(function(){ae=!1}),Qt({target:"Array",proto:!0,forced:ae},{findIndex:function(t){return oe(this,t,arguments.length>1?arguments[1]:void 0)}}),te("findIndex");ie("Array","findIndex");var se=Object.assign,ue=!se||g(function(){var t={},e={},n=Symbol();return t[n]=7,"abcdefghijklmnopqrst".split("").forEach(function(t){e[t]=t}),7!=se({},t)[n]||"abcdefghijklmnopqrst"!=Kt(se({},e)).join("")})?function(t,e){for(var n=T(t),r=arguments.length,i=1,o=Ot.f,a=rt.f;r>i;)for(var s,u=S(arguments[i++]),c=o?Kt(u).concat(o(u)):Kt(u),h=c.length,l=0;h>l;)a.call(u,s=c[l++])&&(n[s]=u[s]);return n}:se;Qt({target:"Object",stat:!0,forced:Object.assign!==ue},{assign:ue});var ce=O,he=(ce.Object.assign,J("match")),le=function(t,e,n){if(k(r=e)&&(void 0!==(i=r[he])?i:"RegExp"==b(r)))throw TypeError("String.prototype."+n+" doesn't accept regex");var r,i;return String(E(t))},fe=J("match"),pe=function(t){var e=/./;try{"/./"[t](e)}catch(n){try{return e[fe]=!1,"/./"[t](e)}catch(t){}}return!1}("startsWith"),de="".startsWith;Qt({target:"String",proto:!0,forced:!pe},{startsWith:function(t){var e=le(this,t,"startsWith"),n=N(Math.min(arguments.length>1?arguments[1]:void 0,e.length)),r=String(t);return de?de.call(e,r,n):e.slice(n,n+r.length)===r}});ie("String","startsWith");Qt({target:"String",proto:!0},{repeat:"".repeat||function(t){var e=String(E(this)),n="",r=D(t);if(r<0||r==1/0)throw RangeError("Wrong number of repetitions");for(;r>0;(r>>>=1)&&(e+=e))1&r&&(n+=e);return n}});ie("String","repeat");var ye=function(t,e,n){var r=F(e);r in t?V.f(t,r,U(0,n)):t[r]=n},me=J("species"),ge=J("isConcatSpreadable"),ve=!g(function(){var t=[];return t[ge]=!1,t.concat()[0]!==t}),be=function(t){return!g(function(){var e=[];return(e.constructor={})[me]=function(){return{foo:1}},1!==e[t](Boolean).foo})}("concat"),we=function(t){if(!k(t))return!1;var e=t[ge];return void 0!==e?!!e:R(t)};Qt({target:"Array",proto:!0,forced:!ve||!be},{concat:function(t){var e,n,r,i,o,a=T(this),s=Z(a,0),u=0;for(e=-1,r=arguments.length;e<r;e++)if(o=-1===e?a:arguments[e],we(o)){if(u+(i=N(o.length))>9007199254740991)throw TypeError("Maximum allowed index exceeded");for(n=0;n<i;n++,u++)n in o&&ye(s,u,o[n])}else{if(u>=9007199254740991)throw TypeError("Maximum allowed index exceeded");ye(s,u++,o)}return s.length=u,s}});var Se=J("toStringTag"),Ee="Arguments"==b(function(){return arguments}()),Te={};Te[J("toStringTag")]="z";var Ie="[object z]"!==String(Te)?function(){return"[object "+(void 0===(t=this)?"Undefined":null===t?"Null":"string"==typeof(n=function(t,e){try{return t[e]}catch(t){}}(e=Object(t),Se))?n:Ee?b(e):"Object"==(r=b(e))&&"function"==typeof e.callee?"Arguments":r)+"]";var t,e,n,r}:Te.toString,Ce=Object.prototype;Ie!==Ce.toString&&Tt(Ce,"toString",Ie,{unsafe:!0});var De=V.f,Ae=J("toStringTag"),Ne=function(t,e,n){t&&!at(t=n?t:t.prototype,Ae)&&De(t,Ae,{configurable:!0,value:e})},ke={f:J},Re=V.f,Oe=function(t){var e=ce.Symbol||(ce.Symbol={});at(e,t)||Re(e,t,{value:ke.f(t)})},_e=Rt.f,Me={}.toString,Pe="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],Le={f:function(t){return Pe&&"[object Window]"==Me.call(t)?function(t){try{return _e(t)}catch(t){return Pe.slice()}}(t):_e(it(t))}},xe=pt("hidden"),qe=Et.set,Fe=Et.getterFor("Symbol"),Be=ut.f,Ve=V.f,Ue=Le.f,je=O.Symbol,Qe=O.JSON,Ke=Qe&&Qe.stringify,Ge=J("toPrimitive"),We=rt.f,ze=K("symbol-registry"),He=K("symbols"),Ye=K("op-symbols"),Xe=K("wks"),Je=Object.prototype,$e=O.QObject,Ze=!$e||!$e.prototype||!$e.prototype.findChild,tn=_&&g(function(){return 7!=Jt(Ve({},"a",{get:function(){return Ve(this,"a",{value:7}).a}})).a})?function(t,e,n){var r=Be(Je,e);r&&delete Je[e],Ve(t,e,n),r&&t!==Je&&Ve(Je,e,r)}:Ve,en=function(t,e){var n=He[t]=Jt(je.prototype);return qe(n,{type:"Symbol",tag:t,description:e}),_||(n.description=e),n},nn=H&&"symbol"==typeof je.iterator?function(t){return"symbol"==typeof t}:function(t){return Object(t)instanceof je},rn=function(t,e,n){return t===Je&&rn(Ye,e,n),q(t),e=F(e,!0),q(n),at(He,e)?(n.enumerable?(at(t,xe)&&t[xe][e]&&(t[xe][e]=!1),n=Jt(n,{enumerable:U(0,!1)})):(at(t,xe)||Ve(t,xe,U(1,{})),t[xe][e]=!0),tn(t,e,n)):Ve(t,e,n)},on=function(t,e){q(t);for(var n,r=function(t){var e=Kt(t),n=Ot.f;if(n)for(var r,i=n(t),o=rt.f,a=0;i.length>a;)o.call(t,r=i[a++])&&e.push(r);return e}(e=it(e)),i=0,o=r.length;o>i;)rn(t,n=r[i++],e[n]);return t},an=function(t){var e=We.call(this,t=F(t,!0));return!(this===Je&&at(He,t)&&!at(Ye,t))&&(!(e||!at(this,t)||!at(He,t)||at(this,xe)&&this[xe][t])||e)},sn=function(t,e){if(t=it(t),e=F(e,!0),t!==Je||!at(He,e)||at(Ye,e)){var n=Be(t,e);return!n||!at(He,e)||at(t,xe)&&t[xe][e]||(n.enumerable=!0),n}},un=function(t){for(var e,n=Ue(it(t)),r=[],i=0;n.length>i;)at(He,e=n[i++])||at(dt,e)||r.push(e);return r},cn=function(t){for(var e,n=t===Je,r=Ue(n?Ye:it(t)),i=[],o=0;r.length>o;)!at(He,e=r[o++])||n&&!at(Je,e)||i.push(He[e]);return i};H||(Tt((je=function(){if(this instanceof je)throw TypeError("Symbol is not a constructor");var t=void 0===arguments[0]?void 0:String(arguments[0]),e=z(t),n=function(t){this===Je&&n.call(Ye,t),at(this,xe)&&at(this[xe],e)&&(this[xe][e]=!1),tn(this,e,U(1,t))};return _&&Ze&&tn(Je,e,{configurable:!0,set:n}),en(e,t)}).prototype,"toString",function(){return Fe(this).tag}),rt.f=an,V.f=rn,ut.f=sn,Rt.f=Le.f=un,Ot.f=cn,_&&(Ve(je.prototype,"description",{configurable:!0,get:function(){return Fe(this).description}}),Tt(Je,"propertyIsEnumerable",an,{unsafe:!0})),ke.f=function(t){return en(J(t),t)}),Qt({global:!0,wrap:!0,forced:!H,sham:!H},{Symbol:je});for(var hn=Kt(Xe),ln=0;hn.length>ln;)Oe(hn[ln++]);Qt({target:"Symbol",stat:!0,forced:!H},{for:function(t){return at(ze,t+="")?ze[t]:ze[t]=je(t)},keyFor:function(t){if(!nn(t))throw TypeError(t+" is not a symbol");for(var e in ze)if(ze[e]===t)return e},useSetter:function(){Ze=!0},useSimple:function(){Ze=!1}}),Qt({target:"Object",stat:!0,forced:!H,sham:!_},{create:function(t,e){return void 0===e?Jt(t):on(Jt(t),e)},defineProperty:rn,defineProperties:on,getOwnPropertyDescriptor:sn}),Qt({target:"Object",stat:!0,forced:!H},{getOwnPropertyNames:un,getOwnPropertySymbols:cn}),Qe&&Qt({target:"JSON",stat:!0,forced:!H||g(function(){var t=je();return"[null]"!=Ke([t])||"{}"!=Ke({a:t})||"{}"!=Ke(Object(t))})},{stringify:function(t){for(var e,n,r=[t],i=1;arguments.length>i;)r.push(arguments[i++]);if(n=e=r[1],(k(e)||void 0!==t)&&!nn(t))return R(e)||(e=function(t,e){if("function"==typeof n&&(e=n.call(this,t,e)),!nn(e))return e}),r[1]=e,Ke.apply(Qe,r)}}),je.prototype[Ge]||j(je.prototype,Ge,je.prototype.valueOf),Ne(je,"Symbol"),dt[xe]=!0,Oe("asyncIterator");var fn=V.f,pn=O.Symbol;if(_&&"function"==typeof pn&&(!("description"in pn.prototype)||void 0!==pn().description)){var dn={},yn=function(){var t=arguments.length<1||void 0===arguments[0]?void 0:String(arguments[0]),e=this instanceof yn?new pn(t):void 0===t?pn():pn(t);return""===t&&(dn[e]=!0),e};Pt(yn,pn);var mn=yn.prototype=pn.prototype;mn.constructor=yn;var gn=mn.toString,vn="Symbol(test)"==String(pn("test")),bn=/^Symbol\((.*)\)[^)]+$/;fn(mn,"description",{configurable:!0,get:function(){var t=k(this)?this.valueOf():this,e=gn.call(t);if(at(dn,t))return"";var n=vn?e.slice(7,-1):e.replace(bn,"$1");return""===n?void 0:n}}),Qt({global:!0,forced:!0},{Symbol:yn})}Oe("hasInstance"),Oe("isConcatSpreadable"),Oe("iterator"),Oe("match"),Oe("replace"),Oe("search"),Oe("species"),Oe("split"),Oe("toPrimitive"),Oe("toStringTag"),Oe("unscopables"),Ne(Math,"Math",!0),Ne(O.JSON,"JSON",!0);ce.Symbol;Oe("dispose"),Oe("observable"),Oe("patternMatch");var wn,Sn,En,Tn=!g(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),In=pt("IE_PROTO"),Cn=Object.prototype,Dn=Tn?Object.getPrototypeOf:function(t){return t=T(t),at(t,In)?t[In]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?Cn:null},An=J("iterator"),Nn=!1;[].keys&&("next"in(En=[].keys())?(Sn=Dn(Dn(En)))!==Object.prototype&&(wn=Sn):Nn=!0),null==wn&&(wn={}),at(wn,An)||j(wn,An,function(){return this});var kn={IteratorPrototype:wn,BUGGY_SAFARI_ITERATORS:Nn},Rn=kn.IteratorPrototype,On=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,n={};try{(t=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(n,[]),e=n instanceof Array}catch(t){}return function(n,r){return function(t,e){if(q(t),!k(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype")}(n,r),e?t.call(n,r):n.__proto__=r,n}}():void 0),_n=J("iterator"),Mn=kn.IteratorPrototype,Pn=kn.BUGGY_SAFARI_ITERATORS,Ln=function(){return this},xn=function(t,e,n,r,i,o,a){!function(t,e,n){var r=e+" Iterator";t.prototype=Jt(Rn,{next:U(1,n)}),Ne(t,r,!1)}(n,e,r);var s,u,c,h=function(t){if(t===i&&y)return y;if(!Pn&&t in p)return p[t];switch(t){case"keys":case"values":case"entries":return function(){return new n(this,t)}}return function(){return new n(this)}},l=e+" Iterator",f=!1,p=t.prototype,d=p[_n]||p["@@iterator"]||i&&p[i],y=!Pn&&d||h(i),m="Array"==e&&p.entries||d;if(m&&(s=Dn(m.call(new t)),Mn!==Object.prototype&&s.next&&(Dn(s)!==Mn&&(On?On(s,Mn):"function"!=typeof s[_n]&&j(s,_n,Ln)),Ne(s,l,!0))),"values"==i&&d&&"values"!==d.name&&(f=!0,y=function(){return d.call(this)}),p[_n]!==y&&j(p,_n,y),i)if(u={values:h("values"),keys:o?y:h("keys"),entries:h("entries")},a)for(c in u)!Pn&&!f&&c in p||Tt(p,c,u[c]);else Qt({target:e,proto:!0,forced:Pn||f},u);return u},qn=Et.set,Fn=Et.getterFor("String Iterator");xn(String,"String",function(t){qn(this,{type:"String Iterator",string:String(t),index:0})},function(){var t,e,n,r,i,o,a,s,u=Fn(this),c=u.string,h=u.index;return h>=c.length?{value:void 0,done:!0}:(e=h,n=!0,o=String(E(c)),a=D(e),s=o.length,t=a<0||a>=s?n?"":void 0:(r=o.charCodeAt(a))<55296||r>56319||a+1===s||(i=o.charCodeAt(a+1))<56320||i>57343?n?o.charAt(a):r:n?o.slice(a,a+2):i-56320+(r-55296<<10)+65536,u.index+=t.length,{value:t,done:!1})});var Bn={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Vn=Et.set,Un=Et.getterFor("Array Iterator"),jn=xn(Array,"Array",function(t,e){Vn(this,{type:"Array Iterator",target:it(t),index:0,kind:e})},function(){var t=Un(this),e=t.target,n=t.kind,r=t.index++;return!e||r>=e.length?(t.target=void 0,{value:void 0,done:!0}):"keys"==n?{value:r,done:!1}:"values"==n?{value:e[r],done:!1}:{value:[r,e[r]],done:!1}},"values");te("keys"),te("values"),te("entries");var Qn=J("iterator"),Kn=J("toStringTag"),Gn=jn.values;for(var Wn in Bn){var zn=O[Wn],Hn=zn&&zn.prototype;if(Hn){if(Hn[Qn]!==Gn)try{j(Hn,Qn,Gn)}catch(pr){Hn[Qn]=Gn}if(Hn[Kn]||j(Hn,Kn,Wn),Bn[Wn])for(var Yn in jn)if(Hn[Yn]!==jn[Yn])try{j(Hn,Yn,jn[Yn])}catch(pr){Hn[Yn]=jn[Yn]}}}ke.f("iterator");var Xn=function(t,e){return(Xn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function Jn(t,e){function n(){this.constructor=t}Xn(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var $n=function(){return($n=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function Zn(t,e,n,r){return new(n||(n=Promise))(function(i,o){function a(t){try{u(r.next(t))}catch(t){o(t)}}function s(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(a,s)}u((r=r.apply(t,e||[])).next())})}function tr(t,e){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function er(t,e){if(!(e instanceof Object))return e;switch(e.constructor){case Date:return new Date(e.getTime());case Object:void 0===t&&(t={});break;case Array:t=[];break;default:return e}for(var n in e)e.hasOwnProperty(n)&&(t[n]=er(t[n],e[n]));return t}function nr(t,e,n){t[e]=n}var rr="FirebaseError",ir=function(t){function e(n,r){var i=t.call(this,r)||this;return i.code=n,i.name=rr,Object.setPrototypeOf(i,e.prototype),Error.captureStackTrace&&Error.captureStackTrace(i,or.prototype.create),i}return Jn(e,t),e}(Error),or=function(){function t(t,e,n){this.service=t,this.serviceName=e,this.errors=n}return t.prototype.create=function(t,e){void 0===e&&(e={});for(var n=this.service+"/"+t,r=this.errors[t],i=r?function(t,e){return t.replace(ar,function(t,n){var r=e[n];return null!=r?r.toString():"<"+n+"?>"})}(r,e):"Error",o=this.serviceName+": "+i+" ("+n+").",a=new ir(n,o),s=0,u=Object.keys(e);s<u.length;s++){var c=u[s];"_"!==c.slice(-1)&&(c in a&&console.warn('Overwriting FirebaseError base field "'+c+'" can cause unexpected behavior.'),a[c]=e[c])}return a},t}();var ar=/\{\$([^}]+)}/g;function sr(t,e){var n=new cr(t,e);return n.subscribe.bind(n)}var ur,cr=function(){function t(t,e){var n=this;this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=e,this.task.then(function(){t(n)}).catch(function(t){n.error(t)})}return t.prototype.next=function(t){this.forEachObserver(function(e){e.next(t)})},t.prototype.error=function(t){this.forEachObserver(function(e){e.error(t)}),this.close(t)},t.prototype.complete=function(){this.forEachObserver(function(t){t.complete()}),this.close()},t.prototype.subscribe=function(t,e,n){var r,i=this;if(void 0===t&&void 0===e&&void 0===n)throw new Error("Missing Observer.");void 0===(r=function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=0,r=e;n<r.length;n++){var i=r[n];if(i in t&&"function"==typeof t[i])return!0}return!1}(t,["next","error","complete"])?t:{next:t,error:e,complete:n}).next&&(r.next=hr),void 0===r.error&&(r.error=hr),void 0===r.complete&&(r.complete=hr);var o=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(function(){try{i.finalError?r.error(i.finalError):r.complete()}catch(t){}}),this.observers.push(r),o},t.prototype.unsubscribeOne=function(t){void 0!==this.observers&&void 0!==this.observers[t]&&(delete this.observers[t],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))},t.prototype.forEachObserver=function(t){if(!this.finalized)for(var e=0;e<this.observers.length;e++)this.sendOne(e,t)},t.prototype.sendOne=function(t,e){var n=this;this.task.then(function(){if(void 0!==n.observers&&void 0!==n.observers[t])try{e(n.observers[t])}catch(t){"undefined"!=typeof console&&console.error&&console.error(t)}})},t.prototype.close=function(t){var e=this;this.finalized||(this.finalized=!0,void 0!==t&&(this.finalError=t),this.task.then(function(){e.observers=void 0,e.onNoObservers=void 0}))},t}();function hr(){}var lr=((ur={})["no-app"]="No Firebase App '{$name}' has been created - call Firebase App.initializeApp()",ur["bad-app-name"]="Illegal App name: '{$name}",ur["duplicate-app"]="Firebase App named '{$name}' already exists",ur["app-deleted"]="Firebase App named '{$name}' already deleted",ur["duplicate-service"]="Firebase service named '{$name}' already registered",ur["invalid-app-argument"]="firebase.{$name}() takes either no argument or a Firebase App instance.",ur),fr=new or("app","Firebase",lr);function pr(t,e){throw fr.create(t,e)}var dr="[DEFAULT]",yr=[],mr=function(){function t(t,e,n){this.firebase_=n,this.isDeleted_=!1,this.services_={},this.name_=e.name,this.automaticDataCollectionEnabled_=e.automaticDataCollectionEnabled||!1,this.options_=er(void 0,t),this.INTERNAL={getUid:function(){return null},getToken:function(){return Promise.resolve(null)},addAuthTokenListener:function(t){yr.push(t),setTimeout(function(){return t(null)},0)},removeAuthTokenListener:function(t){yr=yr.filter(function(e){return e!==t})}}}return Object.defineProperty(t.prototype,"automaticDataCollectionEnabled",{get:function(){return this.checkDestroyed_(),this.automaticDataCollectionEnabled_},set:function(t){this.checkDestroyed_(),this.automaticDataCollectionEnabled_=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this.checkDestroyed_(),this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this.checkDestroyed_(),this.options_},enumerable:!0,configurable:!0}),t.prototype.delete=function(){var t=this;return new Promise(function(e){t.checkDestroyed_(),e()}).then(function(){t.firebase_.INTERNAL.removeApp(t.name_);for(var e=[],n=0,r=Object.keys(t.services_);n<r.length;n++)for(var i=r[n],o=0,a=Object.keys(t.services_[i]);o<a.length;o++){var s=a[o];e.push(t.services_[i][s])}return Promise.all(e.map(function(t){return t.INTERNAL.delete()}))}).then(function(){t.isDeleted_=!0,t.services_={}})},t.prototype._getService=function(t,e){if(void 0===e&&(e=dr),this.checkDestroyed_(),this.services_[t]||(this.services_[t]={}),!this.services_[t][e]){var n=e!==dr?e:void 0,r=this.firebase_.INTERNAL.factories[t](this,this.extendApp.bind(this),n);this.services_[t][e]=r}return this.services_[t][e]},t.prototype.extendApp=function(t){var e=this;er(this,t),t.INTERNAL&&t.INTERNAL.addAuthTokenListener&&(yr.forEach(function(t){e.INTERNAL.addAuthTokenListener(t)}),yr=[])},t.prototype.checkDestroyed_=function(){this.isDeleted_&&pr("app-deleted",{name:this.name_})},t}();function gr(t,e){return Object.prototype.hasOwnProperty.call(t,e)}mr.prototype.name&&mr.prototype.options||mr.prototype.delete||console.log("dc");var vr=!1;try{vr="[object process]"===Object.prototype.toString.call(global.process)}catch(t){}if(vr&&console.warn('\nWarning: This is a browser-targeted Firebase bundle but it appears it is being\nrun in a Node environment.  If running in a Node environment, make sure you\nare using the bundle specified by the "main" field in package.json.\n\nIf you are using Webpack, you can specify "main" as the first item in\n"resolve.mainFields":\nhttps://webpack.js.org/configuration/resolve/#resolvemainfields\n\nIf using Rollup, use the rollup-plugin-node-resolve plugin and set "module"\nto false and "main" to true:\nhttps://github.com/rollup/rollup-plugin-node-resolve\n'),self&&"firebase"in self){console.warn("\n    Warning: Firebase is already defined in the global scope. Please make sure\n    Firebase library is only loaded once.\n  ");var br=self.firebase.SDK_VERSION;br&&br.indexOf("LITE")>=0&&console.warn("\n    Warning: You are trying to load Firebase while using Firebase Performance standalone script.\n    You should load Firebase Performance with this instance of Firebase to avoid loading duplicate code.\n    ")}var wr,Sr=function t(){var e=function(t){var e={},n={},r={},i={__esModule:!0,initializeApp:function(n,r){if(void 0===r&&(r={}),"object"!=typeof r||null===r){var o=r;r={name:o}}var a=r;void 0===a.name&&(a.name=dr);var u=a.name;"string"==typeof u&&u||pr("bad-app-name",{name:String(u)}),gr(e,u)&&pr("duplicate-app",{name:u});var c=new t(n,a,i);return e[u]=c,s(c,"create"),c},app:o,apps:null,Promise:Promise,SDK_VERSION:"5.11.0",INTERNAL:{registerService:function(e,s,u,c,h){function l(t){return void 0===t&&(t=o()),"function"!=typeof t[e]&&pr("invalid-app-argument",{name:e}),t[e]()}return void 0===h&&(h=!1),n[e]&&pr("duplicate-service",{name:e}),n[e]=s,c&&(r[e]=c,a().forEach(function(t){c("create",t)})),void 0!==u&&er(l,u),i[e]=l,t.prototype[e]=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this._getService.bind(this,e).apply(this,h?t:[])},l},removeApp:function(t){s(e[t],"delete"),delete e[t]},factories:n,useAsService:u}};function o(t){return gr(e,t=t||dr)||pr("no-app",{name:t}),e[t]}function a(){return Object.keys(e).map(function(t){return e[t]})}function s(t,e){for(var i=0,o=Object.keys(n);i<o.length;i++){var a=u(t,o[i]);if(null===a)return;r[a]&&r[a](e,t)}}function u(t,e){if("serverAuth"===e)return null;var n=e;return t.options,n}return nr(i,"default",i),Object.defineProperty(i,"apps",{get:a}),nr(o,"App",t),i}(mr);return e.INTERNAL=$n({},e.INTERNAL,{createFirebaseNamespace:t,extendNamespace:function(t){er(e,t)},createSubscribe:sr,ErrorFactory:or,deepExtend:er}),e}();!function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"}(wr||(wr={}));var Er,Tr=wr.INFO,Ir=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(e<t.logLevel)){var i=(new Date).toISOString();switch(e){case wr.DEBUG:case wr.VERBOSE:console.log.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case wr.INFO:console.info.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case wr.WARN:console.warn.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case wr.ERROR:console.error.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+e+")")}}},Cr=function(){function t(t){this.name=t,this._logLevel=Tr,this._logHandler=Ir}return Object.defineProperty(t.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in wr))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!0,configurable:!0}),t.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,wr.DEBUG].concat(t))},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,wr.VERBOSE].concat(t))},t.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,wr.INFO].concat(t))},t.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,wr.WARN].concat(t))},t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,wr.ERROR].concat(t))},t}(),Dr="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Ar=Ar||{},Nr=Dr;function kr(t){return"string"==typeof t}function Rr(t){return"number"==typeof t}function Or(t,e){t=t.split("."),e=e||Nr;for(var n=0;n<t.length;n++)if(null==(e=e[t[n]]))return null;return e}function _r(){}function Mr(t){var e=typeof t;if("object"==e){if(!t)return"null";if(t instanceof Array)return"array";if(t instanceof Object)return e;var n=Object.prototype.toString.call(t);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof t.length&&void 0!==t.splice&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==t.call&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("call"))return"function"}else if("function"==e&&void 0===t.call)return"object";return e}function Pr(t){return"array"==Mr(t)}function Lr(t){var e=Mr(t);return"array"==e||"object"==e&&"number"==typeof t.length}function xr(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var qr="closure_uid_"+(1e9*Math.random()>>>0),Fr=0;function Br(t,e,n){return t.call.apply(t.bind,arguments)}function Vr(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function Ur(t,e,n){return(Ur=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?Br:Vr).apply(null,arguments)}function jr(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}var Qr=Date.now||function(){return+new Date};function Kr(t,e){function n(){}n.prototype=e.prototype,t.N=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.yb=function(t,n,r){for(var i=Array(arguments.length-2),o=2;o<arguments.length;o++)i[o-2]=arguments[o];return e.prototype[n].apply(t,i)}}function Gr(){this.j=this.j,this.i=this.i}Gr.prototype.j=!1,Gr.prototype.la=function(){if(!this.j&&(this.j=!0,this.G(),0))this[qr]||(this[qr]=++Fr)},Gr.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var Wr=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if(kr(t))return kr(e)&&1==e.length?t.indexOf(e,0):-1;for(var n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},zr=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){for(var r=t.length,i=kr(t)?t.split(""):t,o=0;o<r;o++)o in i&&e.call(n,i[o],o,t)};function Hr(t){return Array.prototype.concat.apply([],arguments)}function Yr(t){var e=t.length;if(0<e){for(var n=Array(e),r=0;r<e;r++)n[r]=t[r];return n}return[]}function Xr(t){return/^[\s\xa0]*$/.test(t)}var Jr,$r=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function Zr(t,e){return-1!=t.indexOf(e)}function ti(t,e){return t<e?-1:t>e?1:0}t:{var ei=Nr.navigator;if(ei){var ni=ei.userAgent;if(ni){Jr=ni;break t}}Jr=""}function ri(t,e,n){for(var r in t)e.call(n,t[r],r,t)}function ii(t){var e,n={};for(e in t)n[e]=t[e];return n}var oi="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ai(t,e){for(var n,r,i=1;i<arguments.length;i++){for(n in r=arguments[i])t[n]=r[n];for(var o=0;o<oi.length;o++)n=oi[o],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function si(t){return si[" "](t),t}si[" "]=_r;var ui,ci,hi=Zr(Jr,"Opera"),li=Zr(Jr,"Trident")||Zr(Jr,"MSIE"),fi=Zr(Jr,"Edge"),pi=fi||li,di=Zr(Jr,"Gecko")&&!(Zr(Jr.toLowerCase(),"webkit")&&!Zr(Jr,"Edge"))&&!(Zr(Jr,"Trident")||Zr(Jr,"MSIE"))&&!Zr(Jr,"Edge"),yi=Zr(Jr.toLowerCase(),"webkit")&&!Zr(Jr,"Edge");function mi(){var t=Nr.document;return t?t.documentMode:void 0}t:{var gi="",vi=(ci=Jr,di?/rv:([^\);]+)(\)|;)/.exec(ci):fi?/Edge\/([\d\.]+)/.exec(ci):li?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(ci):yi?/WebKit\/(\S+)/.exec(ci):hi?/(?:Version)[ \/]?(\S+)/.exec(ci):void 0);if(vi&&(gi=vi?vi[1]:""),li){var bi=mi();if(null!=bi&&bi>parseFloat(gi)){ui=String(bi);break t}}ui=gi}var wi,Si={};function Ei(t){return function(t,e){var n=Si;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:n[t]=e(t)}(t,function(){for(var e=0,n=$r(String(ui)).split("."),r=$r(String(t)).split("."),i=Math.max(n.length,r.length),o=0;0==e&&o<i;o++){var a=n[o]||"",s=r[o]||"";do{if(a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==a[0].length&&0==s[0].length)break;e=ti(0==a[1].length?0:parseInt(a[1],10),0==s[1].length?0:parseInt(s[1],10))||ti(0==a[2].length,0==s[2].length)||ti(a[2],s[2]),a=a[3],s=s[3]}while(0==e)}return 0<=e})}var Ti=Nr.document;wi=Ti&&li?mi()||("CSS1Compat"==Ti.compatMode?parseInt(ui,10):5):void 0;var Ii=!li||9<=Number(wi),Ci=li&&!Ei("9"),Di=function(){if(!Nr.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{Nr.addEventListener("test",_r,e),Nr.removeEventListener("test",_r,e)}catch(t){}return t}();function Ai(t,e){this.type=t,this.a=this.target=e,this.Ja=!0}function Ni(t,e){if(Ai.call(this,t?t.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.a=e,e=t.relatedTarget){if(di){t:{try{si(e.nodeName);var i=!0;break t}catch(t){}i=!1}i||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType=kr(t.pointerType)?t.pointerType:ki[t.pointerType]||"",this.c=t,t.defaultPrevented&&this.b()}}Ai.prototype.b=function(){this.Ja=!1},Kr(Ni,Ai);var ki={2:"touch",3:"pen",4:"mouse"};Ni.prototype.b=function(){Ni.N.b.call(this);var t=this.c;if(t.preventDefault)t.preventDefault();else if(t.returnValue=!1,Ci)try{(t.ctrlKey||112<=t.keyCode&&123>=t.keyCode)&&(t.keyCode=-1)}catch(t){}};var Ri="closure_listenable_"+(1e6*Math.random()|0),Oi=0;function _i(t,e,n,r,i){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.da=i,this.key=++Oi,this.X=this.Z=!1}function Mi(t){t.X=!0,t.listener=null,t.proxy=null,t.src=null,t.da=null}function Pi(t){this.src=t,this.a={},this.b=0}function Li(t,e){var n=e.type;if(n in t.a){var r,i=t.a[n],o=Wr(i,e);(r=0<=o)&&Array.prototype.splice.call(i,o,1),r&&(Mi(e),0==t.a[n].length&&(delete t.a[n],t.b--))}}function xi(t,e,n,r){for(var i=0;i<t.length;++i){var o=t[i];if(!o.X&&o.listener==e&&o.capture==!!n&&o.da==r)return i}return-1}Pi.prototype.add=function(t,e,n,r,i){var o=t.toString();(t=this.a[o])||(t=this.a[o]=[],this.b++);var a=xi(t,e,r,i);return-1<a?(e=t[a],n||(e.Z=!1)):((e=new _i(e,this.src,o,!!r,i)).Z=n,t.push(e)),e};var qi="closure_lm_"+(1e6*Math.random()|0),Fi={};function Bi(t,e,n,r,i){if(r&&r.once)return function t(e,n,r,i,o){if(Pr(n)){for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);return null}r=zi(r);return e&&e[Ri]?e.Ba(n,r,xr(i)?!!i.capture:!!i,o):Vi(e,n,r,!0,i,o)}(t,e,n,r,i);if(Pr(e)){for(var o=0;o<e.length;o++)Bi(t,e[o],n,r,i);return null}return n=zi(n),t&&t[Ri]?t.Aa(e,n,xr(r)?!!r.capture:!!r,i):Vi(t,e,n,!1,r,i)}function Vi(t,e,n,r,i,o){if(!e)throw Error("Invalid event type");var a=xr(i)?!!i.capture:!!i;if(a&&!Ii)return null;var s=Gi(t);if(s||(t[qi]=s=new Pi(t)),(n=s.add(e,n,r,a,o)).proxy)return n;if(r=function(){var t=Ki,e=Ii?function(n){return t.call(e.src,e.listener,n)}:function(n){if(!(n=t.call(e.src,e.listener,n)))return n};return e}(),n.proxy=r,r.src=t,r.listener=n,t.addEventListener)Di||(i=a),void 0===i&&(i=!1),t.addEventListener(e.toString(),r,i);else if(t.attachEvent)t.attachEvent(ji(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function Ui(t){if(!Rr(t)&&t&&!t.X){var e=t.src;if(e&&e[Ri])Li(e.c,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(ji(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=Gi(e))?(Li(n,t),0==n.b&&(n.src=null,e[qi]=null)):Mi(t)}}}function ji(t){return t in Fi?Fi[t]:Fi[t]="on"+t}function Qi(t,e){var n=t.listener,r=t.da||t.src;return t.Z&&Ui(t),n.call(r,e)}function Ki(t,e){return!!t.X||(Ii?Qi(t,new Ni(e,this)):Qi(t,e=new Ni(e||Or("window.event"),this)))}function Gi(t){return(t=t[qi])instanceof Pi?t:null}var Wi="__closure_events_fn_"+(1e9*Math.random()>>>0);function zi(t){return"function"==Mr(t)?t:(t[Wi]||(t[Wi]=function(e){return t.handleEvent(e)}),t[Wi])}function Hi(){Gr.call(this),this.c=new Pi(this),this.J=this,this.B=null}function Yi(t,e,n,r){if(!(e=t.c.a[String(e)]))return!0;e=e.concat();for(var i=!0,o=0;o<e.length;++o){var a=e[o];if(a&&!a.X&&a.capture==n){var s=a.listener,u=a.da||a.src;a.Z&&Li(t.c,a),i=!1!==s.call(u,r)&&i}}return i&&0!=r.Ja}Kr(Hi,Gr),Hi.prototype[Ri]=!0,(Er=Hi.prototype).addEventListener=function(t,e,n,r){Bi(this,t,e,n,r)},Er.removeEventListener=function(t,e,n,r){!function t(e,n,r,i,o){if(Pr(n))for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);else i=xr(i)?!!i.capture:!!i,r=zi(r),e&&e[Ri]?(e=e.c,(n=String(n).toString())in e.a&&-1<(r=xi(a=e.a[n],r,i,o))&&(Mi(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete e.a[n],e.b--))):e&&(e=Gi(e))&&(n=e.a[n.toString()],e=-1,n&&(e=xi(n,r,i,o)),(r=-1<e?n[e]:null)&&Ui(r))}(this,t,e,n,r)},Er.dispatchEvent=function(t){var e,n=this.B;if(n)for(e=[];n;n=n.B)e.push(n);n=this.J;var r=t.type||t;if(kr(t))t=new Ai(t,n);else if(t instanceof Ai)t.target=t.target||n;else{var i=t;ai(t=new Ai(r,n),i)}if(i=!0,e)for(var o=e.length-1;0<=o;o--){var a=t.a=e[o];i=Yi(a,r,!0,t)&&i}if(i=Yi(a=t.a=n,r,!0,t)&&i,i=Yi(a,r,!1,t)&&i,e)for(o=0;o<e.length;o++)i=Yi(a=t.a=e[o],r,!1,t)&&i;return i},Er.G=function(){if(Hi.N.G.call(this),this.c){var t,e=this.c;for(t in e.a){for(var n=e.a[t],r=0;r<n.length;r++)Mi(n[r]);delete e.a[t],e.b--}}this.B=null},Er.Aa=function(t,e,n,r){return this.c.add(String(t),e,!1,n,r)},Er.Ba=function(t,e,n,r){return this.c.add(String(t),e,!0,n,r)};var Xi=Nr.JSON.stringify;function Ji(t,e){this.c=t,this.f=e,this.b=0,this.a=null}function $i(){this.b=this.a=null}Ji.prototype.get=function(){if(0<this.b){this.b--;var t=this.a;this.a=t.next,t.next=null}else t=this.c();return t};var Zi,to=new Ji(function(){return new no},function(t){t.reset()});function eo(){var t=ao,e=null;return t.a&&(e=t.a,t.a=t.a.next,t.a||(t.b=null),e.next=null),e}function no(){this.next=this.b=this.a=null}function ro(t){Nr.setTimeout(function(){throw t},0)}function io(t,e){Zi||function(){var t=Nr.Promise.resolve(void 0);Zi=function(){t.then(so)}}(),oo||(Zi(),oo=!0),ao.add(t,e)}$i.prototype.add=function(t,e){var n=to.get();n.set(t,e),this.b?this.b.next=n:this.a=n,this.b=n},no.prototype.set=function(t,e){this.a=t,this.b=e,this.next=null},no.prototype.reset=function(){this.next=this.b=this.a=null};var oo=!1,ao=new $i;function so(){for(var t;t=eo();){try{t.a.call(t.b)}catch(t){ro(t)}var e=to;e.f(t),100>e.b&&(e.b++,t.next=e.a,e.a=t)}oo=!1}function uo(t,e){Hi.call(this),this.b=t||1,this.a=e||Nr,this.f=Ur(this.gb,this),this.g=Qr()}function co(t){t.ba=!1,t.L&&(t.a.clearTimeout(t.L),t.L=null)}function ho(t,e,n){if("function"==Mr(t))n&&(t=Ur(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=Ur(t.handleEvent,t)}return 2147483647<Number(e)?-1:Nr.setTimeout(t,e||0)}function lo(t,e,n){Gr.call(this),this.f=null!=n?Ur(t,n):t,this.c=e,this.b=Ur(this.ab,this),this.a=[]}function fo(t){t.U=ho(t.b,t.c),t.f.apply(null,t.a)}function po(t){Gr.call(this),this.b=t,this.a={}}Kr(uo,Hi),(Er=uo.prototype).ba=!1,Er.L=null,Er.gb=function(){if(this.ba){var t=Qr()-this.g;0<t&&t<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-t):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(co(this),this.start()))}},Er.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=Qr())},Er.G=function(){uo.N.G.call(this),co(this),delete this.a},Kr(lo,Gr),(Er=lo.prototype).ea=!1,Er.U=null,Er.Ua=function(t){this.a=arguments,this.U?this.ea=!0:fo(this)},Er.G=function(){lo.N.G.call(this),this.U&&(Nr.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},Er.ab=function(){this.U=null,this.ea&&(this.ea=!1,fo(this))},Kr(po,Gr);var yo=[];function mo(t,e,n,r){Pr(n)||(n&&(yo[0]=n.toString()),n=yo);for(var i=0;i<n.length;i++){var o=Bi(e,n[i],r||t.handleEvent,!1,t.b||t);if(!o)break;t.a[o.key]=o}}function go(t){ri(t.a,function(t,e){this.a.hasOwnProperty(e)&&Ui(t)},t),t.a={}}function vo(){}po.prototype.G=function(){po.N.G.call(this),go(this)},po.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var bo=new Hi;function wo(t){Ai.call(this,"serverreachability",t)}function So(t){bo.dispatchEvent(new wo(bo,t))}function Eo(t){Ai.call(this,"statevent",t)}function To(t){bo.dispatchEvent(new Eo(bo,t))}function Io(t){Ai.call(this,"timingevent",t)}function Co(t,e){if("function"!=Mr(t))throw Error("Fn must not be null and must be a function");return Nr.setTimeout(function(){t()},e)}Kr(wo,Ai),Kr(Eo,Ai),Kr(Io,Ai);var Do={NO_ERROR:0,hb:1,ob:2,nb:3,kb:4,mb:5,pb:6,Ma:7,TIMEOUT:8,sb:9},Ao={jb:"complete",wb:"success",Na:"error",Ma:"abort",ub:"ready",vb:"readystatechange",TIMEOUT:"timeout",qb:"incrementaldata",tb:"progress",lb:"downloadprogress",xb:"uploadprogress"};function No(){}function ko(t){var e;return(e=t.a)||(e=t.a={}),e}function Ro(){}No.prototype.a=null;var Oo,_o={OPEN:"a",ib:"b",Na:"c",rb:"d"};function Mo(){Ai.call(this,"d")}function Po(){Ai.call(this,"c")}function Lo(){}function xo(t,e,n){this.g=t,this.W=e,this.V=n||1,this.I=new po(this),this.O=qo,t=pi?125:void 0,this.P=new uo(t),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}Kr(Mo,Ai),Kr(Po,Ai),Kr(Lo,No),Oo=new Lo;var qo=45e3,Fo={},Bo={};function Vo(t,e,n){t.F=1,t.f=la(ia(e)),t.l=n,t.H=!0,jo(t,null)}function Uo(t,e,n,r){t.F=1,t.f=la(ia(e)),t.l=null,t.H=n,jo(t,r)}function jo(t,e){t.v=Qr(),Go(t),t.D=ia(t.f),ha(t.D,"t",t.V),t.A=0,t.a=t.g.$(t.g.Y()?e:null),0<t.J&&(t.B=new lo(Ur(t.Ka,t,t.a),t.J)),mo(t.I,t.a,"readystatechange",t.eb),e=t.h?ii(t.h):{},t.l?(t.w||(t.w="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.a.ca(t.D,t.w,t.l,e)):(t.w="GET",t.a.ca(t.D,t.w,null,e)),So(1)}function Qo(t,e,n){for(var r=!0;!t.m&&t.A<n.length;){var i=Ko(t,n);if(i==Bo){4==e&&(t.c=4,To(14),r=!1);break}if(i==Fo){t.c=4,To(15),r=!1;break}Xo(t,i)}4==e&&0==n.length&&(t.c=1,To(16),r=!1),t.b=t.b&&r,r||(Yo(t),Ho(t))}function Ko(t,e){var n=t.A,r=e.indexOf("\n",n);return-1==r?Bo:(n=Number(e.substring(n,r)),isNaN(n)?Fo:(r+=1)+n>e.length?Bo:(e=e.substr(r,n),t.A=r+n,e))}function Go(t){t.R=Qr()+t.O,Wo(t,t.O)}function Wo(t,e){if(null!=t.i)throw Error("WatchDog timer not null");t.i=Co(Ur(t.bb,t),e)}function zo(t){t.i&&(Nr.clearTimeout(t.i),t.i=null)}function Ho(t){t.g.Da()||t.m||t.g.na(t)}function Yo(t){zo(t);var e=t.B;e&&"function"==typeof e.la&&e.la(),t.B=null,co(t.P),go(t.I),t.a&&(e=t.a,t.a=null,e.abort(),e.la())}function Xo(t,e){try{t.g.Ga(t,e),So(4)}catch(t){}}function Jo(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(Lr(t)||kr(t))zr(t,e,void 0);else{if(t.K&&"function"==typeof t.K)var n=t.K();else if(t.C&&"function"==typeof t.C)n=void 0;else if(Lr(t)||kr(t)){n=[];for(var r=t.length,i=0;i<r;i++)n.push(i)}else for(i in n=[],r=0,t)n[r++]=i;i=(r=function(t){if(t.C&&"function"==typeof t.C)return t.C();if(kr(t))return t.split("");if(Lr(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length;for(var o=0;o<i;o++)e.call(void 0,r[o],n&&n[o],t)}}function $o(t,e){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof $o)for(n=t.K(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function Zo(t,e){ea(t.b,e)&&(delete t.b[e],t.c--,t.a.length>2*t.c&&ta(t))}function ta(t){if(t.c!=t.a.length){for(var e=0,n=0;e<t.a.length;){var r=t.a[e];ea(t.b,r)&&(t.a[n++]=r),e++}t.a.length=n}if(t.c!=t.a.length){var i={};for(n=e=0;e<t.a.length;)ea(i,r=t.a[e])||(t.a[n++]=r,i[r]=1),e++;t.a.length=n}}function ea(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(Er=xo.prototype).setTimeout=function(t){this.O=t},Er.eb=function(t){t=t.target;var e=this.B;e&&3==rs(t)?e.Ua():this.Ka(t)},Er.Ka=function(t){try{if(t==this.a)t:{var e=rs(this.a),n=this.a.ya(),r=this.a.T();if(!(3>e||3==e&&!pi&&!this.a.aa())){this.m||4!=e||7==n||So(8==n||0>=r?3:2),zo(this);var i=this.a.T();this.o=i;var o=this.a.aa();if(this.b=200==i){if(this.S&&!this.s){e:{if(this.a){var a=is(this.a,"X-HTTP-Initial-Response");if(a&&!Xr(a)){var s=a;break e}}s=null}if(!s){this.b=!1,this.c=3,To(12),Yo(this),Ho(this);break t}this.s=!0,Xo(this,s)}this.H?(Qo(this,e,o),pi&&this.b&&3==e&&(mo(this.I,this.P,"tick",this.cb),this.P.start())):Xo(this,o),4==e&&Yo(this),this.b&&!this.m&&(4==e?this.g.na(this):(this.b=!1,Go(this)))}else 400==i&&0<o.indexOf("Unknown SID")?(this.c=3,To(12)):(this.c=0,To(13)),Yo(this),Ho(this)}}}catch(t){}},Er.cb=function(){if(this.a){var t=rs(this.a),e=this.a.aa();this.A<e.length&&(zo(this),Qo(this,t,e),this.b&&4!=t&&Go(this))}},Er.cancel=function(){this.m=!0,Yo(this)},Er.bb=function(){this.i=null;var t=Qr();0<=t-this.R?(2!=this.F&&(So(3),To(17)),Yo(this),this.c=2,Ho(this)):Wo(this,this.R-t)},(Er=$o.prototype).C=function(){ta(this);for(var t=[],e=0;e<this.a.length;e++)t.push(this.b[this.a[e]]);return t},Er.K=function(){return ta(this),this.a.concat()},Er.get=function(t,e){return ea(this.b,t)?this.b[t]:e},Er.set=function(t,e){ea(this.b,t)||(this.c++,this.a.push(t)),this.b[t]=e},Er.forEach=function(t,e){for(var n=this.K(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);t.call(e,o,i,this)}};var na=/^(?:([^:\/?#.]+):)?(?:\/\/(?:([^\/?#]*)@)?([^\/#?]*?)(?::([0-9]+))?(?=[\/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function ra(t,e){var n;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,t instanceof ra?(this.h=void 0!==e?e:t.h,oa(this,t.f),this.j=t.j,aa(this,t.b),sa(this,t.i),this.a=t.a,ua(this,Ca(t.c)),this.g=t.g):t&&(n=String(t).match(na))?(this.h=!!e,oa(this,n[1]||"",!0),this.j=fa(n[2]||""),aa(this,n[3]||"",!0),sa(this,n[4]),this.a=fa(n[5]||"",!0),ua(this,n[6]||"",!0),this.g=fa(n[7]||"")):(this.h=!!e,this.c=new wa(null,this.h))}function ia(t){return new ra(t)}function oa(t,e,n){t.f=n?fa(e,!0):e,t.f&&(t.f=t.f.replace(/:$/,""))}function aa(t,e,n){t.b=n?fa(e,!0):e}function sa(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.i=e}else t.i=null}function ua(t,e,n){e instanceof wa?(t.c=e,function(t,e){e&&!t.f&&(Sa(t),t.c=null,t.a.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(Ea(this,e),Ia(this,n,t))},t)),t.f=e}(t.c,t.h)):(n||(e=pa(e,va)),t.c=new wa(e,t.h))}function ca(t,e,n){t.c.set(e,n)}function ha(t,e,n){Pr(n)||(n=[String(n)]),Ia(t.c,e,n)}function la(t){return ca(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Qr()).toString(36)),t}function fa(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function pa(t,e,n){return kr(t)?(t=encodeURI(t).replace(e,da),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function da(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}ra.prototype.toString=function(){var t=[],e=this.f;e&&t.push(pa(e,ya,!0),":");var n=this.b;return(n||"file"==e)&&(t.push("//"),(e=this.j)&&t.push(pa(e,ya,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.i)&&t.push(":",String(n))),(n=this.a)&&(this.b&&"/"!=n.charAt(0)&&t.push("/"),t.push(pa(n,"/"==n.charAt(0)?ga:ma,!0))),(n=this.c.toString())&&t.push("?",n),(n=this.g)&&t.push("#",pa(n,ba)),t.join("")},ra.prototype.resolve=function(t){var e=ia(this),n=!!t.f;n?oa(e,t.f):n=!!t.j,n?e.j=t.j:n=!!t.b,n?aa(e,t.b):n=null!=t.i;var r=t.a;if(n)sa(e,t.i);else if(n=!!t.a){if("/"!=r.charAt(0))if(this.b&&!this.a)r="/"+r;else{var i=e.a.lastIndexOf("/");-1!=i&&(r=e.a.substr(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(Zr(i,"./")||Zr(i,"/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");for(var o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i}return n?e.a=r:n=""!==t.c.toString(),n?ua(e,Ca(t.c)):n=!!t.g,n&&(e.g=t.g),e};var ya=/[#\/\?@]/g,ma=/[#\?:]/g,ga=/[#\?]/g,va=/[#\?@]/g,ba=/#/g;function wa(t,e){this.b=this.a=null,this.c=t||null,this.f=!!e}function Sa(t){t.a||(t.a=new $o,t.b=0,t.c&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),i=null;if(0<=r){var o=t[n].substring(0,r);i=t[n].substring(r+1)}else o=t[n];e(o,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(t.c,function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)}))}function Ea(t,e){Sa(t),e=Da(t,e),ea(t.a.b,e)&&(t.c=null,t.b-=t.a.get(e).length,Zo(t.a,e))}function Ta(t,e){return Sa(t),e=Da(t,e),ea(t.a.b,e)}function Ia(t,e,n){Ea(t,e),0<n.length&&(t.c=null,t.a.set(Da(t,e),Yr(n)),t.b+=n.length)}function Ca(t){var e=new wa;return e.c=t.c,t.a&&(e.a=new $o(t.a),e.b=t.b),e}function Da(t,e){return e=String(e),t.f&&(e=e.toLowerCase()),e}function Aa(t){this.a=t,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function Na(t){var e=t.a.F.a;if(null!=e)To(4),e?(To(10),ms(t.a,t,!1)):(To(11),ms(t.a,t,!0));else{t.b=new xo(t,void 0,void 0),t.b.h=t.h,e=Ss(e=t.a,e.Y()?t.f:null,t.i),To(4),ha(e,"TYPE","xmlhttp");var n=t.a.j,r=t.a.I;n&&r&&ca(e,n,r),Uo(t.b,e,!1,t.f)}}function ka(){this.a=this.b=null}function Ra(){this.a=new $o}function Oa(t){var e=typeof t;return"object"==e&&t||"function"==e?"o"+(t[qr]||(t[qr]=++Fr)):e.charAt(0)+t}function _a(t,e){this.b=t,this.a=e}function Ma(t){this.g=t||Pa,Nr.PerformanceNavigationTiming?t=0<(t=Nr.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):t=!!(Nr.ka&&Nr.ka.Ea&&Nr.ka.Ea()&&Nr.ka.Ea().zb),this.f=t?this.g:1,this.a=null,1<this.f&&(this.a=new Ra),this.b=null,this.c=[]}(Er=wa.prototype).add=function(t,e){Sa(this),this.c=null,t=Da(this,t);var n=this.a.get(t);return n||this.a.set(t,n=[]),n.push(e),this.b+=1,this},Er.forEach=function(t,e){Sa(this),this.a.forEach(function(n,r){zr(n,function(n){t.call(e,n,r,this)},this)},this)},Er.K=function(){Sa(this);for(var t=this.a.C(),e=this.a.K(),n=[],r=0;r<e.length;r++)for(var i=t[r],o=0;o<i.length;o++)n.push(e[r]);return n},Er.C=function(t){Sa(this);var e=[];if(kr(t))Ta(this,t)&&(e=Hr(e,this.a.get(Da(this,t))));else{t=this.a.C();for(var n=0;n<t.length;n++)e=Hr(e,t[n])}return e},Er.set=function(t,e){return Sa(this),this.c=null,Ta(this,t=Da(this,t))&&(this.b-=this.a.get(t).length),this.a.set(t,[e]),this.b+=1,this},Er.get=function(t,e){return t&&0<(t=this.C(t)).length?String(t[0]):e},Er.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var t=[],e=this.a.K(),n=0;n<e.length;n++){var r=e[n],i=encodeURIComponent(String(r));r=this.C(r);for(var o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),t.push(a)}}return this.c=t.join("&")},Kr(function(){},function(){}),(Er=Aa.prototype).M=null,Er.$=function(t){return this.a.$(t)},Er.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},Er.Da=function(){return!1},Er.Ga=function(t,e){if(this.c=t.o,0==this.M){if(!this.a.o&&(t=t.a)){var n=is(t,"X-Client-Wire-Protocol");this.l=n||null,this.a.j&&(t=is(t,"X-HTTP-Session-Id"))&&(this.a.I=t)}if(e){try{var r=this.a.ja.a.parse(e)}catch(t){return(e=this.a).m=this.c,void bs(e,2)}this.f=r[0]}else(e=this.a).m=this.c,bs(e,2)}else 1==this.M&&(this.g?To(6):"11111"==e?(To(5),this.g=!0,(!li||10<=Number(wi))&&(this.c=200,this.b.cancel(),To(11),ms(this.a,this,!0))):(To(7),this.g=!1))},Er.na=function(){if(this.c=this.b.o,this.b.b)0==this.M?(this.M=1,Na(this)):1==this.M&&(this.g?(To(11),ms(this.a,this,!0)):(To(10),ms(this.a,this,!1)));else{0==this.M?To(8):1==this.M&&To(9);var t=this.a;t.m=this.c,bs(t,2)}},Er.Y=function(){return this.a.Y()},Er.ma=function(){return this.a.ma()},Ra.prototype.add=function(t){this.a.set(Oa(t),t)},Ra.prototype.C=function(){return this.a.C()};var Pa=10;function La(t,e){!t.a&&(Zr(e,"spdy")||Zr(e,"quic")||Zr(e,"h2"))&&(t.f=t.g,t.a=new Ra,t.b&&(Ba(t,t.b),t.b=null))}function xa(t){return!!t.b||!!t.a&&t.a.a.c>=t.f}function qa(t){return t.b?1:t.a?t.a.a.c:0}function Fa(t,e){return t.b?t=t.b==e:t.a?(e=Oa(e),t=ea(t.a.a.b,e)):t=!1,t}function Ba(t,e){t.a?t.a.add(e):t.b=e}function Va(t,e){var n;t.b&&t.b==e?t.b=null:((n=t.a)&&(n=Oa(e),n=ea(t.a.a.b,n)),n&&Zo(t.a.a,Oa(e)))}function Ua(t){if(null!=t.b)return t.c.concat(t.b.j);if(null!=t.a&&0!=t.a.a.c){var e=t.c;return zr(t.a.C(),function(t){e=e.concat(t.j)}),e}return Yr(t.c)}function ja(){}function Qa(){this.a=new ja}function Ka(t,e,n){var r=n||"";try{Jo(t,function(t,n){var i=t;xr(t)&&(i=Xi(t)),e.push(r+n+"="+encodeURIComponent(i))})}catch(t){throw e.push(r+"type="+encodeURIComponent("_badmap")),t}}function Ga(t,e,n,r,i){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,i(r)}catch(t){}}Ma.prototype.cancel=function(){var t;this.c=Ua(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(zr(this.a.C(),function(t){t.cancel()}),(t=this.a.a).b={},t.a.length=0,t.c=0)},ja.prototype.stringify=function(t){return Nr.JSON.stringify(t,void 0)},ja.prototype.parse=function(t){return Nr.JSON.parse(t,void 0)};var Wa=Nr.JSON.parse;function za(t){Hi.call(this),this.headers=new $o,this.H=t||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=Ha,this.D=this.F=!1}Kr(za,Hi);var Ha="",Ya=/^https?$/i,Xa=["POST","PUT"];function Ja(t){return"content-type"==t.toLowerCase()}function $a(t,e){t.b=!1,t.a&&(t.g=!0,t.a.abort(),t.g=!1),t.f=e,t.h=5,Za(t),es(t)}function Za(t){t.v||(t.v=!0,t.dispatchEvent("complete"),t.dispatchEvent("error"))}function ts(t){if(t.b&&void 0!==Ar&&(!t.s[1]||4!=rs(t)||2!=t.T()))if(t.l&&4==rs(t))ho(t.Fa,0,t);else if(t.dispatchEvent("readystatechange"),4==rs(t)){t.b=!1;try{var e,n=t.T();t:switch(n){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var r=!0;break t;default:r=!1}if(!(e=r)){var i;if(i=0===n){var o=String(t.A).match(na)[1]||null;if(!o&&Nr.self&&Nr.self.location){var a=Nr.self.location.protocol;o=a.substr(0,a.length-1)}i=!Ya.test(o?o.toLowerCase():"")}e=i}e?(t.dispatchEvent("complete"),t.dispatchEvent("success")):(t.h=6,t.f=t.za()+" ["+t.T()+"]",Za(t))}finally{es(t)}}}function es(t,e){if(t.a){ns(t);var n=t.a,r=t.s[0]?_r:null;t.a=null,t.s=null,e||t.dispatchEvent("ready");try{n.onreadystatechange=r}catch(t){}}}function ns(t){t.a&&t.D&&(t.a.ontimeout=null),t.m&&(Nr.clearTimeout(t.m),t.m=null)}function rs(t){return t.a?t.a.readyState:0}function is(t,e){return t.a?t.a.getResponseHeader(e):null}function os(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}if(r)return t;if(n=function(t){var e="";return ri(t,function(t,n){e+=n,e+=":",e+=t,e+="\r\n"}),e}(n),kr(t)){if(e=encodeURIComponent(String(e)),e+=n=null!=n?"="+encodeURIComponent(String(n)):""){if(0>(n=t.indexOf("#"))&&(n=t.length),0>(r=t.indexOf("?"))||r>n){r=n;var i=""}else i=t.substring(r+1,n);n=(t=[t.substr(0,r),i,t.substr(n)])[1],t[1]=e?n?n+"&"+e:e:n,t=t[0]+(t[1]?"?"+t[1]:"")+t[2]}return t}return ca(t,e,n),t}function as(t){this.f=[],this.F=new ka,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Ra=this.P=0,this.Pa=!!Or("internalChannelParams.failFast",t),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Oa=Or("internalChannelParams.baseRetryDelayMs",t)||5e3,this.Sa=Or("internalChannelParams.retryDelaySeedMs",t)||1e4,this.Qa=Or("internalChannelParams.forwardChannelMaxRetries",t)||2,this.qa=Or("internalChannelParams.forwardChannelRequestTimeoutMs",t)||2e4,this.La=t&&t.Ab||void 0,this.D=void 0,this.R=t&&t.supportsCrossDomainXhr||!1,this.H="",this.b=new Ma(t&&t.concurrentRequestLimit),this.ja=new Qa,this.o=!t||void 0===t.backgroundChannelTest||t.backgroundChannelTest,(this.W=t&&t.fastHandshake||!1)&&!this.o&&(this.o=!0),t&&t.forceLongPolling&&(this.oa=!1),this.fa=void 0}function ss(t){if(us(t),3==t.u){var e=t.P++,n=ia(t.B);ca(n,"SID",t.H),ca(n,"RID",e),ca(n,"TYPE","terminate"),fs(t,n),(e=new xo(t,e,void 0)).F=2,e.f=la(ia(n)),n=!1,Nr.navigator&&Nr.navigator.sendBeacon&&(n=Nr.navigator.sendBeacon(e.f.toString(),"")),!n&&Nr.Image&&((new Image).src=e.f,n=!0),n||(e.a=e.g.$(null),e.a.ca(e.f)),e.v=Qr(),Go(e)}ws(t)}function us(t){t.w&&(t.w.abort(),t.w=null),t.a&&(t.a.cancel(),t.a=null),t.l&&(Nr.clearTimeout(t.l),t.l=null),gs(t),t.b.cancel(),t.h&&(Rr(t.h)&&Nr.clearTimeout(t.h),t.h=null)}function cs(t,e){t.f.push(new _a(t.Ra++,e)),3==t.u&&hs(t)}function hs(t){xa(t.b)||t.h||(t.h=!0,io(t.Ia,t),t.A=0)}function ls(t,e){var n;n=e?e.W:t.P++;var r=ia(t.B);ca(r,"SID",t.H),ca(r,"RID",n),ca(r,"AID",t.O),fs(t,r),t.g&&t.i&&os(r,t.g,t.i),n=new xo(t,n,t.A+1),null===t.g&&(n.h=t.i),e&&(t.f=e.j.concat(t.f)),e=ps(t,n,1e3),n.setTimeout(Math.round(.5*t.qa)+Math.round(.5*t.qa*Math.random())),Ba(t.b,n),Vo(n,r,e)}function fs(t,e){t.c&&Jo({},function(t,n){ca(e,n,t)})}function ps(t,e,n){n=Math.min(t.f.length,n);var r=t.c?Ur(t.c.Ta,t.c,t):null;t:for(var i=t.f,o=-1;;){var a=["count="+n];-1==o?0<n?(o=i[0].b,a.push("ofs="+o)):o=0:a.push("ofs="+o);for(var s=!0,u=0;u<n;u++){var c=i[u].b,h=i[u].a;if(0>(c-=o))o=Math.max(0,i[u].b-100),s=!1;else try{Ka(h,a,"req"+c+"_")}catch(t){r&&r(h)}}if(s){r=a.join("&");break t}}return t=t.f.splice(0,n),e.j=t,r}function ds(t){t.a||t.l||(t.S=1,io(t.Ha,t),t.v=0)}function ys(t){return!(t.a||t.l||3<=t.v)&&(t.S++,t.l=Co(Ur(t.Ha,t),vs(t,t.v)),t.v++,!0)}function ms(t,e,n){var r=e.l;r&&La(t.b,r),t.ia=t.oa&&n,t.m=e.c,t.B=Ss(t,null,t.ha),hs(t)}function gs(t){null!=t.s&&(Nr.clearTimeout(t.s),t.s=null)}function vs(t,e){var n=t.Oa+Math.floor(Math.random()*t.Sa);return t.ma()||(n*=2),n*e}function bs(t,e){if(2==e){var n=null;t.c&&(n=null);var r=Ur(t.fb,t);n||(n=new ra("//www.google.com/images/cleardot.gif"),Nr.location&&"http"==Nr.location.protocol||oa(n,"https"),la(n)),function(t,e){var n=new vo;if(Nr.Image){var r=new Image;r.onload=jr(Ga,n,r,"TestLoadImage: loaded",!0,e),r.onerror=jr(Ga,n,r,"TestLoadImage: error",!1,e),r.onabort=jr(Ga,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=jr(Ga,n,r,"TestLoadImage: timeout",!1,e),Nr.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}else e(!1)}(n.toString(),r)}else To(2);t.u=0,t.c&&t.c.ta(e),ws(t),us(t)}function ws(t){t.u=0,t.m=-1,t.c&&(0==Ua(t.b).length&&0==t.f.length||(t.b.c.length=0,Yr(t.f),t.f.length=0),t.c.sa())}function Ss(t,e,n){var r=function(t){return t instanceof ra?ia(t):new ra(t,void 0)}(n);if(""!=r.b)e&&aa(r,e+"."+r.b),sa(r,r.i);else{var i,o=Nr.location;i=e?e+"."+o.hostname:o.hostname,r=function(t,e,n,r){var i=new ra(null,void 0);return t&&oa(i,t),e&&aa(i,e),n&&sa(i,n),r&&(i.a=r),i}(o.protocol,i,+o.port,n)}return t.V&&ri(t.V,function(t,e){ca(r,e,t)}),e=t.j,n=t.I,e&&n&&ca(r,e,n),ca(r,"VER",t.wa),fs(t,r),r}function Es(){}function Ts(){if(li&&!(10<=Number(wi)))throw Error("Environmental error: no available transport.")}function Is(t,e){Hi.call(this),this.a=new as(e),this.g=t,this.m=e&&e.testUrl?e.testUrl:function(t){for(var e=arguments[0],n=1;n<arguments.length;n++){var r,i=arguments[n];0==i.lastIndexOf("/",0)?e=i:((r=""==e)||(r=0<=(r=e.length-1)&&e.indexOf("/",r)==r),e+=r?i:"/"+i)}return e}(this.g,"test"),this.b=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.a.i=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.xa&&(t?t["X-WebChannel-Client-Profile"]=e.xa:t={"X-WebChannel-Client-Profile":e.xa}),this.a.J=t,(t=e&&e.httpHeadersOverwriteParam)&&!Xr(t)&&(this.a.g=t),this.l=e&&e.supportsCrossDomainXhr||!1,this.h=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!Xr(e)&&(this.a.j=e,null!==(t=this.b)&&e in t&&(e in(t=this.b)&&delete t[e])),this.f=new As(this)}function Cs(t){Mo.call(this);var e=t.__sm__;if(e){t:{for(var n in e){t=n;break t}t=void 0}(this.c=t)?(t=this.c,this.data=null!==e&&t in e?e[t]:void 0):this.data=e}else this.data=t}function Ds(){Po.call(this),this.status=1}function As(t){this.a=t}(Er=za.prototype).ca=function(t,e,n,r){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+t);e=e?e.toUpperCase():"GET",this.A=t,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=this.H?ko(this.H):ko(Oo),this.a.onreadystatechange=Ur(this.Fa,this);try{this.w=!0,this.a.open(e,String(t),!0),this.w=!1}catch(t){return void $a(this,t)}t=n||"";var i=new $o(this.headers);r&&Jo(r,function(t,e){i.set(e,t)}),r=function(t){t:{for(var e=Ja,n=t.length,r=kr(t)?t.split(""):t,i=0;i<n;i++)if(i in r&&e.call(void 0,r[i],i,t)){e=i;break t}e=-1}return 0>e?null:kr(t)?t.charAt(e):t[e]}(i.K()),n=Nr.FormData&&t instanceof Nr.FormData,!(0<=Wr(Xa,e))||r||n||i.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),i.forEach(function(t,e){this.a.setRequestHeader(e,t)},this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{ns(this),0<this.o&&((this.D=function(t){return li&&Ei(9)&&Rr(t.timeout)&&void 0!==t.ontimeout}(this.a))?(this.a.timeout=this.o,this.a.ontimeout=Ur(this.Ca,this)):this.m=ho(this.Ca,this.o,this)),this.l=!0,this.a.send(t),this.l=!1}catch(t){$a(this,t)}},Er.Ca=function(){void 0!==Ar&&this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},Er.abort=function(t){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=t||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),es(this))},Er.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),es(this,!0)),za.N.G.call(this)},Er.Fa=function(){this.j||(this.w||this.l||this.g?ts(this):this.$a())},Er.$a=function(){ts(this)},Er.T=function(){try{return 2<rs(this)?this.a.status:-1}catch(t){return-1}},Er.za=function(){try{return 2<rs(this)?this.a.statusText:""}catch(t){return""}},Er.aa=function(){try{return this.a?this.a.responseText:""}catch(t){return""}},Er.Va=function(t){if(this.a){var e=this.a.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),Wa(e)}},Er.ya=function(){return this.h},Er.Ya=function(){return kr(this.f)?this.f:String(this.f)},(Er=as.prototype).wa=8,Er.u=1,Er.Da=function(){return 0==this.u},Er.Ia=function(t){if(this.h)if(this.h=null,1==this.u){if(!t){this.P=Math.floor(1e5*Math.random());var e,n=new xo(this,t=this.P++,void 0),r=this.i;if(this.J&&(r?ai(r=ii(r),this.J):r=this.J),null===this.g&&(n.h=r),this.W)t:{for(var i=e=0;i<this.f.length;i++){var o=this.f[i];if(void 0===(o="__data__"in o.a&&kr(o=o.a.__data__)?o.length:void 0))break;if(4096<(e+=o)){e=i;break t}if(4096===e||i===this.f.length-1){e=i+1;break t}}e=1e3}else e=1e3;e=ps(this,n,e),ca(i=ia(this.B),"RID",t),ca(i,"CVER",22),this.o&&this.j&&ca(i,"X-HTTP-Session-Id",this.j),fs(this,i),this.g&&r&&os(i,this.g,r),Ba(this.b,n),this.W?(ca(i,"$req",e),ca(i,"SID","null"),n.S=!0,Vo(n,i,null)):Vo(n,i,e),this.u=2}}else 3==this.u&&(t?ls(this,t):0==this.f.length||xa(this.b)||ls(this))},Er.Ha=function(){this.l=null,this.a=new xo(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var t=ia(this.pa);ca(t,"RID","rpc"),ca(t,"SID",this.H),ca(t,"CI",this.ia?"0":"1"),ca(t,"AID",this.O),fs(this,t),ca(t,"TYPE","xmlhttp"),this.g&&this.i&&os(t,this.g,this.i),this.D&&this.a.setTimeout(this.D),Uo(this.a,t,!0,this.ga)},Er.Ga=function(t,e){if(0!=this.u&&(this.a==t||Fa(this.b,t)))if(this.m=t.o,!t.s&&Fa(this.b,t)&&3==this.u){try{var n=this.ja.a.parse(e)}catch(t){n=null}if(Pr(n)&&3==n.length){if(0==(e=n)[0]){t:if(!this.l){if(this.a){if(!(this.a.v+3e3<t.v))break t;gs(this),this.a.cancel(),this.a=null}ys(this),To(18)}}else this.ra=e[1],0<this.ra-this.O&&37500>e[2]&&this.ia&&0==this.v&&!this.s&&(this.s=Co(Ur(this.Za,this),6e3));if(1>=qa(this.b)&&this.fa){try{this.fa()}catch(t){}this.fa=void 0}}else bs(this,11)}else if((t.s||this.a==t)&&gs(this),!Xr(e))for(e=n=this.ja.a.parse(e),n=0;n<e.length;n++){var r=e[n];if(this.O=r[0],r=r[1],2==this.u)if("c"==r[0]){this.H=r[1],this.ga=r[2];var i=r[3];null!=i&&(this.wa=i),null!=(r=r[5])&&Rr(r)&&0<r&&(this.D=1.5*r),this.o&&(r=t.a)&&((i=is(r,"X-Client-Wire-Protocol"))&&La(this.b,i),this.j&&(r=is(r,"X-HTTP-Session-Id")))&&(this.I=r,ca(this.B,this.j,r)),this.u=3,this.c&&this.c.va(),r=t,this.pa=Ss(this,this.Y()?this.ga:null,this.ha),r.s?(Va(this.b,r),(i=this.D)&&r.setTimeout(i),r.i&&(zo(r),Go(r)),this.a=r):ds(this),0<this.f.length&&hs(this)}else"stop"!=r[0]&&"close"!=r[0]||bs(this,7);else 3==this.u&&("stop"==r[0]||"close"==r[0]?"stop"==r[0]?bs(this,7):ss(this):"noop"!=r[0]&&this.c&&this.c.ua(r),this.v=0)}},Er.Za=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,ys(this),To(19))},Er.na=function(t){var e=null;if(this.a==t){gs(this),this.a=null;var n=2}else{if(!Fa(this.b,t))return;e=t.j,Va(this.b,t),n=1}if(this.m=t.o,0!=this.u)if(t.b)1==n?(e=Qr()-t.v,bo.dispatchEvent(new Io(bo,t.l?t.l.length:0,e,this.A)),hs(this)):ds(this);else{var r=t.c;if(3==r||0==r&&0<this.m||!(1==n&&function(t,e){return!(qa(t.b)>=t.b.f-(t.h?1:0)||(t.h?(t.f=e.j.concat(t.f),0):1==t.u||2==t.u||t.A>=(t.Pa?0:t.Qa)||(t.h=Co(Ur(t.Ia,t,e),vs(t,t.A)),t.A++,0)))}(this,t)||2==n&&ys(this)))switch(e&&0<e.length&&(t=this.b,t.c=t.c.concat(e)),r){case 1:bs(this,5);break;case 4:bs(this,10);break;case 3:bs(this,6);break;default:bs(this,2)}}},Er.fb=function(t){To(t?2:1)},Er.$=function(t){if(t&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new za(this.La)).F=this.R,t},Er.ma=function(){return!!this.c&&!0},Er.Y=function(){return this.R},(Er=Es.prototype).va=function(){},Er.ua=function(){},Er.ta=function(){},Er.sa=function(){},Er.Ta=function(){},Ts.prototype.a=function(t,e){return new Is(t,e)},Kr(Is,Hi),(Er=Is.prototype).addEventListener=function(t,e,n,r){Is.N.addEventListener.call(this,t,e,n,r)},Er.removeEventListener=function(t,e,n,r){Is.N.removeEventListener.call(this,t,e,n,r)},Er.Wa=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var t=this.a,e=this.m,n=this.g,r=this.b||void 0;To(0),t.ha=n,t.V=r||{},t.o&&(t.F.b=[],t.F.a=!1),t.w=new Aa(t),null===t.g&&(t.w.h=t.i),n=e,t.g&&t.i&&(n=os(e,t.g,t.i)),(t=t.w).i=n,e=Ss(t.a,null,t.i),To(3),null!=(n=t.a.F.b)?(t.f=n[0],t.M=1,Na(t)):(ha(e,"MODE","init"),!t.a.o&&t.a.j&&ha(e,"X-HTTP-Session-Id",t.a.j),t.b=new xo(t,void 0,void 0),t.b.h=t.h,Uo(t.b,e,!1,null),t.M=0)},Er.close=function(){ss(this.a)},Er.Xa=function(t){if(kr(t)){var e={};e.__data__=t,cs(this.a,e)}else this.h?((e={}).__data__=Xi(t),cs(this.a,e)):cs(this.a,t)},Er.G=function(){this.a.c=null,delete this.f,ss(this.a),delete this.a,Is.N.G.call(this)},Kr(Cs,Mo),Kr(Ds,Po),Kr(As,Es),As.prototype.va=function(){this.a.dispatchEvent("a")},As.prototype.ua=function(t){this.a.dispatchEvent(new Cs(t))},As.prototype.ta=function(t){this.a.dispatchEvent(new Ds(t))},As.prototype.sa=function(){this.a.dispatchEvent("b")};var Ns=jr(function(t,e){function n(){}n.prototype=t.prototype;var r=new n;return t.apply(r,Array.prototype.slice.call(arguments,1)),r},Ts);Ts.prototype.createWebChannel=Ts.prototype.a,Is.prototype.send=Is.prototype.Xa,Is.prototype.open=Is.prototype.Wa,Is.prototype.close=Is.prototype.close,Do.NO_ERROR=0,Do.TIMEOUT=8,Do.HTTP_ERROR=6,Ao.COMPLETE="complete",Ro.EventType=_o,_o.OPEN="a",_o.CLOSE="b",_o.ERROR="c",_o.MESSAGE="d",Hi.prototype.listen=Hi.prototype.Aa,za.prototype.listenOnce=za.prototype.Ba,za.prototype.getLastError=za.prototype.Ya,za.prototype.getLastErrorCode=za.prototype.ya,za.prototype.getStatus=za.prototype.T,za.prototype.getStatusText=za.prototype.za,za.prototype.getResponseJson=za.prototype.Va,za.prototype.getResponseText=za.prototype.aa,za.prototype.send=za.prototype.ca;var ks,Rs={createWebChannelTransport:Ns,ErrorCode:Do,EventType:Ao,WebChannel:Ro,XhrIo:za},Os=Rs.createWebChannelTransport,_s=Rs.ErrorCode,Ms=Rs.EventType,Ps=Rs.WebChannel,Ls=Rs.XhrIo,xs=Sr.SDK_VERSION,qs=new Cr("@firebase/firestore");function Fs(){return qs.logLevel===wr.DEBUG?ks.DEBUG:qs.logLevel===wr.SILENT?ks.SILENT:ks.ERROR}function Bs(t){switch(t){case ks.DEBUG:qs.logLevel=wr.DEBUG;break;case ks.ERROR:qs.logLevel=wr.ERROR;break;case ks.SILENT:qs.logLevel=wr.SILENT;break;default:qs.error("Firestore ("+xs+"): Invalid value passed to `setLogLevel`")}}function Vs(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(qs.logLevel<=wr.DEBUG){var i=n.map(js);qs.debug.apply(qs,["Firestore ("+xs+") ["+t+"]: "+e].concat(i))}}function Us(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(qs.logLevel<=wr.ERROR){var r=e.map(js);qs.error.apply(qs,["Firestore ("+xs+"): "+t].concat(r))}}function js(t){if("string"==typeof t)return t;var e=Gs.getPlatform();try{return e.formatJSON(t)}catch(e){return t}}function Qs(t){var e="FIRESTORE ("+xs+") INTERNAL ASSERTION FAILED: "+t;throw Us(e),new Error(e)}function Ks(t,e){t||Qs(e)}!function(t){t[t.DEBUG=0]="DEBUG",t[t.ERROR=1]="ERROR",t[t.SILENT=2]="SILENT"}(ks||(ks={}));var Gs=function(){function t(){}return t.setPlatform=function(e){t.platform&&Qs("Platform already defined"),t.platform=e},t.getPlatform=function(){return t.platform||Qs("Platform not set"),t.platform},t}();function Ws(){return Gs.getPlatform().emptyByteString}var zs={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},Hs=function(t){function e(e,n){var r=t.call(this,n)||this;return r.code=e,r.message=n,r.name="FirebaseError",r.toString=function(){return r.name+": [code="+r.code+"]: "+r.message},r}return Jn(e,t),e}(Error);function Ys(t,e){function n(){var t="This constructor is private.";throw e&&(t+=" ",t+=e),new Hs(zs.INVALID_ARGUMENT,t)}for(var r in n.prototype=t.prototype,t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function Xs(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Js(t,e){return void 0!==t?t:e}function $s(t,e){for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=Number(n);isNaN(r)||e(r,t[n])}}function Zs(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function tu(t){for(var e in Ks(null!=t&&"object"==typeof t,"isEmpty() expects object parameter."),t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function eu(t,e){if(0!==e.length)throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() does not support arguments, but was called with "+vu(e.length,"argument")+".")}function nu(t,e,n){if(e.length!==n)throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() requires "+vu(n,"argument")+", but was called with "+vu(e.length,"argument")+".")}function ru(t,e,n){if(e.length<n)throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() requires at least "+vu(n,"argument")+", but was called with "+vu(e.length,"argument")+".")}function iu(t,e,n,r){if(e.length<n||e.length>r)throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() requires between "+n+" and "+r+" arguments, but was called with "+vu(e.length,"argument")+".")}function ou(t,e,n,r){lu(t,e,gu(n)+" argument",r)}function au(t,e,n,r){void 0!==r&&ou(t,e,n,r)}function su(t,e,n,r){lu(t,e,n+" option",r)}function uu(t,e,n,r){void 0!==r&&su(t,e,n,r)}function cu(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){if(!(r instanceof Array))throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" option to be an array, but it was: "+pu(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() requires all "+e+" elements to be "+n+", but the value at index "+o+" was: "+pu(r[o]))}(t,e,n,r,i)}function hu(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){for(var o=[],a=0,s=i;a<s.length;a++){var u=s[a];if(u===r)return;o.push(pu(u))}var c=pu(r);throw new Hs(zs.INVALID_ARGUMENT,"Invalid value "+c+" provided to function "+t+'() for option "'+n+'". Acceptable values: '+o.join(", "))}(t,0,n,r,i)}function lu(t,e,n,r){if(!("object"===e?fu(r):"non-empty string"===e?"string"==typeof r&&""!==r:typeof r===e)){var i=pu(r);throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" to be of type "+e+", but it was: "+i)}}function fu(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function pu(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";var e=function(t){if(t.constructor){var e=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(e&&e.length>1)return e[1]}return null}(t);return e?"a custom "+e+" object":"an object"}return"function"==typeof t?"a function":Qs("Unknown wrong type: "+typeof t)}function du(t,e,n){if(void 0===n)throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+gu(e)+" argument, but it was undefined.")}function yu(t,e,n){Zs(e,function(e,r){if(n.indexOf(e)<0)throw new Hs(zs.INVALID_ARGUMENT,"Unknown option '"+e+"' passed to function "+t+"(). Available options: "+n.join(", "))})}function mu(t,e,n,r){var i=pu(r);return new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() requires its "+gu(n)+" argument to be a "+e+", but it was: "+i)}function gu(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function vu(t,e){return t+" "+e+(1===t?"":"s")}var bu=function(){function t(){}return t.newId=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",n=0;n<20;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return Ks(20===e.length,"Invalid auto ID: "+e),e},t}();function wu(t,e){return t<e?-1:t>e?1:0}function Su(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].isEqual(e[n]))return!1;return!0}function Eu(t){return t+"\0"}function Tu(){if("undefined"==typeof Uint8Array)throw new Hs(zs.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function Iu(){if(!Gs.getPlatform().base64Available)throw new Hs(zs.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var Cu,Du,Au=function(){function t(t){Iu(),this._binaryString=t}return t.fromBase64String=function(e){nu("Blob.fromBase64String",arguments,1),ou("Blob.fromBase64String","string",1,e),Iu();try{return new t(Gs.getPlatform().atob(e))}catch(t){throw new Hs(zs.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},t.fromUint8Array=function(e){if(nu("Blob.fromUint8Array",arguments,1),Tu(),!(e instanceof Uint8Array))throw mu("Blob.fromUint8Array","Uint8Array",1,e);return new t(Array.prototype.map.call(e,function(t){return String.fromCharCode(t)}).join(""))},t.prototype.toBase64=function(){return nu("Blob.toBase64",arguments,0),Iu(),Gs.getPlatform().btoa(this._binaryString)},t.prototype.toUint8Array=function(){nu("Blob.toUint8Array",arguments,0),Tu();for(var t=new Uint8Array(this._binaryString.length),e=0;e<this._binaryString.length;e++)t[e]=this._binaryString.charCodeAt(e);return t},t.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},t.prototype.isEqual=function(t){return this._binaryString===t._binaryString},t.prototype._compareTo=function(t){return wu(this._binaryString,t._binaryString)},t}(),Nu=Ys(Au,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),ku=function(){function t(t,e){if(nu("GeoPoint",arguments,2),ou("GeoPoint","number",1,t),ou("GeoPoint","number",2,e),!isFinite(t)||t<-90||t>90)throw new Hs(zs.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Hs(zs.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}return Object.defineProperty(t.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},t.prototype._compareTo=function(t){return wu(this._lat,t._lat)||wu(this._long,t._long)},t}(),Ru=function(){function t(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Hs(zs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Hs(zs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Hs(zs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Hs(zs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}return t.now=function(){return t.fromMillis(Date.now())},t.fromDate=function(e){return t.fromMillis(e.getTime())},t.fromMillis=function(e){var n=Math.floor(e/1e3);return new t(n,1e6*(e-1e3*n))},t.prototype.toDate=function(){return new Date(this.toMillis())},t.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},t.prototype._compareTo=function(t){return this.seconds===t.seconds?wu(this.nanoseconds,t.nanoseconds):wu(this.seconds,t.seconds)},t.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},t.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},t}(),Ou=function(){return function(t,e,n,r,i){this.databaseId=t,this.persistenceKey=e,this.host=n,this.ssl=r,this.forceLongPolling=i}}(),_u="(default)",Mu=function(){function t(t,e){this.projectId=t,this.database=e||_u}return Object.defineProperty(t.prototype,"isDefaultDatabase",{get:function(){return this.database===_u},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return e instanceof t&&e.projectId===this.projectId&&e.database===this.database},t.prototype.compareTo=function(t){return wu(this.projectId,t.projectId)||wu(this.database,t.database)},t}(),Pu=function(){function t(t,e,n){this.init(t,e,n)}return t.prototype.init=function(t,e,n){void 0===e?e=0:e>t.length&&Qs("offset "+e+" out of range "+t.length),void 0===n?n=t.length-e:n>t.length-e&&Qs("length "+n+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.len=n},t.prototype.construct=function(t,e,n){var r=Object.create(Object.getPrototypeOf(this));return r.init(t,e,n),r},Object.defineProperty(t.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return 0===t.comparator(this,e)},t.prototype.child=function(e){var n=this.segments.slice(this.offset,this.limit());return e instanceof t?e.forEach(function(t){n.push(t)}):"string"==typeof e?n.push(e):Qs("Unknown parameter type for Path.child(): "+e),this.construct(n)},t.prototype.limit=function(){return this.offset+this.length},t.prototype.popFirst=function(t){return t=void 0===t?1:t,Ks(this.length>=t,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+t,this.length-t)},t.prototype.popLast=function(){return Ks(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},t.prototype.firstSegment=function(){return Ks(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},t.prototype.lastSegment=function(){return this.get(this.length-1)},t.prototype.get=function(t){return Ks(t<this.length,"Index out of range"),this.segments[this.offset+t]},t.prototype.isEmpty=function(){return 0===this.length},t.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},t.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},t.comparator=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),o=e.get(r);if(i<o)return-1;if(i>o)return 1}return t.length<e.length?-1:t.length>e.length?1:0},t}(),Lu=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Jn(e,t),e.prototype.canonicalString=function(){return this.toArray().join("/")},e.prototype.toString=function(){return this.canonicalString()},e.fromString=function(t){if(t.indexOf("//")>=0)throw new Hs(zs.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new e(t.split("/").filter(function(t){return t.length>0}))},e.EMPTY_PATH=new e([]),e}(Pu),xu=/^[_a-zA-Z][_a-zA-Z0-9]*$/,qu=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Jn(e,t),e.isValidIdentifier=function(t){return xu.test(t)},e.prototype.canonicalString=function(){return this.toArray().map(function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),e.isValidIdentifier(t)||(t="`"+t+"`"),t}).join(".")},e.prototype.toString=function(){return this.canonicalString()},e.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)},e.keyField=function(){return new e(["__name__"])},e.fromServerFormat=function(t){for(var n=[],r="",i=0,o=function(){if(0===r.length)throw new Hs(zs.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");n.push(r),r=""},a=!1;i<t.length;){var s=t[i];if("\\"===s){if(i+1===t.length)throw new Hs(zs.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var u=t[i+1];if("\\"!==u&&"."!==u&&"`"!==u)throw new Hs(zs.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);r+=u,i+=2}else"`"===s?(a=!a,i++):"."!==s||a?(r+=s,i++):(o(),i++)}if(o(),a)throw new Hs(zs.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new e(n)},e.EMPTY_PATH=new e([]),e}(Pu),Fu=function(){function t(e){this.path=e,Ks(t.isDocumentKey(e),"Invalid DocumentKey with an odd number of segments: "+e.toArray().join("/"))}return t.prototype.hasCollectionId=function(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t},t.prototype.isEqual=function(t){return null!==t&&0===Lu.comparator(this.path,t.path)},t.prototype.toString=function(){return this.path.toString()},t.comparator=function(t,e){return Lu.comparator(t.path,e.path)},t.isDocumentKey=function(t){return t.length%2==0},t.fromSegments=function(e){return new t(new Lu(e.slice()))},t.fromPathString=function(e){return new t(Lu.fromString(e))},t.EMPTY=new t(new Lu([])),t}(),Bu=function(){function t(t,e){this.key=t,this.version=e}return t.compareByKey=function(t,e){return Fu.comparator(t.key,e.key)},t}(),Vu=function(t){function e(e,n,r,i,o){var a=t.call(this,e,n)||this;return a.data=r,a.proto=o,a.hasLocalMutations=!!i.hasLocalMutations,a.hasCommittedMutations=!!i.hasCommittedMutations,a}return Jn(e,t),e.prototype.field=function(t){return this.data.field(t)},e.prototype.fieldValue=function(t){var e=this.field(t);return e?e.value():void 0},e.prototype.value=function(){return this.data.value()},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.data.isEqual(t.data)&&this.hasLocalMutations===t.hasLocalMutations&&this.hasCommittedMutations===t.hasCommittedMutations},e.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),e.compareByField=function(t,e,n){var r=e.field(t),i=n.field(t);return void 0!==r&&void 0!==i?r.compareTo(i):Qs("Trying to compare documents on fields that don't exist")},e}(Bu),Uu=function(t){function e(e,n,r){var i=t.call(this,e,n)||this;return i.hasCommittedMutations=!(!r||!r.hasCommittedMutations),i}return Jn(e,t),e.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},e}(Bu),ju=function(t){function e(e,n){return t.call(this,e,n)||this}return Jn(e,t),e.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},e}(Bu),Qu=function(){function t(t,e){this.comparator=t,this.root=e||Gu.EMPTY}return t.prototype.insert=function(e,n){return new t(this.comparator,this.root.insert(e,n,this.comparator).copy(null,null,Gu.BLACK,null,null))},t.prototype.remove=function(e){return new t(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Gu.BLACK,null,null))},t.prototype.get=function(t){for(var e=this.root;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null},t.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1},t.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(t.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),t.prototype.minKey=function(){return this.root.minKey()},t.prototype.maxKey=function(){return this.root.maxKey()},t.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},t.prototype.forEach=function(t){this.inorderTraversal(function(e,n){return t(e,n),!1})},t.prototype.toString=function(){var t=[];return this.inorderTraversal(function(e,n){return t.push(e+":"+n),!1}),"{"+t.join(", ")+"}"},t.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},t.prototype.getIterator=function(){return new Ku(this.root,null,this.comparator,!1)},t.prototype.getIteratorFrom=function(t){return new Ku(this.root,t,this.comparator,!1)},t.prototype.getReverseIterator=function(){return new Ku(this.root,null,this.comparator,!0)},t.prototype.getReverseIteratorFrom=function(t){return new Ku(this.root,t,this.comparator,!0)},t}(),Ku=function(){function t(t,e,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!t.isEmpty();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}return t.prototype.getNext=function(){Ks(this.nodeStack.length>0,"getNext() called on iterator when hasNext() is false.");var t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},t.prototype.hasNext=function(){return this.nodeStack.length>0},t.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},t}(),Gu=function(){function t(e,n,r,i,o){this.key=e,this.value=n,this.color=null!=r?r:t.RED,this.left=null!=i?i:t.EMPTY,this.right=null!=o?o:t.EMPTY,this.size=this.left.size+1+this.right.size}return t.prototype.copy=function(e,n,r,i,o){return new t(null!=e?e:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=o?o:this.right)},t.prototype.isEmpty=function(){return!1},t.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},t.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},t.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},t.prototype.minKey=function(){return this.min().key},t.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},t.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()},t.prototype.removeMin=function(){if(this.left.isEmpty())return t.EMPTY;var e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()},t.prototype.remove=function(e,n){var r,i=this;if(n(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,n),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===n(e,i.key)){if(i.right.isEmpty())return t.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,n))}return i.fixUp()},t.prototype.isRed=function(){return this.color},t.prototype.fixUp=function(){var t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t},t.prototype.moveRedLeft=function(){var t=this.colorFlip();return t.right.left.isRed()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip()),t},t.prototype.moveRedRight=function(){var t=this.colorFlip();return t.left.left.isRed()&&(t=(t=t.rotateRight()).colorFlip()),t},t.prototype.rotateLeft=function(){var e=this.copy(null,null,t.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)},t.prototype.rotateRight=function(){var e=this.copy(null,null,t.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)},t.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},t.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},t.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw Qs("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw Qs("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check();if(t!==this.right.check())throw Qs("Black depths differ");return t+(this.isRed()?0:1)},t.EMPTY=null,t.RED=!0,t.BLACK=!1,t}(),Wu=function(){function t(){this.size=0}return t.prototype.copy=function(t,e,n,r,i){return this},t.prototype.insert=function(t,e,n){return new Gu(t,e)},t.prototype.remove=function(t,e){return this},t.prototype.isEmpty=function(){return!0},t.prototype.inorderTraversal=function(t){return!1},t.prototype.reverseTraversal=function(t){return!1},t.prototype.minKey=function(){return null},t.prototype.maxKey=function(){return null},t.prototype.isRed=function(){return!1},t.prototype.checkMaxDepth=function(){return!0},t.prototype.check=function(){return 0},t}();Gu.EMPTY=new Wu,function(t){t[t.NullValue=0]="NullValue",t[t.BooleanValue=1]="BooleanValue",t[t.NumberValue=2]="NumberValue",t[t.TimestampValue=3]="TimestampValue",t[t.StringValue=4]="StringValue",t[t.BlobValue=5]="BlobValue",t[t.RefValue=6]="RefValue",t[t.GeoPointValue=7]="GeoPointValue",t[t.ArrayValue=8]="ArrayValue",t[t.ObjectValue=9]="ObjectValue"}(Cu||(Cu={})),function(t){t[t.Default=0]="Default",t[t.Estimate=1]="Estimate",t[t.Previous=2]="Previous"}(Du||(Du={}));var zu=function(){function t(t,e){this.serverTimestampBehavior=t,this.timestampsInSnapshots=e}return t.fromSnapshotOptions=function(e,n){switch(e.serverTimestamps){case"estimate":return new t(Du.Estimate,n);case"previous":return new t(Du.Previous,n);case"none":case void 0:return new t(Du.Default,n);default:return Qs("fromSnapshotOptions() called with invalid options.")}},t}(),Hu=function(){function t(){}return t.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},t.prototype.defaultCompareTo=function(t){return Ks(this.typeOrder!==t.typeOrder,"Default compareTo should not be used for values of same type."),wu(this.typeOrder,t.typeOrder)},t}(),Yu=function(t){function e(){var e=t.call(this)||this;return e.typeOrder=Cu.NullValue,e.internalValue=null,e}return Jn(e,t),e.prototype.value=function(t){return null},e.prototype.isEqual=function(t){return t instanceof e},e.prototype.compareTo=function(t){return t instanceof e?0:this.defaultCompareTo(t)},e.INSTANCE=new e,e}(Hu),Xu=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.BooleanValue,n}return Jn(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue===t.internalValue},e.prototype.compareTo=function(t){return t instanceof e?wu(this,t):this.defaultCompareTo(t)},e.of=function(t){return t?e.TRUE:e.FALSE},e.TRUE=new e(!0),e.FALSE=new e(!1),e}(Hu),Ju=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.NumberValue,n}return Jn(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.compareTo=function(t){return t instanceof e?(n=this.internalValue,r=t.internalValue,n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1):this.defaultCompareTo(t);var n,r},e}(Hu);function $u(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}var Zu=function(t){function e(e){return t.call(this,e)||this}return Jn(e,t),e.prototype.isEqual=function(t){return t instanceof e&&$u(this.internalValue,t.internalValue)},e}(Ju),tc=function(t){function e(e){var n=t.call(this,e)||this;return n.internalValue=e,n}return Jn(e,t),e.prototype.isEqual=function(t){return t instanceof e&&$u(this.internalValue,t.internalValue)},e.NAN=new e(NaN),e.POSITIVE_INFINITY=new e(1/0),e.NEGATIVE_INFINITY=new e(-1/0),e}(Ju),ec=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.StringValue,n}return Jn(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue===t.internalValue},e.prototype.compareTo=function(t){return t instanceof e?wu(this.internalValue,t.internalValue):this.defaultCompareTo(t)},e}(Hu),nc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.TimestampValue,n}return Jn(e,t),e.prototype.value=function(t){return!t||t.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):t instanceof rc?-1:this.defaultCompareTo(t)},e}(Hu),rc=function(t){function e(e,n){var r=t.call(this)||this;return r.localWriteTime=e,r.previousValue=n,r.typeOrder=Cu.TimestampValue,r}return Jn(e,t),e.prototype.value=function(t){return t&&t.serverTimestampBehavior===Du.Estimate?new nc(this.localWriteTime).value(t):t&&t.serverTimestampBehavior===Du.Previous&&this.previousValue?this.previousValue.value(t):null},e.prototype.isEqual=function(t){return t instanceof e&&this.localWriteTime.isEqual(t.localWriteTime)},e.prototype.compareTo=function(t){return t instanceof e?this.localWriteTime._compareTo(t.localWriteTime):t instanceof nc?1:this.defaultCompareTo(t)},e.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},e}(Hu),ic=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.BlobValue,n}return Jn(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},e}(Hu),oc=function(t){function e(e,n){var r=t.call(this)||this;return r.databaseId=e,r.key=n,r.typeOrder=Cu.RefValue,r}return Jn(e,t),e.prototype.value=function(t){return this.key},e.prototype.isEqual=function(t){return t instanceof e&&(this.key.isEqual(t.key)&&this.databaseId.isEqual(t.databaseId))},e.prototype.compareTo=function(t){if(t instanceof e){var n=this.databaseId.compareTo(t.databaseId);return 0!==n?n:Fu.comparator(this.key,t.key)}return this.defaultCompareTo(t)},e}(Hu),ac=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.GeoPointValue,n}return Jn(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},e}(Hu),sc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.ObjectValue,n}return Jn(e,t),e.prototype.value=function(t){var e={};return this.internalValue.inorderTraversal(function(n,r){e[n]=r.value(t)}),e},e.prototype.forEach=function(t){this.internalValue.inorderTraversal(t)},e.prototype.isEqual=function(t){if(t instanceof e){for(var n=this.internalValue.getIterator(),r=t.internalValue.getIterator();n.hasNext()&&r.hasNext();){var i=n.getNext(),o=r.getNext();if(i.key!==o.key||!i.value.isEqual(o.value))return!1}return!n.hasNext()&&!r.hasNext()}return!1},e.prototype.compareTo=function(t){if(t instanceof e){for(var n=this.internalValue.getIterator(),r=t.internalValue.getIterator();n.hasNext()&&r.hasNext();){var i=n.getNext(),o=r.getNext(),a=wu(i.key,o.key)||i.value.compareTo(o.value);if(a)return a}return wu(n.hasNext(),r.hasNext())}return this.defaultCompareTo(t)},e.prototype.set=function(t,n){if(Ks(!t.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.setChild(t.firstSegment(),n);var r=this.child(t.firstSegment());r instanceof e||(r=e.EMPTY);var i=r.set(t.popFirst(),n);return this.setChild(t.firstSegment(),i)},e.prototype.delete=function(t){if(Ks(!t.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new e(this.internalValue.remove(t.firstSegment()));var n=this.child(t.firstSegment());if(n instanceof e){var r=n.delete(t.popFirst());return new e(this.internalValue.insert(t.firstSegment(),r))}return this},e.prototype.contains=function(t){return void 0!==this.field(t)},e.prototype.field=function(t){Ks(!t.isEmpty(),"Can't get field of empty path");var n=this;return t.forEach(function(t){n=n instanceof e&&n.internalValue.get(t)||void 0}),n},e.prototype.toString=function(){return this.internalValue.toString()},e.prototype.child=function(t){return this.internalValue.get(t)||void 0},e.prototype.setChild=function(t,n){return new e(this.internalValue.insert(t,n))},e.EMPTY=new e(new Qu(wu)),e}(Hu),uc=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=Cu.ArrayValue,n}return Jn(e,t),e.prototype.value=function(t){return this.internalValue.map(function(e){return e.value(t)})},e.prototype.forEach=function(t){this.internalValue.forEach(t)},e.prototype.isEqual=function(t){if(t instanceof e){if(this.internalValue.length!==t.internalValue.length)return!1;for(var n=0;n<this.internalValue.length;n++)if(!this.internalValue[n].isEqual(t.internalValue[n]))return!1;return!0}return!1},e.prototype.compareTo=function(t){if(t instanceof e){for(var n=Math.min(this.internalValue.length,t.internalValue.length),r=0;r<n;r++){var i=this.internalValue[r].compareTo(t.internalValue[r]);if(i)return i}return wu(this.internalValue.length,t.internalValue.length)}return this.defaultCompareTo(t)},e.prototype.toString=function(){return"["+this.internalValue.map(function(t){return t.toString()}).join(",")+"]"},e}(Hu),cc=Number,hc=cc.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),lc=cc.MAX_SAFE_INTEGER||Math.pow(2,53)-1,fc=cc.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t};function pc(t){return null==t}function dc(t){return fc(t)&&t<=lc&&t>=hc}var yc,mc=function(){function t(t,e,n,r,i,o,a){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=a,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}return t.atPath=function(e){return new t(e)},Object.defineProperty(t.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var t=this.getInequalityFilterField(),e=this.getFirstOrderByField();if(null!==t&&null===e)t.isKeyField()?this.memoizedOrderBy=[Cc]:this.memoizedOrderBy=[new Ic(t),Cc];else{Ks(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field."),this.memoizedOrderBy=[];for(var n=!1,r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}if(!n){var a=this.explicitOrderBy.length>0?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Ec.ASCENDING;this.memoizedOrderBy.push(a===Ec.ASCENDING?Cc:Dc)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),t.prototype.addFilter=function(e){Ks(null==this.getInequalityFilterField()||!(e instanceof bc)||!e.isInequality()||e.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),Ks(!this.isDocumentQuery(),"No filtering allowed for document query");var n=this.filters.concat([e]);return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),n,this.limit,this.startAt,this.endAt)},t.prototype.addOrderBy=function(e){Ks(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var n=this.explicitOrderBy.concat([e]);return new t(this.path,this.collectionGroup,n,this.filters.slice(),this.limit,this.startAt,this.endAt)},t.prototype.withLimit=function(e){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),e,this.startAt,this.endAt)},t.prototype.withStartAt=function(e){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,e,this.endAt)},t.prototype.withEndAt=function(e){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,e)},t.prototype.asCollectionQueryAtPath=function(e){return new t(e,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)},t.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var t=this.path.canonicalString();this.isCollectionGroupQuery()&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(var e=0,n=this.filters;e<n.length;e++){t+=n[e].canonicalId(),t+=","}t+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++){t+=i[r].canonicalId(),t+=","}pc(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.memoizedCanonicalId=t}return this.memoizedCanonicalId},t.prototype.toString=function(){var t="Query("+this.path.canonicalString();return this.isCollectionGroupQuery()&&(t+=" collectionGroup="+this.collectionGroup),this.filters.length>0&&(t+=", filters: ["+this.filters.join(", ")+"]"),pc(this.limit)||(t+=", limit: "+this.limit),this.explicitOrderBy.length>0&&(t+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),t+")"},t.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return this.collectionGroup===t.collectionGroup&&(!!this.path.isEqual(t.path)&&(!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)))},t.prototype.docComparator=function(t,e){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],a=o.compare(t,e);if(0!==a)return a;n=n||o.field.isKeyField()}return Ks(n,"orderBy used that doesn't compare on key field"),0},t.prototype.matches=function(t){return this.matchesPathAndCollectionGroup(t)&&this.matchesOrderBy(t)&&this.matchesFilters(t)&&this.matchesBounds(t)},t.prototype.hasLimit=function(){return!pc(this.limit)},t.prototype.getFirstOrderByField=function(){return this.explicitOrderBy.length>0?this.explicitOrderBy[0].field:null},t.prototype.getInequalityFilterField=function(){for(var t=0,e=this.filters;t<e.length;t++){var n=e[t];if(n instanceof bc&&n.isInequality())return n.field}return null},t.prototype.hasArrayContainsFilter=function(){return void 0!==this.filters.find(function(t){return t instanceof bc&&t.op===vc.ARRAY_CONTAINS})},t.prototype.isDocumentQuery=function(){return Fu.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},t.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},t.prototype.matchesPathAndCollectionGroup=function(t){var e=t.key.path;return null!==this.collectionGroup?t.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(e):Fu.isDocumentKey(this.path)?this.path.isEqual(e):this.path.isImmediateParentOf(e)},t.prototype.matchesOrderBy=function(t){for(var e=0,n=this.explicitOrderBy;e<n.length;e++){var r=n[e];if(!r.field.isKeyField()&&void 0===t.field(r.field))return!1}return!0},t.prototype.matchesFilters=function(t){for(var e=0,n=this.filters;e<n.length;e++){if(!n[e].matches(t))return!1}return!0},t.prototype.matchesBounds=function(t){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,t))&&(!this.endAt||!this.endAt.sortsBeforeDocument(this.orderBy,t))},t.prototype.assertValidBound=function(t){Ks(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},t}(),gc=function(){function t(){}return t.create=function(t,e,n){if(n.isEqual(Yu.INSTANCE)){if(e!==vc.EQUAL)throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on null.");return new wc(t)}if(n.isEqual(tc.NAN)){if(e!==vc.EQUAL)throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on NaN.");return new Sc(t)}return new bc(t,e,n)},t}(),vc=function(){function t(t){this.name=t}return t.fromString=function(e){switch(e){case"<":return t.LESS_THAN;case"<=":return t.LESS_THAN_OR_EQUAL;case"==":return t.EQUAL;case">=":return t.GREATER_THAN_OR_EQUAL;case">":return t.GREATER_THAN;case"array-contains":return t.ARRAY_CONTAINS;default:return Qs("Unknown relation: "+e)}},t.prototype.toString=function(){return this.name},t.prototype.isEqual=function(t){return this.name===t.name},t.LESS_THAN=new t("<"),t.LESS_THAN_OR_EQUAL=new t("<="),t.EQUAL=new t("=="),t.GREATER_THAN=new t(">"),t.GREATER_THAN_OR_EQUAL=new t(">="),t.ARRAY_CONTAINS=new t("array-contains"),t}(),bc=function(t){function e(e,n,r){var i=t.call(this)||this;return i.field=e,i.op=n,i.value=r,i}return Jn(e,t),e.prototype.matches=function(t){if(this.field.isKeyField()){Ks(this.value instanceof oc,"Comparing on key, but filter value not a RefValue"),Ks(this.op!==vc.ARRAY_CONTAINS,"array-contains queries don't make sense on document keys.");var e=this.value,n=Fu.comparator(t.key,e.key);return this.matchesComparison(n)}var r=t.field(this.field);return void 0!==r&&this.matchesValue(r)},e.prototype.matchesValue=function(t){var e=this;return this.op===vc.ARRAY_CONTAINS?t instanceof uc&&void 0!==t.internalValue.find(function(t){return t.isEqual(e.value)}):this.value.typeOrder===t.typeOrder&&this.matchesComparison(t.compareTo(this.value))},e.prototype.matchesComparison=function(t){switch(this.op){case vc.LESS_THAN:return t<0;case vc.LESS_THAN_OR_EQUAL:return t<=0;case vc.EQUAL:return 0===t;case vc.GREATER_THAN:return t>0;case vc.GREATER_THAN_OR_EQUAL:return t>=0;default:return Qs("Unknown relation op"+this.op)}},e.prototype.isInequality=function(){return this.op!==vc.EQUAL&&this.op!==vc.ARRAY_CONTAINS},e.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},e.prototype.isEqual=function(t){return t instanceof e&&(this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value))},e.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},e}(gc),wc=function(t){function e(e){var n=t.call(this)||this;return n.field=e,n}return Jn(e,t),e.prototype.matches=function(t){var e=t.field(this.field);return void 0!==e&&null===e.value()},e.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"},e.prototype.toString=function(){return this.field.canonicalString()+" IS null"},e.prototype.isEqual=function(t){return t instanceof e&&this.field.isEqual(t.field)},e}(gc),Sc=function(t){function e(e){var n=t.call(this)||this;return n.field=e,n}return Jn(e,t),e.prototype.matches=function(t){var e=t.field(this.field),n=e&&e.value();return"number"==typeof n&&isNaN(n)},e.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"},e.prototype.toString=function(){return this.field.canonicalString()+" IS NaN"},e.prototype.isEqual=function(t){return t instanceof e&&this.field.isEqual(t.field)},e}(gc),Ec=function(){function t(t){this.name=t}return t.prototype.toString=function(){return this.name},t.ASCENDING=new t("asc"),t.DESCENDING=new t("desc"),t}(),Tc=function(){function t(t,e){this.position=t,this.before=e}return t.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",e=0,n=this.position;e<n.length;e++){t+=n[e].toString()}return t},t.prototype.sortsBeforeDocument=function(t,e){Ks(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i=t[r],o=this.position[r];if(i.field.isKeyField())Ks(o instanceof oc,"Bound has a non-key value where the key path is being used."),n=Fu.comparator(o.key,e.key);else{var a=e.field(i.field);Ks(void 0!==a,"Field should exist since document matched the orderBy already."),n=o.compareTo(a)}if(i.dir===Ec.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},t.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var e=0;e<this.position.length;e++){var n=this.position[e],r=t.position[e];return n.isEqual(r)}return!0},t}(),Ic=function(){function t(t,e){this.field=t,void 0===e&&(e=Ec.ASCENDING),this.dir=e,this.isKeyOrderBy=t.isKeyField()}return t.prototype.compare=function(t,e){var n=this.isKeyOrderBy?Vu.compareByKey(t,e):Vu.compareByField(this.field,t,e);switch(this.dir){case Ec.ASCENDING:return n;case Ec.DESCENDING:return-1*n;default:return Qs("Unknown direction: "+this.dir)}},t.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},t.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},t.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},t}(),Cc=new Ic(qu.keyField(),Ec.ASCENDING),Dc=new Ic(qu.keyField(),Ec.DESCENDING),Ac=function(){function t(t){this.timestamp=t}return t.fromMicroseconds=function(e){var n=Math.floor(e/1e6);return new t(new Ru(n,e%1e6*1e3))},t.fromTimestamp=function(e){return new t(e)},t.forDeletedDoc=function(){return t.MIN},t.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},t.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},t.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},t.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},t.prototype.toTimestamp=function(){return this.timestamp},t.MIN=new t(new Ru(0,0)),t}();!function(t){t[t.Listen=0]="Listen",t[t.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",t[t.LimboResolution=2]="LimboResolution"}(yc||(yc={}));var Nc,kc=function(){function t(t,e,n,r,i,o){void 0===i&&(i=Ac.MIN),void 0===o&&(o=Ws()),this.query=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.resumeToken=o}return t.prototype.copy=function(e){return new t(this.query,this.targetId,this.purpose,void 0===e.sequenceNumber?this.sequenceNumber:e.sequenceNumber,void 0===e.snapshotVersion?this.snapshotVersion:e.snapshotVersion,void 0===e.resumeToken?this.resumeToken:e.resumeToken)},t.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.purpose===t.purpose&&this.sequenceNumber===t.sequenceNumber&&this.snapshotVersion.isEqual(t.snapshotVersion)&&this.resumeToken===t.resumeToken&&this.query.isEqual(t.query)},t}(),Rc=function(){function t(t){this.comparator=t,this.data=new Qu(this.comparator)}return t.fromMapKeys=function(e){var n=new t(e.comparator);return e.forEach(function(t){n=n.add(t)}),n},t.prototype.has=function(t){return null!==this.data.get(t)},t.prototype.first=function(){return this.data.minKey()},t.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(t.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),t.prototype.indexOf=function(t){return this.data.indexOf(t)},t.prototype.forEach=function(t){this.data.inorderTraversal(function(e,n){return t(e),!1})},t.prototype.forEachInRange=function(t,e){for(var n=this.data.getIteratorFrom(t[0]);n.hasNext();){var r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}},t.prototype.forEachWhile=function(t,e){var n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();){if(!t(n.getNext().key))return}},t.prototype.firstAfterOrEqual=function(t){var e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null},t.prototype.getIterator=function(){return new Oc(this.data.getIterator())},t.prototype.getIteratorFrom=function(t){return new Oc(this.data.getIteratorFrom(t))},t.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},t.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},t.prototype.isEmpty=function(){return this.data.isEmpty()},t.prototype.unionWith=function(t){var e=this;return t.forEach(function(t){e=e.add(t)}),e},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.data.getIterator(),r=e.data.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(0!==this.comparator(i,o))return!1}return!0},t.prototype.toArray=function(){var t=[];return this.forEach(function(e){t.push(e)}),t},t.prototype.toString=function(){var t=[];return this.forEach(function(e){return t.push(e)}),"SortedSet("+t.toString()+")"},t.prototype.copy=function(e){var n=new t(this.comparator);return n.data=e,n},t}(),Oc=function(){function t(t){this.iter=t}return t.prototype.getNext=function(){return this.iter.getNext().key},t.prototype.hasNext=function(){return this.iter.hasNext()},t}(),_c=function(){function t(t){this.fields=t}return t.fromSet=function(e){return new t(e)},t.fromArray=function(e){var n=new Rc(qu.comparator);return e.forEach(function(t){return n=n.add(t)}),new t(n)},t.prototype.covers=function(t){var e=!1;return this.fields.forEach(function(n){n.isPrefixOf(t)&&(e=!0)}),e},t.prototype.applyTo=function(t){var e=sc.EMPTY;return this.fields.forEach(function(n){if(n.isEmpty())return t;var r=t.field(n);void 0!==r&&(e=e.set(n,r))}),e},t.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},t}(),Mc=function(){function t(t,e){this.field=t,this.transform=e}return Object.defineProperty(t.prototype,"isIdempotent",{get:function(){return this.transform.isIdempotent},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},t}(),Pc=function(){return function(t,e){this.version=t,this.transformResults=e}}();!function(t){t[t.Set=0]="Set",t[t.Patch=1]="Patch",t[t.Transform=2]="Transform",t[t.Delete=3]="Delete"}(Nc||(Nc={}));var Lc=function(){function t(t,e){this.updateTime=t,this.exists=e,Ks(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}return t.exists=function(e){return new t(void 0,e)},t.updateTime=function(e){return new t(e)},Object.defineProperty(t.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),t.prototype.isValidFor=function(t){return void 0!==this.updateTime?t instanceof Vu&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof Vu:(Ks(this.isNone,"Precondition should be empty"),!0)},t.prototype.isEqual=function(t){return e=this.updateTime,n=t.updateTime,(null!=e?!(!n||!e.isEqual(n)):e===n)&&this.exists===t.exists;var e,n},t.NONE=new t,t}(),xc=function(){function t(){}return t.prototype.verifyKeyMatches=function(t){null!=t&&Ks(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},t.getPostMutationVersion=function(t){return t instanceof Vu?t.version:Ac.MIN},t}(),qc=function(t){function e(e,n,r){var i=t.call(this)||this;return i.key=e,i.value=n,i.precondition=r,i.type=Nc.Set,i}return Jn(e,t),e.prototype.applyToRemoteDocument=function(t,e){this.verifyKeyMatches(t),Ks(null==e.transformResults,"Transform results received by SetMutation.");var n=e.version;return new Vu(this.key,n,this.value,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=xc.getPostMutationVersion(t);return new Vu(this.key,r,this.value,{hasLocalMutations:!0})},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.precondition.isEqual(t.precondition)},e}(xc),Fc=function(t){function e(e,n,r,i){var o=t.call(this)||this;return o.key=e,o.data=n,o.fieldMask=r,o.precondition=i,o.type=Nc.Patch,o}return Jn(e,t),e.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Ks(null==e.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(t))return new ju(this.key,e.version);var n=this.patchDocument(t);return new Vu(this.key,e.version,n,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=xc.getPostMutationVersion(t),i=this.patchDocument(t);return new Vu(this.key,r,i,{hasLocalMutations:!0})},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.fieldMask.isEqual(t.fieldMask)&&this.precondition.isEqual(t.precondition)},e.prototype.patchDocument=function(t){var e;return e=t instanceof Vu?t.data:sc.EMPTY,this.patchObject(e)},e.prototype.patchObject=function(t){var e=this;return this.fieldMask.fields.forEach(function(n){if(!n.isEmpty()){var r=e.data.field(n);t=void 0!==r?t.set(n,r):t.delete(n)}}),t},e}(xc),Bc=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r.fieldTransforms=n,r.type=Nc.Transform,r.precondition=Lc.exists(!0),r}return Jn(e,t),e.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Ks(null!=e.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(t))return new ju(this.key,e.version);var n=this.requireDocument(t),r=this.serverTransformResults(t,e.transformResults),i=e.version,o=this.transformObject(n.data,r);return new Vu(this.key,i,o,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=this.requireDocument(t),i=this.localTransformResults(n,e),o=this.transformObject(r.data,i);return new Vu(this.key,r.version,o,{hasLocalMutations:!0})},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){for(var t=0,e=this.fieldTransforms;t<e.length;t++){if(!e[t].isIdempotent)return!1}return!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldMask",{get:function(){var t=new Rc(qu.comparator);return this.fieldTransforms.forEach(function(e){return t=t.add(e.field)}),new _c(t)},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&Su(this.fieldTransforms,t.fieldTransforms)&&this.precondition.isEqual(t.precondition)},e.prototype.requireDocument=function(t){Ks(t instanceof Vu,"Unknown MaybeDocument type "+t);var e=t;return Ks(e.key.isEqual(this.key),"Can only transform a document with the same key"),e},e.prototype.serverTransformResults=function(t,e){var n=[];Ks(this.fieldTransforms.length===e.length,"server transform result count ("+e.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<e.length;r++){var i=this.fieldTransforms[r],o=i.transform,a=null;t instanceof Vu&&(a=t.field(i.field)||null),n.push(o.applyToRemoteDocument(a,e[r]))}return n},e.prototype.localTransformResults=function(t,e){for(var n=[],r=0,i=this.fieldTransforms;r<i.length;r++){var o=i[r],a=o.transform,s=null;e instanceof Vu&&(s=e.field(o.field)||null),n.push(a.applyToLocalView(s,t))}return n},e.prototype.transformObject=function(t,e){Ks(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n].field;t=t.set(r,e[n])}return t},e}(xc),Vc=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r.precondition=n,r.type=Nc.Delete,r}return Jn(e,t),e.prototype.applyToRemoteDocument=function(t,e){return this.verifyKeyMatches(t),Ks(null==e.transformResults,"Transform results received by DeleteMutation."),new Uu(this.key,e.version,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){return this.verifyKeyMatches(t),this.precondition.isValidFor(t)?(t&&Ks(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new Uu(this.key,Ac.forDeletedDoc())):t},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.precondition.isEqual(t.precondition)},Object.defineProperty(e.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0}),e}(xc),Uc=function(){function t(){this.isIdempotent=!0}return t.prototype.applyToLocalView=function(t,e){return new rc(e,t)},t.prototype.applyToRemoteDocument=function(t,e){return e},t.prototype.isEqual=function(e){return e instanceof t},t.instance=new t,t}(),jc=function(){function t(t){this.elements=t,this.isIdempotent=!0}return t.prototype.applyToLocalView=function(t,e){return this.apply(t)},t.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},t.prototype.apply=function(t){for(var e=Gc(t),n=function(t){e.find(function(e){return e.isEqual(t)})||e.push(t)},r=0,i=this.elements;r<i.length;r++){n(i[r])}return new uc(e)},t.prototype.isEqual=function(e){return e instanceof t&&Su(e.elements,this.elements)},t}(),Qc=function(){function t(t){this.elements=t,this.isIdempotent=!0}return t.prototype.applyToLocalView=function(t,e){return this.apply(t)},t.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},t.prototype.apply=function(t){for(var e=Gc(t),n=function(t){e=e.filter(function(e){return!e.isEqual(t)})},r=0,i=this.elements;r<i.length;r++){n(i[r])}return new uc(e)},t.prototype.isEqual=function(e){return e instanceof t&&Su(e.elements,this.elements)},t}(),Kc=function(){function t(t){this.operand=t,this.isIdempotent=!1}return t.prototype.applyToLocalView=function(t,e){if(t instanceof Zu&&this.operand instanceof Zu){var n=t.internalValue+this.operand.internalValue;return new Zu(n)}if(t instanceof Ju){n=t.internalValue+this.operand.internalValue;return new tc(n)}return this.operand},t.prototype.applyToRemoteDocument=function(t,e){return Ks(null!==e,"Didn't receive transformResult for NUMERIC_ADD transform"),e},t.prototype.isEqual=function(e){return e instanceof t&&this.operand.isEqual(e.operand)},t}();function Gc(t){return t instanceof uc?t.internalValue.slice():[]}var Wc,zc=function(){function t(t){this.count=t}return t.prototype.isEqual=function(t){return t&&t.count===this.count},t}();function Hc(t){switch(t){case zs.OK:return Qs("Treated status OK as error");case zs.CANCELLED:case zs.UNKNOWN:case zs.DEADLINE_EXCEEDED:case zs.RESOURCE_EXHAUSTED:case zs.INTERNAL:case zs.UNAVAILABLE:case zs.UNAUTHENTICATED:return!1;case zs.INVALID_ARGUMENT:case zs.NOT_FOUND:case zs.ALREADY_EXISTS:case zs.PERMISSION_DENIED:case zs.FAILED_PRECONDITION:case zs.ABORTED:case zs.OUT_OF_RANGE:case zs.UNIMPLEMENTED:case zs.DATA_LOSS:return!0;default:return Qs("Unknown status code: "+t)}}function Yc(t){if(void 0===t)return Us("GRPC error has no .code"),zs.UNKNOWN;switch(t){case Wc.OK:return zs.OK;case Wc.CANCELLED:return zs.CANCELLED;case Wc.UNKNOWN:return zs.UNKNOWN;case Wc.DEADLINE_EXCEEDED:return zs.DEADLINE_EXCEEDED;case Wc.RESOURCE_EXHAUSTED:return zs.RESOURCE_EXHAUSTED;case Wc.INTERNAL:return zs.INTERNAL;case Wc.UNAVAILABLE:return zs.UNAVAILABLE;case Wc.UNAUTHENTICATED:return zs.UNAUTHENTICATED;case Wc.INVALID_ARGUMENT:return zs.INVALID_ARGUMENT;case Wc.NOT_FOUND:return zs.NOT_FOUND;case Wc.ALREADY_EXISTS:return zs.ALREADY_EXISTS;case Wc.PERMISSION_DENIED:return zs.PERMISSION_DENIED;case Wc.FAILED_PRECONDITION:return zs.FAILED_PRECONDITION;case Wc.ABORTED:return zs.ABORTED;case Wc.OUT_OF_RANGE:return zs.OUT_OF_RANGE;case Wc.UNIMPLEMENTED:return zs.UNIMPLEMENTED;case Wc.DATA_LOSS:return zs.DATA_LOSS;default:return Qs("Unknown status code: "+t)}}function Xc(t){if(void 0===t)return Wc.OK;switch(t){case zs.OK:return Wc.OK;case zs.CANCELLED:return Wc.CANCELLED;case zs.UNKNOWN:return Wc.UNKNOWN;case zs.DEADLINE_EXCEEDED:return Wc.DEADLINE_EXCEEDED;case zs.RESOURCE_EXHAUSTED:return Wc.RESOURCE_EXHAUSTED;case zs.INTERNAL:return Wc.INTERNAL;case zs.UNAVAILABLE:return Wc.UNAVAILABLE;case zs.UNAUTHENTICATED:return Wc.UNAUTHENTICATED;case zs.INVALID_ARGUMENT:return Wc.INVALID_ARGUMENT;case zs.NOT_FOUND:return Wc.NOT_FOUND;case zs.ALREADY_EXISTS:return Wc.ALREADY_EXISTS;case zs.PERMISSION_DENIED:return Wc.PERMISSION_DENIED;case zs.FAILED_PRECONDITION:return Wc.FAILED_PRECONDITION;case zs.ABORTED:return Wc.ABORTED;case zs.OUT_OF_RANGE:return Wc.OUT_OF_RANGE;case zs.UNIMPLEMENTED:return Wc.UNIMPLEMENTED;case zs.DATA_LOSS:return Wc.DATA_LOSS;default:return Qs("Unknown status code: "+t)}}!function(t){t[t.OK=0]="OK",t[t.CANCELLED=1]="CANCELLED",t[t.UNKNOWN=2]="UNKNOWN",t[t.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",t[t.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",t[t.NOT_FOUND=5]="NOT_FOUND",t[t.ALREADY_EXISTS=6]="ALREADY_EXISTS",t[t.PERMISSION_DENIED=7]="PERMISSION_DENIED",t[t.UNAUTHENTICATED=16]="UNAUTHENTICATED",t[t.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",t[t.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",t[t.ABORTED=10]="ABORTED",t[t.OUT_OF_RANGE=11]="OUT_OF_RANGE",t[t.UNIMPLEMENTED=12]="UNIMPLEMENTED",t[t.INTERNAL=13]="INTERNAL",t[t.UNAVAILABLE=14]="UNAVAILABLE",t[t.DATA_LOSS=15]="DATA_LOSS"}(Wc||(Wc={}));var Jc=new Qu(Fu.comparator);function $c(){return Jc}function Zc(){return $c()}var th=new Qu(Fu.comparator);function eh(){return th}var nh=new Qu(Fu.comparator);function rh(){return nh}var ih=new Rc(Fu.comparator);function oh(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=ih,r=0,i=t;r<i.length;r++){var o=i[r];n=n.add(o)}return n}var ah=new Rc(wu);function sh(){return ah}var uh,ch,hh=function(){function t(t){this.comparator=t?function(e,n){return t(e,n)||Fu.comparator(e.key,n.key)}:function(t,e){return Fu.comparator(t.key,e.key)},this.keyedMap=eh(),this.sortedSet=new Qu(this.comparator)}return t.emptySet=function(e){return new t(e.comparator)},t.prototype.has=function(t){return null!=this.keyedMap.get(t)},t.prototype.get=function(t){return this.keyedMap.get(t)},t.prototype.first=function(){return this.sortedSet.minKey()},t.prototype.last=function(){return this.sortedSet.maxKey()},t.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},t.prototype.indexOf=function(t){var e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1},Object.defineProperty(t.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t){this.sortedSet.inorderTraversal(function(e,n){return t(e),!1})},t.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))},t.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(!i.isEqual(o))return!1}return!0},t.prototype.toString=function(){var t=[];return this.forEach(function(e){t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"},t.prototype.copy=function(e,n){var r=new t;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=n,r},t}();!function(t){t[t.Added=0]="Added",t[t.Removed=1]="Removed",t[t.Modified=2]="Modified",t[t.Metadata=3]="Metadata"}(uh||(uh={})),function(t){t[t.Local=0]="Local",t[t.Synced=1]="Synced"}(ch||(ch={}));var lh,fh=function(){function t(){this.changeMap=new Qu(Fu.comparator)}return t.prototype.track=function(t){var e=t.doc.key,n=this.changeMap.get(e);n?t.type!==uh.Added&&n.type===uh.Metadata?this.changeMap=this.changeMap.insert(e,t):t.type===uh.Metadata&&n.type!==uh.Removed?this.changeMap=this.changeMap.insert(e,{type:n.type,doc:t.doc}):t.type===uh.Modified&&n.type===uh.Modified?this.changeMap=this.changeMap.insert(e,{type:uh.Modified,doc:t.doc}):t.type===uh.Modified&&n.type===uh.Added?this.changeMap=this.changeMap.insert(e,{type:uh.Added,doc:t.doc}):t.type===uh.Removed&&n.type===uh.Added?this.changeMap=this.changeMap.remove(e):t.type===uh.Removed&&n.type===uh.Modified?this.changeMap=this.changeMap.insert(e,{type:uh.Removed,doc:n.doc}):t.type===uh.Added&&n.type===uh.Removed?this.changeMap=this.changeMap.insert(e,{type:uh.Modified,doc:t.doc}):Qs("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(n)):this.changeMap=this.changeMap.insert(e,t)},t.prototype.getChanges=function(){var t=[];return this.changeMap.inorderTraversal(function(e,n){t.push(n)}),t},t}(),ph=function(){function t(t,e,n,r,i,o,a,s){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}return t.fromInitialDocuments=function(e,n,r,i){var o=[];return n.forEach(function(t){o.push({type:uh.Added,doc:t})}),new t(e,n,hh.emptySet(n),o,r,i,!0,!1)},Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},t}(),dh=function(){function t(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}return t.createSynthesizedRemoteEventForCurrentChange=function(e,n){var r,i=((r={})[e]=yh.createSynthesizedTargetChangeForCurrentChange(e,n),r);return new t(Ac.MIN,i,sh(),$c(),oh())},t}(),yh=function(){function t(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}return t.createSynthesizedTargetChangeForCurrentChange=function(e,n){return new t(Ws(),n,oh(),oh(),oh())},t}(),mh=function(){return function(t,e,n,r){this.updatedTargetIds=t,this.removedTargetIds=e,this.key=n,this.newDoc=r}}(),gh=function(){return function(t,e){this.targetId=t,this.existenceFilter=e}}();!function(t){t[t.NoChange=0]="NoChange",t[t.Added=1]="Added",t[t.Removed=2]="Removed",t[t.Current=3]="Current",t[t.Reset=4]="Reset"}(lh||(lh={}));var vh=function(){return function(t,e,n,r){void 0===n&&(n=Ws()),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}(),bh=function(){function t(){this.pendingResponses=0,this.documentChanges=Eh(),this._resumeToken=Ws(),this._current=!1,this._hasPendingChanges=!0}return Object.defineProperty(t.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),t.prototype.updateResumeToken=function(t){t.length>0&&(this._hasPendingChanges=!0,this._resumeToken=t)},t.prototype.toTargetChange=function(){var t=oh(),e=oh(),n=oh();return this.documentChanges.forEach(function(r,i){switch(i){case uh.Added:t=t.add(r);break;case uh.Modified:e=e.add(r);break;case uh.Removed:n=n.add(r);break;default:Qs("Encountered invalid change type: "+i)}}),new yh(this._resumeToken,this._current,t,e,n)},t.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=Eh()},t.prototype.addDocumentChange=function(t,e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(t,e)},t.prototype.removeDocumentChange=function(t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(t)},t.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},t.prototype.recordTargetResponse=function(){this.pendingResponses-=1},t.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},t}(),wh=function(){function t(t){this.metadataProvider=t,this.targetStates={},this.pendingDocumentUpdates=$c(),this.pendingDocumentTargetMapping=Sh(),this.pendingTargetResets=new Rc(wu)}return t.prototype.handleDocumentChange=function(t){for(var e=0,n=t.updatedTargetIds;e<n.length;e++){var r=n[e];t.newDoc instanceof Vu?this.addDocumentToTarget(r,t.newDoc):t.newDoc instanceof Uu&&this.removeDocumentFromTarget(r,t.key,t.newDoc)}for(var i=0,o=t.removedTargetIds;i<o.length;i++){r=o[i];this.removeDocumentFromTarget(r,t.key,t.newDoc)}},t.prototype.handleTargetChange=function(t){var e=this;this.forEachTarget(t,function(n){var r=e.ensureTargetState(n);switch(t.state){case lh.NoChange:e.isActiveTarget(n)&&r.updateResumeToken(t.resumeToken);break;case lh.Added:r.recordTargetResponse(),r.isPending||r.clearPendingChanges(),r.updateResumeToken(t.resumeToken);break;case lh.Removed:r.recordTargetResponse(),r.isPending||e.removeTarget(n),Ks(!t.cause,"WatchChangeAggregator does not handle errored targets");break;case lh.Current:e.isActiveTarget(n)&&(r.markCurrent(),r.updateResumeToken(t.resumeToken));break;case lh.Reset:e.isActiveTarget(n)&&(e.resetTarget(n),r.updateResumeToken(t.resumeToken));break;default:Qs("Unknown target watch change state: "+t.state)}})},t.prototype.forEachTarget=function(t,e){t.targetIds.length>0?t.targetIds.forEach(e):$s(this.targetStates,e)},t.prototype.handleExistenceFilter=function(t){var e=t.targetId,n=t.existenceFilter.count,r=this.queryDataForActiveTarget(e);if(r){var i=r.query;if(i.isDocumentQuery())if(0===n){var o=new Fu(i.path);this.removeDocumentFromTarget(e,o,new Uu(o,Ac.forDeletedDoc()))}else Ks(1===n,"Single document existence filter with count: "+n);else this.getCurrentDocumentCountForTarget(e)!==n&&(this.resetTarget(e),this.pendingTargetResets=this.pendingTargetResets.add(e))}},t.prototype.createRemoteEvent=function(t){var e=this,n={};$s(this.targetStates,function(r,i){var o=e.queryDataForActiveTarget(r);if(o){if(i.current&&o.query.isDocumentQuery()){var a=new Fu(o.query.path);null!==e.pendingDocumentUpdates.get(a)||e.targetContainsDocument(r,a)||e.removeDocumentFromTarget(r,a,new Uu(a,t))}i.hasPendingChanges&&(n[r]=i.toTargetChange(),i.clearPendingChanges())}});var r=oh();this.pendingDocumentTargetMapping.forEach(function(t,n){var i=!0;n.forEachWhile(function(t){var n=e.queryDataForActiveTarget(t);return!n||n.purpose===yc.LimboResolution||(i=!1,!1)}),i&&(r=r.add(t))});var i=new dh(t,n,this.pendingTargetResets,this.pendingDocumentUpdates,r);return this.pendingDocumentUpdates=$c(),this.pendingDocumentTargetMapping=Sh(),this.pendingTargetResets=new Rc(wu),i},t.prototype.addDocumentToTarget=function(t,e){if(this.isActiveTarget(t)){var n=this.targetContainsDocument(t,e.key)?uh.Modified:uh.Added;this.ensureTargetState(t).addDocumentChange(e.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e.key,e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e.key,this.ensureDocumentTargetMapping(e.key).add(t))}},t.prototype.removeDocumentFromTarget=function(t,e,n){if(this.isActiveTarget(t)){var r=this.ensureTargetState(t);this.targetContainsDocument(t,e)?r.addDocumentChange(e,uh.Removed):r.removeDocumentChange(e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,this.ensureDocumentTargetMapping(e).delete(t)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e,n))}},t.prototype.removeTarget=function(t){delete this.targetStates[t]},t.prototype.getCurrentDocumentCountForTarget=function(t){var e=this.ensureTargetState(t).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size},t.prototype.recordPendingTargetRequest=function(t){this.ensureTargetState(t).recordPendingTargetRequest()},t.prototype.ensureTargetState=function(t){return this.targetStates[t]||(this.targetStates[t]=new bh),this.targetStates[t]},t.prototype.ensureDocumentTargetMapping=function(t){var e=this.pendingDocumentTargetMapping.get(t);return e||(e=new Rc(wu),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,e)),e},t.prototype.isActiveTarget=function(t){return null!==this.queryDataForActiveTarget(t)},t.prototype.queryDataForActiveTarget=function(t){var e=this.targetStates[t];return e&&e.isPending?null:this.metadataProvider.getQueryDataForTarget(t)},t.prototype.resetTarget=function(t){var e=this;Ks(!this.targetStates[t].isPending,"Should only reset active targets"),this.targetStates[t]=new bh,this.metadataProvider.getRemoteKeysForTarget(t).forEach(function(n){e.removeDocumentFromTarget(t,n,null)})},t.prototype.targetContainsDocument=function(t,e){return this.metadataProvider.getRemoteKeysForTarget(t).has(e)},t}();function Sh(){return new Qu(Fu.comparator)}function Eh(){return new Qu(Fu.comparator)}var Th,Ih,Ch=((Th={})[Ec.ASCENDING.name]="ASCENDING",Th[Ec.DESCENDING.name]="DESCENDING",Th),Dh=((Ih={})[vc.LESS_THAN.name]="LESS_THAN",Ih[vc.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",Ih[vc.GREATER_THAN.name]="GREATER_THAN",Ih[vc.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",Ih[vc.EQUAL.name]="EQUAL",Ih[vc.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",Ih),Ah=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Nh(t,e){Ks(!pc(t),e+" is missing")}function kh(t){return"number"==typeof t?t:"string"==typeof t?Number(t):Qs("can't parse "+t)}var Rh=function(){function t(t,e){this.databaseId=t,this.options=e}return t.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},t.prototype.unsafeCastProtoByteString=function(t){return t},t.prototype.fromRpcStatus=function(t){var e=void 0===t.code?zs.UNKNOWN:Yc(t.code);return new Hs(e,t.message||"")},t.prototype.toInt32Value=function(t){return pc(t)?void 0:{value:t}},t.prototype.fromInt32Value=function(t){var e;return pc(e="object"==typeof t?t.value:t)?null:e},t.prototype.toTimestamp=function(t){return{seconds:t.seconds,nanos:t.nanoseconds}},t.prototype.fromTimestamp=function(t){if("string"==typeof t)return this.fromIso8601String(t);Ks(!!t,"Cannot deserialize null or undefined timestamp.");var e=kh(t.seconds||"0"),n=t.nanos||0;return new Ru(e,n)},t.prototype.fromIso8601String=function(t){var e=0,n=Ah.exec(t);if(Ks(!!n,"invalid timestamp: "+t),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),e=Number(r)}var i=new Date(t),o=Math.floor(i.getTime()/1e3);return new Ru(o,e)},t.prototype.toBytes=function(t){return this.options.useProto3Json?t.toBase64():this.unsafeCastProtoByteString(t.toUint8Array())},t.prototype.fromBlob=function(t){return"string"==typeof t?(Ks(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Au.fromBase64String(t)):(Ks(!this.options.useProto3Json,"Expected bytes to be passed in as string, but got something else instead."),Au.fromUint8Array(t))},t.prototype.toVersion=function(t){return this.toTimestamp(t.toTimestamp())},t.prototype.fromVersion=function(t){return Ks(!!t,"Trying to deserialize version that isn't set"),Ac.fromTimestamp(this.fromTimestamp(t))},t.prototype.toResourceName=function(t,e){return this.fullyQualifiedPrefixPath(t).child("documents").child(e).canonicalString()},t.prototype.fromResourceName=function(t){var e=Lu.fromString(t);return Ks(this.isValidResourceName(e),"Tried to deserialize invalid key "+e.toString()),e},t.prototype.toName=function(t){return this.toResourceName(this.databaseId,t.path)},t.prototype.fromName=function(t){var e=this.fromResourceName(t);return Ks(e.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+e.get(1)+" vs "+this.databaseId.projectId),Ks(!e.get(3)&&!this.databaseId.database||e.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+e.get(3)+" vs "+this.databaseId.database),new Fu(this.extractLocalPathFromResourceName(e))},t.prototype.toQueryPath=function(t){return this.toResourceName(this.databaseId,t)},t.prototype.fromQueryPath=function(t){var e=this.fromResourceName(t);return 4===e.length?Lu.EMPTY_PATH:this.extractLocalPathFromResourceName(e)},Object.defineProperty(t.prototype,"encodedDatabaseId",{get:function(){return new Lu(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),t.prototype.fullyQualifiedPrefixPath=function(t){return new Lu(["projects",t.projectId,"databases",t.database])},t.prototype.extractLocalPathFromResourceName=function(t){return Ks(t.length>4&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.popFirst(5)},t.prototype.isValidResourceName=function(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)},t.prototype.toValue=function(t){if(t instanceof Yu)return{nullValue:"NULL_VALUE"};if(t instanceof Xu)return{booleanValue:t.value()};if(t instanceof Zu)return{integerValue:""+t.value()};if(t instanceof tc){var e=t.value();if(this.options.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof ec?{stringValue:t.value()}:t instanceof sc?{mapValue:this.toMapValue(t)}:t instanceof uc?{arrayValue:this.toArrayValue(t)}:t instanceof nc?{timestampValue:this.toTimestamp(t.internalValue)}:t instanceof ac?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof ic?{bytesValue:this.toBytes(t.value())}:t instanceof oc?{referenceValue:this.toResourceName(t.databaseId,t.key.path)}:Qs("Unknown FieldValue "+JSON.stringify(t))},t.prototype.fromValue=function(t){var e=this,n=t.value_type;if(Oh(t,n,"nullValue"))return Yu.INSTANCE;if(Oh(t,n,"booleanValue"))return Xu.of(t.booleanValue);if(Oh(t,n,"integerValue"))return new Zu(kh(t.integerValue));if(Oh(t,n,"doubleValue")){if(this.options.useProto3Json){if("NaN"===t.doubleValue)return tc.NAN;if("Infinity"===t.doubleValue)return tc.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return tc.NEGATIVE_INFINITY}return new tc(t.doubleValue)}if(Oh(t,n,"stringValue"))return new ec(t.stringValue);if(Oh(t,n,"mapValue"))return this.fromFields(t.mapValue.fields||{});if(Oh(t,n,"arrayValue")){Nh(t.arrayValue,"arrayValue");var r=t.arrayValue.values||[];return new uc(r.map(function(t){return e.fromValue(t)}))}if(Oh(t,n,"timestampValue"))return Nh(t.timestampValue,"timestampValue"),new nc(this.fromTimestamp(t.timestampValue));if(Oh(t,n,"geoPointValue")){Nh(t.geoPointValue,"geoPointValue");var i=t.geoPointValue.latitude||0,o=t.geoPointValue.longitude||0;return new ac(new ku(i,o))}if(Oh(t,n,"bytesValue")){Nh(t.bytesValue,"bytesValue");var a=this.fromBlob(t.bytesValue);return new ic(a)}if(Oh(t,n,"referenceValue")){Nh(t.referenceValue,"referenceValue");var s=this.fromResourceName(t.referenceValue),u=new Mu(s.get(1),s.get(3)),c=new Fu(this.extractLocalPathFromResourceName(s));return new oc(u,c)}return Qs("Unknown Value proto "+JSON.stringify(t))},t.prototype.toMutationDocument=function(t,e){return{name:this.toName(t),fields:this.toFields(e)}},t.prototype.toDocument=function(t){return Ks(!t.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(t.key),fields:this.toFields(t.data),updateTime:this.toTimestamp(t.version.toTimestamp())}},t.prototype.fromDocument=function(t,e){return new Vu(this.fromName(t.name),this.fromVersion(t.updateTime),this.fromFields(t.fields||{}),{hasCommittedMutations:!!e})},t.prototype.toFields=function(t){var e=this,n={};return t.forEach(function(t,r){n[t]=e.toValue(r)}),n},t.prototype.fromFields=function(t){var e=this,n=t,r=sc.EMPTY;return Zs(n,function(t,n){r=r.set(new qu([t]),e.fromValue(n))}),r},t.prototype.toMapValue=function(t){return{fields:this.toFields(t)}},t.prototype.toArrayValue=function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.toValue(t))}),{values:n}},t.prototype.fromFound=function(t){Ks(!!t.found,"Tried to deserialize a found document from a missing document."),Nh(t.found.name,"doc.found.name"),Nh(t.found.updateTime,"doc.found.updateTime");var e=this.fromName(t.found.name),n=this.fromVersion(t.found.updateTime),r=this.fromFields(t.found.fields||{});return new Vu(e,n,r,{},t.found)},t.prototype.fromMissing=function(t){Ks(!!t.missing,"Tried to deserialize a missing document from a found document."),Ks(!!t.readTime,"Tried to deserialize a missing document without a read time.");var e=this.fromName(t.missing),n=this.fromVersion(t.readTime);return new Uu(e,n)},t.prototype.fromMaybeDocument=function(t){var e=t.result;return Oh(t,e,"found")?this.fromFound(t):Oh(t,e,"missing")?this.fromMissing(t):Qs("invalid batch get response: "+JSON.stringify(t))},t.prototype.toWatchTargetChangeState=function(t){switch(t){case lh.Added:return"ADD";case lh.Current:return"CURRENT";case lh.NoChange:return"NO_CHANGE";case lh.Removed:return"REMOVE";case lh.Reset:return"RESET";default:return Qs("Unknown WatchTargetChangeState: "+t)}},t.prototype.toTestWatchChange=function(t){if(t instanceof gh)return{filter:{count:t.existenceFilter.count,targetId:t.targetId}};if(t instanceof mh){if(t.newDoc instanceof Vu){var e=t.newDoc;return{documentChange:{document:{name:this.toName(e.key),fields:this.toFields(e.data),updateTime:this.toVersion(e.version)},targetIds:t.updatedTargetIds,removedTargetIds:t.removedTargetIds}}}if(t.newDoc instanceof Uu){e=t.newDoc;return{documentDelete:{document:this.toName(e.key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}}}if(null===t.newDoc)return{documentRemove:{document:this.toName(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof vh){var n=void 0;return t.cause&&(n={code:Xc(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(t.state),targetIds:t.targetIds,resumeToken:this.unsafeCastProtoByteString(t.resumeToken),cause:n}}}return Qs("Unrecognized watch change: "+JSON.stringify(t))},t.prototype.fromWatchChange=function(t){var e,n=t.response_type;if(Oh(t,n,"targetChange")){Nh(t.targetChange,"targetChange");var r=this.fromWatchTargetChangeState(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],o=t.targetChange.resumeToken||this.emptyByteString(),a=t.targetChange.cause,s=a&&this.fromRpcStatus(a);e=new vh(r,i,o,s||null)}else if(Oh(t,n,"documentChange")){Nh(t.documentChange,"documentChange"),Nh(t.documentChange.document,"documentChange.name"),Nh(t.documentChange.document.name,"documentChange.document.name"),Nh(t.documentChange.document.updateTime,"documentChange.document.updateTime");var u=t.documentChange,c=this.fromName(u.document.name),h=this.fromVersion(u.document.updateTime),l=this.fromFields(u.document.fields||{}),f=new Vu(c,h,l,{},u.document),p=u.targetIds||[],d=u.removedTargetIds||[];e=new mh(p,d,f.key,f)}else if(Oh(t,n,"documentDelete")){Nh(t.documentDelete,"documentDelete"),Nh(t.documentDelete.document,"documentDelete.document");var y=t.documentDelete;c=this.fromName(y.document),h=y.readTime?this.fromVersion(y.readTime):Ac.forDeletedDoc(),f=new Uu(c,h),d=y.removedTargetIds||[];e=new mh([],d,f.key,f)}else if(Oh(t,n,"documentRemove")){Nh(t.documentRemove,"documentRemove"),Nh(t.documentRemove.document,"documentRemove");var m=t.documentRemove;c=this.fromName(m.document),d=m.removedTargetIds||[];e=new mh([],d,c,null)}else{if(!Oh(t,n,"filter"))return Qs("Unknown change type "+JSON.stringify(t));Nh(t.filter,"filter"),Nh(t.filter.targetId,"filter.targetId");var g=t.filter,v=g.count||0,b=new zc(v),w=g.targetId;e=new gh(w,b)}return e},t.prototype.fromWatchTargetChangeState=function(t){return"NO_CHANGE"===t?lh.NoChange:"ADD"===t?lh.Added:"REMOVE"===t?lh.Removed:"CURRENT"===t?lh.Current:"RESET"===t?lh.Reset:Qs("Got unexpected TargetChange.state: "+t)},t.prototype.versionFromListenResponse=function(t){if(!Oh(t,t.response_type,"targetChange"))return Ac.MIN;var e=t.targetChange;return e.targetIds&&e.targetIds.length?Ac.MIN:e.readTime?this.fromVersion(e.readTime):Ac.MIN},t.prototype.toMutation=function(t){var e,n=this;if(t instanceof qc)e={update:this.toMutationDocument(t.key,t.value)};else if(t instanceof Vc)e={delete:this.toName(t.key)};else if(t instanceof Fc)e={update:this.toMutationDocument(t.key,t.data),updateMask:this.toDocumentMask(t.fieldMask)};else{if(!(t instanceof Bc))return Qs("Unknown mutation type "+t.type);e={transform:{document:this.toName(t.key),fieldTransforms:t.fieldTransforms.map(function(t){return n.toFieldTransform(t)})}}}return t.precondition.isNone||(e.currentDocument=this.toPrecondition(t.precondition)),e},t.prototype.fromMutation=function(t){var e=this,n=t.currentDocument?this.fromPrecondition(t.currentDocument):Lc.NONE;if(t.update){Nh(t.update.name,"name");var r=this.fromName(t.update.name),i=this.fromFields(t.update.fields||{});if(t.updateMask){var o=this.fromDocumentMask(t.updateMask);return new Fc(r,i,o,n)}return new qc(r,i,n)}if(t.delete){r=this.fromName(t.delete);return new Vc(r,n)}if(t.transform){r=this.fromName(t.transform.document);var a=t.transform.fieldTransforms.map(function(t){return e.fromFieldTransform(t)});return Ks(!0===n.exists,'Transforms only support precondition "exists == true"'),new Bc(r,a)}return Qs("unknown mutation proto: "+JSON.stringify(t))},t.prototype.toPrecondition=function(t){return Ks(!t.isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:Qs("Unknown precondition")},t.prototype.fromPrecondition=function(t){return void 0!==t.updateTime?Lc.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?Lc.exists(t.exists):Lc.NONE},t.prototype.fromWriteResult=function(t,e){var n=this,r=t.updateTime?this.fromVersion(t.updateTime):this.fromVersion(e),i=null;return t.transformResults&&t.transformResults.length>0&&(i=t.transformResults.map(function(t){return n.fromValue(t)})),new Pc(r,i)},t.prototype.fromWriteResults=function(t,e){var n=this;return t&&t.length>0?(Ks(void 0!==e,"Received a write result without a commit time"),t.map(function(t){return n.fromWriteResult(t,e)})):[]},t.prototype.toFieldTransform=function(t){var e=this,n=t.transform;if(n instanceof Uc)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof jc)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Qc)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Kc)return{fieldPath:t.field.canonicalString(),increment:this.toValue(n.operand)};throw Qs("Unknown transform: "+t.transform)},t.prototype.fromFieldTransform=function(t){var e=this,n=t.transform_type,r=null;if(Oh(t,n,"setToServerValue"))Ks("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),r=Uc.instance;else if(Oh(t,n,"appendMissingElements")){var i=t.appendMissingElements.values||[];r=new jc(i.map(function(t){return e.fromValue(t)}))}else if(Oh(t,n,"removeAllFromArray")){i=t.removeAllFromArray.values||[];r=new Qc(i.map(function(t){return e.fromValue(t)}))}else if(Oh(t,n,"increment")){var o=this.fromValue(t.increment);Ks(o instanceof Ju,"NUMERIC_ADD transform requires a NumberValue"),r=new Kc(o)}else Qs("Unknown transform proto: "+JSON.stringify(t));var a=qu.fromServerFormat(t.fieldPath);return new Mc(a,r)},t.prototype.toDocumentsTarget=function(t){return{documents:[this.toQueryPath(t.path)]}},t.prototype.fromDocumentsTarget=function(t){var e=t.documents.length;Ks(1===e,"DocumentsTarget contained other than 1 document: "+e);var n=t.documents[0];return mc.atPath(this.fromQueryPath(n))},t.prototype.toQueryTarget=function(t){var e={structuredQuery:{}},n=t.path;null!==t.collectionGroup?(Ks(n.length%2==0,"Collection Group queries should be within a document path or root."),e.parent=this.toQueryPath(n),e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(Ks(n.length%2!=0,"Document queries with filters are not supported."),e.parent=this.toQueryPath(n.popLast()),e.structuredQuery.from=[{collectionId:n.lastSegment()}]);var r=this.toFilter(t.filters);r&&(e.structuredQuery.where=r);var i=this.toOrder(t.orderBy);i&&(e.structuredQuery.orderBy=i);var o=this.toInt32Value(t.limit);return void 0!==o&&(e.structuredQuery.limit=o),t.startAt&&(e.structuredQuery.startAt=this.toCursor(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.toCursor(t.endAt)),e},t.prototype.fromQueryTarget=function(t){var e=this.fromQueryPath(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0,i=null;if(r>0){Ks(1===r,"StructuredQuery.from with more than one collection is not supported.");var o=n.from[0];o.allDescendants?i=o.collectionId:e=e.child(o.collectionId)}var a=[];n.where&&(a=this.fromFilter(n.where));var s=[];n.orderBy&&(s=this.fromOrder(n.orderBy));var u=null;n.limit&&(u=this.fromInt32Value(n.limit));var c=null;n.startAt&&(c=this.fromCursor(n.startAt));var h=null;return n.endAt&&(h=this.fromCursor(n.endAt)),new mc(e,i,s,a,u,c,h)},t.prototype.toListenRequestLabels=function(t){var e=this.toLabel(t.purpose);return null==e?null:{"goog-listen-tags":e}},t.prototype.toLabel=function(t){switch(t){case yc.Listen:return null;case yc.ExistenceFilterMismatch:return"existence-filter-mismatch";case yc.LimboResolution:return"limbo-document";default:return Qs("Unrecognized query purpose: "+t)}},t.prototype.toTarget=function(t){var e,n=t.query;return(e=n.isDocumentQuery()?{documents:this.toDocumentsTarget(n)}:{query:this.toQueryTarget(n)}).targetId=t.targetId,t.resumeToken.length>0&&(e.resumeToken=this.unsafeCastProtoByteString(t.resumeToken)),e},t.prototype.toFilter=function(t){var e=this;if(0!==t.length){var n=t.map(function(t){return t instanceof bc?e.toRelationFilter(t):e.toUnaryFilter(t)});return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},t.prototype.fromFilter=function(t){var e=this;return t?void 0!==t.unaryFilter?[this.fromUnaryFilter(t)]:void 0!==t.fieldFilter?[this.fromRelationFilter(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(function(t){return e.fromFilter(t)}).reduce(function(t,e){return t.concat(e)}):Qs("Unknown filter: "+JSON.stringify(t)):[]},t.prototype.toOrder=function(t){var e=this;if(0!==t.length)return t.map(function(t){return e.toPropertyOrder(t)})},t.prototype.fromOrder=function(t){var e=this;return t.map(function(t){return e.fromPropertyOrder(t)})},t.prototype.toCursor=function(t){var e=this;return{before:t.before,values:t.position.map(function(t){return e.toValue(t)})}},t.prototype.fromCursor=function(t){var e=this,n=!!t.before,r=t.values.map(function(t){return e.fromValue(t)});return new Tc(r,n)},t.prototype.toDirection=function(t){return Ch[t.name]},t.prototype.fromDirection=function(t){switch(t){case"ASCENDING":return Ec.ASCENDING;case"DESCENDING":return Ec.DESCENDING;default:return}},t.prototype.toOperatorName=function(t){return Dh[t.name]},t.prototype.fromOperatorName=function(t){switch(t){case"EQUAL":return vc.EQUAL;case"GREATER_THAN":return vc.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return vc.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return vc.LESS_THAN;case"LESS_THAN_OR_EQUAL":return vc.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return vc.ARRAY_CONTAINS;case"OPERATOR_UNSPECIFIED":return Qs("Unspecified relation");default:return Qs("Unknown relation")}},t.prototype.toFieldPathReference=function(t){return{fieldPath:t.canonicalString()}},t.prototype.fromFieldPathReference=function(t){return qu.fromServerFormat(t.fieldPath)},t.prototype.toPropertyOrder=function(t){return{field:this.toFieldPathReference(t.field),direction:this.toDirection(t.dir)}},t.prototype.fromPropertyOrder=function(t){return new Ic(this.fromFieldPathReference(t.field),this.fromDirection(t.direction))},t.prototype.toRelationFilter=function(t){return t instanceof bc?{fieldFilter:{field:this.toFieldPathReference(t.field),op:this.toOperatorName(t.op),value:this.toValue(t.value)}}:Qs("Unrecognized filter: "+JSON.stringify(t))},t.prototype.fromRelationFilter=function(t){return new bc(this.fromFieldPathReference(t.fieldFilter.field),this.fromOperatorName(t.fieldFilter.op),this.fromValue(t.fieldFilter.value))},t.prototype.toUnaryFilter=function(t){return t instanceof Sc?{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NAN"}}:t instanceof wc?{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NULL"}}:Qs("Unrecognized filter: "+JSON.stringify(t))},t.prototype.fromUnaryFilter=function(t){switch(t.unaryFilter.op){case"IS_NAN":var e=this.fromFieldPathReference(t.unaryFilter.field);return new Sc(e);case"IS_NULL":var n=this.fromFieldPathReference(t.unaryFilter.field);return new wc(n);case"OPERATOR_UNSPECIFIED":return Qs("Unspecified filter");default:return Qs("Unknown filter")}},t.prototype.toDocumentMask=function(t){var e=[];return t.fields.forEach(function(t){return e.push(t.canonicalString())}),{fieldPaths:e}},t.prototype.fromDocumentMask=function(t){var e=(t.fieldPaths||[]).map(function(t){return qu.fromServerFormat(t)});return _c.fromArray(e)},t}();function Oh(t,e,n){return e===n||!e&&n in t}var _h=function(){function t(t){this.sendFn=t.sendFn,this.closeFn=t.closeFn}return t.prototype.onOpen=function(t){Ks(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=t},t.prototype.onClose=function(t){Ks(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=t},t.prototype.onMessage=function(t){Ks(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=t},t.prototype.close=function(){this.closeFn()},t.prototype.send=function(t){this.sendFn(t)},t.prototype.callOnOpen=function(){Ks(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},t.prototype.callOnClose=function(t){Ks(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(t)},t.prototype.callOnMessage=function(t){Ks(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(t)},t}(),Mh="Connection",Ph={BatchGetDocuments:"batchGet",Commit:"commit"},Lh="gl-js/ fire/"+xs,xh=function(){function t(t){this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.baseUrl=e+"://"+t.host,this.forceLongPolling=t.forceLongPolling}return t.prototype.modifyHeadersForRequest=function(t,e){if(e)for(var n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n]);t["X-Goog-Api-Client"]=Lh},t.prototype.invokeRPC=function(t,e,n){var r=this,i=this.makeUrl(t);return new Promise(function(o,a){var s=new Ls;s.listenOnce(Ms.COMPLETE,function(){try{switch(s.getLastErrorCode()){case _s.NO_ERROR:var e=s.getResponseJson();Vs(Mh,"XHR received:",JSON.stringify(e)),o(e);break;case _s.TIMEOUT:Vs(Mh,'RPC "'+t+'" timed out'),a(new Hs(zs.DEADLINE_EXCEEDED,"Request time out"));break;case _s.HTTP_ERROR:var n=s.getStatus();Vs(Mh,'RPC "'+t+'" failed with status:',n,"response text:",s.getResponseText()),n>0?a(new Hs(function(t){switch(t){case 200:return zs.OK;case 400:return zs.INVALID_ARGUMENT;case 401:return zs.UNAUTHENTICATED;case 403:return zs.PERMISSION_DENIED;case 404:return zs.NOT_FOUND;case 409:return zs.ABORTED;case 416:return zs.OUT_OF_RANGE;case 429:return zs.RESOURCE_EXHAUSTED;case 499:return zs.CANCELLED;case 500:return zs.UNKNOWN;case 501:return zs.UNIMPLEMENTED;case 503:return zs.UNAVAILABLE;case 504:return zs.DEADLINE_EXCEEDED;default:return t>=200&&t<300?zs.OK:t>=400&&t<500?zs.FAILED_PRECONDITION:t>=500&&t<600?zs.INTERNAL:zs.UNKNOWN}}(n),"Server responded with status "+s.getStatusText())):(Vs(Mh,'RPC "'+t+'" failed'),a(new Hs(zs.UNAVAILABLE,"Connection failed.")));break;default:Qs('RPC "'+t+'" failed with unanticipated webchannel error '+s.getLastErrorCode()+": "+s.getLastError()+", giving up.")}}finally{Vs(Mh,'RPC "'+t+'" completed.')}});var u=JSON.stringify(e);Vs(Mh,"XHR sending: ",i+" "+u);var c={"Content-Type":"text/plain"};r.modifyHeadersForRequest(c,n),s.send(i,"POST",u,c,15)})},t.prototype.invokeStreamingRPC=function(t,e,n){return this.invokeRPC(t,e,n)},t.prototype.openStream=function(t,e){var n=[this.baseUrl,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=Os(),i={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(i.initMessageHeaders,e),"object"==typeof navigator&&"ReactNative"===navigator.product||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");Vs(Mh,"Creating WebChannel: "+o+" "+i);var a=r.createWebChannel(o,i),s=!1,u=!1,c=new _h({sendFn:function(t){u?Vs(Mh,"Not sending because WebChannel is closed:",t):(s||(Vs(Mh,"Opening WebChannel transport."),a.open(),s=!0),Vs(Mh,"WebChannel sending:",t),a.send(t))},closeFn:function(){return a.close()}}),h=function(t,e){a.listen(t,function(t){try{e(t)}catch(t){setTimeout(function(){throw t},0)}})};return h(Ps.EventType.OPEN,function(){u||Vs(Mh,"WebChannel transport opened.")}),h(Ps.EventType.CLOSE,function(){u||(u=!0,Vs(Mh,"WebChannel transport closed"),c.callOnClose())}),h(Ps.EventType.ERROR,function(t){u||(u=!0,Vs(Mh,"WebChannel transport errored:",t),c.callOnClose(new Hs(zs.UNAVAILABLE,"The operation could not be completed")))}),h(Ps.EventType.MESSAGE,function(t){if(!u){var e=t.data[0];Ks(!!e,"Got a webchannel message without data.");var n=e.error||e[0]&&e[0].error;if(n){Vs(Mh,"WebChannel received error:",n);var r=n.status,i=function(t){var e=Wc[t];if(void 0!==e)return Yc(e)}(r),o=n.message;void 0===i&&(i=zs.INTERNAL,o="Unknown error status: "+r+" with message "+n.message),u=!0,c.callOnClose(new Hs(i,o)),a.close()}else Vs(Mh,"WebChannel received:",e),c.callOnMessage(e)}}),setTimeout(function(){c.callOnOpen()},0),c},t.prototype.makeUrl=function(t){var e=Ph[t];Ks(void 0!==e,"Unknown REST mapping for: "+t);var n=[this.baseUrl,"/","v1"];return n.push("/projects/"),n.push(this.databaseId.projectId),n.push("/databases/"),n.push(this.databaseId.database),n.push("/documents"),n.push(":"),n.push(e),n.join("")},t}(),qh=function(){function t(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}return Object.defineProperty(t.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),t.prototype.loadConnection=function(t){return Promise.resolve(new xh(t))},t.prototype.newSerializer=function(t){return new Rh(t,{useProto3Json:!0})},t.prototype.formatJSON=function(t){return JSON.stringify(t)},t.prototype.atob=function(t){return atob(t)},t.prototype.btoa=function(t){return btoa(t)},t}();Gs.setPlatform(new qh);var Fh,Bh=function(){function t(t,e){var n=this;this.previousValue=t,e&&(e.sequenceNumberHandler=function(t){return n.setPreviousValue(t)},this.writeNewSequenceNumber=function(t){return e.writeSequenceNumber(t)})}return t.prototype.setPreviousValue=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},t.prototype.next=function(){var t=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(t),t},t.INVALID=-1,t}(),Vh=function(){return function(){var t=this;this.promise=new Promise(function(e,n){t.resolve=e,t.reject=n})}}();!function(t){t.All="all",t.ListenStreamIdle="listen_stream_idle",t.ListenStreamConnectionBackoff="listen_stream_connection_backoff",t.WriteStreamIdle="write_stream_idle",t.WriteStreamConnectionBackoff="write_stream_connection_backoff",t.OnlineStateTimeout="online_state_timeout",t.ClientMetadataRefresh="client_metadata_refresh",t.LruGarbageCollection="lru_garbage_collection"}(Fh||(Fh={}));var Uh=function(){function t(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Vh,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(t){})}return t.createAndSchedule=function(e,n,r,i,o){var a=new t(e,n,Date.now()+r,i,o);return a.start(r),a},t.prototype.start=function(t){var e=this;this.timerHandle=setTimeout(function(){return e.handleDelayElapsed()},t)},t.prototype.skipDelay=function(){return this.handleDelayElapsed()},t.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Hs(zs.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},t.prototype.handleDelayElapsed=function(){var t=this;this.asyncQueue.enqueueAndForget(function(){return null!==t.timerHandle?(t.clearTimeout(),t.op().then(function(e){return t.deferred.resolve(e)})):Promise.resolve()})},t.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},t}(),jh=function(){function t(){this.tail=Promise.resolve(),this.delayedOperations=[],this.operationInProgress=!1}return t.prototype.enqueueAndForget=function(t){this.enqueue(t)},t.prototype.enqueue=function(t){var e=this;this.verifyNotFailed();var n=this.tail.then(function(){return e.operationInProgress=!0,t().catch(function(t){e.failure=t,e.operationInProgress=!1;var n=t.stack||t.message||"";throw Us("INTERNAL UNHANDLED ERROR: ",n),n.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw t},0),t}).then(function(t){return e.operationInProgress=!1,t})});return this.tail=n,n},t.prototype.enqueueAfterDelay=function(t,e,n){var r=this;this.verifyNotFailed(),Ks(e>=0,"Attempted to schedule an operation with a negative delay of "+e),Ks(!this.containsDelayedOperation(t),"Attempted to schedule multiple operations with timer id "+t+".");var i=Uh.createAndSchedule(this,t,e,n,function(t){return r.removeDelayedOperation(t)});return this.delayedOperations.push(i),i},t.prototype.verifyNotFailed=function(){this.failure&&Qs("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},t.prototype.verifyOperationInProgress=function(){Ks(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},t.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})},t.prototype.containsDelayedOperation=function(t){for(var e=0,n=this.delayedOperations;e<n.length;e++){if(n[e].timerId===t)return!0}return!1},t.prototype.runDelayedOperationsEarly=function(t){var e=this;return this.drain().then(function(){Ks(t===Fh.All||e.containsDelayedOperation(t),"Attempted to drain to missing operation "+t),e.delayedOperations.sort(function(t,e){return t.targetTimeMs-e.targetTimeMs});for(var n=0,r=e.delayedOperations;n<r.length;n++){var i=r[n];if(i.skipDelay(),t!==Fh.All&&i.timerId===t)break}return e.drain()})},t.prototype.removeDelayedOperation=function(t){var e=this.delayedOperations.indexOf(t);Ks(e>=0,"Delayed operation not found."),this.delayedOperations.splice(e,1)},t}(),Qh="",Kh="",Gh="",Wh="";function zh(t){for(var e="",n=0;n<t.length;n++)e.length>0&&(e=Yh(e)),e=Hh(t.get(n),e);return Yh(e)}function Hh(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var o=t.charAt(i);switch(o){case"\0":n+=Qh+Gh;break;case Qh:n+=Qh+Wh;break;default:n+=o}}return n}function Yh(t){return t+Qh+Kh}function Xh(t){var e=t.length;if(Ks(e>=2,"Invalid path "+t),2===e)return Ks(t.charAt(0)===Qh&&t.charAt(1)===Kh,"Non-empty path "+t+" had length 2"),Lu.EMPTY_PATH;for(var n=e-2,r=[],i="",o=0;o<e;){var a=t.indexOf(Qh,o);switch((a<0||a>n)&&Qs('Invalid encoded resource path: "'+t+'"'),t.charAt(a+1)){case Kh:var s=t.substring(o,a),u=void 0;0===i.length?u=s:(u=i+=s,i=""),r.push(u);break;case Gh:i+=t.substring(o,a),i+="\0";break;case Wh:i+=t.substring(o,a+1);break;default:Qs('Invalid encoded resource path: "'+t+'"')}o=a+2}return new Lu(r)}var Jh=function(){function t(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r,Ks(r.length>0,"Cannot create an empty mutation batch")}return t.prototype.applyToRemoteDocument=function(t,e,n){e&&Ks(e.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+e.key);var r=n.mutationResults;Ks(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o=this.mutations[i];if(o.key.isEqual(t)){var a=r[i];e=o.applyToRemoteDocument(e,a)}}return e},t.prototype.applyToLocalView=function(t,e){e&&Ks(e.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+e.key);for(var n=0,r=this.baseMutations;n<r.length;n++){(s=r[n]).key.isEqual(t)&&(e=s.applyToLocalView(e,e,this.localWriteTime))}for(var i=e,o=0,a=this.mutations;o<a.length;o++){var s;(s=a[o]).key.isEqual(t)&&(e=s.applyToLocalView(e,i,this.localWriteTime))}return e},t.prototype.applyToLocalDocumentSet=function(t){var e=this,n=t;return this.mutations.forEach(function(r){var i=e.applyToLocalView(r.key,t.get(r.key));i&&(n=n.insert(r.key,i))}),n},t.prototype.keys=function(){return this.mutations.reduce(function(t,e){return t.add(e.key)},oh())},t.prototype.isEqual=function(t){return this.batchId===t.batchId&&Su(this.mutations,t.mutations)&&Su(this.baseMutations,t.baseMutations)},t}(),$h=function(){function t(t,e,n,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.streamToken=r,this.docVersions=i}return t.from=function(e,n,r,i){Ks(e.mutations.length===r.length,"Mutations sent "+e.mutations.length+" must equal results received "+r.length);for(var o=rh(),a=e.mutations,s=0;s<a.length;s++)o=o.insert(a[s].key,r[s].version);return new t(e,n,r,i,o)},t}(),Zh=function(){function t(t){var e=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(function(t){e.isDone=!0,e.result=t,e.nextCallback&&e.nextCallback(t)},function(t){e.isDone=!0,e.error=t,e.catchCallback&&e.catchCallback(t)})}return t.prototype.catch=function(t){return this.next(void 0,t)},t.prototype.next=function(e,n){var r=this;return this.callbackAttached&&Qs("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(n,this.error):this.wrapSuccess(e,this.result):new t(function(t,i){r.nextCallback=function(n){r.wrapSuccess(e,n).next(t,i)},r.catchCallback=function(e){r.wrapFailure(n,e).next(t,i)}})},t.prototype.toPromise=function(){var t=this;return new Promise(function(e,n){t.next(e,n)})},t.prototype.wrapUserFunction=function(e){try{var n=e();return n instanceof t?n:t.resolve(n)}catch(e){return t.reject(e)}},t.prototype.wrapSuccess=function(e,n){return e?this.wrapUserFunction(function(){return e(n)}):t.resolve(n)},t.prototype.wrapFailure=function(e,n){return e?this.wrapUserFunction(function(){return e(n)}):t.reject(n)},t.resolve=function(e){return new t(function(t,n){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},t.waitFor=function(e){return new t(function(t,n){var r=0,i=0,o=!1;e.forEach(function(e){++r,e.next(function(){++i,o&&i===r&&t()},function(t){return n(t)})}),o=!0,i===r&&t()})},t.or=function(e){for(var n=t.resolve(!1),r=function(e){n=n.next(function(n){return n?t.resolve(n):e()})},i=0,o=e;i<o.length;i++){r(o[i])}return n},t.forEach=function(t,e){var n=this,r=[];return t.forEach(function(t,i){r.push(e.call(n,t,i))}),this.waitFor(r)},t}(),tl=function(){function t(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.documentKeysByBatchId={}}return t.forUser=function(e,n,r,i){return Ks(""!==e.uid,"UserID must not be an empty string."),new t(e.isAuthenticated()?e.uid:"",n,r,i)},t.prototype.checkEmpty=function(t){var e=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return il(t).iterate({index:ql.userMutationsIndex,range:n},function(t,n,r){e=!1,r.done()}).next(function(){return e})},t.prototype.acknowledgeBatch=function(t,e,n){return this.getMutationQueueMetadata(t).next(function(e){return e.lastStreamToken=rl(n),al(t).put(e)})},t.prototype.getLastStreamToken=function(t){return this.getMutationQueueMetadata(t).next(function(t){return t.lastStreamToken})},t.prototype.setLastStreamToken=function(t,e){return this.getMutationQueueMetadata(t).next(function(n){return n.lastStreamToken=rl(e),al(t).put(n)})},t.prototype.addMutationBatch=function(t,e,n,r){var i=this,o=ol(t),a=il(t);return a.add({}).next(function(s){Ks("number"==typeof s,"Auto-generated key is not a number");var u=new Jh(s,e,n,r),c=i.serializer.toDbMutationBatch(i.userId,u);i.documentKeysByBatchId[s]=u.keys();for(var h=[],l=0,f=r;l<f.length;l++){var p=f[l],d=Fl.key(i.userId,p.key.path,s);h.push(a.put(c)),h.push(o.put(d,Fl.PLACEHOLDER)),h.push(i.indexManager.addToCollectionParentIndex(t,p.key.path.popLast()))}return Zh.waitFor(h).next(function(){return u})})},t.prototype.lookupMutationBatch=function(t,e){var n=this;return il(t).get(e).next(function(t){return t?(Ks(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),n.serializer.fromDbMutationBatch(t)):null})},t.prototype.lookupMutationKeys=function(t,e){var n=this;return this.documentKeysByBatchId[e]?Zh.resolve(this.documentKeysByBatchId[e]):this.lookupMutationBatch(t,e).next(function(t){if(t){var r=t.keys();return n.documentKeysByBatchId[e]=r,r}return null})},t.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=this;return this.getMutationQueueMetadata(t).next(function(r){var i=e+1,o=IDBKeyRange.lowerBound([n.userId,i]),a=null;return il(t).iterate({index:ql.userMutationsIndex,range:o},function(t,e,r){e.userId===n.userId&&(Ks(e.batchId>=i,"Should have found mutation after "+i),a=n.serializer.fromDbMutationBatch(e)),r.done()}).next(function(){return a})})},t.prototype.getAllMutationBatches=function(t){var e=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return il(t).loadAll(ql.userMutationsIndex,n).next(function(t){return t.map(function(t){return e.serializer.fromDbMutationBatch(t)})})},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=Fl.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=[];return ol(t).iterate({range:i},function(r,i,a){var s=r[0],u=r[1],c=r[2],h=Xh(u);if(s===n.userId&&e.path.isEqual(h))return il(t).get(c).next(function(t){if(!t)throw Qs("Dangling document-mutation reference found: "+r+" which points to "+c);Ks(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+c),o.push(n.serializer.fromDbMutationBatch(t))});a.done()}).next(function(){return o})},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new Rc(wu),i=[];return e.forEach(function(e){var o=Fl.prefixForPath(n.userId,e.path),a=IDBKeyRange.lowerBound(o),s=ol(t).iterate({range:a},function(t,i,o){var a=t[0],s=t[1],u=t[2],c=Xh(s);a===n.userId&&e.path.isEqual(c)?r=r.add(u):o.done()});i.push(s)}),Zh.waitFor(i).next(function(){return n.lookupMutationBatches(t,r)})},t.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var n=this;Ks(!e.isDocumentQuery(),"Document queries shouldn't go down this path"),Ks(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var r=e.path,i=r.length+1,o=Fl.prefixForPath(this.userId,r),a=IDBKeyRange.lowerBound(o),s=new Rc(wu);return ol(t).iterate({range:a},function(t,e,o){var a=t[0],u=t[1],c=t[2],h=Xh(u);a===n.userId&&r.isPrefixOf(h)?h.length===i&&(s=s.add(c)):o.done()}).next(function(){return n.lookupMutationBatches(t,s)})},t.prototype.lookupMutationBatches=function(t,e){var n=this,r=[],i=[];return e.forEach(function(e){i.push(il(t).get(e).next(function(t){if(null===t)throw Qs("Dangling document-mutation reference found, which points to "+e);Ks(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),r.push(n.serializer.fromDbMutationBatch(t))}))}),Zh.waitFor(i).next(function(){return r})},t.prototype.removeMutationBatch=function(t,e){var n=this;return nl(t.simpleDbTransaction,this.userId,e).next(function(r){return n.removeCachedMutationKeys(e.batchId),Zh.forEach(r,function(e){return n.referenceDelegate.removeMutationReference(t,e)})})},t.prototype.removeCachedMutationKeys=function(t){delete this.documentKeysByBatchId[t]},t.prototype.performConsistencyCheck=function(t){var e=this;return this.checkEmpty(t).next(function(n){if(!n)return Zh.resolve();var r=IDBKeyRange.lowerBound(Fl.prefixForUser(e.userId)),i=[];return ol(t).iterate({range:r},function(t,n,r){if(t[0]===e.userId){var o=Xh(t[1]);i.push(o)}else r.done()}).next(function(){Ks(0===i.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+i.map(function(t){return t.canonicalString()}))})})},t.prototype.containsKey=function(t,e){return el(t,this.userId,e)},t.prototype.getMutationQueueMetadata=function(t){var e=this;return al(t).get(this.userId).next(function(t){return t||new xl(e.userId,-1,"")})},t}();function el(t,e,n){var r=Fl.prefixForPath(e,n.path),i=r[1],o=IDBKeyRange.lowerBound(r),a=!1;return ol(t).iterate({range:o,keysOnly:!0},function(t,n,r){var o=t[0],s=t[1];t[2];o===e&&s===i&&(a=!0),r.done()}).next(function(){return a})}function nl(t,e,n){var r=t.store(ql.store),i=t.store(Fl.store),o=[],a=IDBKeyRange.only(n.batchId),s=0,u=r.iterate({range:a},function(t,e,n){return s++,n.delete()});o.push(u.next(function(){Ks(1===s,"Dangling document-mutation reference found: Missing batch "+n.batchId)}));for(var c=[],h=0,l=n.mutations;h<l.length;h++){var f=l[h],p=Fl.key(e,f.key.path,n.batchId);o.push(i.delete(p)),c.push(f.key)}return Zh.waitFor(o).next(function(){return c})}function rl(t){return t instanceof Uint8Array?(Ks("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function il(t){return pf.getStore(t,ql.store)}function ol(t){return pf.getStore(t,Fl.store)}function al(t){return pf.getStore(t,xl.store)}var sl,ul=1;!function(t){t[t.QueryCache=0]="QueryCache",t[t.SyncEngine=1]="SyncEngine"}(sl||(sl={}));var cl=function(){function t(t,e){this.generatorId=t,Ks((t&ul)===t,"Generator ID "+t+" contains more than "+ul+" reserved bits"),this.seek(void 0!==e?e:this.generatorId)}return t.prototype.next=function(){var t=this.nextId;return this.nextId+=1<<ul,t},t.prototype.after=function(t){return this.seek(t+(1<<ul)),this.next()},t.prototype.seek=function(t){Ks((t&ul)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=t},t.forQueryCache=function(){return new t(sl.QueryCache,2)},t.forSyncEngine=function(){return new t(sl.SyncEngine)},t}(),hl=function(){function t(t){this.db=t}return t.openOrCreate=function(e,n,r){return Ks(t.isAvailable(),"IndexedDB not supported in current environment."),Vs("SimpleDb","Opening database:",e),new Zh(function(i,o){var a=window.indexedDB.open(e,n);a.onsuccess=function(e){var n=e.target.result;i(new t(n))},a.onblocked=function(){o(new Hs(zs.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},a.onerror=function(t){var e=t.target.error;"VersionError"===e.name?o(new Hs(zs.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o(e)},a.onupgradeneeded=function(t){Vs("SimpleDb",'Database "'+e+'" requires upgrade from version:',t.oldVersion);var n=t.target.result,i=new fl(a.transaction);r.createOrUpgrade(n,i,t.oldVersion,_l).next(function(){Vs("SimpleDb","Database upgrade to version "+_l+" complete")})}}).toPromise()},t.delete=function(t){return Vs("SimpleDb","Removing database:",t),dl(window.indexedDB.deleteDatabase(t)).toPromise()},t.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var e=window.navigator.userAgent,n=t.getIOSVersion(e),r=0<n&&n<10,i=t.getAndroidVersion(e),o=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||o)},t.getStore=function(t,e){return t.store(e)},t.getIOSVersion=function(t){var e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_")[0]:"-1";return Number(n)},t.getAndroidVersion=function(t){var e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)},t.prototype.runTransaction=function(t,e,n){var r=fl.open(this.db,t,e),i=n(r).catch(function(t){return r.abort(t),Zh.reject(t)}).toPromise();return i.catch(function(){}),r.completionPromise.then(function(){return i})},t.prototype.close=function(){this.db.close()},t}(),ll=function(){function t(t){this.dbCursor=t,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(t.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cursor",{set:function(t){this.dbCursor=t},enumerable:!0,configurable:!0}),t.prototype.done=function(){this.shouldStop=!0},t.prototype.skip=function(t){this.nextKey=t},t.prototype.delete=function(){return dl(this.dbCursor.delete())},t}(),fl=function(){function t(t){var e=this;this.transaction=t,this.aborted=!1,this.completionDeferred=new Vh,this.transaction.oncomplete=function(){e.completionDeferred.resolve()},this.transaction.onabort=function(){t.error?e.completionDeferred.reject(t.error):e.completionDeferred.resolve()},this.transaction.onerror=function(t){e.completionDeferred.reject(t.target.error)}}return t.open=function(e,n,r){return new t(e.transaction(r,n))},Object.defineProperty(t.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),t.prototype.abort=function(t){t&&this.completionDeferred.reject(t),this.aborted||(Vs("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},t.prototype.store=function(t){var e=this.transaction.objectStore(t);return Ks(!!e,"Object store not part of transaction: "+t),new pl(e)},t}(),pl=function(){function t(t){this.store=t}return t.prototype.put=function(t,e){var n;return void 0!==e?(Vs("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(Vs("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),dl(n)},t.prototype.add=function(t){return Vs("SimpleDb","ADD",this.store.name,t,t),dl(this.store.add(t))},t.prototype.get=function(t){var e=this;return dl(this.store.get(t)).next(function(n){return void 0===n&&(n=null),Vs("SimpleDb","GET",e.store.name,t,n),n})},t.prototype.delete=function(t){return Vs("SimpleDb","DELETE",this.store.name,t),dl(this.store.delete(t))},t.prototype.count=function(){return Vs("SimpleDb","COUNT",this.store.name),dl(this.store.count())},t.prototype.loadAll=function(t,e){var n=this.cursor(this.options(t,e)),r=[];return this.iterateCursor(n,function(t,e){r.push(e)}).next(function(){return r})},t.prototype.deleteAll=function(t,e){Vs("SimpleDb","DELETE ALL",this.store.name);var n=this.options(t,e);n.keysOnly=!1;var r=this.cursor(n);return this.iterateCursor(r,function(t,e,n){return n.delete()})},t.prototype.iterate=function(t,e){var n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.iterateCursor(r,e)},t.prototype.iterateSerial=function(t){var e=this.cursor({});return new Zh(function(n,r){e.onerror=function(t){r(t.target.error)},e.onsuccess=function(e){var r=e.target.result;r?t(r.primaryKey,r.value).next(function(t){t?r.continue():n()}):n()}})},t.prototype.iterateCursor=function(t,e){var n=[];return new Zh(function(r,i){t.onerror=function(t){i(t.target.error)},t.onsuccess=function(t){var i=t.target.result;if(i){var o=new ll(i),a=e(i.primaryKey,i.value,o);if(a instanceof Zh){var s=a.catch(function(t){return o.done(),Zh.reject(t)});n.push(s)}o.isDone?r():null===o.skipToKey?i.continue():i.continue(o.skipToKey)}else r()}}).next(function(){return Zh.waitFor(n)})},t.prototype.options=function(t,e){var n=void 0;return void 0!==t&&("string"==typeof t?n=t:(Ks(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:n,range:e}},t.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.keysOnly?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},t}();function dl(t){return new Zh(function(e,n){t.onsuccess=function(t){var n=t.target.result;e(n)},t.onerror=function(t){n(t.target.error)}})}var yl=function(){function t(t,e){this.referenceDelegate=t,this.serializer=e,this.targetIdGenerator=cl.forQueryCache()}return t.prototype.allocateTargetId=function(t){var e=this;return this.retrieveMetadata(t).next(function(n){return n.highestTargetId=e.targetIdGenerator.after(n.highestTargetId),e.saveMetadata(t,n).next(function(){return n.highestTargetId})})},t.prototype.getLastRemoteSnapshotVersion=function(t){return this.retrieveMetadata(t).next(function(t){return Ac.fromTimestamp(new Ru(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))})},t.prototype.getHighestSequenceNumber=function(t){return vl(t.simpleDbTransaction)},t.prototype.setTargetsMetadata=function(t,e,n){var r=this;return this.retrieveMetadata(t).next(function(i){return i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),r.saveMetadata(t,i)})},t.prototype.addQueryData=function(t,e){var n=this;return this.saveQueryData(t,e).next(function(){return n.retrieveMetadata(t).next(function(r){return r.targetCount+=1,n.updateMetadataFromQueryData(e,r),n.saveMetadata(t,r)})})},t.prototype.updateQueryData=function(t,e){return this.saveQueryData(t,e)},t.prototype.removeQueryData=function(t,e){var n=this;return this.removeMatchingKeysForTargetId(t,e.targetId).next(function(){return ml(t).delete(e.targetId)}).next(function(){return n.retrieveMetadata(t)}).next(function(e){return Ks(e.targetCount>0,"Removing from an empty query cache"),e.targetCount-=1,n.saveMetadata(t,e)})},t.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return ml(t).iterate(function(a,s){var u=r.serializer.fromDbTarget(s);u.sequenceNumber<=e&&void 0===n[u.targetId]&&(i++,o.push(r.removeQueryData(t,u)))}).next(function(){return Zh.waitFor(o)}).next(function(){return i})},t.prototype.forEachTarget=function(t,e){var n=this;return ml(t).iterate(function(t,r){var i=n.serializer.fromDbTarget(r);e(i)})},t.prototype.retrieveMetadata=function(t){return gl(t.simpleDbTransaction)},t.prototype.saveMetadata=function(t,e){return(n=t,pf.getStore(n,Gl.store)).put(Gl.key,e);var n},t.prototype.saveQueryData=function(t,e){return ml(t).put(this.serializer.toDbTarget(e))},t.prototype.updateMetadataFromQueryData=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},t.prototype.getQueryCount=function(t){return this.retrieveMetadata(t).next(function(t){return t.targetCount})},t.prototype.getQueryData=function(t,e){var n=this,r=e.canonicalId(),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),o=null;return ml(t).iterate({range:i,index:Ql.queryTargetsIndexName},function(t,r,i){var a=n.serializer.fromDbTarget(r);e.isEqual(a.query)&&(o=a,i.done())}).next(function(){return o})},t.prototype.addMatchingKeys=function(t,e,n){var r=this,i=[],o=bl(t);return e.forEach(function(e){var a=zh(e.path);i.push(o.put(new Kl(n,a))),i.push(r.referenceDelegate.addReference(t,e))}),Zh.waitFor(i)},t.prototype.removeMatchingKeys=function(t,e,n){var r=this,i=bl(t);return Zh.forEach(e,function(e){var o=zh(e.path);return Zh.waitFor([i.delete([n,o]),r.referenceDelegate.removeReference(t,e)])})},t.prototype.removeMatchingKeysForTargetId=function(t,e){var n=bl(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)},t.prototype.getMatchingKeysForTargetId=function(t,e){var n=IDBKeyRange.bound([e],[e+1],!1,!0),r=bl(t),i=oh();return r.iterate({range:n,keysOnly:!0},function(t,e,n){var r=Xh(t[1]),o=new Fu(r);i=i.add(o)}).next(function(){return i})},t.prototype.containsKey=function(t,e){var n=zh(e.path),r=IDBKeyRange.bound([n],[Eu(n)],!1,!0),i=0;return bl(t).iterate({index:Kl.documentTargetsIndex,keysOnly:!0,range:r},function(t,e,n){var r=t[0];t[1];0!==r&&(i++,n.done())}).next(function(){return i>0})},t.prototype.getQueryDataForTarget=function(t,e){var n=this;return ml(t).get(e).next(function(t){return t?n.serializer.fromDbTarget(t):null})},t}();function ml(t){return pf.getStore(t,Ql.store)}function gl(t){return hl.getStore(t,Gl.store).get(Gl.key).next(function(t){return Ks(null!==t,"Missing metadata row."),t})}function vl(t){return gl(t).next(function(t){return t.highestListenSequenceNumber})}function bl(t){return pf.getStore(t,Kl.store)}var wl=function(){function t(t){this.mapKeyFn=t,this.inner={}}return t.prototype.get=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];if(a.isEqual(t))return s}},t.prototype.has=function(t){return void 0!==this.get(t)},t.prototype.set=function(t,e){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(t))return void(r[i]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]},t.prototype.delete=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1},t.prototype.forEach=function(t){Zs(this.inner,function(e,n){for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];t(a,s)}})},t.prototype.isEmpty=function(){return tu(this.inner)},t}(),Sl=function(){function t(){this.changes=$c(),this.documentSizes=new wl(function(t){return t.toString()})}return t.prototype.addEntry=function(t){var e=this.assertChanges();this.changes=e.insert(t.key,t)},t.prototype.getEntry=function(t,e){var n=this,r=this.assertChanges().get(e);return r?Zh.resolve(r):this.getFromCache(t,e).next(function(t){return null===t?(n.documentSizes.set(e,0),null):(n.documentSizes.set(e,t.size),t.maybeDocument)})},t.prototype.getEntries=function(t,e){var n=this;return this.getAllFromCache(t,e).next(function(t){var e=t.maybeDocuments;return t.sizeMap.forEach(function(t,e){n.documentSizes.set(t,e)}),e})},t.prototype.apply=function(t){var e=this.applyChanges(t);return this.changes=null,e},t.prototype.assertChanges=function(){return Ks(null!==this.changes,"Changes have already been applied."),this.changes},t}(),El="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",Tl=function(){function t(t,e,n){this.serializer=t,this.indexManager=e,this.keepDocumentChangeLog=n,this._lastProcessedDocumentChangeId=0}return Object.defineProperty(t.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),t.prototype.start=function(t){var e=hl.getStore(t,Hl.store);return this.synchronizeLastDocumentChangeId(e)},t.prototype.addEntries=function(t,e,n){var r=[];if(e.length>0){for(var i=Dl(t),o=oh(),a=0,s=e;a<s.length;a++){var u=s[a],c=u.key,h=u.doc;r.push(i.put(Nl(c),h)),o=o.add(c),r.push(this.indexManager.addToCollectionParentIndex(t,c.path.popLast()))}this.keepDocumentChangeLog&&r.push(Al(t).put({changes:this.serializer.toDbResourcePaths(o)})),r.push(this.updateSize(t,n))}return Zh.waitFor(r)},t.prototype.removeEntry=function(t,e){var n=Dl(t),r=Nl(e);return n.get(r).next(function(t){return t?n.delete(r).next(function(){return kl(t)}):Zh.resolve(0)})},t.prototype.getEntry=function(t,e){var n=this;return Dl(t).get(Nl(e)).next(function(t){return t?n.serializer.fromDbRemoteDocument(t):null})},t.prototype.getSizedEntry=function(t,e){var n=this;return Dl(t).get(Nl(e)).next(function(t){return t?{maybeDocument:n.serializer.fromDbRemoteDocument(t),size:kl(t)}:null})},t.prototype.getEntries=function(t,e){var n=this,r=Zc();return this.forEachDbEntry(t,e,function(t,e){r=e?r.insert(t,n.serializer.fromDbRemoteDocument(e)):r.insert(t,null)}).next(function(){return r})},t.prototype.getSizedEntries=function(t,e){var n=this,r=Zc(),i=new Qu(Fu.comparator);return this.forEachDbEntry(t,e,function(t,e){e?(r=r.insert(t,n.serializer.fromDbRemoteDocument(e)),i=i.insert(t,kl(e))):(r=r.insert(t,null),i=i.insert(t,0))}).next(function(){return{maybeDocuments:r,sizeMap:i}})},t.prototype.forEachDbEntry=function(t,e,n){if(e.isEmpty())return Zh.resolve();var r=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),i=e.getIterator(),o=i.getNext();return Dl(t).iterate({range:r},function(t,e,r){for(var a=Fu.fromSegments(t);o&&Fu.comparator(o,a)<0;)n(o,null),o=i.getNext();o&&o.isEqual(a)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.skip(o.path.toArray()):r.done()}).next(function(){for(;o;)n(o,null),o=i.hasNext()?i.getNext():null})},t.prototype.getDocumentsMatchingQuery=function(t,e){var n=this;Ks(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var r=eh(),i=e.path.length+1,o=e.path.toArray(),a=IDBKeyRange.lowerBound(o);return Dl(t).iterate({range:a},function(t,o,a){if(t.length===i){var s=n.serializer.fromDbRemoteDocument(o);e.path.isPrefixOf(s.key.path)?s instanceof Vu&&e.matches(s)&&(r=r.insert(s.key,s)):a.done()}}).next(function(){return r})},t.prototype.getNewDocumentChanges=function(t){var e=this;Ks(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var n=oh(),r=$c(),i=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),o=!0,a=Al(t);return a.iterate({range:i},function(t,r){if(o&&(o=!1,e._lastProcessedDocumentChangeId+1!==r.id))return e.synchronizeLastDocumentChangeId(a).next(function(){return Zh.reject(new Hs(zs.DATA_LOSS,El))});n=n.unionWith(e.serializer.fromDbResourcePaths(r.changes)),e._lastProcessedDocumentChangeId=r.id}).next(function(){var i=[];return n.forEach(function(n){i.push(e.getEntry(t,n).next(function(t){var e=t||new Uu(n,Ac.forDeletedDoc());r=r.insert(n,e)}))}),Zh.waitFor(i)}).next(function(){return r})},t.prototype.removeDocumentChangesThroughChangeId=function(t,e){var n=IDBKeyRange.upperBound(e);return Al(t).delete(n)},t.prototype.synchronizeLastDocumentChangeId=function(t){var e=this;return this._lastProcessedDocumentChangeId=0,t.iterate({keysOnly:!0,reverse:!0},function(t,n,r){e._lastProcessedDocumentChangeId=t,r.done()})},t.prototype.newChangeBuffer=function(){return new Cl(this)},t.prototype.getSize=function(t){return this.getMetadata(t).next(function(t){return t.byteSize})},t.prototype.getMetadata=function(t){return Il(t).get(jl.key).next(function(t){return Ks(!!t,"Missing document cache metadata"),t})},t.prototype.setMetadata=function(t,e){return Il(t).put(jl.key,e)},t.prototype.updateSize=function(t,e){var n=this;return this.getMetadata(t).next(function(r){return r.byteSize+=e,n.setMetadata(t,r)})},t}();function Il(t){return pf.getStore(t,jl.store)}var Cl=function(t){function e(e){var n=t.call(this)||this;return n.documentCache=e,n}return Jn(e,t),e.prototype.applyChanges=function(t){var e=this,n=this.assertChanges(),r=0,i=[];return n.forEach(function(t,n){var o=e.documentCache.serializer.toDbRemoteDocument(n),a=e.documentSizes.get(t);Ks(void 0!==a,"Attempting to change document "+t.toString()+" without having read it first");var s=kl(o);r+=s-a,i.push({key:t,doc:o})}),this.documentCache.addEntries(t,i,r)},e.prototype.getFromCache=function(t,e){return this.documentCache.getSizedEntry(t,e)},e.prototype.getAllFromCache=function(t,e){return this.documentCache.getSizedEntries(t,e)},e}(Sl);function Dl(t){return pf.getStore(t,Ul.store)}function Al(t){return pf.getStore(t,Hl.store)}function Nl(t){return t.path.toArray()}function kl(t){var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Qs("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}var Rl=function(){function t(){this.collectionParentIndex=new Ol}return t.prototype.addToCollectionParentIndex=function(t,e){return this.collectionParentIndex.add(e),Zh.resolve()},t.prototype.getCollectionParents=function(t,e){return Zh.resolve(this.collectionParentIndex.getEntries(e))},t}(),Ol=function(){function t(){this.index={}}return t.prototype.add=function(t){Ks(t.length%2==1,"Expected a collection path.");var e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Rc(Lu.comparator),i=!r.has(n);return this.index[e]=r.add(n),i},t.prototype.getEntries=function(t){return(this.index[t]||new Rc(Lu.comparator)).toArray()},t}(),_l=8,Ml=function(){function t(t){this.serializer=t}return t.prototype.createOrUpgrade=function(t,e,n,r){var i=this;Ks(n<r&&n>=0&&r<=_l,"Unexpected schema upgrade from v"+n+" to v{toVersion}."),n<1&&r>=1&&(function(t){t.createObjectStore(Ll.store)}(t),function(t){t.createObjectStore(xl.store,{keyPath:xl.keyPath}),t.createObjectStore(ql.store,{keyPath:ql.keyPath,autoIncrement:!0}).createIndex(ql.userMutationsIndex,ql.userMutationsKeyPath,{unique:!0}),t.createObjectStore(Fl.store)}(t),zl(t),function(t){t.createObjectStore(Ul.store)}(t));var o=Zh.resolve();return n<3&&r>=3&&(0!==n&&(!function(t){t.deleteObjectStore(Kl.store),t.deleteObjectStore(Ql.store),t.deleteObjectStore(Gl.store)}(t),zl(t)),o=o.next(function(){return function(t){var e=t.store(Gl.store),n=new Gl(0,0,Ac.MIN.toTimestamp(),0);return e.put(Gl.key,n)}(e)})),n<4&&r>=4&&(0!==n&&(o=o.next(function(){return function(t,e){return e.store(ql.store).loadAll().next(function(n){t.deleteObjectStore(ql.store);var r=t.createObjectStore(ql.store,{keyPath:ql.keyPath,autoIncrement:!0});r.createIndex(ql.userMutationsIndex,ql.userMutationsKeyPath,{unique:!0});var i=e.store(ql.store),o=n.map(function(t){return i.put(t)});return Zh.waitFor(o)})}(t,e)})),o=o.next(function(){!function(t){t.createObjectStore(Yl.store,{keyPath:Yl.keyPath})}(t),function(t){t.createObjectStore(Hl.store,{keyPath:"id",autoIncrement:!0})}(t)})),n<5&&r>=5&&(o=o.next(function(){return i.removeAcknowledgedMutations(e)})),n<6&&r>=6&&(o=o.next(function(){return function(t){t.createObjectStore(jl.store)}(t),i.addDocumentGlobal(e)})),n<7&&r>=7&&(o=o.next(function(){return i.ensureSequenceNumbers(e)})),n<8&&r>=8&&(o=o.next(function(){return i.createCollectionParentIndex(t,e)})),o},t.prototype.addDocumentGlobal=function(t){var e=0;return t.store(Ul.store).iterate(function(t,n){e+=kl(n)}).next(function(){var n=new jl(e);return t.store(jl.store).put(jl.key,n)})},t.prototype.removeAcknowledgedMutations=function(t){var e=this,n=t.store(xl.store),r=t.store(ql.store);return n.loadAll().next(function(n){return Zh.forEach(n,function(n){var i=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return r.loadAll(ql.userMutationsIndex,i).next(function(r){return Zh.forEach(r,function(r){Ks(r.userId===n.userId,"Cannot process batch "+r.batchId+" from unexpected user");var i=e.serializer.fromDbMutationBatch(r);return nl(t,n.userId,i).next(function(){})})})})})},t.prototype.ensureSequenceNumbers=function(t){var e=t.store(Kl.store),n=t.store(Ul.store);return vl(t).next(function(t){var r=[];return n.iterate(function(n,i){var o=new Lu(n),a=function(t){return[0,zh(t)]}(o);r.push(e.get(a).next(function(n){return n?Zh.resolve():function(n){return e.put(new Kl(0,zh(n),t))}(o)}))}).next(function(){return Zh.waitFor(r)})})},t.prototype.createCollectionParentIndex=function(t,e){t.createObjectStore(Wl.store,{keyPath:Wl.keyPath});var n=e.store(Wl.store),r=new Ol,i=function(t){if(r.add(t)){var e=t.lastSegment(),i=t.popLast();return n.put({collectionId:e,parent:zh(i)})}};return e.store(Ul.store).iterate({keysOnly:!0},function(t,e){var n=new Lu(t);return i(n.popLast())}).next(function(){return e.store(Fl.store).iterate({keysOnly:!0},function(t,e){t[0];var n=t[1],r=(t[2],Xh(n));return i(r.popLast())})})},t}();var Pl=function(){return function(t,e){this.seconds=t,this.nanoseconds=e}}(),Ll=function(){function t(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}return t.store="owner",t.key="owner",t}();var xl=function(){function t(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}return t.store="mutationQueues",t.keyPath="userId",t}(),ql=function(){function t(t,e,n,r,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i}return t.store="mutations",t.keyPath="batchId",t.userMutationsIndex="userMutationsIndex",t.userMutationsKeyPath=["userId","batchId"],t}();var Fl=function(){function t(){}return t.prefixForUser=function(t){return[t]},t.prefixForPath=function(t,e){return[t,zh(e)]},t.key=function(t,e,n){return[t,zh(e),n]},t.store="documentMutations",t.PLACEHOLDER=new t,t}();var Bl=function(){return function(t,e){this.path=t,this.readTime=e}}(),Vl=function(){return function(t,e){this.path=t,this.version=e}}(),Ul=function(){function t(t,e,n,r){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r}return t.store="remoteDocuments",t}(),jl=function(){function t(t){this.byteSize=t}return t.store="remoteDocumentGlobal",t.key="remoteDocumentGlobalKey",t}();var Ql=function(){function t(t,e,n,r,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.query=o}return t.store="targets",t.keyPath="targetId",t.queryTargetsIndexName="queryTargetsIndex",t.queryTargetsKeyPath=["canonicalId","targetId"],t}(),Kl=function(){function t(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n,Ks(0===t==(void 0!==n),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}return t.store="targetDocuments",t.keyPath=["targetId","path"],t.documentTargetsIndex="documentTargetsIndex",t.documentTargetsKeyPath=["path","targetId"],t}(),Gl=function(){function t(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}return t.key="targetGlobalKey",t.store="targetGlobal",t}(),Wl=function(){function t(t,e){this.collectionId=t,this.parent=e}return t.store="collectionParents",t.keyPath=["collectionId","parent"],t}();function zl(t){t.createObjectStore(Kl.store,{keyPath:Kl.keyPath}).createIndex(Kl.documentTargetsIndex,Kl.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Ql.store,{keyPath:Ql.keyPath}).createIndex(Ql.queryTargetsIndexName,Ql.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Gl.store)}var Hl=function(){function t(t){this.changes=t}return t.store="remoteDocumentChanges",t.keyPath="id",t}();var Yl=function(){function t(t,e,n,r,i){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r,this.lastProcessedDocumentChangeId=i}return t.store="clientMetadata",t.keyPath="clientId",t}();var Xl=[xl.store,ql.store,Fl.store,Ul.store,Ql.store,Ll.store,Gl.store,Kl.store].concat([Yl.store,Hl.store]).concat([jl.store]).concat([Wl.store]),Jl=function(){function t(){this.collectionParentsCache=new Ol}return t.prototype.addToCollectionParentIndex=function(t,e){if(Ks(e.length%2==1,"Expected a collection path."),this.collectionParentsCache.add(e)){Ks(e.length>=1,"Invalid collection path.");var n=e.lastSegment(),r=e.popLast();return $l(t).put({collectionId:n,parent:zh(r)})}return Zh.resolve()},t.prototype.getCollectionParents=function(t,e){var n=[],r=IDBKeyRange.bound([e,""],[Eu(e),""],!1,!0);return $l(t).loadAll(r).next(function(t){for(var r=0,i=t;r<i.length;r++){var o=i[r];if(o.collectionId!==e)break;n.push(Xh(o.parent))}return n})},t}();function $l(t){return pf.getStore(t,Wl.store)}var Zl=function(){function t(t){this.remoteSerializer=t}return t.prototype.fromDbRemoteDocument=function(t){if(t.document)return this.remoteSerializer.fromDocument(t.document,!!t.hasCommittedMutations);if(t.noDocument){var e=Fu.fromSegments(t.noDocument.path),n=this.fromDbTimestamp(t.noDocument.readTime);return new Uu(e,n,{hasCommittedMutations:!!t.hasCommittedMutations})}if(t.unknownDocument){e=Fu.fromSegments(t.unknownDocument.path),n=this.fromDbTimestamp(t.unknownDocument.version);return new ju(e,n)}return Qs("Unexpected DbRemoteDocument")},t.prototype.toDbRemoteDocument=function(t){if(t instanceof Vu){var e=t.proto?t.proto:this.remoteSerializer.toDocument(t),n=t.hasCommittedMutations;return new Ul(null,null,e,n)}if(t instanceof Uu){var r=t.key.path.toArray(),i=this.toDbTimestamp(t.version);n=t.hasCommittedMutations;return new Ul(null,new Bl(r,i),null,n)}if(t instanceof ju){r=t.key.path.toArray(),i=this.toDbTimestamp(t.version);return new Ul(new Vl(r,i),null,null,!0)}return Qs("Unexpected MaybeDocumment")},t.prototype.toDbTimestamp=function(t){var e=t.toTimestamp();return new Pl(e.seconds,e.nanoseconds)},t.prototype.fromDbTimestamp=function(t){var e=new Ru(t.seconds,t.nanoseconds);return Ac.fromTimestamp(e)},t.prototype.toDbMutationBatch=function(t,e){var n=this,r=e.baseMutations.map(function(t){return n.remoteSerializer.toMutation(t)}),i=e.mutations.map(function(t){return n.remoteSerializer.toMutation(t)});return new ql(t,e.batchId,e.localWriteTime.toMillis(),r,i)},t.prototype.fromDbMutationBatch=function(t){var e=this,n=(t.baseMutations||[]).map(function(t){return e.remoteSerializer.fromMutation(t)}),r=t.mutations.map(function(t){return e.remoteSerializer.fromMutation(t)}),i=Ru.fromMillis(t.localWriteTimeMs);return new Jh(t.batchId,i,n,r)},t.prototype.toDbResourcePaths=function(t){var e=[];return t.forEach(function(t){e.push(zh(t.path))}),e},t.prototype.fromDbResourcePaths=function(t){for(var e=oh(),n=0,r=t;n<r.length;n++){var i=r[n];e=e.add(new Fu(Xh(i)))}return e},t.prototype.fromDbTarget=function(t){var e,n=this.fromDbTimestamp(t.readTime);return e=void 0!==t.query.documents?this.remoteSerializer.fromDocumentsTarget(t.query):this.remoteSerializer.fromQueryTarget(t.query),new kc(e,t.targetId,yc.Listen,t.lastListenSequenceNumber,n,t.resumeToken)},t.prototype.toDbTarget=function(t){Ks(yc.Listen===t.purpose,"Only queries with purpose "+yc.Listen+" may be stored, got "+t.purpose);var e,n,r=this.toDbTimestamp(t.snapshotVersion);return e=t.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(t.query):this.remoteSerializer.toQueryTarget(t.query),t.resumeToken instanceof Uint8Array?(Ks("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),n=t.resumeToken.toString()):n=t.resumeToken,new Ql(t.targetId,t.query.canonicalId(),r,n,t.sequenceNumber,e)},t}();function tf(t,e){var n=t[0],r=t[1],i=e[0],o=e[1],a=wu(n,i);return 0===a?wu(r,o):a}var ef=function(){function t(t){this.maxElements=t,this.buffer=new Rc(tf),this.previousIndex=0}return t.prototype.nextIndex=function(){return++this.previousIndex},t.prototype.addElement=function(t){var e=[t,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(e);else{var n=this.buffer.last();tf(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}},Object.defineProperty(t.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),t}(),nf={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},rf=function(){function t(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}return t.withCacheSize=function(e){return new t(e,t.DEFAULT_COLLECTION_PERCENTILE,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},t.COLLECTION_DISABLED=-1,t.MINIMUM_CACHE_SIZE_BYTES=1048576,t.DEFAULT_CACHE_SIZE_BYTES=41943040,t.DEFAULT_COLLECTION_PERCENTILE=10,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,t.DEFAULT=new t(t.DEFAULT_CACHE_SIZE_BYTES,t.DEFAULT_COLLECTION_PERCENTILE,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),t.DISABLED=new t(t.COLLECTION_DISABLED,0,0),t}(),of=function(){function t(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.gcTask=null}return t.prototype.start=function(){Ks(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==rf.COLLECTION_DISABLED&&this.scheduleGC()},t.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(t.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),t.prototype.scheduleGC=function(){var t=this;Ks(null===this.gcTask,"Cannot schedule GC while a task is pending");var e=this.hasRun?3e5:6e4;Vs("LruGarbageCollector","Garbage collection scheduled in "+e+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(Fh.LruGarbageCollection,e,function(){return t.gcTask=null,t.hasRun=!0,t.localStore.collectGarbage(t.garbageCollector).then(function(){return t.scheduleGC()}).catch(df)})},t}(),af=function(){function t(t,e){this.delegate=t,this.params=e}return t.prototype.calculateTargetCount=function(t,e){return this.delegate.getSequenceNumberCount(t).next(function(t){return Math.floor(e/100*t)})},t.prototype.nthSequenceNumber=function(t,e){var n=this;if(0===e)return Zh.resolve(Bh.INVALID);var r=new ef(e);return this.delegate.forEachTarget(t,function(t){return r.addElement(t.sequenceNumber)}).next(function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(t,function(t){return r.addElement(t)})}).next(function(){return r.maxValue})},t.prototype.removeTargets=function(t,e,n){return this.delegate.removeTargets(t,e,n)},t.prototype.removeOrphanedDocuments=function(t,e){return this.delegate.removeOrphanedDocuments(t,e)},t.prototype.collect=function(t,e){var n=this;return this.params.cacheSizeCollectionThreshold===rf.COLLECTION_DISABLED?(Vs("LruGarbageCollector","Garbage collection skipped; disabled"),Zh.resolve(nf)):this.getCacheSize(t).next(function(r){return r<n.params.cacheSizeCollectionThreshold?(Vs("LruGarbageCollector","Garbage collection skipped; Cache size "+r+" is lower than threshold "+n.params.cacheSizeCollectionThreshold),nf):n.runGarbageCollection(t,e)})},t.prototype.getCacheSize=function(t){return this.delegate.getCacheSize(t)},t.prototype.runGarbageCollection=function(t,e){var n,r,i,o,a,s,u,c,h=this;return o=Date.now(),this.calculateTargetCount(t,this.params.percentileToCollect).next(function(e){return e>h.params.maximumSequenceNumbersToCollect?(Vs("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+h.params.maximumSequenceNumbersToCollect+" from "+e),r=h.params.maximumSequenceNumbersToCollect):r=e,a=Date.now(),h.nthSequenceNumber(t,r)}).next(function(r){return n=r,s=Date.now(),h.removeTargets(t,n,e)}).next(function(e){return i=e,u=Date.now(),h.removeOrphanedDocuments(t,n)}).next(function(t){(c=Date.now(),Fs()<=ks.DEBUG)&&Vs("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(a-o)+"ms\n\tDetermined least recently used "+r+" in "+(s-a)+"ms\n\tRemoved "+i+" targets in "+(u-s)+"ms\n\tRemoved "+t+" documents in "+(c-u)+"ms\nTotal Duration: "+(c-o)+"ms");return Zh.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:t})})},t}(),sf=function(){return function(){}}(),uf="IndexedDbPersistence",cf="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",hf="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `experimentalTabSynchronization:true` in all tabs.",lf="This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.",ff=function(t){function e(e,n){var r=t.call(this)||this;return r.simpleDbTransaction=e,r.currentSequenceNumber=n,r}return Jn(e,t),e}(sf),pf=function(){function t(e,n,r,i,o,a,s){if(this.persistenceKey=e,this.clientId=n,this.queue=i,this.multiClientParams=s,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.inForeground=!1,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(t){return Promise.resolve()},!t.isAvailable())throw new Hs(zs.UNIMPLEMENTED,lf);if(this.referenceDelegate=new gf(this,a),this.dbName=e+t.MAIN_DATABASE,this.serializer=new Zl(o),this.document=r.document,this.allowTabSynchronization=void 0!==s,this.queryCache=new yl(this.referenceDelegate,this.serializer),this.indexManager=new Jl,this.remoteDocumentCache=new Tl(this.serializer,this.indexManager,this.allowTabSynchronization),!r.window||!r.window.localStorage)throw new Hs(zs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=r.window,this.webStorage=this.window.localStorage}return t.getStore=function(t,e){if(t instanceof ff)return hl.getStore(t.simpleDbTransaction,e);throw Qs("IndexedDbPersistence must use instances of IndexedDbTransaction")},t.createIndexedDbPersistence=function(e,n,r,i,o,a){return Zn(this,void 0,void 0,function(){var s;return tr(this,function(u){switch(u.label){case 0:return[4,(s=new t(e,n,r,i,o,a)).start()];case 1:return u.sent(),[2,s]}})})},t.createMultiClientIndexedDbPersistence=function(e,n,r,i,o,a,s){return Zn(this,void 0,void 0,function(){var u;return tr(this,function(c){switch(c.label){case 0:return[4,(u=new t(e,n,r,i,o,a,s)).start()];case 1:return c.sent(),[2,u]}})})},t.prototype.start=function(){var t=this;return Ks(!this.started,"IndexedDbPersistence double-started!"),Ks(null!==this.window,"Expected 'window' to be defined"),hl.openOrCreate(this.dbName,_l,new Ml(this.serializer)).then(function(e){return t.simpleDb=e,t.updateClientMetadataAndTryBecomePrimary()}).then(function(){return t.attachVisibilityHandler(),t.attachWindowUnloadHook(),t.scheduleClientMetadataAndPrimaryLeaseRefreshes(),t.startRemoteDocumentCache()}).then(function(){return t.simpleDb.runTransaction("readonly",[Gl.store],function(e){return vl(e).next(function(e){var n=t.multiClientParams?t.multiClientParams.sequenceNumberSyncer:void 0;t.listenSequence=new Bh(e,n)})})}).then(function(){t._started=!0}).catch(function(e){return t.simpleDb&&t.simpleDb.close(),Promise.reject(e)})},t.prototype.startRemoteDocumentCache=function(){var t=this;return this.simpleDb.runTransaction("readonly",Xl,function(e){return t.remoteDocumentCache.start(e)})},t.prototype.setPrimaryStateListener=function(t){var e=this;return this.primaryStateListener=function(n){return Zn(e,void 0,void 0,function(){return tr(this,function(e){return this.started?[2,t(n)]:[2]})})},t(this.isPrimary)},t.prototype.setNetworkEnabled=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.queue.enqueueAndForget(function(){return Zn(e,void 0,void 0,function(){return tr(this,function(t){switch(t.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})}))},t.prototype.updateClientMetadataAndTryBecomePrimary=function(){var t=this;return this.simpleDb.runTransaction("readwrite",Xl,function(e){return mf(e).put(new Yl(t.clientId,Date.now(),t.networkEnabled,t.inForeground,t.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(t.isPrimary)return t.verifyPrimaryLease(e).next(function(e){e||(t.isPrimary=!1,t.queue.enqueueAndForget(function(){return t.primaryStateListener(!1)}))})}).next(function(){return t.canActAsPrimary(e)}).next(function(n){var r=t.isPrimary;return t.isPrimary=n,r!==t.isPrimary&&t.queue.enqueueAndForget(function(){return t.primaryStateListener(t.isPrimary)}),r&&!t.isPrimary?t.releasePrimaryLeaseIfHeld(e):t.isPrimary?t.acquireOrExtendPrimaryLease(e):void 0})})},t.prototype.verifyPrimaryLease=function(t){var e=this;return yf(t).get(Ll.key).next(function(t){return Zh.resolve(e.isLocalClient(t))})},t.prototype.removeClientMetadata=function(t){return mf(t).delete(this.clientId)},t.prototype.maybeGarbageCollectMultiClientState=function(){return Zn(this,void 0,void 0,function(){var e,n,r=this;return tr(this,function(i){switch(i.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),n=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(i){var o=t.getStore(i,Yl.store);return o.loadAll().next(function(t){e=r.filterActiveClients(t,18e5),n=t.filter(function(t){return-1===e.indexOf(t)})}).next(function(){return Zh.forEach(n,function(t){return o.delete(t.clientId)})}).next(function(){if((e=e.filter(function(t){return t.clientId!==r.clientId})).length>0){var t=e.map(function(t){return t.lastProcessedDocumentChangeId||0}),n=Math.min.apply(Math,t);return r.remoteDocumentCache.removeDocumentChangesThroughChangeId(i,n)}})})]);case 1:i.sent(),n.forEach(function(t){r.window.localStorage.removeItem(r.zombiedClientLocalStorageKey(t.clientId))}),i.label=2;case 2:return[2]}})})},t.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var t=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(Fh.ClientMetadataRefresh,4e3,function(){return t.updateClientMetadataAndTryBecomePrimary().then(function(){return t.maybeGarbageCollectMultiClientState()}).then(function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},t.prototype.isLocalClient=function(t){return!!t&&t.ownerId===this.clientId},t.prototype.canActAsPrimary=function(t){var e=this;return yf(t).get(Ll.key).next(function(n){if(null!==n&&e.isWithinAge(n.leaseTimestampMs,5e3)&&!e.isClientZombied(n.ownerId)){if(e.isLocalClient(n)&&e.networkEnabled)return!0;if(!e.isLocalClient(n)){if(!n.allowTabSynchronization)throw new Hs(zs.FAILED_PRECONDITION,hf);return!1}}return!(!e.networkEnabled||!e.inForeground)||mf(t).loadAll().next(function(t){return void 0===e.filterActiveClients(t,5e3).find(function(t){if(e.clientId!==t.clientId){var n=!e.networkEnabled&&t.networkEnabled,r=!e.inForeground&&t.inForeground,i=e.networkEnabled===t.networkEnabled;if(n||r&&i)return!0}return!1})})}).next(function(t){return e.isPrimary!==t&&Vs(uf,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t})},t.prototype.shutdown=function(){return Zn(this,void 0,void 0,function(){var t=this;return tr(this,function(e){switch(e.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&this.clientMetadataRefresher.cancel(),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[Ll.store,Yl.store],function(e){return t.releasePrimaryLeaseIfHeld(e).next(function(){return t.removeClientMetadata(e)})})];case 1:return e.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}})})},t.prototype.filterActiveClients=function(t,e){var n=this;return t.filter(function(t){return n.isWithinAge(t.updateTimeMs,e)&&!n.isClientZombied(t.clientId)})},t.prototype.getActiveClients=function(){var t=this;return this.simpleDb.runTransaction("readonly",[Yl.store],function(e){return mf(e).loadAll().next(function(e){return t.filterActiveClients(e,18e5).map(function(t){return t.clientId})})})},t.clearPersistence=function(e){return Zn(this,void 0,void 0,function(){var n;return tr(this,function(r){switch(r.label){case 0:return t.isAvailable()?(n=e+t.MAIN_DATABASE,[4,hl.delete(n)]):[2,Promise.resolve()];case 1:return r.sent(),[2]}})})},Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.getMutationQueue=function(t){return Ks(this.started,"Cannot initialize MutationQueue before persistence is started."),tl.forUser(t,this.serializer,this.indexManager,this.referenceDelegate)},t.prototype.getQueryCache=function(){return Ks(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},t.prototype.getRemoteDocumentCache=function(){return Ks(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},t.prototype.getIndexManager=function(){return Ks(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},t.prototype.runTransaction=function(t,e,n){var r=this;return Vs(uf,"Starting transaction:",t),this.simpleDb.runTransaction("readonly"===e?"readonly":"readwrite",Xl,function(i){return"readwrite-primary"===e?r.verifyPrimaryLease(i).next(function(e){if(!e)throw Us("Failed to obtain primary lease for action '"+t+"'."),r.isPrimary=!1,r.queue.enqueueAndForget(function(){return r.primaryStateListener(!1)}),new Hs(zs.FAILED_PRECONDITION,cf);return n(new ff(i,r.listenSequence.next()))}).next(function(t){return r.acquireOrExtendPrimaryLease(i).next(function(){return t})}):r.verifyAllowTabSynchronization(i).next(function(){return n(new ff(i,r.listenSequence.next()))})})},t.prototype.verifyAllowTabSynchronization=function(t){var e=this;return yf(t).get(Ll.key).next(function(t){if(null!==t&&e.isWithinAge(t.leaseTimestampMs,5e3)&&!e.isClientZombied(t.ownerId)&&!e.isLocalClient(t)&&!t.allowTabSynchronization)throw new Hs(zs.FAILED_PRECONDITION,hf)})},t.prototype.acquireOrExtendPrimaryLease=function(t){var e=new Ll(this.clientId,this.allowTabSynchronization,Date.now());return yf(t).put(Ll.key,e)},t.isAvailable=function(){return hl.isAvailable()},t.buildStoragePrefix=function(t){var e=t.databaseId.projectId;return t.databaseId.isDefaultDatabase||(e+="."+t.databaseId.database),"firestore/"+t.persistenceKey+"/"+e+"/"},t.prototype.releasePrimaryLeaseIfHeld=function(t){var e=this,n=yf(t);return n.get(Ll.key).next(function(t){return e.isLocalClient(t)?(Vs(uf,"Releasing primary lease."),n.delete(Ll.key)):Zh.resolve()})},t.prototype.isWithinAge=function(t,e){var n=Date.now();return!(t<n-e)&&(!(t>n)||(Us("Detected an update time that is in the future: "+t+" > "+n),!1))},t.prototype.attachVisibilityHandler=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){t.queue.enqueueAndForget(function(){return t.inForeground="visible"===t.document.visibilityState,t.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},t.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(Ks(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},t.prototype.attachWindowUnloadHook=function(){var t=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget(function(){return t.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},t.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(Ks("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},t.prototype.isClientZombied=function(t){try{var e=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(t));return Vs(uf,"Client '"+t+"' "+(e?"is":"is not")+" zombied in LocalStorage"),e}catch(t){return Us(uf,"Failed to get zombied client id.",t),!1}},t.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(t){Us("Failed to set zombie client id.",t)}},t.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(t){}},t.prototype.zombiedClientLocalStorageKey=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},t.MAIN_DATABASE="main",t}();function df(t){return Zn(this,void 0,void 0,function(){return tr(this,function(e){if(!function(t){return t.code===zs.FAILED_PRECONDITION&&t.message===cf}(t))throw t;return Vs(uf,"Unexpectedly lost primary lease"),[2]})})}function yf(t){return t.store(Ll.store)}function mf(t){return t.store(Yl.store)}var gf=function(){function t(t,e){this.db=t,this.garbageCollector=new af(this,e)}return t.prototype.getSequenceNumberCount=function(t){var e=this.orphanedDocmentCount(t);return this.db.getQueryCache().getQueryCount(t).next(function(t){return e.next(function(e){return t+e})})},t.prototype.orphanedDocmentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},t.prototype.forEachTarget=function(t,e){return this.db.getQueryCache().forEachTarget(t,e)},t.prototype.forEachOrphanedDocumentSequenceNumber=function(t,e){return this.forEachOrphanedDocument(t,function(t,n){return e(n)})},t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.addReference=function(t,e){return vf(t,e)},t.prototype.removeReference=function(t,e){return vf(t,e)},t.prototype.removeTargets=function(t,e,n){return this.db.getQueryCache().removeTargets(t,e,n)},t.prototype.removeMutationReference=function(t,e){return vf(t,e)},t.prototype.isPinned=function(t,e){return this.inMemoryPins.containsKey(e)?Zh.resolve(!0):function(t,e){var n=!1;return al(t).iterateSerial(function(r){return el(t,r,e).next(function(t){return t&&(n=!0),Zh.resolve(!t)})}).next(function(){return n})}(t,e)},t.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=0,i=0,o=[];return this.forEachOrphanedDocument(t,function(a,s){if(s<=e){var u=n.isPinned(t,a).next(function(e){if(!e)return r++,n.removeOrphanedDocument(t,a).next(function(t){i+=t})});o.push(u)}}).next(function(){return Zh.waitFor(o)}).next(function(){return n.db.getRemoteDocumentCache().updateSize(t,-i)}).next(function(){return r})},t.prototype.removeOrphanedDocument=function(t,e){var n,r=0,i=this.db.getRemoteDocumentCache();return Zh.waitFor([bl(t).delete((n=e,[0,zh(n.path)])),i.removeEntry(t,e).next(function(t){r+=t})]).next(function(){return r})},t.prototype.removeTarget=function(t,e){var n=e.copy({sequenceNumber:t.currentSequenceNumber});return this.db.getQueryCache().updateQueryData(t,n)},t.prototype.updateLimboDocument=function(t,e){return vf(t,e)},t.prototype.forEachOrphanedDocument=function(t,e){var n,r=bl(t),i=Bh.INVALID;return r.iterate({index:Kl.documentTargetsIndex},function(t,r){var o=t[0],a=(t[1],r.path),s=r.sequenceNumber;0===o?(i!==Bh.INVALID&&e(new Fu(Xh(n)),i),i=s,n=a):i=Bh.INVALID}).next(function(){i!==Bh.INVALID&&e(new Fu(Xh(n)),i)})},t.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},t}();function vf(t,e){return bl(t).put(function(t,e){return new Kl(0,zh(t.path),e)}(e,t.currentSequenceNumber))}var bf=function(){function t(t,e,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.indexManager=n}return t.prototype.getDocument=function(t,e){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(t,e).next(function(r){return n.getDocumentInternal(t,e,r)})},t.prototype.getDocumentInternal=function(t,e,n){return this.remoteDocumentCache.getEntry(t,e).next(function(t){for(var r=0,i=n;r<i.length;r++){t=i[r].applyToLocalView(e,t)}return t})},t.prototype.applyLocalMutationsToDocuments=function(t,e,n){var r=Zc();return e.forEach(function(t,e){for(var i=0,o=n;i<o.length;i++){e=o[i].applyToLocalView(t,e)}r=r.insert(t,e)}),r},t.prototype.getDocuments=function(t,e){var n=this;return this.remoteDocumentCache.getEntries(t,e).next(function(e){return n.getLocalViewOfDocuments(t,e)})},t.prototype.getLocalViewOfDocuments=function(t,e){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(function(r){var i=n.applyLocalMutationsToDocuments(t,e,r),o=$c();return i.forEach(function(t,e){e||(e=new Uu(t,Ac.forDeletedDoc())),o=o.insert(t,e)}),o})},t.prototype.getDocumentsMatchingQuery=function(t,e){return e.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(t,e.path):e.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(t,e):this.getDocumentsMatchingCollectionQuery(t,e)},t.prototype.getDocumentsMatchingDocumentQuery=function(t,e){return this.getDocument(t,new Fu(e)).next(function(t){var e=eh();return t instanceof Vu&&(e=e.insert(t.key,t)),e})},t.prototype.getDocumentsMatchingCollectionGroupQuery=function(t,e){var n=this;Ks(e.path.isEmpty(),"Currently we only support collection group queries at the root.");var r=e.collectionGroup,i=eh();return this.indexManager.getCollectionParents(t,r).next(function(o){return Zh.forEach(o,function(o){var a=e.asCollectionQueryAtPath(o.child(r));return n.getDocumentsMatchingCollectionQuery(t,a).next(function(t){t.forEach(function(t,e){i=i.insert(t,e)})})}).next(function(){return i})})},t.prototype.getDocumentsMatchingCollectionQuery=function(t,e){var n,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(t,e).next(function(i){return n=i,r.mutationQueue.getAllMutationBatchesAffectingQuery(t,e)}).next(function(t){for(var r=0,i=t;r<i.length;r++)for(var o=i[r],a=0,s=o.mutations;a<s.length;a++){var u=s[a],c=u.key;if(e.path.isImmediateParentOf(c.path)){var h=n.get(c),l=u.applyToLocalView(h,h,o.localWriteTime);n=l instanceof Vu?n.insert(c,l):n.remove(c)}}}).next(function(){return n.forEach(function(t,r){e.matches(r)||(n=n.remove(t))}),n})},t}(),wf=function(){function t(){this.refsByKey=new Rc(Sf.compareByKey),this.refsByTarget=new Rc(Sf.compareByTargetId)}return t.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},t.prototype.addReference=function(t,e){var n=new Sf(t,e);this.refsByKey=this.refsByKey.add(n),this.refsByTarget=this.refsByTarget.add(n)},t.prototype.addReferences=function(t,e){var n=this;t.forEach(function(t){return n.addReference(t,e)})},t.prototype.removeReference=function(t,e){this.removeRef(new Sf(t,e))},t.prototype.removeReferences=function(t,e){var n=this;t.forEach(function(t){return n.removeReference(t,e)})},t.prototype.removeReferencesForId=function(t){var e=this,n=Fu.EMPTY,r=new Sf(n,t),i=new Sf(n,t+1),o=[];return this.refsByTarget.forEachInRange([r,i],function(t){e.removeRef(t),o.push(t.key)}),o},t.prototype.removeAllReferences=function(){var t=this;this.refsByKey.forEach(function(e){return t.removeRef(e)})},t.prototype.removeRef=function(t){this.refsByKey=this.refsByKey.delete(t),this.refsByTarget=this.refsByTarget.delete(t)},t.prototype.referencesForId=function(t){var e=Fu.EMPTY,n=new Sf(e,t),r=new Sf(e,t+1),i=oh();return this.refsByTarget.forEachInRange([n,r],function(t){i=i.add(t.key)}),i},t.prototype.containsKey=function(t){var e=new Sf(t,0),n=this.refsByKey.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)},t}(),Sf=function(){function t(t,e){this.key=t,this.targetOrBatchId=e}return t.compareByKey=function(t,e){return Fu.comparator(t.key,e.key)||wu(t.targetOrBatchId,e.targetOrBatchId)},t.compareByTargetId=function(t,e){return wu(t.targetOrBatchId,e.targetOrBatchId)||Fu.comparator(t.key,e.key)},t}(),Ef=function(){function t(t,e){this.persistence=t,this.localViewReferences=new wf,this.queryDataByTarget={},Ks(t.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=t.getMutationQueue(e),this.remoteDocuments=t.getRemoteDocumentCache(),this.queryCache=t.getQueryCache(),this.localDocuments=new bf(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}return t.prototype.handleUserChange=function(t){var e=this;return this.persistence.runTransaction("Handle user change","readonly",function(n){var r;return e.mutationQueue.getAllMutationBatches(n).next(function(i){return r=i,e.mutationQueue=e.persistence.getMutationQueue(t),e.localDocuments=new bf(e.remoteDocuments,e.mutationQueue,e.persistence.getIndexManager()),e.mutationQueue.getAllMutationBatches(n)}).next(function(t){for(var i=[],o=[],a=oh(),s=0,u=r;s<u.length;s++){var c=u[s];i.push(c.batchId);for(var h=0,l=c.mutations;h<l.length;h++){var f=l[h];a=a.add(f.key)}}for(var p=0,d=t;p<d.length;p++){c=d[p];o.push(c.batchId);for(var y=0,m=c.mutations;y<m.length;y++){f=m[y];a=a.add(f.key)}}return e.localDocuments.getDocuments(n,a).next(function(t){return{affectedDocuments:t,removedBatchIds:i,addedBatchIds:o}})})})},t.prototype.localWrite=function(t){var e=this,n=Ru.now(),r=t.reduce(function(t,e){return t.add(e.key)},oh());return this.persistence.runTransaction("Locally write mutations","readwrite",function(i){return e.localDocuments.getDocuments(i,r).next(function(r){for(var o=[],a=0,s=t;a<s.length;a++){var u=s[a],c=r.get(u.key);if(!u.isIdempotent){var h=u.fieldMask;if(h){var l=c instanceof Vu?h.applyTo(c.data):sc.EMPTY;o.push(new Fc(u.key,l,h,Lc.exists(!0)))}}}return e.mutationQueue.addMutationBatch(i,n,o,t).next(function(t){var e=t.applyToLocalDocumentSet(r);return{batchId:t.batchId,changes:e}})})})},t.prototype.lookupMutationDocuments=function(t){var e=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(n){return e.mutationQueue.lookupMutationKeys(n,t).next(function(t){return t?e.localDocuments.getDocuments(n,t):Zh.resolve(null)})})},t.prototype.acknowledgeBatch=function(t){var e=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(n){var r=t.batch.keys(),i=e.remoteDocuments.newChangeBuffer();return e.mutationQueue.acknowledgeBatch(n,t.batch,t.streamToken).next(function(){return e.applyWriteToRemoteDocuments(n,t,i)}).next(function(){return i.apply(n)}).next(function(){return e.mutationQueue.performConsistencyCheck(n)}).next(function(){return e.localDocuments.getDocuments(n,r)})})},t.prototype.rejectBatch=function(t){var e=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(n){var r;return e.mutationQueue.lookupMutationBatch(n,t).next(function(t){return Ks(null!==t,"Attempt to reject nonexistent batch!"),r=t.keys(),e.mutationQueue.removeMutationBatch(n,t)}).next(function(){return e.mutationQueue.performConsistencyCheck(n)}).next(function(){return e.localDocuments.getDocuments(n,r)})})},t.prototype.getLastStreamToken=function(){var t=this;return this.persistence.runTransaction("Get last stream token","readonly",function(e){return t.mutationQueue.getLastStreamToken(e)})},t.prototype.setLastStreamToken=function(t){var e=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(n){return e.mutationQueue.setLastStreamToken(n,t)})},t.prototype.getLastRemoteSnapshotVersion=function(){var t=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(e){return t.queryCache.getLastRemoteSnapshotVersion(e)})},t.prototype.applyRemoteEvent=function(e){var n=this,r=this.remoteDocuments.newChangeBuffer();return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(i){var o=[],a=oh();$s(e.targetChanges,function(r,s){var u=n.queryDataByTarget[r];if(u){s.addedDocuments.forEach(function(t){a=a.add(t)}),s.modifiedDocuments.forEach(function(t){a=a.add(t)}),o.push(n.queryCache.removeMatchingKeys(i,s.removedDocuments,r).next(function(){return n.queryCache.addMatchingKeys(i,s.addedDocuments,r)}));var c=s.resumeToken;if(c.length>0){var h=u;u=u.copy({resumeToken:c,snapshotVersion:e.snapshotVersion}),n.queryDataByTarget[r]=u,t.shouldPersistQueryData(h,u,s)&&o.push(n.queryCache.updateQueryData(i,u))}}});var s=$c(),u=oh();e.documentUpdates.forEach(function(t,e){u=u.add(t)}),o.push(r.getEntries(i,u).next(function(t){e.documentUpdates.forEach(function(u,c){var h=t.get(u);null==h||c.version.isEqual(Ac.MIN)||a.has(c.key)&&!h.hasPendingWrites||c.version.compareTo(h.version)>=0?(r.addEntry(c),s=s.insert(u,c)):Vs("LocalStore","Ignoring outdated watch update for ",u,". Current version:",h.version," Watch version:",c.version),e.resolvedLimboDocuments.has(u)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(i,u))})}));var c=e.snapshotVersion;if(!c.isEqual(Ac.MIN)){var h=n.queryCache.getLastRemoteSnapshotVersion(i).next(function(t){return Ks(c.compareTo(t)>=0,"Watch stream reverted to previous snapshot?? "+c+" < "+t),n.queryCache.setTargetsMetadata(i,i.currentSequenceNumber,c)});o.push(h)}return Zh.waitFor(o).next(function(){return r.apply(i)}).next(function(){return n.localDocuments.getLocalViewOfDocuments(i,s)})})},t.shouldPersistQueryData=function(t,e,n){return 0!==e.resumeToken.length&&(0===t.resumeToken.length||(e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0))},t.prototype.notifyLocalViewChanges=function(t){var e=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(n){return Zh.forEach(t,function(t){return e.localViewReferences.addReferences(t.addedKeys,t.targetId),e.localViewReferences.removeReferences(t.removedKeys,t.targetId),Zh.forEach(t.removedKeys,function(t){return e.persistence.referenceDelegate.removeReference(n,t)})})})},t.prototype.nextMutationBatch=function(t){var e=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(n){return void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)})},t.prototype.readDocument=function(t){var e=this;return this.persistence.runTransaction("read document","readonly",function(n){return e.localDocuments.getDocument(n,t)})},t.prototype.allocateQuery=function(t){var e=this;return this.persistence.runTransaction("Allocate query","readwrite",function(n){var r;return e.queryCache.getQueryData(n,t).next(function(i){return i?(r=i,Zh.resolve()):e.queryCache.allocateTargetId(n).next(function(i){return r=new kc(t,i,yc.Listen,n.currentSequenceNumber),e.queryCache.addQueryData(n,r)})}).next(function(){return Ks(!e.queryDataByTarget[r.targetId],"Tried to allocate an already allocated query: "+t),e.queryDataByTarget[r.targetId]=r,r})})},t.prototype.releaseQuery=function(t,e){var n=this,r=e?"readwrite":"readwrite-primary";return this.persistence.runTransaction("Release query",r,function(r){return n.queryCache.getQueryData(r,t).next(function(i){Ks(null!=i,"Tried to release nonexistent query: "+t);var o=i.targetId,a=n.queryDataByTarget[o],s=n.localViewReferences.removeReferencesForId(o);return delete n.queryDataByTarget[o],e?Zh.resolve():Zh.forEach(s,function(t){return n.persistence.referenceDelegate.removeReference(r,t)}).next(function(){return n.persistence.referenceDelegate.removeTarget(r,a)})})})},t.prototype.executeQuery=function(t){var e=this;return this.persistence.runTransaction("Execute query","readonly",function(n){return e.localDocuments.getDocumentsMatchingQuery(n,t)})},t.prototype.remoteDocumentKeys=function(t){var e=this;return this.persistence.runTransaction("Remote document keys","readonly",function(n){return e.queryCache.getMatchingKeysForTargetId(n,t)})},t.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},t.prototype.removeCachedMutationBatchMetadata=function(t){this.mutationQueue.removeCachedMutationKeys(t)},t.prototype.setNetworkEnabled=function(t){this.persistence.setNetworkEnabled(t)},t.prototype.applyWriteToRemoteDocuments=function(t,e,n){var r=this,i=e.batch,o=i.keys(),a=Zh.resolve();return o.forEach(function(r){a=a.next(function(){return n.getEntry(t,r)}).next(function(t){var o=t,a=e.docVersions.get(r);Ks(null!==a,"ackVersions should contain every doc in the write."),(!o||o.version.compareTo(a)<0)&&((o=i.applyToRemoteDocument(r,o,e))?n.addEntry(o):Ks(!t,"Mutation batch "+i+" applied to document "+t+" resulted in null"))})}),a.next(function(){return r.mutationQueue.removeMutationBatch(t,i)})},t.prototype.collectGarbage=function(t){var e=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(n){return t.collect(n,e.queryDataByTarget)})},t.prototype.getQueryForTarget=function(t){var e=this;return this.queryDataByTarget[t]?Promise.resolve(this.queryDataByTarget[t].query):this.persistence.runTransaction("Get query data","readonly",function(n){return e.queryCache.getQueryDataForTarget(n,t).next(function(t){return t?t.query:null})})},t.prototype.getNewDocumentChanges=function(){var t=this;return this.persistence.runTransaction("Get new document changes","readonly",function(e){return t.remoteDocuments.getNewDocumentChanges(e)})},t.RESUME_TOKEN_MAX_AGE_MICROS=3e8,t}(),Tf=function(){function t(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=Ws(),this.batchesByDocumentKey=new Rc(Sf.compareByKey)}return t.prototype.checkEmpty=function(t){return Zh.resolve(0===this.mutationQueue.length)},t.prototype.acknowledgeBatch=function(t,e,n){var r=e.batchId,i=this.indexOfExistingBatchId(r,"acknowledged");Ks(0===i,"Can only acknowledge the first batch in the mutation queue");var o=this.mutationQueue[i];return Ks(r===o.batchId,"Queue ordering failure: expected batch "+r+", got batch "+o.batchId),this.lastStreamToken=n,Zh.resolve()},t.prototype.getLastStreamToken=function(t){return Zh.resolve(this.lastStreamToken)},t.prototype.setLastStreamToken=function(t,e){return this.lastStreamToken=e,Zh.resolve()},t.prototype.addMutationBatch=function(t,e,n,r){Ks(0!==r.length,"Mutation batches should not be empty");var i=this.nextBatchId;(this.nextBatchId++,this.mutationQueue.length>0)&&Ks(this.mutationQueue[this.mutationQueue.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");var o=new Jh(i,e,n,r);this.mutationQueue.push(o);for(var a=0,s=r;a<s.length;a++){var u=s[a];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new Sf(u.key,i)),this.indexManager.addToCollectionParentIndex(t,u.key.path.popLast())}return Zh.resolve(o)},t.prototype.lookupMutationBatch=function(t,e){return Zh.resolve(this.findMutationBatch(e))},t.prototype.lookupMutationKeys=function(t,e){var n=this.findMutationBatch(e);return Ks(null!=n,"Failed to find local mutation batch."),Zh.resolve(n.keys())},t.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=e+1,r=this.indexOfBatchId(n),i=r<0?0:r;return Zh.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)},t.prototype.getAllMutationBatches=function(t){return Zh.resolve(this.mutationQueue.slice())},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=new Sf(e,0),i=new Sf(e,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([r,i],function(t){Ks(e.isEqual(t.key),"Should only iterate over a single key's batches");var r=n.findMutationBatch(t.targetOrBatchId);Ks(null!==r,"Batches in the index must exist in the main table"),o.push(r)}),Zh.resolve(o)},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new Rc(wu);return e.forEach(function(t){var e=new Sf(t,0),i=new Sf(t,Number.POSITIVE_INFINITY);n.batchesByDocumentKey.forEachInRange([e,i],function(e){Ks(t.isEqual(e.key),"For each key, should only iterate over a single key's batches"),r=r.add(e.targetOrBatchId)})}),Zh.resolve(this.findMutationBatches(r))},t.prototype.getAllMutationBatchesAffectingQuery=function(t,e){Ks(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var n=e.path,r=n.length+1,i=n;Fu.isDocumentKey(i)||(i=i.child(""));var o=new Sf(new Fu(i),0),a=new Rc(wu);return this.batchesByDocumentKey.forEachWhile(function(t){var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(a=a.add(t.targetOrBatchId)),!0)},o),Zh.resolve(this.findMutationBatches(a))},t.prototype.findMutationBatches=function(t){var e=this,n=[];return t.forEach(function(t){var r=e.findMutationBatch(t);null!==r&&n.push(r)}),n},t.prototype.removeMutationBatch=function(t,e){var n=this;Ks(0===this.indexOfExistingBatchId(e.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var r=this.batchesByDocumentKey;return Zh.forEach(e.mutations,function(i){var o=new Sf(i.key,e.batchId);return r=r.delete(o),n.referenceDelegate.removeMutationReference(t,i.key)}).next(function(){n.batchesByDocumentKey=r})},t.prototype.removeCachedMutationKeys=function(t){},t.prototype.containsKey=function(t,e){var n=new Sf(e,0),r=this.batchesByDocumentKey.firstAfterOrEqual(n);return Zh.resolve(e.isEqual(r&&r.key))},t.prototype.performConsistencyCheck=function(t){return 0===this.mutationQueue.length&&Ks(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),Zh.resolve()},t.prototype.indexOfExistingBatchId=function(t,e){var n=this.indexOfBatchId(t);return Ks(n>=0&&n<this.mutationQueue.length,"Batches must exist to be "+e),n},t.prototype.indexOfBatchId=function(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId},t.prototype.findMutationBatch=function(t){var e=this.indexOfBatchId(t);if(e<0||e>=this.mutationQueue.length)return null;var n=this.mutationQueue[e];return Ks(n.batchId===t,"If found batch must match"),n},t}(),If=function(){function t(t){this.persistence=t,this.queries=new wl(function(t){return t.canonicalId()}),this.lastRemoteSnapshotVersion=Ac.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new wf,this.targetCount=0,this.targetIdGenerator=cl.forQueryCache()}return t.prototype.getTargetCount=function(t){return Zh.resolve(this.targetCount)},t.prototype.forEachTarget=function(t,e){return this.queries.forEach(function(t,n){return e(n)}),Zh.resolve()},t.prototype.getLastRemoteSnapshotVersion=function(t){return Zh.resolve(this.lastRemoteSnapshotVersion)},t.prototype.getHighestSequenceNumber=function(t){return Zh.resolve(this.highestSequenceNumber)},t.prototype.allocateTargetId=function(t){var e=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=e,Zh.resolve(e)},t.prototype.setTargetsMetadata=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.highestSequenceNumber&&(this.highestSequenceNumber=e),Zh.resolve()},t.prototype.saveQueryData=function(t){this.queries.set(t.query,t);var e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=t.sequenceNumber)},t.prototype.addQueryData=function(t,e){return Ks(!this.queries.has(e.query),"Adding a query that already exists"),this.saveQueryData(e),this.targetCount+=1,Zh.resolve()},t.prototype.updateQueryData=function(t,e){return Ks(this.queries.has(e.query),"Updating a non-existent query"),this.saveQueryData(e),Zh.resolve()},t.prototype.removeQueryData=function(t,e){return Ks(this.targetCount>0,"Removing a target from an empty cache"),Ks(this.queries.has(e.query),"Removing a non-existent target from the cache"),this.queries.delete(e.query),this.references.removeReferencesForId(e.targetId),this.targetCount-=1,Zh.resolve()},t.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return this.queries.forEach(function(a,s){s.sequenceNumber<=e&&!n[s.targetId]&&(r.queries.delete(a),o.push(r.removeMatchingKeysForTargetId(t,s.targetId)),i++)}),Zh.waitFor(o).next(function(){return i})},t.prototype.getQueryCount=function(t){return Zh.resolve(this.targetCount)},t.prototype.getQueryData=function(t,e){var n=this.queries.get(e)||null;return Zh.resolve(n)},t.prototype.getQueryDataForTarget=function(t,e){return Qs("Not yet implemented.")},t.prototype.addMatchingKeys=function(t,e,n){this.references.addReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(function(e){i.push(r.addReference(t,e))}),Zh.waitFor(i)},t.prototype.removeMatchingKeys=function(t,e,n){this.references.removeReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(function(e){i.push(r.removeReference(t,e))}),Zh.waitFor(i)},t.prototype.removeMatchingKeysForTargetId=function(t,e){return this.references.removeReferencesForId(e),Zh.resolve()},t.prototype.getMatchingKeysForTargetId=function(t,e){var n=this.references.referencesForId(e);return Zh.resolve(n)},t.prototype.containsKey=function(t,e){return Zh.resolve(this.references.containsKey(e))},t}();var Cf,Df=function(){function t(t,e){this.indexManager=t,this.sizer=e,this.docs=new Qu(Fu.comparator),this.newDocumentChanges=oh(),this.size=0}return t.prototype.addEntries=function(t,e,n){for(var r=[],i=0,o=e;i<o.length;i++){var a=o[i],s=a.maybeDocument.key;this.docs=this.docs.insert(s,a),this.newDocumentChanges=this.newDocumentChanges.add(s),r.push(this.indexManager.addToCollectionParentIndex(t,s.path.popLast()))}return this.size+=n,Zh.waitFor(r)},t.prototype.removeEntry=function(t,e){var n=this.docs.get(e);return n?(this.docs=this.docs.remove(e),this.size-=n.size,Zh.resolve(n.size)):Zh.resolve(0)},t.prototype.getEntry=function(t,e){var n=this.docs.get(e);return Zh.resolve(n?n.maybeDocument:null)},t.prototype.getSizedEntry=function(t,e){return Zh.resolve(this.docs.get(e))},t.prototype.getEntries=function(t,e){var n=this,r=Zc();return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null)}),Zh.resolve(r)},t.prototype.getSizedEntries=function(t,e){var n=this,r=Zc(),i=new Qu(Fu.comparator);return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null),i=i.insert(t,e?e.size:0)}),Zh.resolve({maybeDocuments:r,sizeMap:i})},t.prototype.getDocumentsMatchingQuery=function(t,e){Ks(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var n=eh(),r=new Fu(e.path.child("")),i=this.docs.getIteratorFrom(r);i.hasNext();){var o=i.getNext(),a=o.key,s=o.value.maybeDocument;if(!e.path.isPrefixOf(a.path))break;s instanceof Vu&&e.matches(s)&&(n=n.insert(s.key,s))}return Zh.resolve(n)},t.prototype.forEachDocumentKey=function(t,e){return Zh.forEach(this.docs,function(t){return e(t)})},t.prototype.getNewDocumentChanges=function(t){var e=this,n=$c();return this.newDocumentChanges.forEach(function(t){var r=e.docs.get(t),i=r?r.maybeDocument:new Uu(t,Ac.forDeletedDoc());n=n.insert(t,i)}),this.newDocumentChanges=oh(),Zh.resolve(n)},t.prototype.newChangeBuffer=function(){return new Af(this.sizer,this)},t.prototype.getSize=function(t){return Zh.resolve(this.size)},t}(),Af=function(t){function e(e,n){var r=t.call(this)||this;return r.sizer=e,r.documentCache=n,r}return Jn(e,t),e.prototype.applyChanges=function(t){var e=this,n=this.assertChanges(),r=0,i=[];return n.forEach(function(t,n){var o=e.documentSizes.get(t);Ks(void 0!==o,"Attempting to change document "+t.toString()+" without having read it first");var a=e.sizer(n);r+=a-o,i.push({maybeDocument:n,size:a})}),this.documentCache.addEntries(t,i,r)},e.prototype.getFromCache=function(t,e){return this.documentCache.getSizedEntry(t,e)},e.prototype.getAllFromCache=function(t,e){return this.documentCache.getSizedEntries(t,e)},e}(Sl),Nf=function(){function t(t,e){var n=this;this.clientId=t,this.mutationQueues={},this.listenSequence=new Bh(0),this._started=!1,this._started=!0,this.referenceDelegate=e(this),this.queryCache=new If(this);this.indexManager=new Rl,this.remoteDocumentCache=new Df(this.indexManager,function(t){return n.referenceDelegate.documentSize(t)})}return t.createLruPersistence=function(e,n,r){return new t(e,function(t){return new Of(t,new Zl(n),r)})},t.createEagerPersistence=function(e){return new t(e,function(t){return new Rf(t)})},t.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.getActiveClients=function(){return Zn(this,void 0,void 0,function(){return tr(this,function(t){return[2,[this.clientId]]})})},t.prototype.setPrimaryStateListener=function(t){return t(!0)},t.prototype.setNetworkEnabled=function(t){},t.prototype.getIndexManager=function(){return this.indexManager},t.prototype.getMutationQueue=function(t){var e=this.mutationQueues[t.toKey()];return e||(e=new Tf(this.indexManager,this.referenceDelegate),this.mutationQueues[t.toKey()]=e),e},t.prototype.getQueryCache=function(){return this.queryCache},t.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},t.prototype.runTransaction=function(t,e,n){var r=this;Vs("MemoryPersistence","Starting transaction:",t);var i=new kf(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next(function(t){return r.referenceDelegate.onTransactionCommitted(i).next(function(){return t})}).toPromise()},t.prototype.mutationQueuesContainKey=function(t,e){return Zh.or((n=this.mutationQueues,r=[],Zs(n,function(t,e){return r.push(e)}),r).map(function(n){return function(){return n.containsKey(t,e)}}));var n,r},t}(),kf=function(){return function(t){this.currentSequenceNumber=t}}(),Rf=function(){function t(t){this.persistence=t}return t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.addReference=function(t,e){return this.orphanedDocuments.delete(e),Zh.resolve()},t.prototype.removeReference=function(t,e){return this.orphanedDocuments.add(e),Zh.resolve()},t.prototype.removeMutationReference=function(t,e){return this.orphanedDocuments.add(e),Zh.resolve()},t.prototype.removeTarget=function(t,e){var n=this,r=this.persistence.getQueryCache();return r.getMatchingKeysForTargetId(t,e.targetId).next(function(t){t.forEach(function(t){return n.orphanedDocuments.add(t)})}).next(function(){return r.removeQueryData(t,e)})},t.prototype.onTransactionStarted=function(){this.orphanedDocuments=new Set},t.prototype.onTransactionCommitted=function(t){var e=this,n=this.persistence.getRemoteDocumentCache();return Zh.forEach(this.orphanedDocuments,function(r){return e.isReferenced(t,r).next(function(e){return e?Zh.resolve():n.removeEntry(t,r).next(function(){})})})},t.prototype.updateLimboDocument=function(t,e){var n=this;return this.isReferenced(t,e).next(function(t){t?n.orphanedDocuments.delete(e):n.orphanedDocuments.add(e)})},t.prototype.documentSize=function(t){return 0},t.prototype.isReferenced=function(t,e){var n=this;return Zh.or([function(){return n.persistence.getQueryCache().containsKey(t,e)},function(){return n.persistence.mutationQueuesContainKey(t,e)},function(){return Zh.resolve(n.inMemoryPins.containsKey(e))}])},t}(),Of=function(){function t(t,e,n){this.persistence=t,this.serializer=e,this.orphanedSequenceNumbers=new wl(function(t){return zh(t.path)}),this.garbageCollector=new af(this,n)}return t.prototype.onTransactionStarted=function(){},t.prototype.onTransactionCommitted=function(t){return Zh.resolve()},t.prototype.forEachTarget=function(t,e){return this.persistence.getQueryCache().forEachTarget(t,e)},t.prototype.getSequenceNumberCount=function(t){var e=this.orphanedDocumentCount(t);return this.persistence.getQueryCache().getTargetCount(t).next(function(t){return e.next(function(e){return t+e})})},t.prototype.orphanedDocumentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},t.prototype.forEachOrphanedDocumentSequenceNumber=function(t,e){var n=this;return Zh.forEach(this.orphanedSequenceNumbers,function(r,i){return n.isPinned(t,r,i).next(function(t){return t?Zh.resolve():e(i)})})},t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.removeTargets=function(t,e,n){return this.persistence.getQueryCache().removeTargets(t,e,n)},t.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=0,i=this.persistence.getRemoteDocumentCache();return i.forEachDocumentKey(t,function(o){return n.isPinned(t,o,e).next(function(e){return e?Zh.resolve():(r++,i.removeEntry(t,o).next())})}).next(function(){return r})},t.prototype.removeMutationReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Zh.resolve()},t.prototype.removeTarget=function(t,e){var n=e.copy({sequenceNumber:t.currentSequenceNumber});return this.persistence.getQueryCache().updateQueryData(t,n)},t.prototype.addReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Zh.resolve()},t.prototype.removeReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Zh.resolve()},t.prototype.updateLimboDocument=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),Zh.resolve()},t.prototype.documentSize=function(t){var e,n=this.serializer.toDbRemoteDocument(t);if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw Qs("Unknown remote document type");e=n.noDocument}return JSON.stringify(e).length},t.prototype.isPinned=function(t,e,n){var r=this;return Zh.or([function(){return r.persistence.mutationQueuesContainKey(t,e)},function(){return Zh.resolve(r.inMemoryPins.containsKey(e))},function(){return r.persistence.getQueryCache().containsKey(t,e)},function(){var t=r.orphanedSequenceNumbers.get(e);return Zh.resolve(void 0!==t&&t>n)}])},t.prototype.getCacheSize=function(t){return this.persistence.getRemoteDocumentCache().getSize(t)},t}(),_f=function(){function t(t,e,n,r,i){this.queue=t,this.timerId=e,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}return t.prototype.reset=function(){this.currentBaseMs=0},t.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},t.prototype.backoffAndRun=function(t){var e=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);this.currentBaseMs>0&&Vs("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,function(){return e.lastAttemptTime=Date.now(),t()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},t.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},t.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},t}();!function(t){t[t.Initial=0]="Initial",t[t.Starting=1]="Starting",t[t.Open=2]="Open",t[t.Error=3]="Error",t[t.Backoff=4]="Backoff"}(Cf||(Cf={}));var Mf,Pf,Lf=1e3,xf=6e4,qf=1.5,Ff=function(){function t(t,e,n,r,i,o){this.queue=t,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=Cf.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new _f(t,e,Lf,qf,xf)}return t.prototype.isStarted=function(){return this.state===Cf.Starting||this.state===Cf.Open||this.state===Cf.Backoff},t.prototype.isOpen=function(){return this.state===Cf.Open},t.prototype.start=function(){this.state!==Cf.Error?(Ks(this.state===Cf.Initial,"Already started"),this.auth()):this.performBackoff()},t.prototype.stop=function(){return Zn(this,void 0,void 0,function(){return tr(this,function(t){switch(t.label){case 0:return this.isStarted()?[4,this.close(Cf.Initial)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t.prototype.inhibitBackoff=function(){Ks(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=Cf.Initial,this.backoff.reset()},t.prototype.markIdle=function(){var t=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return t.handleIdleCloseTimer()}))},t.prototype.sendRequest=function(t){this.cancelIdleCheck(),this.stream.send(t)},t.prototype.handleIdleCloseTimer=function(){return Zn(this,void 0,void 0,function(){return tr(this,function(t){return this.isOpen()?[2,this.close(Cf.Initial)]:[2]})})},t.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},t.prototype.close=function(t,e){return Zn(this,void 0,void 0,function(){return tr(this,function(n){switch(n.label){case 0:return Ks(this.isStarted(),"Only started streams should be closed."),Ks(t===Cf.Error||pc(e),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,t!==Cf.Error?this.backoff.reset():e&&e.code===zs.RESOURCE_EXHAUSTED?(Us(e.toString()),Us("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):e&&e.code===zs.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=t,[4,this.listener.onClose(e)];case 1:return n.sent(),[2]}})})},t.prototype.tearDown=function(){},t.prototype.auth=function(){var t=this;Ks(this.state===Cf.Initial,"Must be in initial state to auth"),this.state=Cf.Starting;var e=this.getCloseGuardedDispatcher(this.closeCount),n=this.closeCount;this.credentialsProvider.getToken().then(function(e){t.closeCount===n&&t.startStream(e)},function(n){e(function(){var e=new Hs(zs.UNKNOWN,"Fetching auth token failed: "+n.message);return t.handleStreamClose(e)})})},t.prototype.startStream=function(t){var e=this;Ks(this.state===Cf.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(t),this.stream.onOpen(function(){n(function(){return Ks(e.state===Cf.Starting,"Expected stream to be in state Starting, but was "+e.state),e.state=Cf.Open,e.listener.onOpen()})}),this.stream.onClose(function(t){n(function(){return e.handleStreamClose(t)})}),this.stream.onMessage(function(t){n(function(){return e.onMessage(t)})})},t.prototype.performBackoff=function(){var t=this;Ks(this.state===Cf.Error,"Should only perform backoff when in Error state"),this.state=Cf.Backoff,this.backoff.backoffAndRun(function(){return Zn(t,void 0,void 0,function(){return tr(this,function(t){return Ks(this.state===Cf.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=Cf.Initial,this.start(),Ks(this.isStarted(),"PersistentStream should have started"),[2]})})})},t.prototype.handleStreamClose=function(t){return Ks(this.isStarted(),"Can't handle server close on non-started stream"),Vs("PersistentStream","close with error: "+t),this.stream=null,this.close(Cf.Error,t)},t.prototype.getCloseGuardedDispatcher=function(t){var e=this;return function(n){e.queue.enqueueAndForget(function(){return e.closeCount===t?n():(Vs("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},t}(),Bf=function(t){function e(e,n,r,i,o){var a=t.call(this,e,Fh.ListenStreamConnectionBackoff,Fh.ListenStreamIdle,n,r,o)||this;return a.serializer=i,a}return Jn(e,t),e.prototype.startRpc=function(t){return this.connection.openStream("Listen",t)},e.prototype.onMessage=function(t){this.backoff.reset();var e=this.serializer.fromWatchChange(t),n=this.serializer.versionFromListenResponse(t);return this.listener.onWatchChange(e,n)},e.prototype.watch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.addTarget=this.serializer.toTarget(t);var n=this.serializer.toListenRequestLabels(t);n&&(e.labels=n),this.sendRequest(e)},e.prototype.unwatch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.removeTarget=t,this.sendRequest(e)},e}(Ff),Vf=function(t){function e(e,n,r,i,o){var a=t.call(this,e,Fh.WriteStreamConnectionBackoff,Fh.WriteStreamIdle,n,r,o)||this;return a.serializer=i,a.handshakeComplete_=!1,a}return Jn(e,t),Object.defineProperty(e.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),e.prototype.start=function(){this.handshakeComplete_=!1,t.prototype.start.call(this)},e.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},e.prototype.startRpc=function(t){return this.connection.openStream("Write",t)},e.prototype.onMessage=function(t){if(Ks(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.handshakeComplete_){this.backoff.reset();var e=this.serializer.fromWriteResults(t.writeResults,t.commitTime),n=this.serializer.fromVersion(t.commitTime);return this.listener.onMutationResult(n,e)}return Ks(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},e.prototype.writeHandshake=function(){Ks(this.isOpen(),"Writing handshake requires an opened stream"),Ks(!this.handshakeComplete_,"Handshake already completed");var t={};t.database=this.serializer.encodedDatabaseId,this.sendRequest(t)},e.prototype.writeMutations=function(t){var e=this;Ks(this.isOpen(),"Writing mutations requires an opened stream"),Ks(this.handshakeComplete_,"Handshake must be complete before writing mutations"),Ks(this.lastStreamToken.length>0,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:t.map(function(t){return e.serializer.toMutation(t)})};this.sendRequest(n)},e}(Ff),Uf=function(){function t(t,e,n,r){this.queue=t,this.connection=e,this.credentials=n,this.serializer=r}return t.prototype.newPersistentWriteStream=function(t){return new Vf(this.queue,this.connection,this.credentials,this.serializer,t)},t.prototype.newPersistentWatchStream=function(t){return new Bf(this.queue,this.connection,this.credentials,this.serializer,t)},t.prototype.commit=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,writes:t.map(function(t){return e.serializer.toMutation(t)})};return this.invokeRPC("Commit",n).then(function(t){return e.serializer.fromWriteResults(t.writeResults,t.commitTime)})},t.prototype.lookup=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,documents:t.map(function(t){return e.serializer.toName(t)})};return this.invokeStreamingRPC("BatchGetDocuments",n).then(function(n){var r=$c();n.forEach(function(t){var n=e.serializer.fromMaybeDocument(t);r=r.insert(n.key,n)});var i=[];return t.forEach(function(t){var e=r.get(t);Ks(!!e,"Missing entity in write response for "+t),i.push(e)}),i})},t.prototype.invokeRPC=function(t,e){var n=this;return this.credentials.getToken().then(function(r){return n.connection.invokeRPC(t,e,r)}).catch(function(t){throw t.code===zs.UNAUTHENTICATED&&n.credentials.invalidateToken(),t})},t.prototype.invokeStreamingRPC=function(t,e){var n=this;return this.credentials.getToken().then(function(r){return n.connection.invokeStreamingRPC(t,e,r)}).catch(function(t){throw t.code===zs.UNAUTHENTICATED&&n.credentials.invalidateToken(),t})},t}(),jf=function(){function t(t){this.datastore=t,this.readVersions=rh(),this.mutations=[],this.committed=!1}return t.prototype.recordVersion=function(t){var e;if(t instanceof Vu)e=t.version;else{if(!(t instanceof Uu))throw Qs("Document in a transaction was a "+t.constructor.name);e=Ac.forDeletedDoc()}var n=this.readVersions.get(t.key);if(null!==n){if(!e.isEqual(n))throw new Hs(zs.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(t.key,e)},t.prototype.lookup=function(t){var e=this;return this.committed?Promise.reject("Transaction has already completed."):this.mutations.length>0?Promise.reject("Transactions lookups are invalid after writes."):this.datastore.lookup(t).then(function(t){return t.forEach(function(t){t instanceof Uu||t instanceof Vu?e.recordVersion(t):Qs("Document in a transaction was a "+t.constructor.name)}),t})},t.prototype.write=function(t){if(this.committed)throw new Hs(zs.FAILED_PRECONDITION,"Transaction has already completed.");this.mutations=this.mutations.concat(t)},t.prototype.precondition=function(t){var e=this.readVersions.get(t);return e?Lc.updateTime(e):Lc.NONE},t.prototype.preconditionForUpdate=function(t){var e=this.readVersions.get(t);if(e&&e.isEqual(Ac.forDeletedDoc()))throw new Hs(zs.FAILED_PRECONDITION,"Can't update a document that doesn't exist.");return e?Lc.updateTime(e):Lc.exists(!0)},t.prototype.set=function(t,e){this.write(e.toMutations(t,this.precondition(t)))},t.prototype.update=function(t,e){this.write(e.toMutations(t,this.preconditionForUpdate(t)))},t.prototype.delete=function(t){this.write([new Vc(t,this.precondition(t))]),this.readVersions=this.readVersions.insert(t,Ac.forDeletedDoc())},t.prototype.commit=function(){var t=this,e=this.readVersions;return this.mutations.forEach(function(t){e=e.remove(t.key)}),e.isEmpty()?this.datastore.commit(this.mutations).then(function(){t.committed=!0}):Promise.reject(Error("Every document read in a transaction must also be written."))},t}();!function(t){t[t.Unknown=0]="Unknown",t[t.Online=1]="Online",t[t.Offline=2]="Offline"}(Mf||(Mf={})),function(t){t[t.RemoteStore=0]="RemoteStore",t[t.SharedClientState=1]="SharedClientState"}(Pf||(Pf={}));var Qf=function(){function t(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state=Mf.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}return t.prototype.handleWatchStreamStart=function(){var t=this;0===this.watchStreamFailures&&(this.setAndBroadcast(Mf.Unknown),Ks(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(Fh.OnlineStateTimeout,1e4,function(){return t.onlineStateTimer=null,Ks(t.state===Mf.Unknown,"Timer should be canceled if we transitioned to a different state."),t.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),t.setAndBroadcast(Mf.Offline),Promise.resolve()}))},t.prototype.handleWatchStreamFailure=function(t){this.state===Mf.Online?(this.setAndBroadcast(Mf.Unknown),Ks(0===this.watchStreamFailures,"watchStreamFailures must be 0"),Ks(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,this.watchStreamFailures>=1&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+t.toString()),this.setAndBroadcast(Mf.Offline)))},t.prototype.set=function(t){this.clearOnlineStateTimer(),this.watchStreamFailures=0,t===Mf.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(t)},t.prototype.setAndBroadcast=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},t.prototype.logClientOfflineWarningIfNecessary=function(t){var e="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(Us(e),this.shouldWarnClientIsOffline=!1):Vs("OnlineStateTracker",e)},t.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},t}(),Kf=function(){function t(t,e,n,r){this.localStore=t,this.datastore=e,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.onlineStateTracker=new Qf(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}return t.prototype.start=function(){return this.enableNetwork()},t.prototype.enableNetwork=function(){return Zn(this,void 0,void 0,function(){var t;return tr(this,function(e){switch(e.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(t=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return t.lastStreamToken=e.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(Mf.Unknown),[4,this.fillWritePipeline()];case 2:e.sent(),e.label=3;case 3:return[2]}})})},t.prototype.disableNetwork=function(){return Zn(this,void 0,void 0,function(){return tr(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(Mf.Offline),[2]}})})},t.prototype.disableNetworkInternal=function(){return Zn(this,void 0,void 0,function(){return tr(this,function(t){switch(t.label){case 0:return[4,this.writeStream.stop()];case 1:return t.sent(),[4,this.watchStream.stop()];case 2:return t.sent(),this.writePipeline.length>0&&(Vs("RemoteStore","Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})},t.prototype.shutdown=function(){return Zn(this,void 0,void 0,function(){return tr(this,function(t){switch(t.label){case 0:return Vs("RemoteStore","RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(Mf.Unknown),[2]}})})},t.prototype.listen=function(t){Ks(!Xs(this.listenTargets,t.targetId),"listen called with duplicate targetId!"),this.listenTargets[t.targetId]=t,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(t)},t.prototype.unlisten=function(t){Ks(Xs(this.listenTargets,t),"unlisten called without assigned target ID!"),delete this.listenTargets[t],this.watchStream.isOpen()&&this.sendUnwatchRequest(t),tu(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(Mf.Unknown))},t.prototype.getQueryDataForTarget=function(t){return this.listenTargets[t]||null},t.prototype.getRemoteKeysForTarget=function(t){return this.syncEngine.getRemoteKeysForTarget(t)},t.prototype.sendWatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t.targetId),this.watchStream.watch(t)},t.prototype.sendUnwatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t),this.watchStream.unwatch(t)},t.prototype.startWatchStream=function(){Ks(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new wh(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},t.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!tu(this.listenTargets)},t.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},t.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},t.prototype.onWatchStreamOpen=function(){return Zn(this,void 0,void 0,function(){var t=this;return tr(this,function(e){return $s(this.listenTargets,function(e,n){t.sendWatchRequest(n)}),[2]})})},t.prototype.onWatchStreamClose=function(t){return Zn(this,void 0,void 0,function(){return tr(this,function(e){return void 0===t&&Ks(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(t),this.startWatchStream()):this.onlineStateTracker.set(Mf.Unknown),[2]})})},t.prototype.onWatchStreamChange=function(t,e){return Zn(this,void 0,void 0,function(){var n;return tr(this,function(r){switch(r.label){case 0:return this.onlineStateTracker.set(Mf.Online),t instanceof vh&&t.state===lh.Removed&&t.cause?[2,this.handleTargetError(t)]:(t instanceof mh?this.watchChangeAggregator.handleDocumentChange(t):t instanceof gh?this.watchChangeAggregator.handleExistenceFilter(t):(Ks(t instanceof vh,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(t)),e.isEqual(Ac.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return n=r.sent(),e.compareTo(n)>=0?[4,this.raiseWatchSnapshot(e)]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}})})},t.prototype.raiseWatchSnapshot=function(t){var e=this;Ks(!t.isEqual(Ac.MIN),"Can't raise event for unknown SnapshotVersion");var n=this.watchChangeAggregator.createRemoteEvent(t);return $s(n.targetChanges,function(n,r){if(r.resumeToken.length>0){var i=e.listenTargets[n];i&&(e.listenTargets[n]=i.copy({resumeToken:r.resumeToken,snapshotVersion:t}))}}),n.targetMismatches.forEach(function(t){var n=e.listenTargets[t];if(n){e.listenTargets[t]=n.copy({resumeToken:Ws()}),e.sendUnwatchRequest(t);var r=new kc(n.query,t,yc.ExistenceFilterMismatch,n.sequenceNumber);e.sendWatchRequest(r)}}),this.syncEngine.applyRemoteEvent(n)},t.prototype.handleTargetError=function(t){var e=this;Ks(!!t.cause,"Handling target error without a cause");var n=t.cause,r=Promise.resolve();return t.targetIds.forEach(function(t){r=r.then(function(){return Zn(e,void 0,void 0,function(){return tr(this,function(e){return Xs(this.listenTargets,t)?(delete this.listenTargets[t],this.watchChangeAggregator.removeTarget(t),[2,this.syncEngine.rejectListen(t,n)]):[2]})})})}),r},t.prototype.fillWritePipeline=function(){return Zn(this,void 0,void 0,function(){var t,e;return tr(this,function(n){switch(n.label){case 0:return this.canAddToWritePipeline()?(t=this.writePipeline.length>0?this.writePipeline[this.writePipeline.length-1].batchId:-1,[4,this.localStore.nextMutationBatch(t)]):[3,4];case 1:return null!==(e=n.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(e),[4,this.fillWritePipeline()];case 3:n.sent(),n.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})},t.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},t.prototype.outstandingWrites=function(){return this.writePipeline.length},t.prototype.addToWritePipeline=function(t){Ks(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(t),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(t.mutations)},t.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&this.writePipeline.length>0},t.prototype.startWriteStream=function(){Ks(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},t.prototype.onWriteStreamOpen=function(){return Zn(this,void 0,void 0,function(){return tr(this,function(t){return this.writeStream.writeHandshake(),[2]})})},t.prototype.onWriteHandshakeComplete=function(){var t=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var e=0,n=t.writePipeline;e<n.length;e++){var r=n[e];t.writeStream.writeMutations(r.mutations)}}).catch(df)},t.prototype.onMutationResult=function(t,e){var n=this;Ks(this.writePipeline.length>0,"Got result for empty write pipeline");var r=this.writePipeline.shift(),i=$h.from(r,t,e,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(i).then(function(){return n.fillWritePipeline()})},t.prototype.onWriteStreamClose=function(t){return Zn(this,void 0,void 0,function(){var e=this;return tr(this,function(n){return void 0===t&&Ks(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),t&&this.writePipeline.length>0?(void 0,[2,(this.writeStream.handshakeComplete?this.handleWriteError(t):this.handleHandshakeError(t)).then(function(){e.shouldStartWriteStream()&&e.startWriteStream()})]):[2]})})},t.prototype.handleHandshakeError=function(t){return Zn(this,void 0,void 0,function(){return tr(this,function(e){return Hc(t.code)?(Vs("RemoteStore","RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=Ws(),[2,this.localStore.setLastStreamToken(Ws()).catch(df)]):[2]})})},t.prototype.handleWriteError=function(t){return Zn(this,void 0,void 0,function(){var e,n=this;return tr(this,function(r){return Hc(i=t.code)&&i!==zs.ABORTED?(e=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(e.batchId,t).then(function(){return n.fillWritePipeline()})]):[2];var i})})},t.prototype.createTransaction=function(){return new jf(this.datastore)},t.prototype.handleCredentialChange=function(){return Zn(this,void 0,void 0,function(){return tr(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(Vs("RemoteStore","RemoteStore restarting streams for new credential"),this.networkEnabled=!1,[4,this.disableNetworkInternal()]):[3,3];case 1:return t.sent(),this.onlineStateTracker.set(Mf.Unknown),[4,this.enableNetwork()];case 2:t.sent(),t.label=3;case 3:return[2]}})})},t.prototype.applyPrimaryState=function(t){return Zn(this,void 0,void 0,function(){return tr(this,function(e){switch(e.label){case 0:return this.isPrimary=t,t&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return e.sent(),[3,4];case 2:return t?[3,4]:[4,this.disableNetworkInternal()];case 3:e.sent(),this.onlineStateTracker.set(Mf.Unknown),e.label=4;case 4:return[2]}})})},t}(),Gf=function(){return function(){this.listeners=[]}}(),Wf=function(){function t(t){this.syncEngine=t,this.queries=new wl(function(t){return t.canonicalId()}),this.onlineState=Mf.Unknown,this.syncEngine.subscribe(this)}return t.prototype.listen=function(t){var e=t.query,n=!1,r=this.queries.get(e);return r||(n=!0,r=new Gf,this.queries.set(e,r)),r.listeners.push(t),t.applyOnlineStateChange(this.onlineState),r.viewSnap&&t.onViewSnapshot(r.viewSnap),n?this.syncEngine.listen(e).then(function(t){return r.targetId=t,t}):Promise.resolve(r.targetId)},t.prototype.unlisten=function(t){return Zn(this,void 0,void 0,function(){var e,n,r,i;return tr(this,function(o){return e=t.query,n=!1,(r=this.queries.get(e))&&(i=r.listeners.indexOf(t))>=0&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(e),[2,this.syncEngine.unlisten(e)]):[2]})})},t.prototype.onWatchChange=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e],i=r.query,o=this.queries.get(i);if(o){for(var a=0,s=o.listeners;a<s.length;a++){s[a].onViewSnapshot(r)}o.viewSnap=r}}},t.prototype.onWatchError=function(t,e){var n=this.queries.get(t);if(n)for(var r=0,i=n.listeners;r<i.length;r++){i[r].onError(e)}this.queries.delete(t)},t.prototype.onOnlineStateChange=function(t){this.onlineState=t,this.queries.forEach(function(e,n){for(var r=0,i=n.listeners;r<i.length;r++){i[r].applyOnlineStateChange(t)}})},t}(),zf=function(){function t(t,e,n){this.query=t,this.queryObserver=e,this.raisedInitialEvent=!1,this.onlineState=Mf.Unknown,this.options=n||{}}return t.prototype.onViewSnapshot=function(t){if(Ks(t.docChanges.length>0||t.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];i.type!==uh.Metadata&&e.push(i)}t=new ph(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}this.raisedInitialEvent?this.shouldRaiseEvent(t)&&this.queryObserver.next(t):this.shouldRaiseInitialEvent(t,this.onlineState)&&this.raiseInitialEvent(t),this.snap=t},t.prototype.onError=function(t){this.queryObserver.error(t)},t.prototype.applyOnlineStateChange=function(t){this.onlineState=t,this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,t)&&this.raiseInitialEvent(this.snap)},t.prototype.shouldRaiseInitialEvent=function(t,e){if(Ks(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!t.fromCache)return!0;var n=e!==Mf.Offline;return this.options.waitForSyncWhenOnline&&n?(Ks(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.isEmpty()||e===Mf.Offline},t.prototype.shouldRaiseEvent=function(t){if(t.docChanges.length>0)return!0;var e=this.snap&&this.snap.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges},t.prototype.raiseInitialEvent=function(t){Ks(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t=ph.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(t)},t}(),Hf=function(){function t(t,e,n){this.targetId=t,this.addedKeys=e,this.removedKeys=n}return t.fromSnapshot=function(e,n){for(var r=oh(),i=oh(),o=0,a=n.docChanges;o<a.length;o++){var s=a[o];switch(s.type){case uh.Added:r=r.add(s.doc.key);break;case uh.Removed:i=i.add(s.doc.key)}}return new t(e,r,i)},t}(),Yf=function(){return function(t){this.key=t}}(),Xf=function(){return function(t){this.key=t}}(),Jf=function(){function t(t,e){this.query=t,this._syncedDocuments=e,this.syncState=null,this.current=!1,this.limboDocuments=oh(),this.mutatedKeys=oh(),this.documentSet=new hh(t.docComparator.bind(t))}return Object.defineProperty(t.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),t.prototype.computeDocChanges=function(t,e){var n=this,r=e?e.changeSet:new fh,i=e?e.documentSet:this.documentSet,o=e?e.mutatedKeys:this.mutatedKeys,a=i,s=!1,u=this.query.hasLimit()&&i.size===this.query.limit?i.last():null;if(t.inorderTraversal(function(t,e){var c=i.get(t),h=e instanceof Vu?e:null;h&&(Ks(t.isEqual(h.key),"Mismatching keys found in document changes: "+t+" != "+h.key),h=n.query.matches(h)?h:null);var l=!!c&&n.mutatedKeys.has(c.key),f=!!h&&(h.hasLocalMutations||n.mutatedKeys.has(h.key)&&h.hasCommittedMutations),p=!1;c&&h?c.data.isEqual(h.data)?l!==f&&(r.track({type:uh.Metadata,doc:h}),p=!0):n.shouldWaitForSyncedDocument(c,h)||(r.track({type:uh.Modified,doc:h}),p=!0,u&&n.query.docComparator(h,u)>0&&(s=!0)):!c&&h?(r.track({type:uh.Added,doc:h}),p=!0):c&&!h&&(r.track({type:uh.Removed,doc:c}),p=!0,u&&(s=!0));p&&(h?(a=a.add(h),o=f?o.add(t):o.delete(t)):(a=a.delete(t),o=o.delete(t)))}),this.query.hasLimit())for(;a.size>this.query.limit;){var c=a.last();a=a.delete(c.key),o=o.delete(c.key),r.track({type:uh.Removed,doc:c})}return Ks(!s||!e,"View was refilled using docs that themselves needed refilling."),{documentSet:a,changeSet:r,needsRefill:s,mutatedKeys:o}},t.prototype.shouldWaitForSyncedDocument=function(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations},t.prototype.applyChanges=function(t,e,n){var r=this;Ks(!t.needsRefill,"Cannot apply changes that need a refill");var i=this.documentSet;this.documentSet=t.documentSet,this.mutatedKeys=t.mutatedKeys;var o=t.changeSet.getChanges();o.sort(function(t,e){return function(t,e){var n=function(t){switch(t){case uh.Added:return 1;case uh.Modified:case uh.Metadata:return 2;case uh.Removed:return 0;default:return Qs("Unknown ChangeType: "+t)}};return n(t)-n(e)}(t.type,e.type)||r.query.docComparator(t.doc,e.doc)}),this.applyTargetChange(n);var a=e?this.updateLimboDocuments():[],s=0===this.limboDocuments.size&&this.current?ch.Synced:ch.Local,u=s!==this.syncState;return this.syncState=s,0!==o.length||u?{snapshot:new ph(this.query,t.documentSet,i,o,t.mutatedKeys,s===ch.Local,u,!1),limboChanges:a}:{limboChanges:a}},t.prototype.applyOnlineStateChange=function(t){return this.current&&t===Mf.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new fh,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},t.prototype.shouldBeInLimbo=function(t){return!this._syncedDocuments.has(t)&&(!!this.documentSet.has(t)&&!this.documentSet.get(t).hasLocalMutations)},t.prototype.applyTargetChange=function(t){var e=this;t&&(t.addedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.add(t)}),t.modifiedDocuments.forEach(function(t){return Ks(e._syncedDocuments.has(t),"Modified document "+t+" not found in view.")}),t.removedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.delete(t)}),this.current=t.current)},t.prototype.updateLimboDocuments=function(){var t=this;if(!this.current)return[];var e=this.limboDocuments;this.limboDocuments=oh(),this.documentSet.forEach(function(e){t.shouldBeInLimbo(e.key)&&(t.limboDocuments=t.limboDocuments.add(e.key))});var n=[];return e.forEach(function(e){t.limboDocuments.has(e)||n.push(new Xf(e))}),this.limboDocuments.forEach(function(t){e.has(t)||n.push(new Yf(t))}),n},t.prototype.synchronizeWithPersistedState=function(t,e){this._syncedDocuments=e,this.limboDocuments=oh();var n=this.computeDocChanges(t);return this.applyChanges(n,!0)},t.prototype.computeInitialSnapshot=function(){return ph.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===ch.Local)},t}();var $f=function(){return function(t,e,n){this.query=t,this.targetId=e,this.view=n}}(),Zf=function(){return function(t){this.key=t}}(),tp=function(){function t(t,e,n,r){this.localStore=t,this.remoteStore=e,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new wl(function(t){return t.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new Qu(Fu.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new wf,this.mutationUserCallbacks={},this.limboTargetIdGenerator=cl.forSyncEngine(),this.isPrimary=void 0,this.onlineState=Mf.Unknown}return Object.defineProperty(t.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),t.prototype.subscribe=function(t){Ks(null!==t,"SyncEngine listener cannot be null"),Ks(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=t},t.prototype.listen=function(t){return Zn(this,void 0,void 0,function(){var e,n,r,i,o;return tr(this,function(a){switch(a.label){case 0:return this.assertSubscribed("listen()"),(r=this.queryViewsByQuery.get(t))?(e=r.targetId,this.sharedClientState.addLocalQueryTarget(e),n=r.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(t)];case 2:return i=a.sent(),o=this.sharedClientState.addLocalQueryTarget(i.targetId),e=i.targetId,[4,this.initializeViewAndComputeSnapshot(i,"current"===o)];case 3:n=a.sent(),this.isPrimary&&this.remoteStore.listen(i),a.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,e]}})})},t.prototype.initializeViewAndComputeSnapshot=function(t,e){var n=this,r=t.query;return this.localStore.executeQuery(r).then(function(i){return n.localStore.remoteDocumentKeys(t.targetId).then(function(o){var a=new Jf(r,o),s=a.computeDocChanges(i),u=yh.createSynthesizedTargetChangeForCurrentChange(t.targetId,e&&n.onlineState!==Mf.Offline),c=a.applyChanges(s,!0===n.isPrimary,u);Ks(0===c.limboChanges.length,"View returned limbo docs before target ack from the server."),Ks(!!c.snapshot,"applyChanges for new view should always return a snapshot");var h=new $f(r,t.targetId,a);return n.queryViewsByQuery.set(r,h),n.queryViewsByTarget[t.targetId]=h,c.snapshot})})},t.prototype.synchronizeViewAndComputeSnapshot=function(t){var e=this;return this.localStore.executeQuery(t.query).then(function(n){return e.localStore.remoteDocumentKeys(t.targetId).then(function(r){return Zn(e,void 0,void 0,function(){var e;return tr(this,function(i){return e=t.view.synchronizeWithPersistedState(n,r),this.isPrimary&&this.updateTrackedLimbos(t.targetId,e.limboChanges),[2,e]})})})})},t.prototype.unlisten=function(t){return Zn(this,void 0,void 0,function(){var e,n=this;return tr(this,function(r){switch(r.label){case 0:return this.assertSubscribed("unlisten()"),Ks(!!(e=this.queryViewsByQuery.get(t)),"Trying to unlisten on query not found:"+t),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(e.targetId),this.sharedClientState.isActiveQueryTarget(e.targetId)?[3,2]:[4,this.localStore.releaseQuery(t,!1).then(function(){n.sharedClientState.clearQueryState(e.targetId),n.remoteStore.unlisten(e.targetId),n.removeAndCleanupQuery(e)}).catch(df)]):[3,3];case 1:r.sent(),r.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(e),[4,this.localStore.releaseQuery(t,!0)];case 4:r.sent(),r.label=5;case 5:return[2]}})})},t.prototype.write=function(t,e){var n=this;return this.assertSubscribed("write()"),this.localStore.localWrite(t).then(function(t){return n.sharedClientState.addPendingMutation(t.batchId),n.addMutationCallback(t.batchId,e),n.emitNewSnapsAndNotifyLocalStore(t.changes)}).then(function(){return n.remoteStore.fillWritePipeline()})},t.prototype.wrapUpdateFunctionError=function(t){return t},t.prototype.runTransaction=function(t,e){var n=this;void 0===e&&(e=5),Ks(e>=0,"Got negative number of retries for transaction.");var r=this.remoteStore.createTransaction();return function(){try{var e=t(r);return!pc(e)&&e.catch&&e.then?e.catch(function(t){return Promise.reject(n.wrapUpdateFunctionError(t))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(t){return Promise.reject(n.wrapUpdateFunctionError(t))}}().then(function(i){return r.commit().then(function(){return i}).catch(function(r){return 0===e?Promise.reject(r):n.runTransaction(t,e-1)})})},t.prototype.applyRemoteEvent=function(t){var e=this;return this.assertSubscribed("applyRemoteEvent()"),this.localStore.applyRemoteEvent(t).then(function(n){return Zs(t.targetChanges,function(t,n){var r=e.limboResolutionsByTarget[t];r&&(Ks(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),n.addedDocuments.size>0?r.receivedDocument=!0:n.modifiedDocuments.size>0?Ks(r.receivedDocument,"Received change for limbo target document without add."):n.removedDocuments.size>0&&(Ks(r.receivedDocument,"Received remove for limbo target document without add."),r.receivedDocument=!1))}),e.emitNewSnapsAndNotifyLocalStore(n,t)}).catch(df)},t.prototype.applyOnlineStateChange=function(t,e){if(this.isPrimary&&e===Pf.RemoteStore||!this.isPrimary&&e===Pf.SharedClientState){var n=[];this.queryViewsByQuery.forEach(function(e,r){var i=r.view.applyOnlineStateChange(t);Ks(0===i.limboChanges.length,"OnlineState should not affect limbo documents."),i.snapshot&&n.push(i.snapshot)}),this.syncEngineListener.onOnlineStateChange(t),this.syncEngineListener.onWatchChange(n),this.onlineState=t,this.isPrimary&&this.sharedClientState.setOnlineState(t)}},t.prototype.rejectListen=function(t,e){return Zn(this,void 0,void 0,function(){var n,r,i,o,a,s,u=this;return tr(this,function(c){switch(c.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(t,"rejected",e),n=this.limboResolutionsByTarget[t],(r=n&&n.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(r),delete this.limboResolutionsByTarget[t],i=(i=new Qu(Fu.comparator)).insert(r,new Uu(r,Ac.forDeletedDoc())),o=oh().add(r),a=new dh(Ac.MIN,{},new Rc(wu),i,o),[2,this.applyRemoteEvent(a)]):[3,1];case 1:return Ks(!!(s=this.queryViewsByTarget[t]),"Unknown targetId: "+t),[4,this.localStore.releaseQuery(s.query,!1).then(function(){return u.removeAndCleanupQuery(s)}).catch(df)];case 2:c.sent(),this.syncEngineListener.onWatchError(s.query,e),c.label=3;case 3:return[2]}})})},t.prototype.applyBatchState=function(t,e,n){return Zn(this,void 0,void 0,function(){var r;return tr(this,function(i){switch(i.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(t)];case 1:return null===(r=i.sent())?(Vs("SyncEngine","Cannot apply mutation batch with id: "+t),[2]):"pending"!==e?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return i.sent(),[3,4];case 3:"acknowledged"===e||"rejected"===e?(this.processUserCallback(t,n||null),this.localStore.removeCachedMutationBatchMetadata(t)):Qs("Unknown batchState: "+e),i.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(r)];case 5:return i.sent(),[2]}})})},t.prototype.applySuccessfulWrite=function(t){var e=this;this.assertSubscribed("applySuccessfulWrite()");var n=t.batch.batchId;return this.processUserCallback(n,null),this.localStore.acknowledgeBatch(t).then(function(t){return e.sharedClientState.updateMutationState(n,"acknowledged"),e.emitNewSnapsAndNotifyLocalStore(t)}).catch(df)},t.prototype.rejectFailedWrite=function(t,e){var n=this;return this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(t,e),this.localStore.rejectBatch(t).then(function(r){return n.sharedClientState.updateMutationState(t,"rejected",e),n.emitNewSnapsAndNotifyLocalStore(r)}).catch(df)},t.prototype.addMutationCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n||(n=new Qu(wu)),n=n.insert(t,e),this.mutationUserCallbacks[this.currentUser.toKey()]=n},t.prototype.processUserCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];if(n){var r=n.get(t);r&&(Ks(t===n.minKey(),"Mutation callbacks processed out-of-order?"),e?r.reject(e):r.resolve(),n=n.remove(t)),this.mutationUserCallbacks[this.currentUser.toKey()]=n}},t.prototype.removeAndCleanupQuery=function(t){var e=this;if(this.sharedClientState.removeLocalQueryTarget(t.targetId),this.queryViewsByQuery.delete(t.query),delete this.queryViewsByTarget[t.targetId],this.isPrimary){var n=this.limboDocumentRefs.referencesForId(t.targetId);this.limboDocumentRefs.removeReferencesForId(t.targetId),n.forEach(function(t){e.limboDocumentRefs.containsKey(t)||e.removeLimboTarget(t)})}},t.prototype.removeLimboTarget=function(t){var e=this.limboTargetsByKey.get(t);null!==e&&(this.remoteStore.unlisten(e),this.limboTargetsByKey=this.limboTargetsByKey.remove(t),delete this.limboResolutionsByTarget[e])},t.prototype.updateTrackedLimbos=function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n];if(i instanceof Yf)this.limboDocumentRefs.addReference(i.key,t),this.trackLimboChange(i);else if(i instanceof Xf){Vs("SyncEngine","Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,t),this.limboDocumentRefs.containsKey(i.key)||this.removeLimboTarget(i.key)}else Qs("Unknown limbo change: "+JSON.stringify(i))}},t.prototype.trackLimboChange=function(t){var e=t.key;if(!this.limboTargetsByKey.get(e)){Vs("SyncEngine","New document in limbo: "+e);var n=this.limboTargetIdGenerator.next(),r=mc.atPath(e.path);this.limboResolutionsByTarget[n]=new Zf(e),this.remoteStore.listen(new kc(r,n,yc.LimboResolution,Bh.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(e,n)}},t.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},t.prototype.emitNewSnapsAndNotifyLocalStore=function(t,e){return Zn(this,void 0,void 0,function(){var n,r,i,o=this;return tr(this,function(a){switch(a.label){case 0:return n=[],r=[],i=[],this.queryViewsByQuery.forEach(function(a,s){i.push(Promise.resolve().then(function(){var e=s.view.computeDocChanges(t);return e.needsRefill?o.localStore.executeQuery(s.query).then(function(t){return s.view.computeDocChanges(t,e)}):e}).then(function(t){var i=e&&e.targetChanges[s.targetId],a=s.view.applyChanges(t,!0===o.isPrimary,i);if(o.updateTrackedLimbos(s.targetId,a.limboChanges),a.snapshot){o.isPrimary&&o.sharedClientState.updateQueryState(s.targetId,a.snapshot.fromCache?"not-current":"current"),n.push(a.snapshot);var u=Hf.fromSnapshot(s.targetId,a.snapshot);r.push(u)}}))}),[4,Promise.all(i)];case 1:return a.sent(),this.syncEngineListener.onWatchChange(n),[4,this.localStore.notifyLocalViewChanges(r)];case 2:return a.sent(),[2]}})})},t.prototype.assertSubscribed=function(t){Ks(null!==this.syncEngineListener,"Trying to call "+t+" before calling subscribe().")},t.prototype.handleCredentialChange=function(t){return Zn(this,void 0,void 0,function(){var e,n;return tr(this,function(r){switch(r.label){case 0:return e=!this.currentUser.isEqual(t),this.currentUser=t,e?[4,this.localStore.handleUserChange(t)]:[3,3];case 1:return n=r.sent(),this.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(n.affectedDocuments)];case 2:r.sent(),r.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return r.sent(),[2]}})})},t.prototype.applyPrimaryState=function(t){return Zn(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u=this;return tr(this,function(c){switch(c.label){case 0:return!0!==t||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return c.sent(),e=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e.toArray())];case 2:for(n=c.sent(),r=0,i=n;r<i.length;r++)o=i[r],this.remoteStore.listen(o);return[3,7];case 3:return!1!==t||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,a=[],s=Promise.resolve(),$s(this.queryViewsByTarget,function(t,e){u.sharedClientState.isLocalQueryTarget(t)?a.push(t):s=s.then(function(){return u.unlisten(e.query)}),u.remoteStore.unlisten(e.targetId)}),[4,s]);case 4:return c.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(a)];case 5:return c.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:c.sent(),c.label=7;case 7:return[2]}})})},t.prototype.resetLimboDocuments=function(){var t=this;$s(this.limboResolutionsByTarget,function(e){t.remoteStore.unlisten(e)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new Qu(Fu.comparator)},t.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(t){for(var e=this,n=Promise.resolve(),r=[],i=[],o=function(t){n=n.then(function(){return Zn(e,void 0,void 0,function(){var e,n,o,a;return tr(this,function(s){switch(s.label){case 0:return(n=this.queryViewsByTarget[t])?[4,this.localStore.releaseQuery(n.query,!0)]:[3,4];case 1:return s.sent(),[4,this.localStore.allocateQuery(n.query)];case 2:return e=s.sent(),[4,this.synchronizeViewAndComputeSnapshot(n)];case 3:return(o=s.sent()).snapshot&&i.push(o.snapshot),[3,8];case 4:return Ks(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(t)];case 5:return Ks(!!(a=s.sent()),"Query data for target "+t+" not found"),[4,this.localStore.allocateQuery(a)];case 6:return e=s.sent(),[4,this.initializeViewAndComputeSnapshot(e,!1)];case 7:s.sent(),s.label=8;case 8:return r.push(e),[2]}})})})},a=0,s=t;a<s.length;a++){o(s[a])}return n.then(function(){return e.syncEngineListener.onWatchChange(i),r})},t.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},t.prototype.applyTargetState=function(t,e,n){return Zn(this,void 0,void 0,function(){var r,i=this;return tr(this,function(o){switch(o.label){case 0:if(this.isPrimary)return Vs("SyncEngine","Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[t])return[3,5];switch(e){case"current":case"not-current":return[3,1];case"rejected":return[3,2]}return[3,4];case 1:return[2,this.localStore.getNewDocumentChanges().then(function(n){return Zn(i,void 0,void 0,function(){var r;return tr(this,function(i){switch(i.label){case 0:return r=dh.createSynthesizedRemoteEventForCurrentChange(t,"current"===e),[4,this.emitNewSnapsAndNotifyLocalStore(n,r)];case 1:return i.sent(),[2]}})})},function(t){return Zn(i,void 0,void 0,function(){var e;return tr(this,function(n){switch(n.label){case 0:return function(t){return t.code===zs.DATA_LOSS&&t.message===El}(t)?(e=[],$s(this.queryViewsByTarget,function(t){return e.push(t)}),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e)]):[3,2];case 1:return n.sent(),[3,3];case 2:throw t;case 3:return[2]}})})})];case 2:return r=this.queryViewsByTarget[t],this.removeAndCleanupQuery(r),[4,this.localStore.releaseQuery(r.query,!0)];case 3:return o.sent(),this.syncEngineListener.onWatchError(r.query,n),[3,5];case 4:Qs("Unexpected target state: "+e),o.label=5;case 5:return[2]}})})},t.prototype.applyActiveTargetsChange=function(t,e){return Zn(this,void 0,void 0,function(){var n,r,i,o,a,s,u,c,h,l=this;return tr(this,function(f){switch(f.label){case 0:if(!this.isPrimary)return[2];n=0,r=t,f.label=1;case 1:return n<r.length?(h=r[n],Ks(!this.queryViewsByTarget[h],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(h)]):[3,6];case 2:return Ks(!!(i=f.sent()),"Query data for active target "+h+" not found"),[4,this.localStore.allocateQuery(i)];case 3:return o=f.sent(),[4,this.initializeViewAndComputeSnapshot(o,!1)];case 4:f.sent(),this.remoteStore.listen(o),f.label=5;case 5:return n++,[3,1];case 6:a=function(t){var e;return tr(this,function(n){switch(n.label){case 0:return(e=s.queryViewsByTarget[t])?[4,s.localStore.releaseQuery(e.query,!1).then(function(){l.remoteStore.unlisten(t),l.removeAndCleanupQuery(e)}).catch(df)]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}})},s=this,u=0,c=e,f.label=7;case 7:return u<c.length?(h=c[u],[5,a(h)]):[3,10];case 8:f.sent(),f.label=9;case 9:return u++,[3,7];case 10:return[2]}})})},t.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},t.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},t.prototype.getRemoteKeysForTarget=function(t){var e=this.limboResolutionsByTarget[t];return e&&e.receivedDocument?oh().add(e.key):this.queryViewsByTarget[t]?this.queryViewsByTarget[t].view.syncedDocuments:oh()},t}(),ep=function(){function t(t){this.uid=t}return t.prototype.isAuthenticated=function(){return null!=this.uid},t.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},t.prototype.isEqual=function(t){return t.uid===this.uid},t.UNAUTHENTICATED=new t(null),t.GOOGLE_CREDENTIALS=new t("google-credentials-uid"),t.FIRST_PARTY=new t("first-party-uid"),t}(),np="SharedClientState",rp="firestore_clients",ip="firestore_mutations",op="firestore_targets",ap="firestore_online_state",sp="firestore_sequence_number",up=function(){function t(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r,Ks(void 0!==r==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}return t.fromWebStorageEntry=function(e,n,r){var i=JSON.parse(r),o="object"==typeof i&&-1!==["pending","acknowledged","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error),a=void 0;return o&&i.error&&(o="string"==typeof i.error.message&&"string"==typeof i.error.code)&&(a=new Hs(i.error.code,i.error.message)),o?new t(e,n,i.state,a):(Us(np,"Failed to parse mutation state for ID '"+n+"': "+r),null)},t.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),cp=function(){function t(t,e,n){this.targetId=t,this.state=e,this.error=n,Ks(void 0!==n==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}return t.fromWebStorageEntry=function(e,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["not-current","current","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new Hs(r.error.code,r.error.message)),i?new t(e,r.state,o):(Us(np,"Failed to parse target state for ID '"+e+"': "+n),null)},t.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),hp=function(){function t(t,e){this.clientId=t,this.activeTargetIds=e}return t.fromWebStorageEntry=function(e,n){for(var r=JSON.parse(n),i="object"==typeof r&&r.activeTargetIds instanceof Array,o=sh(),a=0;i&&a<r.activeTargetIds.length;++a)i=dc(r.activeTargetIds[a]),o=o.add(r.activeTargetIds[a]);return i?new t(e,o):(Us(np,"Failed to parse client data for instance '"+e+"': "+n),null)},t}(),lp=function(){function t(t,e){this.clientId=t,this.onlineState=e}return t.fromWebStorageEntry=function(e){var n=JSON.parse(e);return"object"==typeof n&&void 0!==Mf[n.onlineState]&&"string"==typeof n.clientId?new t(n.clientId,Mf[n.onlineState]):(Us(np,"Failed to parse online state: "+e),null)},t}(),fp=function(){function t(){this.activeTargetIds=sh()}return t.prototype.addQueryTarget=function(t){Ks(!this.activeTargetIds.has(t),"Target with ID '"+t+"' already active."),this.activeTargetIds=this.activeTargetIds.add(t)},t.prototype.removeQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},t.prototype.toWebStorageJSON=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},t}(),pp=function(){function t(e,n,r,i,o){if(this.queue=e,this.platform=n,this.persistenceKey=r,this.localClientId=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!t.isAvailable(this.platform))throw new Hs(zs.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var a=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=o,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey=sp+"_"+r,this.activeClients[this.localClientId]=new fp,this.clientStateKeyRe=new RegExp("^"+rp+"_"+a+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+ip+"_"+a+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+op+"_"+a+"_(\\d+)$"),this.onlineStateKey=ap+"_"+r,this.platform.window.addEventListener("storage",this.storageListener)}return t.isAvailable=function(t){return!(!t.window||null==t.window.localStorage)},t.prototype.start=function(){return Zn(this,void 0,void 0,function(){var t,e,n,r,i,o,a,s,u,c,h,l=this;return tr(this,function(f){switch(f.label){case 0:return Ks(!this.started,"WebStorageSharedClientState already started"),Ks(null!==this.syncEngine,"syncEngine property must be set before calling start()"),Ks(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(t=f.sent(),e=0,n=t;e<n.length;e++)(r=n[e])!==this.localClientId&&(i=this.getItem(this.toWebStorageClientStateKey(r)))&&(o=hp.fromWebStorageEntry(r,i))&&(this.activeClients[o.clientId]=o);for(this.persistClientState(),(a=this.storage.getItem(this.onlineStateKey))&&(s=this.fromWebStorageOnlineState(a))&&this.handleOnlineStateEvent(s),u=0,c=this.earlyEvents;u<c.length;u++)h=c[u],this.handleWebStorageEvent(h);return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return l.shutdown()}),this.started=!0,[2]}})})},t.prototype.writeSequenceNumber=function(t){this.setItem(this.sequenceNumberKey,JSON.stringify(t))},t.prototype.getAllActiveQueryTargets=function(){var t=sh();return Zs(this.activeClients,function(e,n){t=t.unionWith(n.activeTargetIds)}),t},t.prototype.isActiveQueryTarget=function(t){for(var e in this.activeClients)if(this.activeClients.hasOwnProperty(e)&&this.activeClients[e].activeTargetIds.has(t))return!0;return!1},t.prototype.addPendingMutation=function(t){this.persistMutationState(t,"pending")},t.prototype.updateMutationState=function(t,e,n){this.persistMutationState(t,e,n),this.removeMutationState(t)},t.prototype.addLocalQueryTarget=function(t){var e="not-current";if(this.isActiveQueryTarget(t)){var n=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(t));if(n){var r=cp.fromWebStorageEntry(t,n);r&&(e=r.state)}}return this.localClientState.addQueryTarget(t),this.persistClientState(),e},t.prototype.removeLocalQueryTarget=function(t){this.localClientState.removeQueryTarget(t),this.persistClientState()},t.prototype.isLocalQueryTarget=function(t){return this.localClientState.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){this.removeItem(this.toWebStorageQueryTargetMetadataKey(t))},t.prototype.updateQueryState=function(t,e,n){this.persistQueryTargetState(t,e,n)},t.prototype.handleUserChange=function(t,e,n){var r=this;e.forEach(function(t){r.removeMutationState(t)}),this.currentUser=t,n.forEach(function(t){r.addPendingMutation(t)})},t.prototype.setOnlineState=function(t){this.persistOnlineState(t)},t.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},t.prototype.getItem=function(t){var e=this.storage.getItem(t);return Vs(np,"READ",t,e),e},t.prototype.setItem=function(t,e){Vs(np,"SET",t,e),this.storage.setItem(t,e)},t.prototype.removeItem=function(t){Vs(np,"REMOVE",t),this.storage.removeItem(t)},t.prototype.handleWebStorageEvent=function(t){var e=this;if(t.storageArea===this.storage){if(Vs(np,"EVENT",t.key,t.newValue),t.key===this.localClientStorageKey)return void Us("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget(function(){return Zn(e,void 0,void 0,function(){var e,n,r,i,o,a;return tr(this,function(s){if(!this.started)return this.earlyEvents.push(t),[2];if(null===t.key)return[2];if(this.clientStateKeyRe.test(t.key)){if(null==t.newValue)return n=this.fromWebStorageClientStateKey(t.key),[2,this.handleClientStateEvent(n,null)];if(e=this.fromWebStorageClientState(t.key,t.newValue))return[2,this.handleClientStateEvent(e.clientId,e)]}else if(this.mutationBatchKeyRe.test(t.key)){if(null!==t.newValue&&(r=this.fromWebStorageMutationMetadata(t.key,t.newValue)))return[2,this.handleMutationBatchEvent(r)]}else if(this.queryTargetKeyRe.test(t.key)){if(null!==t.newValue&&(i=this.fromWebStorageQueryTargetMetadata(t.key,t.newValue)))return[2,this.handleQueryTargetEvent(i)]}else if(t.key===this.onlineStateKey){if(null!==t.newValue&&(o=this.fromWebStorageOnlineState(t.newValue)))return[2,this.handleOnlineStateEvent(o)]}else t.key===this.sequenceNumberKey&&(Ks(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(a=function(t){var e=Bh.INVALID;if(null!=t)try{var n=JSON.parse(t);Ks("number"==typeof n,"Found non-numeric sequence number"),e=n}catch(t){Us(np,"Failed to read sequence number from WebStorage",t)}return e}(t.newValue))!==Bh.INVALID&&this.sequenceNumberHandler(a));return[2]})})})}},Object.defineProperty(t.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),t.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},t.prototype.persistMutationState=function(t,e,n){var r=new up(this.currentUser,t,e,n),i=this.toWebStorageMutationBatchKey(t);this.setItem(i,r.toWebStorageJSON())},t.prototype.removeMutationState=function(t){var e=this.toWebStorageMutationBatchKey(t);this.removeItem(e)},t.prototype.persistOnlineState=function(t){var e={clientId:this.localClientId,onlineState:Mf[t]};this.storage.setItem(this.onlineStateKey,JSON.stringify(e))},t.prototype.persistQueryTargetState=function(t,e,n){var r=this.toWebStorageQueryTargetMetadataKey(t),i=new cp(t,e,n);this.setItem(r,i.toWebStorageJSON())},t.prototype.toWebStorageClientStateKey=function(t){return Ks(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),rp+"_"+this.persistenceKey+"_"+t},t.prototype.toWebStorageQueryTargetMetadataKey=function(t){return op+"_"+this.persistenceKey+"_"+t},t.prototype.toWebStorageMutationBatchKey=function(t){var e=ip+"_"+this.persistenceKey+"_"+t;return this.currentUser.isAuthenticated()&&(e+="_"+this.currentUser.uid),e},t.prototype.fromWebStorageClientStateKey=function(t){var e=this.clientStateKeyRe.exec(t);return e?e[1]:null},t.prototype.fromWebStorageClientState=function(t,e){var n=this.fromWebStorageClientStateKey(t);return Ks(null!==n,"Cannot parse client state key '"+t+"'"),hp.fromWebStorageEntry(n,e)},t.prototype.fromWebStorageMutationMetadata=function(t,e){var n=this.mutationBatchKeyRe.exec(t);Ks(null!==n,"Cannot parse mutation batch key '"+t+"'");var r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return up.fromWebStorageEntry(new ep(i),r,e)},t.prototype.fromWebStorageQueryTargetMetadata=function(t,e){var n=this.queryTargetKeyRe.exec(t);Ks(null!==n,"Cannot parse query target key '"+t+"'");var r=Number(n[1]);return cp.fromWebStorageEntry(r,e)},t.prototype.fromWebStorageOnlineState=function(t){return lp.fromWebStorageEntry(t)},t.prototype.handleMutationBatchEvent=function(t){return Zn(this,void 0,void 0,function(){return tr(this,function(e){return t.user.uid!==this.currentUser.uid?(Vs(np,"Ignoring mutation for non-active user "+t.user.uid),[2]):[2,this.syncEngine.applyBatchState(t.batchId,t.state,t.error)]})})},t.prototype.handleQueryTargetEvent=function(t){return this.syncEngine.applyTargetState(t.targetId,t.state,t.error)},t.prototype.handleClientStateEvent=function(t,e){var n=this,r=this.getAllActiveQueryTargets();e?this.activeClients[t]=e:delete this.activeClients[t];var i=this.getAllActiveQueryTargets(),o=[],a=[];return i.forEach(function(t){return Zn(n,void 0,void 0,function(){return tr(this,function(e){return r.has(t)||o.push(t),[2]})})}),r.forEach(function(t){return Zn(n,void 0,void 0,function(){return tr(this,function(e){return i.has(t)||a.push(t),[2]})})}),this.syncEngine.applyActiveTargetsChange(o,a)},t.prototype.handleOnlineStateEvent=function(t){this.activeClients[t.clientId]&&this.onlineStateHandler(t.onlineState)},t}();var dp=function(){function t(){this.localState=new fp,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}return t.prototype.addPendingMutation=function(t){},t.prototype.updateMutationState=function(t,e,n){},t.prototype.addLocalQueryTarget=function(t){return this.localState.addQueryTarget(t),this.queryState[t]||"not-current"},t.prototype.updateQueryState=function(t,e,n){this.queryState[t]=e},t.prototype.removeLocalQueryTarget=function(t){this.localState.removeQueryTarget(t)},t.prototype.isLocalQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){delete this.queryState[t]},t.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},t.prototype.isActiveQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},t.prototype.start=function(){return this.localState=new fp,Promise.resolve()},t.prototype.handleUserChange=function(t,e,n){},t.prototype.setOnlineState=function(t){},t.prototype.shutdown=function(){},t.prototype.writeSequenceNumber=function(t){},t}(),yp=function(){function t(t,e){this.cacheSizeBytes=t,this.experimentalTabSynchronization=e}return t.prototype.lruParams=function(){return rf.withCacheSize(this.cacheSizeBytes)},t}(),mp=function(){return function(){}}(),gp=function(){function t(t,e,n,r){this.platform=t,this.databaseInfo=e,this.credentials=n,this.asyncQueue=r,this.clientId=bu.newId(),this.isShutdown=!1}return t.prototype.start=function(t){var e=this;this.verifyNotShutdown();var n=new Vh,r=new Vh,i=!1;return this.credentials.setChangeListener(function(o){i?e.asyncQueue.enqueueAndForget(function(){return e.handleCredentialChange(o)}):(i=!0,e.initializePersistence(t,r,o).then(function(t){return e.initializeRest(o,t)}).then(n.resolve,n.reject))}),this.asyncQueue.enqueueAndForget(function(){return n.promise}),r.promise},t.prototype.enableNetwork=function(){var t=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return t.syncEngine.enableNetwork()})},t.prototype.initializePersistence=function(t,e,n){var r=this;return t instanceof yp?this.startIndexedDbPersistence(n,t).then(function(t){return e.resolve(),t}).catch(function(t){if(e.reject(t),!r.canFallback(t))throw t;return console.warn("Error enabling offline storage. Falling back to storage disabled: "+t),r.startMemoryPersistence()}):(e.resolve(),this.startMemoryPersistence())},t.prototype.canFallback=function(t){return t instanceof Hs?t.code===zs.FAILED_PRECONDITION||t.code===zs.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code)},t.prototype.verifyNotShutdown=function(){if(this.isShutdown)throw new Hs(zs.FAILED_PRECONDITION,"The client has already been shutdown.")},t.prototype.startIndexedDbPersistence=function(t,e){var n=this,r=pf.buildStoragePrefix(this.databaseInfo),i=new Rh(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return Zn(n,void 0,void 0,function(){var n,o;return tr(this,function(a){switch(a.label){case 0:if(e.experimentalTabSynchronization&&!pp.isAvailable(this.platform))throw new Hs(zs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return o=e.lruParams(),e.experimentalTabSynchronization?(this.sharedClientState=new pp(this.asyncQueue,this.platform,r,this.clientId,t),[4,pf.createMultiClientIndexedDbPersistence(r,this.clientId,this.platform,this.asyncQueue,i,o,{sequenceNumberSyncer:this.sharedClientState})]):[3,2];case 1:return n=a.sent(),[3,4];case 2:return this.sharedClientState=new dp,[4,pf.createIndexedDbPersistence(r,this.clientId,this.platform,this.asyncQueue,i,o)];case 3:n=a.sent(),a.label=4;case 4:return this.persistence=n,[2,n.referenceDelegate.garbageCollector]}})})})},t.prototype.startMemoryPersistence=function(){return this.persistence=Nf.createEagerPersistence(this.clientId),this.sharedClientState=new dp,Promise.resolve(null)},t.prototype.initializeRest=function(t,e){var n=this;return Vs("FirestoreClient","Initializing. user=",t.uid),this.platform.loadConnection(this.databaseInfo).then(function(r){return Zn(n,void 0,void 0,function(){var n,i,o,a,s=this;return tr(this,function(u){switch(u.label){case 0:return this.localStore=new Ef(this.persistence,t),e&&(this.lruScheduler=new of(e,this.asyncQueue,this.localStore)),n=this.platform.newSerializer(this.databaseInfo.databaseId),i=new Uf(this.asyncQueue,r,this.credentials,n),o=function(t){return s.syncEngine.applyOnlineStateChange(t,Pf.RemoteStore)},a=function(t){return s.syncEngine.applyOnlineStateChange(t,Pf.SharedClientState)},this.remoteStore=new Kf(this.localStore,i,this.asyncQueue,o),this.syncEngine=new tp(this.localStore,this.remoteStore,this.sharedClientState,t),this.sharedClientState.onlineStateHandler=a,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new Wf(this.syncEngine),[4,this.sharedClientState.start()];case 1:return u.sent(),[4,this.remoteStore.start()];case 2:return u.sent(),[4,this.persistence.setPrimaryStateListener(function(t){return Zn(s,void 0,void 0,function(){return tr(this,function(e){switch(e.label){case 0:return[4,this.syncEngine.applyPrimaryState(t)];case 1:return e.sent(),this.lruScheduler&&(t&&!this.lruScheduler.started?this.lruScheduler.start():t||this.lruScheduler.stop()),[2]}})})})];case 3:return u.sent(),[2]}})})})},t.prototype.handleCredentialChange=function(t){return this.asyncQueue.verifyOperationInProgress(),Vs("FirestoreClient","Credential Changed. Current user: "+t.uid),this.syncEngine.handleCredentialChange(t)},t.prototype.disableNetwork=function(){var t=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return t.syncEngine.disableNetwork()})},t.prototype.shutdown=function(){var t=this;return!0===this.isShutdown?Promise.resolve():this.asyncQueue.enqueue(function(){return Zn(t,void 0,void 0,function(){return tr(this,function(t){switch(t.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return t.sent(),[4,this.sharedClientState.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown()];case 3:return t.sent(),this.credentials.removeChangeListener(),this.isShutdown=!0,[2]}})})})},t.prototype.listen=function(t,e,n){var r=this;this.verifyNotShutdown();var i=new zf(t,e,n);return this.asyncQueue.enqueueAndForget(function(){return r.eventMgr.listen(i)}),i},t.prototype.unlisten=function(t){var e=this;this.verifyNotShutdown(),this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.unlisten(t)})},t.prototype.getDocumentFromLocalCache=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return e.localStore.readDocument(t)}).then(function(t){if(t instanceof Vu)return t;if(t instanceof Uu)return null;throw new Hs(zs.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},t.prototype.getDocumentsFromLocalCache=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return e.localStore.executeQuery(t)}).then(function(e){var n=oh(),r=new Jf(t,n),i=r.computeDocChanges(e);return r.applyChanges(i,!1).snapshot})},t.prototype.write=function(t){var e=this;this.verifyNotShutdown();var n=new Vh;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.write(t,n)}),n.promise},t.prototype.databaseId=function(){return this.databaseInfo.databaseId},t.prototype.transaction=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return Zn(e,void 0,void 0,function(){return tr(this,function(t){return[2]})})}).then(function(){return e.syncEngine.runTransaction(t)})},t}(),vp=function(){function t(t){this.observer=t,this.muted=!1}return t.prototype.next=function(t){this.scheduleEvent(this.observer.next,t)},t.prototype.error=function(t){this.scheduleEvent(this.observer.error,t)},t.prototype.mute=function(){this.muted=!0},t.prototype.scheduleEvent=function(t,e){var n=this;this.muted||setTimeout(function(){n.muted||t(e)},0)},t}(),bp=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];!function(t,e,n,r){if(!(e instanceof Array)||e.length<r)throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" argument to be an array with at least "+vu(r,"element")+".")}("FieldPath",t,"fieldNames",1);for(var n=0;n<t.length;++n)if(ou("FieldPath","string",n,t[n]),0===t[n].length)throw new Hs(zs.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new qu(t)}return t.documentId=function(){return t._DOCUMENT_ID},t.prototype.isEqual=function(e){if(!(e instanceof t))throw mu("isEqual","FieldPath",1,e);return this._internalPath.isEqual(e._internalPath)},t._DOCUMENT_ID=new t(qu.keyField().canonicalString()),t}(),wp=new RegExp("[~\\*/\\[\\]]");var Sp=function(){return function(t,e){this.user=e,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+t}}}(),Ep=function(){function t(){this.changeListener=null}return t.prototype.getToken=function(){return Promise.resolve(null)},t.prototype.invalidateToken=function(){},t.prototype.setChangeListener=function(t){Ks(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,t(ep.UNAUTHENTICATED)},t.prototype.removeChangeListener=function(){Ks(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},t}(),Tp=function(){function t(t){var e=this;this.app=t,this.tokenListener=null,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){e.tokenCounter++,e.currentUser=e.getUser(),e.changeListener&&e.changeListener(e.currentUser)},this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}return t.prototype.getToken=function(){var t=this;Ks(null!=this.tokenListener,"getToken cannot be called after listener removed.");var e=this.tokenCounter,n=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(n).then(function(n){if(t.tokenCounter!==e)throw new Hs(zs.ABORTED,"getToken aborted due to token change.");return n?(Ks("string"==typeof n.accessToken,"Invalid tokenData returned from getToken():"+n),new Sp(n.accessToken,t.currentUser)):null})},t.prototype.invalidateToken=function(){this.forceRefresh=!0},t.prototype.setChangeListener=function(t){Ks(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,this.currentUser&&t(this.currentUser)},t.prototype.removeChangeListener=function(){Ks(null!=this.tokenListener,"removeChangeListener() called twice"),Ks(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},t.prototype.getUser=function(){var t=this.app.INTERNAL.getUid();return Ks(null===t||"string"==typeof t,"Received invalid UID: "+t),new ep(t)},t}(),Ip=function(){function t(t,e){this.gapi=t,this.sessionIndex=e,this.type="FirstParty",this.user=ep.FIRST_PARTY}return Object.defineProperty(t.prototype,"authHeaders",{get:function(){var t={"X-Goog-AuthUser":this.sessionIndex},e=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),t},enumerable:!0,configurable:!0}),t}(),Cp=function(){function t(t,e){this.gapi=t,this.sessionIndex=e}return t.prototype.getToken=function(){return Promise.resolve(new Ip(this.gapi,this.sessionIndex))},t.prototype.setChangeListener=function(t){t(ep.FIRST_PARTY)},t.prototype.removeChangeListener=function(){},t.prototype.invalidateToken=function(){},t}();function Dp(t){return function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=t,r=0,i=e;r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return!0}return!1}(t,["next","error","complete"])}var Ap,Np=function(){function t(t){this._methodName=t}return t.delete=function(){return eu("FieldValue.delete",arguments),kp.instance},t.serverTimestamp=function(){return eu("FieldValue.serverTimestamp",arguments),Rp.instance},t.arrayUnion=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return ru("FieldValue.arrayUnion",arguments,1),new Op(t)},t.arrayRemove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return ru("FieldValue.arrayRemove",arguments,1),new _p(t)},t.increment=function(t){return ou("FieldValue.increment","number",1,t),nu("FieldValue.increment",arguments,1),new Mp(t)},t.prototype.isEqual=function(t){return this===t},t}(),kp=function(t){function e(){return t.call(this,"FieldValue.delete")||this}return Jn(e,t),e.instance=new e,e}(Np),Rp=function(t){function e(){return t.call(this,"FieldValue.serverTimestamp")||this}return Jn(e,t),e.instance=new e,e}(Np),Op=function(t){function e(e){var n=t.call(this,"FieldValue.arrayUnion")||this;return n._elements=e,n}return Jn(e,t),e}(Np),_p=function(t){function e(e){var n=t.call(this,"FieldValue.arrayRemove")||this;return n._elements=e,n}return Jn(e,t),e}(Np),Mp=function(t){function e(e){var n=t.call(this,"FieldValue.increment")||this;return n._operand=e,n}return Jn(e,t),e}(Np),Pp=Ys(Np,"Use FieldValue.<field>() instead."),Lp=/^__.*__$/,xp=function(){function t(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}return t.prototype.toMutations=function(t,e){var n=[];return null!==this.fieldMask?n.push(new Fc(t,this.data,this.fieldMask,e)):n.push(new qc(t,this.data,e)),this.fieldTransforms.length>0&&n.push(new Bc(t,this.fieldTransforms)),n},t}(),qp=function(){function t(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}return t.prototype.toMutations=function(t,e){var n=[new Fc(t,this.data,this.fieldMask,e)];return this.fieldTransforms.length>0&&n.push(new Bc(t,this.fieldTransforms)),n},t}();function Fp(t){switch(t){case Ap.Set:case Ap.MergeSet:case Ap.Update:return!0;case Ap.Argument:return!1;default:throw Qs("Unexpected case for UserDataSource: "+t)}}!function(t){t[t.Set=0]="Set",t[t.Update=1]="Update",t[t.MergeSet=2]="MergeSet",t[t.Argument=3]="Argument"}(Ap||(Ap={}));var Bp=function(){function t(t,e,n,r,i,o){this.dataSource=t,this.methodName=e,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}return t.prototype.childContextForField=function(e){var n=null==this.path?null:this.path.child(e),r=new t(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePathSegment(e),r},t.prototype.childContextForFieldPath=function(e){var n=null==this.path?null:this.path.child(e),r=new t(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePath(),r},t.prototype.childContextForArray=function(e){return new t(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},t.prototype.createError=function(t){var e=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new Hs(zs.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+e)},t.prototype.contains=function(t){return void 0!==this.fieldMask.find(function(e){return t.isPrefixOf(e)})||void 0!==this.fieldTransforms.find(function(e){return t.isPrefixOf(e.field)})},t.prototype.validatePath=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.validatePathSegment(this.path.get(t))},t.prototype.validatePathSegment=function(t){if(Fp(this.dataSource)&&Lp.test(t))throw this.createError("Document fields cannot begin and end with __")},t}(),Vp=function(){return function(t,e){this.databaseId=t,this.key=e}}(),Up=function(){function t(t){this.preConverter=t}return t.prototype.parseSetData=function(t,e){var n=new Bp(Ap.Set,t,qu.EMPTY_PATH);Qp("Data must be an object, but it was:",n,e);var r=this.parseData(e,n);return new xp(r,null,n.fieldTransforms)},t.prototype.parseMergeData=function(t,e,n){var r=new Bp(Ap.MergeSet,t,qu.EMPTY_PATH);Qp("Data must be an object, but it was:",r,e);var i,o,a=this.parseData(e,r);if(n){for(var s=new Rc(qu.comparator),u=0,c=n;u<c.length;u++){var h=c[u],l=void 0;if(h instanceof bp)l=h._internalPath;else{if("string"!=typeof h)throw Qs("Expected stringOrFieldPath to be a string or a FieldPath");l=Gp(t,h)}if(!r.contains(l))throw new Hs(zs.INVALID_ARGUMENT,"Field '"+l+"' is specified in your field mask but missing from your input data.");s=s.add(l)}i=_c.fromSet(s),o=r.fieldTransforms.filter(function(t){return i.covers(t.field)})}else i=_c.fromArray(r.fieldMask),o=r.fieldTransforms;return new xp(a,i,o)},t.prototype.parseUpdateData=function(t,e){var n=this,r=new Bp(Ap.Update,t,qu.EMPTY_PATH);Qp("Data must be an object, but it was:",r,e);var i=new Rc(qu.comparator),o=sc.EMPTY;Zs(e,function(e,a){var s=Gp(t,e),u=r.childContextForFieldPath(s);if((a=n.runPreConverter(a,u))instanceof kp)i=i.add(s);else{var c=n.parseData(a,u);null!=c&&(i=i.add(s),o=o.set(s,c))}});var a=_c.fromSet(i);return new qp(o,a,r.fieldTransforms)},t.prototype.parseUpdateVarargs=function(t,e,n,r){var i=new Bp(Ap.Update,t,qu.EMPTY_PATH),o=[Kp(t,e)],a=[n];if(r.length%2!=0)throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var s=0;s<r.length;s+=2)o.push(Kp(t,r[s])),a.push(r[s+1]);var u=new Rc(qu.comparator),c=sc.EMPTY;for(s=0;s<o.length;++s){var h=o[s],l=i.childContextForFieldPath(h),f=this.runPreConverter(a[s],l);if(f instanceof kp)u=u.add(h);else{var p=this.parseData(f,l);null!=p&&(u=u.add(h),c=c.set(h,p))}}var d=_c.fromSet(u);return new qp(c,d,i.fieldTransforms)},t.prototype.parseQueryValue=function(t,e){var n=new Bp(Ap.Argument,t,qu.EMPTY_PATH),r=this.parseData(e,n);return Ks(null!=r,"Parsed data should not be null."),Ks(0===n.fieldTransforms.length,"Field transforms should have been disallowed."),r},t.prototype.runPreConverter=function(t,e){try{return this.preConverter(t)}catch(t){var n=Wp(t);throw e.createError(n)}},t.prototype.parseData=function(t,e){if(jp(t=this.runPreConverter(t,e)))return Qp("Unsupported field value:",e,t),this.parseObject(t,e);if(t instanceof Np)return this.parseSentinelFieldValue(t,e),null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.arrayElement)throw e.createError("Nested arrays are not supported");return this.parseArray(t,e)}return this.parseScalarValue(t,e)},t.prototype.parseObject=function(t,e){var n=this,r=new Qu(wu);return tu(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):Zs(t,function(t,i){var o=n.parseData(i,e.childContextForField(t));null!=o&&(r=r.insert(t,o))}),new sc(r)},t.prototype.parseArray=function(t,e){for(var n=[],r=0,i=0,o=t;i<o.length;i++){var a=o[i],s=this.parseData(a,e.childContextForArray(r));null==s&&(s=Yu.INSTANCE),n.push(s),r++}return new uc(n)},t.prototype.parseSentinelFieldValue=function(t,e){if(!Fp(e.dataSource))throw e.createError(t._methodName+"() can only be used with update() and set()");if(null===e.path)throw e.createError(t._methodName+"() is not currently supported inside arrays");if(t instanceof kp){if(e.dataSource!==Ap.MergeSet)throw e.dataSource===Ap.Update?(Ks(e.path.length>0,"FieldValue.delete() at the top level should have already been handled."),e.createError("FieldValue.delete() can only appear at the top level of your update data")):e.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.fieldMask.push(e.path)}else if(t instanceof Rp)e.fieldTransforms.push(new Mc(e.path,Uc.instance));else if(t instanceof Op){var n=this.parseArrayTransformElements(t._methodName,t._elements),r=new jc(n);e.fieldTransforms.push(new Mc(e.path,r))}else if(t instanceof _p){n=this.parseArrayTransformElements(t._methodName,t._elements);var i=new Qc(n);e.fieldTransforms.push(new Mc(e.path,i))}else if(t instanceof Mp){var o=this.parseQueryValue("FieldValue.increment",t._operand),a=new Kc(o);e.fieldTransforms.push(new Mc(e.path,a))}else Qs("Unknown FieldValue type: "+t)},t.prototype.parseScalarValue=function(t,e){if(null===t)return Yu.INSTANCE;if("number"==typeof t)return dc(t)?new Zu(t):new tc(t);if("boolean"==typeof t)return Xu.of(t);if("string"==typeof t)return new ec(t);if(t instanceof Date)return new nc(Ru.fromDate(t));if(t instanceof Ru)return new nc(new Ru(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof ku)return new ac(t);if(t instanceof Au)return new ic(t);if(t instanceof Vp)return new oc(t.databaseId,t.key);throw e.createError("Unsupported field value: "+pu(t))},t.prototype.parseArrayTransformElements=function(t,e){var n=this;return e.map(function(e,r){var i=new Bp(Ap.Argument,t,qu.EMPTY_PATH);return n.parseData(e,i.childContextForArray(r))})},t}();function jp(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Ru||t instanceof ku||t instanceof Au||t instanceof Vp||t instanceof Np)}function Qp(t,e,n){if(!jp(n)||!fu(n)){var r=pu(n);throw"an object"===r?e.createError(t+" a custom object"):e.createError(t+" "+r)}}function Kp(t,e){if(e instanceof bp)return e._internalPath;if("string"==typeof e)return Gp(t,e);throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function Gp(t,e){try{return function(t){if(t.search(wp)>=0)throw new Hs(zs.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(bp.bind.apply(bp,[void 0].concat(t.split("."))))}catch(e){throw new Hs(zs.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(e)._internalPath}catch(e){var n=Wp(e);throw new Hs(zs.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. "+n)}}function Wp(t){return t instanceof Error?t.message:t.toString()}var zp="firestore.googleapis.com",Hp=!0,Yp=!0,Xp=!1,Jp=rf.COLLECTION_DISABLED,$p=function(){function t(t){if(void 0===t.host){if(void 0!==t.ssl)throw new Hs(zs.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=zp,this.ssl=Hp}else su("settings","non-empty string","host",t.host),this.host=t.host,uu("settings","boolean","ssl",t.ssl),this.ssl=Js(t.ssl,Hp);if(yu("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),uu("settings","object","credentials",t.credentials),this.credentials=t.credentials,uu("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?Us("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&Us("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=Js(t.timestampsInSnapshots,Yp),uu("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=rf.DEFAULT_CACHE_SIZE_BYTES;else{if(t.cacheSizeBytes!==Jp&&t.cacheSizeBytes<rf.MINIMUM_CACHE_SIZE_BYTES)throw new Hs(zs.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+rf.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=t.cacheSizeBytes}uu("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0===t.experimentalForceLongPolling?Xp:t.experimentalForceLongPolling}return t.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling},t}(),Zp=function(){return function(){}}(),td=function(){function t(e){var n=this;this._queue=new jh,this.INTERNAL={delete:function(){return Zn(n,void 0,void 0,function(){return tr(this,function(t){switch(t.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.shutdown()];case 1:return t.sent(),this.clientRunning=!1,[2]}})})}},this.clientRunning=!1;var r=new Zp;if("object"==typeof e.options){var i=e;r.firebaseApp=i,r.databaseId=t.databaseIdFromApp(i),r.persistenceKey=r.firebaseApp.name,r.credentials=new Tp(i)}else{var o=e;if(!o.projectId)throw new Hs(zs.INVALID_ARGUMENT,"Must provide projectId");r.databaseId=new Mu(o.projectId,o.database),r.persistenceKey="[DEFAULT]",r.credentials=new Ep}r.settings=new $p({}),this._config=r,this._databaseId=r.databaseId}return t.prototype.settings=function(t){if(nu("Firestore.settings",arguments,1),ou("Firestore.settings","object",1,t),Xs(t,"persistence"))throw new Hs(zs.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var e=new $p(t);if(this._firestoreClient&&!this._config.settings.isEqual(e))throw new Hs(zs.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this._config.settings=e,void 0!==e.credentials&&(this._config.credentials=function(t){if(!t)return new Ep;switch(t.type){case"gapi":var e=t.client;return Ks(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new Cp(e,t.sessionIndex||"0");case"provider":return t.client;default:throw new Hs(zs.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(e.credentials))},t.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},t.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},t.prototype.enablePersistence=function(t){if(this._firestoreClient)throw new Hs(zs.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");return this.configureClient(new yp(this._config.settings.cacheSizeBytes,void 0!==t&&Js(t.experimentalTabSynchronization,!1)))},t.prototype._clearPersistence=function(){if(this.clientRunning)throw new Hs(zs.FAILED_PRECONDITION,"Persistence cannot be cleared while the client is running");var t=pf.buildStoragePrefix(this.makeDatabaseInfo());return pf.clearPersistence(t)},t.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new mp),this._firestoreClient},t.prototype.makeDatabaseInfo=function(){return new Ou(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl,this._config.settings.forceLongPolling)},t.prototype.configureClient=function(t){var e=this;Ks(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey"),Ks(!this._firestoreClient,"configureClient() called multiple times"),this.clientRunning=!0;var n=this.makeDatabaseInfo();return this._dataConverter=new Up(function(t){if(t instanceof rd){var n=e._config.databaseId,r=t.firestore._config.databaseId;if(!r.isEqual(n))throw new Hs(zs.INVALID_ARGUMENT,"Document reference is for database "+r.projectId+"/"+r.database+" but should be for database "+n.projectId+"/"+n.database);return new Vp(e._config.databaseId,t._key)}return t}),this._firestoreClient=new gp(Gs.getPlatform(),n,this._config.credentials,this._queue),this._firestoreClient.start(t)},t.databaseIdFromApp=function(t){var e=t.options;if(!Xs(e,"projectId"))throw new Hs(zs.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var n=e.projectId;if(!n||"string"!=typeof n)throw new Hs(zs.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new Mu(n)},Object.defineProperty(t.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new Hs(zs.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){return nu("Firestore.collection",arguments,1),ou("Firestore.collection","non-empty string",1,t),this.ensureClientConfigured(),new cd(Lu.fromString(t),this)},t.prototype.doc=function(t){return nu("Firestore.doc",arguments,1),ou("Firestore.doc","non-empty string",1,t),this.ensureClientConfigured(),rd.forPath(Lu.fromString(t),this)},t.prototype._collectionGroup=function(t){if(nu("Firestore.collectionGroup",arguments,1),ou("Firestore.collectionGroup","non-empty string",1,t),t.indexOf("/")>=0)throw new Hs(zs.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new sd(new mc(Lu.EMPTY_PATH,t),this)},t.prototype.runTransaction=function(t){var e=this;return nu("Firestore.runTransaction",arguments,1),ou("Firestore.runTransaction","function",1,t),this.ensureClientConfigured().transaction(function(n){return t(new ed(e,n))})},t.prototype.batch=function(){return this.ensureClientConfigured(),new nd(this)},Object.defineProperty(t,"logLevel",{get:function(){switch(Fs()){case ks.DEBUG:return"debug";case ks.ERROR:return"error";case ks.SILENT:return"silent";default:return Qs("Unknown log level: "+Fs())}},enumerable:!0,configurable:!0}),t.setLogLevel=function(t){switch(nu("Firestore.setLogLevel",arguments,1),ou("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":Bs(ks.DEBUG);break;case"error":Bs(ks.ERROR);break;case"silent":Bs(ks.SILENT);break;default:throw new Hs(zs.INVALID_ARGUMENT,"Invalid log level: "+t)}},t.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots},t}(),ed=function(){function t(t,e){this._firestore=t,this._transaction=e}return t.prototype.get=function(t){var e=this;nu("Transaction.get",arguments,1);var n=pd("Transaction.get",t,this._firestore);return this._transaction.lookup([n._key]).then(function(t){if(!t||1!==t.length)return Qs("Mismatch in docs returned from document lookup.");var r=t[0];if(r instanceof Uu)return new od(e._firestore,n._key,null,!1,!1);if(r instanceof Vu)return new od(e._firestore,n._key,r,!1,!1);throw Qs("BatchGetDocumentsRequest returned unexpected document type: "+r.constructor.name)})},t.prototype.set=function(t,e,n){iu("Transaction.set",arguments,2,3);var r=pd("Transaction.set",t,this._firestore),i=(n=hd("Transaction.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",e);return this._transaction.set(r._key,i),this},t.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return"string"==typeof e||e instanceof bp?(ru("Transaction.update",arguments,3),r=pd("Transaction.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",e,n,o)):(nu("Transaction.update",arguments,2),r=pd("Transaction.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateData("Transaction.update",e)),this._transaction.update(r._key,i),this},t.prototype.delete=function(t){nu("Transaction.delete",arguments,1);var e=pd("Transaction.delete",t,this._firestore);return this._transaction.delete(e._key),this},t}(),nd=function(){function t(t){this._firestore=t,this._mutations=[],this._committed=!1}return t.prototype.set=function(t,e,n){iu("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var r=pd("WriteBatch.set",t,this._firestore),i=(n=hd("WriteBatch.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",e);return this._mutations=this._mutations.concat(i.toMutations(r._key,Lc.NONE)),this},t.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return this.verifyNotCommitted(),"string"==typeof e||e instanceof bp?(ru("WriteBatch.update",arguments,3),r=pd("WriteBatch.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",e,n,o)):(nu("WriteBatch.update",arguments,2),r=pd("WriteBatch.update",t,this._firestore),i=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",e)),this._mutations=this._mutations.concat(i.toMutations(r._key,Lc.exists(!0))),this},t.prototype.delete=function(t){nu("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var e=pd("WriteBatch.delete",t,this._firestore);return this._mutations=this._mutations.concat(new Vc(e._key,Lc.NONE)),this},t.prototype.commit=function(){return Zn(this,void 0,void 0,function(){return tr(this,function(t){return this.verifyNotCommitted(),this._committed=!0,this._mutations.length>0?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},t.prototype.verifyNotCommitted=function(){if(this._committed)throw new Hs(zs.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},t}(),rd=function(){function t(t,e){this._key=t,this.firestore=e,this._firestoreClient=this.firestore.ensureClientConfigured()}return t.forPath=function(e,n){if(e.length%2!=0)throw new Hs(zs.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new t(new Fu(e),n)},Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return new cd(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){if(nu("DocumentReference.collection",arguments,1),ou("DocumentReference.collection","non-empty string",1,t),!t)throw new Hs(zs.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var e=Lu.fromString(t);return new cd(this._key.path.child(e),this.firestore)},t.prototype.isEqual=function(e){if(!(e instanceof t))throw mu("isEqual","DocumentReference",1,e);return this.firestore===e.firestore&&this._key.isEqual(e._key)},t.prototype.set=function(t,e){iu("DocumentReference.set",arguments,1,2);var n=(e=hd("DocumentReference.set",e)).merge||e.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",t,e.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",t);return this._firestoreClient.write(n.toMutations(this._key,Lc.NONE))},t.prototype.update=function(t,e){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return"string"==typeof t||t instanceof bp?(ru("DocumentReference.update",arguments,2),n=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",t,e,r)):(nu("DocumentReference.update",arguments,1),n=this.firestore._dataConverter.parseUpdateData("DocumentReference.update",t)),this._firestoreClient.write(n.toMutations(this._key,Lc.exists(!0)))},t.prototype.delete=function(){return nu("DocumentReference.delete",arguments,0),this._firestoreClient.write([new Vc(this._key,Lc.NONE)])},t.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];iu("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},i=0;"object"!=typeof t[i]||Dp(t[i])||(yu("DocumentReference.onSnapshot",r=t[i],["includeMetadataChanges"]),uu("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++);var o={includeMetadataChanges:r.includeMetadataChanges};return Dp(t[i])?n=t[i]:(ou("DocumentReference.onSnapshot","function",i,t[i]),au("DocumentReference.onSnapshot","function",i+1,t[i+1]),au("DocumentReference.onSnapshot","function",i+2,t[i+2]),n={next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(o,n)},t.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new vp({next:function(t){if(e.next){Ks(t.docs.size<=1,"Too many documents returned on a document query");var r=t.docs.get(n._key);e.next(new od(n.firestore,n._key,r,t.fromCache,t.hasPendingWrites))}},error:r}),o=this._firestoreClient.listen(mc.atPath(this._key.path),i,t);return function(){i.mute(),n._firestoreClient.unlisten(o)}},t.prototype.get=function(t){var e=this;return iu("DocumentReference.get",arguments,0,1),fd("DocumentReference.get",t),new Promise(function(n,r){t&&"cache"===t.source?e.firestore.ensureClientConfigured().getDocumentFromLocalCache(e._key).then(function(t){n(new od(e.firestore,e._key,t,!0,t instanceof Vu&&t.hasLocalMutations))},r):e.getViaSnapshotListener(n,r,t)})},t.prototype.getViaSnapshotListener=function(t,e,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),!i.exists&&i.metadata.fromCache?e(new Hs(zs.UNAVAILABLE,"Failed to get document because the client is offline.")):i.exists&&i.metadata.fromCache&&n&&"server"===n.source?e(new Hs(zs.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):t(i)},error:e})},t}(),id=function(){function t(t,e){this.hasPendingWrites=t,this.fromCache=e}return t.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},t}(),od=function(){function t(t,e,n,r,i){this._firestore=t,this._key=e,this._document=n,this._fromCache=r,this._hasPendingWrites=i}return t.prototype.data=function(t){return iu("DocumentSnapshot.data",arguments,0,1),t=ld("DocumentSnapshot.data",t),this._document?this.convertObject(this._document.data,zu.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},t.prototype.get=function(t,e){if(iu("DocumentSnapshot.get",arguments,1,2),e=ld("DocumentSnapshot.get",e),this._document){var n=this._document.data.field(Kp("DocumentSnapshot.get",t));if(void 0!==n)return this.convertValue(n,zu.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ref",{get:function(){return new rd(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"metadata",{get:function(){return new id(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){if(!(e instanceof t))throw mu("isEqual","DocumentSnapshot",1,e);return this._firestore===e._firestore&&this._fromCache===e._fromCache&&this._key.isEqual(e._key)&&(null===this._document?null===e._document:this._document.isEqual(e._document))},t.prototype.convertObject=function(t,e){var n=this,r={};return t.forEach(function(t,i){r[t]=n.convertValue(i,e)}),r},t.prototype.convertValue=function(t,e){if(t instanceof sc)return this.convertObject(t,e);if(t instanceof uc)return this.convertArray(t,e);if(t instanceof oc){var n=t.value(e),r=this._firestore.ensureClientConfigured().databaseId();return t.databaseId.isEqual(r)||Us("Document "+this._key.path+" contains a document reference within a different database ("+t.databaseId.projectId+"/"+t.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new rd(n,this._firestore)}return t.value(e)},t.prototype.convertArray=function(t,e){var n=this;return t.internalValue.map(function(t){return n.convertValue(t,e)})},t}(),ad=function(t){function e(e,n,r,i,o){return t.call(this,e,n,r,i,o)||this}return Jn(e,t),e.prototype.data=function(e){var n=t.prototype.data.call(this,e);return Ks("object"==typeof n,"Document in a QueryDocumentSnapshot should exist"),n},e}(od),sd=function(){function t(t,e){this._query=t,this.firestore=e}return t.prototype.where=function(e,n,r){nu("Query.where",arguments,3),du("Query.where",3,r);var i;!function(t,e,n,r){if(!e.some(function(t){return t===r}))throw new Hs(zs.INVALID_ARGUMENT,"Invalid value "+pu(r)+" provided to function "+t+"() for its "+gu(n)+" argument. Acceptable values: "+e.join(", "))}("Query.where",["<","<=","==",">=",">","array-contains"],2,n);var o=Kp("Query.where",e),a=vc.fromString(n);if(o.isKeyField()){if(a===vc.ARRAY_CONTAINS)throw new Hs(zs.INVALID_ARGUMENT,"Invalid Query. You can't perform array-contains queries on FieldPath.documentId() since document IDs are not arrays.");if("string"==typeof r){if(""===r)throw new Hs(zs.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==r.indexOf("/"))throw new Hs(zs.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection by FieldPath.documentId(), the value provided must be a plain document ID, but '"+r+"' contains a slash.");var s=this._query.path.child(Lu.fromString(r));if(!Fu.isDocumentKey(s))throw new Hs(zs.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+s+"' is not because it has an odd number of segments ("+s.length+").");i=new oc(this.firestore._databaseId,new Fu(s))}else{if(!(r instanceof rd))throw new Hs(zs.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a string or a DocumentReference if the first parameter is FieldPath.documentId(), but it was: "+pu(r)+".");var u=r;i=new oc(this.firestore._databaseId,u._key)}}else i=this.firestore._dataConverter.parseQueryValue("Query.where",r);var c=gc.create(o,a,i);return this.validateNewFilter(c),new t(this._query.addFilter(c),this.firestore)},t.prototype.orderBy=function(e,n){var r;if(iu("Query.orderBy",arguments,1,2),au("Query.orderBy","non-empty string",2,n),void 0===n||"asc"===n)r=Ec.ASCENDING;else{if("desc"!==n)throw new Hs(zs.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+n+"', expected 'asc' or 'desc'.");r=Ec.DESCENDING}if(null!==this._query.startAt)throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var i=Kp("Query.orderBy",e),o=new Ic(i,r);return this.validateNewOrderBy(o),new t(this._query.addOrderBy(o),this.firestore)},t.prototype.limit=function(e){if(nu("Query.limit",arguments,1),ou("Query.limit","number",1,e),e<=0)throw new Hs(zs.INVALID_ARGUMENT,"Invalid Query. Query limit ("+e+") is invalid. Limit must be positive.");return new t(this._query.withLimit(e),this.firestore)},t.prototype.startAt=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];ru("Query.startAt",arguments,1);var i=this.boundFromDocOrFields("Query.startAt",e,n,!0);return new t(this._query.withStartAt(i),this.firestore)},t.prototype.startAfter=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];ru("Query.startAfter",arguments,1);var i=this.boundFromDocOrFields("Query.startAfter",e,n,!1);return new t(this._query.withStartAt(i),this.firestore)},t.prototype.endBefore=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];ru("Query.endBefore",arguments,1);var i=this.boundFromDocOrFields("Query.endBefore",e,n,!0);return new t(this._query.withEndAt(i),this.firestore)},t.prototype.endAt=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];ru("Query.endAt",arguments,1);var i=this.boundFromDocOrFields("Query.endAt",e,n,!1);return new t(this._query.withEndAt(i),this.firestore)},t.prototype.isEqual=function(e){if(!(e instanceof t))throw mu("isEqual","Query",1,e);return this.firestore===e.firestore&&this._query.isEqual(e._query)},t.prototype.boundFromDocOrFields=function(t,e,n,r){if(du(t,1,e),e instanceof od){if(n.length>0)throw new Hs(zs.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var i=e;if(!i.exists)throw new Hs(zs.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.boundFromDocument(t,i._document,r)}var o=[e].concat(n);return this.boundFromFields(t,o,r)},t.prototype.boundFromDocument=function(t,e,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var a=o[i];if(a.field.isKeyField())r.push(new oc(this.firestore._databaseId,e.key));else{var s=e.field(a.field);if(s instanceof rc)throw new Hs(zs.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(void 0===s){var u=a.field.canonicalString();throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}r.push(s)}}return new Tc(r,n)},t.prototype.boundFromFields=function(t,e,n){var r=this._query.explicitOrderBy;if(e.length>r.length)throw new Hs(zs.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<e.length;o++){var a=e[o];if(r[o].field.isKeyField()){if("string"!=typeof a)throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof a);if(!this._query.isCollectionGroupQuery()&&-1!==a.indexOf("/"))throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+t+"() must be a plain document ID, but '"+a+"' contains a slash.");var s=this._query.path.child(Lu.fromString(a));if(!Fu.isDocumentKey(s))throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+t+"() must result in a valid document path, but '"+s+"' is not because it contains an odd number of segments.");var u=new Fu(s);i.push(new oc(this.firestore._databaseId,u))}else{var c=this.firestore._dataConverter.parseQueryValue(t,a);i.push(c)}}return new Tc(i,n)},t.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];iu("Query.onSnapshot",arguments,1,4);var n,r={},i=0;return"object"!=typeof t[i]||Dp(t[i])||(yu("Query.onSnapshot",r=t[i],["includeMetadataChanges"]),uu("Query.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++),Dp(t[i])?n=t[i]:(ou("Query.onSnapshot","function",i,t[i]),au("Query.onSnapshot","function",i+1,t[i+1]),au("Query.onSnapshot","function",i+2,t[i+2]),n={next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(r,n)},t.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new vp({next:function(t){e.next&&e.next(new ud(n.firestore,n._query,t))},error:r}),o=this.firestore.ensureClientConfigured(),a=o.listen(this._query,i,t);return function(){i.mute(),o.unlisten(a)}},t.prototype.get=function(t){var e=this;return iu("Query.get",arguments,0,1),fd("Query.get",t),new Promise(function(n,r){t&&"cache"===t.source?e.firestore.ensureClientConfigured().getDocumentsFromLocalCache(e._query).then(function(t){n(new ud(e.firestore,e._query,t))},r):e.getViaSnapshotListener(n,r,t)})},t.prototype.getViaSnapshotListener=function(t,e,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),i.metadata.fromCache&&n&&"server"===n.source?e(new Hs(zs.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):t(i)},error:e})},t.prototype.validateNewFilter=function(t){if(t instanceof bc)if(t.isInequality()){var e=this._query.getInequalityFilterField();if(null!==e&&!e.isEqual(t.field))throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+e.toString()+"' and '"+t.field.toString()+"'");var n=this._query.getFirstOrderByField();null!==n&&this.validateOrderByAndInequalityMatch(t.field,n)}else if(t.op===vc.ARRAY_CONTAINS&&this._query.hasArrayContainsFilter())throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. Queries only support a single array-contains filter.")},t.prototype.validateNewOrderBy=function(t){if(null===this._query.getFirstOrderByField()){var e=this._query.getInequalityFilterField();null!==e&&this.validateOrderByAndInequalityMatch(e,t.field)}},t.prototype.validateOrderByAndInequalityMatch=function(t,e){if(!e.isEqual(t))throw new Hs(zs.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+e.toString()+"' instead.")},t}(),ud=function(){function t(t,e,n){this._firestore=t,this._originalQuery=e,this._snapshot=n,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new id(n.hasPendingWrites,n.fromCache)}return Object.defineProperty(t.prototype,"docs",{get:function(){var t=[];return this.forEach(function(e){return t.push(e)}),t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t,e){var n=this;iu("QuerySnapshot.forEach",arguments,1,2),ou("QuerySnapshot.forEach","function",1,t),this._snapshot.docs.forEach(function(r){t.call(e,n.convertToDocumentImpl(r))})},Object.defineProperty(t.prototype,"query",{get:function(){return new sd(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),t.prototype.docChanges=function(t){t&&(yu("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),uu("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));var e=!(!t||!t.includeMetadataChanges);if(e&&this._snapshot.excludesMetadataChanges)throw new Hs(zs.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e,n){if(n.oldDocs.isEmpty()){var r,i=0;return n.docChanges.map(function(e){var o=new ad(t,e.doc.key,e.doc,n.fromCache,n.mutatedKeys.has(e.doc.key));return Ks(e.type===uh.Added,"Invalid event type for first snapshot"),Ks(!r||n.query.docComparator(r,e.doc)<0,"Got added events in wrong order"),r=e.doc,{type:"added",doc:o,oldIndex:-1,newIndex:i++}})}var o=n.oldDocs;return n.docChanges.filter(function(t){return e||t.type!==uh.Metadata}).map(function(e){var r=new ad(t,e.doc.key,e.doc,n.fromCache,n.mutatedKeys.has(e.doc.key)),i=-1,a=-1;return e.type!==uh.Added&&(Ks((i=o.indexOf(e.doc.key))>=0,"Index for document not found"),o=o.delete(e.doc.key)),e.type!==uh.Removed&&(o=o.add(e.doc),a=o.indexOf(e.doc.key)),{type:dd(e.type),doc:r,oldIndex:i,newIndex:a}})}(this._firestore,e,this._snapshot),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges},t.prototype.isEqual=function(e){if(!(e instanceof t))throw mu("isEqual","QuerySnapshot",1,e);return this._firestore===e._firestore&&this._originalQuery.isEqual(e._originalQuery)&&this._snapshot.isEqual(e._snapshot)},t.prototype.convertToDocumentImpl=function(t){return new ad(this._firestore,t.key,t,this.metadata.fromCache,this._snapshot.mutatedKeys.has(t.key))},t}();["length","forEach","map"].concat("undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach(function(t){try{Object.defineProperty(ud.prototype.docChanges,t,{get:function(){return function(){throw new Hs(zs.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}()}})}catch(t){}});var cd=function(t){function e(e,n){var r=t.call(this,mc.atPath(e),n)||this;if(e.length%2!=1)throw new Hs(zs.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+e.canonicalString()+" has "+e.length);return r}return Jn(e,t),Object.defineProperty(e.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){var t=this._query.path.popLast();return t.isEmpty()?null:new rd(new Fu(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),e.prototype.doc=function(t){if(iu("CollectionReference.doc",arguments,0,1),0===arguments.length&&(t=bu.newId()),ou("CollectionReference.doc","non-empty string",1,t),""===t)throw new Hs(zs.INVALID_ARGUMENT,"Document path must be a non-empty string");var e=Lu.fromString(t);return rd.forPath(this._query.path.child(e),this.firestore)},e.prototype.add=function(t){nu("CollectionReference.add",arguments,1),ou("CollectionReference.add","object",1,t);var e=this.doc();return e.set(t).then(function(){return e})},e}(sd);function hd(t,e){if(void 0===e)return{merge:!1};if(yu(t,e,["merge","mergeFields"]),uu(t,"boolean","merge",e.merge),cu(t,"mergeFields","a string or a FieldPath",e.mergeFields,function(t){return"string"==typeof t||t instanceof bp}),void 0!==e.mergeFields&&void 0!==e.merge)throw new Hs(zs.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return e}function ld(t,e){return void 0===e?{}:(yu(t,e,["serverTimestamps"]),hu(t,0,"serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function fd(t,e){au(t,"object",1,e),e&&(yu(t,e,["source"]),hu(t,0,"source",e.source,["default","server","cache"]))}function pd(t,e,n){if(e instanceof rd){if(e.firestore!==n)throw new Hs(zs.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}throw mu(t,"DocumentReference",1,e)}function dd(t){switch(t){case uh.Added:return"added";case uh.Modified:case uh.Metadata:return"modified";case uh.Removed:return"removed";default:return Qs("Unknown change type: "+t)}}var yd=Ys(td,"Use firebase.firestore() instead."),md=Ys(ed,"Use firebase.firestore().runTransaction() instead."),gd=Ys(nd,"Use firebase.firestore().batch() instead."),vd=Ys(rd,"Use firebase.firestore().doc() instead."),bd=Ys(od),wd=Ys(ad),Sd=Ys(sd),Ed=Ys(ud),Td=Ys(cd,"Use firebase.firestore().collection() instead."),Id={Firestore:yd,GeoPoint:ku,Timestamp:Ru,Blob:Nu,Transaction:md,WriteBatch:gd,DocumentReference:vd,DocumentSnapshot:bd,Query:Sd,QueryDocumentSnapshot:wd,QuerySnapshot:Ed,CollectionReference:Td,FieldPath:bp,FieldValue:Pp,setLogLevel:td.setLogLevel,CACHE_SIZE_UNLIMITED:Jp};function Cd(t){t.INTERNAL.registerService("firestore",function(t){return new td(t)},function(t){Ks(t&&"object"==typeof t,"shallowCopy() expects object parameter.");var e={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}(Id))}Cd(Sr),Sr.initializeApp({apiKey:"AIzaSyCV444-QKFwglGHmhJbVgCN6Cj2GXf5KIM",authDomain:"rotavo-pwa.firebaseapp.com",databaseURL:"https://rotavo-pwa.firebaseio.com",projectId:"rotavo-pwa",storageBucket:"rotavo-pwa.appspot.com",messagingSenderId:"646348013955"});const Dd=Sr.firestore(),Ad=window.location.pathname.split("/").pop();new RegExp("^[a-z0-9]+$","gi").test(Ad)||console.log("Invalid ID"),Dd.collection("drawings").doc(Ad).get().then(function(t){if(t.exists){console.log("Document data:",t.data());const e=t.data().path,n=e[0];let r=`M ${n.x-2} ${n.y-2} M ${n.x+2} ${n.y+2} M ${n.x} ${n.y}`;for(let t=1;t<e.length;t++){const n=e[t];r+=` L ${n.x} ${n.y}`}document.querySelector(".sketch-path").setAttribute("d",r);const i=e[e.length-1],o=document.querySelector(".sketch-stylus");o.setAttribute("x1",i.x),o.setAttribute("x2",i.x),o.setAttribute("y1",i.y),o.setAttribute("y2",i.y)}else console.log("No such document!")}).catch(function(t){console.log("Error getting document:",t)})}();
//# sourceMappingURL=draw.js.map
